import{j as t,n as d,F as Ze}from"./index-Cu0vEPZc.js";import{r as a,H as et,a as tt,N as st}from"./handsontable-7BBM75Z1.js";import{L as at,D as Ne,y as c,F as nt,a as rt,S as ot,b as ct}from"./DropdownWithHeaders-D_q9bidk.js";import"./react-Csw2ODfV.js";function lt({value:x,onChange:N,items:R,headers:_,columns:b,search:y,onSearchChange:O,inputClassName:l,dropdownClassName:P,columnWidths:u,placeholder:D="- -"}){const[F,g]=a.useState(!1),[M,v]=a.useState(""),I=a.useRef(null),j=a.useRef(null),B=a.useRef(null),f=(y??M).trim().toLowerCase(),T=a.useMemo(()=>f?R.filter(n=>b.some(m=>String(n[m]??"").toLowerCase().includes(f))):R,[R,b,f]);a.useEffect(()=>{const n=p=>{const w=I.current;w&&(w.contains(p.target)||g(!1))},m=p=>{p.key==="Escape"&&g(!1)};return document.addEventListener("mousedown",n,!0),document.addEventListener("touchstart",n,!0),document.addEventListener("keydown",m,!0),()=>{document.removeEventListener("mousedown",n,!0),document.removeEventListener("touchstart",n,!0),document.removeEventListener("keydown",m,!0)}},[]),a.useEffect(()=>{F&&setTimeout(()=>B.current?.focus(),0)},[F]);const A=()=>setTimeout(()=>{const n=I.current;n&&!n.contains(document.activeElement)&&g(!1)},0);return t.jsxs("div",{className:"relative w-full",ref:I,children:[t.jsx("input",{ref:j,value:x??"",onChange:n=>N(n.target.value),onFocus:()=>g(!0),onBlur:A,className:`w-full border rounded px-3 py-2 h-11 text-sm ${l||""}`,placeholder:D,autoComplete:"off"}),F&&t.jsxs("div",{className:`absolute z-50 mt-1 min-w-full bg-white border rounded shadow ${P||""}`,onMouseDown:n=>{n.target.closest("input")||n.preventDefault()},children:[t.jsx("div",{className:"p-2 border-b sticky top-0 bg-white",children:t.jsx("input",{ref:B,value:y??M,onChange:n=>O?O(n.target.value):v(n.target.value),onBlur:A,className:"w-full border px-2 py-1 rounded text-sm",placeholder:"Search..."})}),t.jsx("div",{className:"grid text-xs font-semibold text-gray-600 px-2 py-2 border-b",style:{gridTemplateColumns:u&&u.length?u.join(" "):`repeat(${_.length}, minmax(0, 1fr))`},children:_.map(n=>t.jsx("div",{className:"truncate pr-2",children:n},n))}),t.jsx("div",{className:"max-h-72 overflow-auto",children:T.length===0?t.jsx("div",{className:"px-3 py-3 text-sm text-gray-500",children:"No results"}):T.map(n=>t.jsx("button",{type:"button",className:"grid w-full text-left px-2 py-1 hover:bg-gray-100 text-sm",style:{gridTemplateColumns:u&&u.length?u.join(" "):`repeat(${_.length}, minmax(0, 1fr))`},onClick:()=>{N(String(n.code??n[b[0]])),g(!1),j.current?.focus()},children:b.map((m,p)=>t.jsx("div",{className:"truncate pr-2",children:String(n[m]??"")},`${n.code??n[b[0]]}-${p}`))},String(n.code??n[b[0]])))})]})]})}tt.cellTypes.registerCellType("numeric",st);const C=x=>Number(Math.round((x||0)*100)/100).toLocaleString("en-US",{minimumFractionDigits:2}),k=x=>x?new Date(x).toISOString().slice(0,10):"";function ht(){const x=a.useRef(null),[N,R]=a.useState(!1),[_,b]=a.useState([]),[y,O]=a.useState(""),[l,P]=a.useState(""),[u,D]=a.useState(""),[F,g]=a.useState(""),[M,v]=a.useState(""),[I,j]=a.useState(""),[B,f]=a.useState(""),[T,A]=a.useState(""),[n,m]=a.useState(""),[p,w]=a.useState(""),[Y,H]=a.useState(!1),[Q,U]=a.useState(!1),[V,K]=a.useState(""),[G,z]=a.useState(""),[ne,_e]=a.useState([]),[it,dt]=a.useState(""),[re,oe]=a.useState([]),[ce,ve]=a.useState(""),[q,J]=a.useState(0),[X,Z]=a.useState(0),[le,ie]=a.useState(0),[de,ue]=a.useState(0),[me,pe]=a.useState(0),[E,W]=a.useState([]),[je,ge]=a.useState(!1),[we,Se]=a.useState(0),[Ce,ke]=a.useState(0),[Re,De]=a.useState(0),[Fe,Ie]=a.useState(0),[Te,Ae]=a.useState(0),[Ee,Le]=a.useState(0),he="h-11 px-3 py-2.5 text-base leading-6 rounded border border-gray-300";a.useEffect(()=>{(async()=>{const{data:e}=await d.get("/api/receiving/rr-list",{params:{include_posted:N?"1":"0",q:y}});b(e||[])})().catch(console.error)},[N,y]),a.useEffect(()=>{(async()=>{const e=await d.get("/api/pbn/list",{params:{include_posted:"1"}}),s=Array.isArray(e.data)?e.data:Array.isArray(e.data?.data)?e.data.data:[];_e(s),console.log("PBN items â†’",s.length,s[0])})().catch(console.error)},[]);const Oe=a.useMemo(()=>{const e=y.toLowerCase();return _.filter(s=>(s.receipt_no||"").toLowerCase().includes(e)||(s.pbn_number||"").toLowerCase().includes(e)||(s.vendor_name||"").toLowerCase().includes(e))},[_,y]),Pe=async e=>{try{P(e);const{data:s}=await d.get("/api/receiving/entry",{params:{receipt_no:e}});if(D(k(s.receipt_date)||""),g(s.pbn_number||""),v(s.item_number||""),j(s.vendor_name||""),f(s.mill||""),A(s.gl_account_key||""),m(s.assoc_dues??""),w(s.others??""),H(!!s.no_storage),U(!!s.no_insurance),z(s.insurance_week?k(s.insurance_week):""),K(s.storage_week?k(s.storage_week):""),s.pbn_number){const[{data:o},{data:i},{data:h}]=await Promise.all([d.get("/api/pbn/items",{params:{pbn_number:s.pbn_number}}),d.get("/api/receiving/pbn-item",{params:{pbn_number:s.pbn_number,item_no:s.item_number}}),d.get("/api/mills/rate",{params:{mill_name:s.mill,as_of:k(s.receipt_date)}})]);oe(Array.isArray(o)?o:[]),J(Number(i?.unit_cost||0)),Z(Number(i?.commission||0)),ie(Number(h?.insurance_rate||0)),ue(Number(h?.storage_rate||0)),pe(Number(h?.days_free||0))}const{data:r}=await d.get("/api/receiving/details",{params:{receipt_no:e}});W(Array.isArray(r)?r.map(o=>({...o,persisted:!0})):[]),ge(!0)}catch(s){console.error(s),c.error("Failed to load Receiving Entry.")}},Me=async e=>{try{g(e);const s=ne.find(o=>o.pbn_number===e);s&&j(s.vendor_name||"");const{data:r}=await d.get("/api/pbn/items",{params:{pbn_number:e}});oe(Array.isArray(r)?r:[]),v(""),f(""),J(0),Z(0)}catch(s){console.error(s),c.error("Failed to load PBN items.")}},Be=async e=>{const s=re.find(r=>String(r.row)===String(e));if(v(e),!!s){f(s.mill||""),J(Number(s.unit_cost||0)),Z(Number(s.commission||0));try{const{data:r}=await d.get("/api/mills/rate",{params:{mill_name:s.mill,as_of:u||void 0}});ie(Number(r?.insurance_rate||0)),ue(Number(r?.storage_rate||0)),pe(Number(r?.days_free||0))}catch{}}},qe=(e,s)=>{const r=(new Date(s).getTime()-new Date(e).getTime())/864e5;return Math.ceil(Math.abs(r)/30)},We=(e,s,r)=>{let o=(new Date(s).getTime()-new Date(e).getTime())/864e5;return o-=r,o<0&&(o=0),Math.floor(o/30)},$e=e=>{let s=0,r=0,o=0,i=0,h=0,be=0;const $=u||"",Ge=G||"",ze=V||"";e.forEach(S=>{const L=Number(S.quantity||0),Je=Number(S.liens||0);s+=L,r+=Je;const ye=Ge||(S.week_ending?k(S.week_ending):""),fe=ze||(S.week_ending?k(S.week_ending):"");let te=0;if(ye&&$&&!Q){const ae=qe(ye,$);te=L*(le||0)*ae}let se=0;if(fe&&$&&!Y){const ae=We(fe,$,me||0);se=L*(de||0)*ae}const Xe=L*(q||0)-(X||0);i+=te,o+=se,h+=Xe,be+=L*(q||0)-te-se}),Se(s),ke(r),De(o),Ie(i),Ae(h),Le(be)};a.useEffect(()=>{$e(E)},[E,u,G,V,Q,Y,q,X,le,de,me]);const xe=async(e,s)=>{l&&await d.post("/api/receiving/update-flag",{receipt_no:l,field:e,value:s?1:0})},ee=async(e,s)=>{l&&await d.post("/api/receiving/update-date",{receipt_no:l,field:e,value:s||null})},Ye=async e=>{H(e);try{await xe("no_storage",e),c.success("Storage flag updated")}catch{c.error("Failed to update storage flag")}},He=async e=>{U(e);try{await xe("no_insurance",e),c.success("Insurance flag updated")}catch{c.error("Failed to update insurance flag")}},Qe=async e=>{K(e);try{await ee("storage_week",e)}catch{c.error("Failed to update Storage Week")}},Ue=async e=>{z(e);try{await ee("insurance_week",e)}catch{c.error("Failed to update Insurance Week")}},Ve=async e=>{D(e);try{await ee("receipt_date",e),c.success("Date Received updated")}catch{c.error("Failed to update Date Received")}},Ke=async(e,s)=>{if(l)try{const r={receipt_no:l,row_index:s,row:e},{data:o}=await d.post("/api/receiving/batch-insert",r),i=o?.id;if(i){const h=[...E];h[s]={...e,id:i,persisted:!0},W(h)}}catch(r){console.error(r),c.error("Auto-save failed.")}};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(at,{position:"top-right",autoClose:2500}),t.jsxs("div",{className:"bg-yellow-50 shadow rounded-lg p-4 border border-yellow-300 space-y-4",children:[t.jsx("h2",{className:"text-lg font-bold text-slate-700",children:"RECEIVING ENTRY"}),t.jsxs("div",{className:"grid grid-cols-12 gap-3 items-end",children:[t.jsxs("div",{className:"col-span-8",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Receiving #"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:N,onChange:()=>R(e=>!e),title:"Include posted"}),t.jsx("div",{className:"flex-1",children:t.jsx(Ne,{label:"",value:l,onChange:Pe,items:Oe.map(e=>({code:e.receipt_no,label:e.receipt_no,description:e.vendor_name,quantity:e.quantity,pbn_number:e.pbn_number,sugar_type:e.sugar_type,receipt_date:e.receipt_date})),search:y,onSearchChange:O,headers:["Receipt No","Quantity","Sugar Type","PBN No","RDate","Vendor ID","Vendor Name"],columnWidths:["120px","90px","70px","110px","110px","110px","220px"],customKey:"rr",inputClassName:`${he} bg-green-100 text-green-900`})})]})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Date Received"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"date",value:u,onChange:e=>Ve(e.target.value),className:"w-full border p-2 rounded bg-yellow-100"}),t.jsx("span",{className:"inline-flex items-center text-xs px-2 rounded border",children:"UD"})]})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-8",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"PBN #"}),t.jsx(lt,{value:F,onChange:Me,items:ne.map(e=>({code:e.pbn_number,pbn_number:e.pbn_number,sugar_type:e.sugar_type,vendor_id:e.vendor_code,vendor_name:e.vendor_name,crop_year:e.crop_year,pbn_date:e.pbn_date})),headers:["PBN #","Sugar Type","Vendor ID","Vendor Name","Crop Year","PBN Date"],columns:["pbn_number","sugar_type","vendor_id","vendor_name","crop_year","pbn_date"],inputClassName:"bg-yellow-100",dropdownClassName:"min-w-[1000px]",columnWidths:["100px","70px","110px","350px","90px","110px"]})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Item #"}),t.jsx(Ne,{label:"",value:M,onChange:Be,items:re.filter(e=>[String(e.row),e.mill,String(e.quantity??"")].join(" ").toLowerCase().includes(ce.toLowerCase())).map(e=>({code:String(e.row),label:String(e.row),mill:e.mill,quantity:e.quantity,unit_cost:e.unit_cost,commission:e.commission})),search:ce,onSearchChange:ve,headers:["Item","MillMark","Quantity","BCost","CCost"],columnWidths:["80px","260px","120px","120px","120px"],dropdownPositionStyle:{minWidth:"750px"},customKey:"pbnitem",inputClassName:`${he} bg-yellow-100`})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-8",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Vendor Name"}),t.jsx("input",{value:I,disabled:!0,className:"w-full border p-2 bg-yellow-100 rounded"})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Mill"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{value:B,disabled:!0,className:"w-full border p-2 bg-yellow-100 rounded"}),t.jsx("span",{className:"inline-flex items-center text-xs px-2 rounded border",children:"UM"})]})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-6 flex items-center gap-3",children:[t.jsxs("label",{className:"inline-flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:Y,onChange:e=>Ye(e.target.checked)}),t.jsx("span",{children:"No Storage"})]}),t.jsxs("label",{className:"inline-flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:Q,onChange:e=>He(e.target.checked)}),t.jsx("span",{children:"No Insurance"})]})]}),t.jsxs("div",{className:"col-span-3",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Storage Week"}),t.jsx("input",{type:"date",value:V,onChange:e=>Qe(e.target.value),className:"w-full border p-2 bg-white rounded"})]}),t.jsxs("div",{className:"col-span-3",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Insurance Week"}),t.jsx("input",{type:"date",value:G,onChange:e=>Ue(e.target.value),className:"w-full border p-2 bg-white rounded"})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm",children:"GL Account"}),t.jsx("input",{value:T,onChange:e=>A(e.target.value),onBlur:async()=>{if(l)try{await d.post("/api/receiving/update-gl",{receipt_no:l,gl_account_key:T}),c.success("GL Account updated")}catch{c.error("Failed to update GL Account")}},className:"w-full border p-2 rounded"})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm",children:"Assoc Dues"}),t.jsx("input",{type:"number",step:"0.01",value:n,onChange:e=>m(e.target.value===""?"":Number(e.target.value)),onBlur:async()=>{if(l)try{await d.post("/api/receiving/update-assoc-others",{receipt_no:l,assoc_dues:Number(n||0),others:Number(p||0)}),c.success("Assoc/Others saved")}catch{c.error("Failed to save Assoc/Others")}},className:"w-full border p-2 rounded"})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm",children:"Others"}),t.jsx("input",{type:"number",step:"0.01",value:p,onChange:e=>w(e.target.value===""?"":Number(e.target.value)),onBlur:async()=>{if(l)try{await d.post("/api/receiving/update-assoc-others",{receipt_no:l,assoc_dues:Number(n||0),others:Number(p||0)}),c.success("Assoc/Others saved")}catch{c.error("Failed to save Assoc/Others")}},className:"w-full border p-2 rounded"})]})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-gray-800 mb-2",children:"Details"}),je&&t.jsx(et,{ref:x,data:E,colHeaders:["Quedan #","Quantity","Liens","Week Ending","Date Issued","Planter TIN","Planter Name","Item","Mill","Unit Cost","Commission","Storage","Insurance","Total AP"],columns:[{data:"quedan_no",type:"text"},{data:"quantity",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"liens",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"week_ending",type:"date",dateFormat:"YYYY-MM-DD",correctFormat:!0},{data:"date_issued",type:"date",dateFormat:"YYYY-MM-DD",correctFormat:!0},{data:"planter_tin",type:"text"},{data:"planter_name",readOnly:!0},{data:"item_no",readOnly:!0},{data:"mill",readOnly:!0},{data:"unit_cost",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"commission",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"storage",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"insurance",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"total_ap",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}}],stretchH:"all",height:420,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation",afterChange:(e,s)=>{if(!e||s!=="edit")return;const r=[...E];e.forEach(([o])=>{const i={...r[o]||{}};i.unit_cost=q,i.commission=X,r[o]=i,i.quedan_no&&i.quantity!=null&&Ke(i,o)}),W(r)}})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[t.jsxs("div",{children:[" Total Quantity__ ",t.jsx("span",{className:"font-semibold",children:C(we)})," "]}),t.jsxs("div",{children:[" Total Insurance_ ",t.jsx("span",{className:"font-semibold",children:C(Fe)})," "]}),t.jsxs("div",{children:[" Total Cost______ ",t.jsx("span",{className:"font-semibold",children:C(Te)})," "]}),t.jsxs("div",{children:[" Total Liens_____ ",t.jsx("span",{className:"font-semibold",children:C(Ce)})," "]}),t.jsxs("div",{children:[" Total Storage___ ",t.jsx("span",{className:"font-semibold",children:C(Re)})," "]}),t.jsxs("div",{children:["Total AP Cost___"," ",t.jsx("span",{className:"font-semibold",children:C(Ee+Number(n||0)+Number(p||0))})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white",children:[t.jsx(nt,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(Ze,{className:"h-4 w-4"})]}),t.jsxs("button",{className:"inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700",onClick:()=>{P(""),ge(!1),W([]),D(""),g(""),v(""),j(""),f(""),m(""),w(""),U(!1),H(!1),z(""),K(""),c.success("Ready for new Receiving Entry")},children:[t.jsx(rt,{className:"h-5 w-5"}),"New"]}),t.jsxs("button",{className:"inline-flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",onClick:()=>ot.fire({title:"Saved",icon:"success",timer:1200,showConfirmButton:!1}),children:[t.jsx(ct,{className:"h-5 w-5"}),"Save"]})]})]})}export{ht as default};
