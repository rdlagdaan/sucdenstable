import{n as u,j as t,F as se}from"./index-ICeWsGAD.js";import{r as c,H as Oe,a as re,N as Me}from"./handsontable-7BBM75Z1.js";import{L as He,D as ae,b as ne,y as d,F as Ie,a as Pe}from"./DropdownWithHeaders-CKbzX9B9.js";import{S as L,F as Ue,a as Be,b as ce}from"./sweetalert2.esm.all-B4pNkPRF.js";import"./react-Csw2ODfV.js";re.cellTypes.registerCellType("numeric",Me);function Ye(b){if(!b)return"";const g=new Date(b);if(isNaN(g.getTime()))return"";const y=g.getFullYear(),N=String(g.getMonth()+1).padStart(2,"0"),w=String(g.getDate()).padStart(2,"0");return`${y}-${N}-${w}`}function Je(){const b=c.useRef(null),[g,y]=c.useState(""),[N,w]=c.useState(""),[P,v]=c.useState(""),[U,S]=c.useState(""),[B,j]=c.useState(""),[Y,C]=c.useState(""),[r,D]=c.useState(null),[x,_]=c.useState(!1),[A,E]=c.useState(!0),[O,z]=c.useState([]),[R,G]=c.useState([]),[oe,ie]=c.useState(""),[le,M]=c.useState(""),[H,I]=c.useState(""),[X,q]=c.useState([]),[h,f]=c.useState([]),[W,k]=c.useState(!1),[de,J]=c.useState(!1),[ue,V]=c.useState(!1),[me,pe]=c.useState(void 0),[he,K]=c.useState(!1),Q=c.useRef(null),[Z,fe]=c.useState(600),T=e=>(e||"").split(";")[0];c.useLayoutEffect(()=>{const e=()=>{const s=Q.current?.getBoundingClientRect()?.top??0,n=window.innerHeight-s-140;fe(Math.max(320,Math.floor(n)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const xe=28,be=32,ge=240,ye=c.useMemo(()=>{const e=Math.max(h.length,6),a=be+e*xe+ge;return Math.min(a,Z)},[h.length,Z]),l=c.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);c.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/customers",{params:{company_id:l?.company_id}}),a=(e||[]).map(s=>({code:String(s.cust_id??s.code),label:s.cust_name??s.label??"",description:s.cust_name??s.description??""}));z(a)}catch(e){console.error("Failed to load customers",e),z([])}})()},[l?.company_id]),c.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/accounts",{params:{company_id:l?.company_id}});G(Array.isArray(e)?e:[])}catch(e){console.error("Failed to load accounts",e),G([])}})()},[l?.company_id]);const F=async()=>{try{const{data:e}=await u.get("/api/sales/list",{params:{company_id:l?.company_id||"",q:H||""}}),a=Array.isArray(e)?e:[];q(a)}catch(e){console.error("Failed to load cash sales list",e),q([])}};c.useEffect(()=>{F()},[H]);const we=c.useMemo(()=>(X||[]).map(e=>({code:String(e.id),cs_no:e.cs_no,cust_id:e.cust_id,sales_date:e.sales_date,sales_amount:e.sales_amount,si_no:e.si_no,label:e.cs_no,description:e.cust_id})),[X]),m=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),_e=()=>{M(""),I(""),y(""),w(""),v(""),S(""),j(""),C(""),D(null),_(!1),k(!1),f([m()])},Ne=async()=>{if((await L.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed)try{const a=await u.get("/api/sales/generate-cs-number",{params:{company_id:l?.company_id}}),s=a.data?.cs_no??a.data;y(s);const n=await u.post("/api/sales/save-main",{cs_no:s,cust_id:N,sales_date:U,explanation:B,si_no:Y,company_id:l?.company_id,user_id:l?.id});D(n.data.id),k(!0),f([m(),m()]),d.success("Main saved. You can now input details."),F(),_(!0),E(!1)}catch(a){console.error(a),d.error(a?.response?.data?.message||"Failed to save.")}},ve=()=>{_(!1),E(!1),d.success("Editing enabled. You can now update this transaction.")},Se=async()=>{if(!(!r||!(await L.fire({title:"Cancel this transaction?",text:"This will mark the transaction as CANCELLED.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, cancel it"})).isConfirmed))try{await u.post("/api/sales/cancel",{id:r,is_cancel:"y",company_id:l?.company_id||""}),_(!0),d.success("Transaction has been cancelled."),F()}catch(a){console.error(a),d.error("Failed to cancel transaction.")}},je=async()=>{if(!(!r||!(await L.fire({title:"Delete this transaction?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await u.delete(`/api/sales/${r}`),_e(),d.success("Transaction deleted."),F()}catch(a){console.error(a),d.error("Failed to delete transaction.")}},Ce=e=>!!T(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,De=async(e,a)=>{if(!r||!Ce(e))return;const s=T(e.acct_code);try{if(e.persisted)await u.post("/api/sales/update-detail",{id:e.id,transaction_id:r,acct_code:s,debit:e.debit||0,credit:e.credit||0});else{const n=await u.post("/api/sales/save-detail",{transaction_id:r,acct_code:s,debit:e.debit||0,credit:e.credit||0,company_id:l?.company_id,user_id:l?.id}),o=[...h];o[a]={...e,id:n.data.detail_id,persisted:!0},a===o.length-1&&o.push(m()),f(o)}}catch(n){console.error(n),d.error(n?.response?.data?.message||"Row save failed")}},Ee=async e=>{if(e)try{M(e);const{data:a}=await u.get(`/api/sales/${e}`,{params:{company_id:l?.company_id}}),s=a.main??a;D(s.id),y(s.cs_no),w(String(s.cust_id||""));const n=O.find(i=>String(i.code)===String(s.cust_id));v(n?.description||n?.label||"");const o=Ye(s.sales_date);S(o),j(s.explanation??""),C(s.si_no??"");const p=(a.details||[]).map(i=>({id:i.id,acct_code:`${i.acct_code};${i.acct_desc||ee(i.acct_code)}`,acct_desc:i.acct_desc,debit:Number(i.debit??0),credit:Number(i.credit??0),persisted:!0}));f(p.length?p.concat([m()]):[m()]),k(!0),_(!0),E(!0),d.success("Transaction loaded.")}catch(a){console.error(a),d.error("Unable to load the selected transaction.")}},Re=c.useMemo(()=>R.map(e=>`${e.acct_code};${e.acct_desc}`),[R]),ee=e=>R.find(s=>s.acct_code===e)?.acct_desc||"",ke=()=>{if(!r)return d.info("Select or save a transaction first.");const e=`/api/sales/form-pdf/${r}?company_id=${encodeURIComponent(l?.company_id||"")}`;pe(e),K(!0)},Te=async()=>{if(!r)return d.info("Select or save a transaction first.");const e=await u.get(`/api/sales/form-excel/${r}`,{responseType:"blob",params:{company_id:l?.company_id||""}}),a=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`SalesVoucher_${g||r}.xlsx`,s=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),n=URL.createObjectURL(s),o=document.createElement("a");o.href=n,o.download=a,document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(n)},Fe=()=>{M(""),I(""),D(null),y(""),w(""),v(""),S(""),j(""),C(""),_(!1),E(!1),f([m(),m(),m(),m()]),k(!1),d.success("Form is ready for a new entry.")},te=0,$e=(e,a)=>{if(x||a!==te)return;const s=b.current?.hotInstance;if(!s)return;const n=s.getActiveEditor();n?.cellProperties?.type==="autocomplete"&&(n.TEXTAREA.value="",n.query="",n.open(),n.refreshDropdown?.())},Le=(e,a)=>{if(a!==te||A)return;const s=b.current?.hotInstance;s&&requestAnimationFrame(()=>{const n=s.getActiveEditor();n&&(n.beginEditing(""),n.cellProperties?.type==="autocomplete"&&(n.TEXTAREA.value="",n.query="",n.refreshDropdown?.()))})};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(He,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-yellow-50 shadow-md rounded-lg p-6 space-y-4 border border-yellow-400",children:[t.jsx("h2",{className:"text-xl font-bold text-green-800 mb-2",children:"SALES JOURNAL"}),t.jsxs("div",{className:"text-xs text-gray-500",children:["accounts: ",R.length," | hotEnabled: ",String(W)," | locked: ",String(x)," | gridLocked: ",String(A)]}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsx("div",{className:"col-span-3",children:t.jsx(ae,{label:"Search Transaction",value:le,onChange:e=>Ee(e),items:we,search:H,onSearchChange:I,headers:["ID","Sales No","Customer","Date","Amount","S.I. #"],inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-2",children:t.jsx(ae,{label:"Customer",value:N,onChange:e=>{w(e);const a=O.find(s=>String(s.code)===String(e));v(a?.description||a?.label||"")},items:O,search:oe,onSearchChange:ie,headers:["Code","Label","Description"],inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:U,disabled:x,onChange:e=>S(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Explanation"}),t.jsx("input",{value:B,disabled:x,onChange:e=>j(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"S.I. #"}),t.jsx("input",{value:Y,disabled:x,onChange:e=>C(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),P&&t.jsxs("div",{className:"col-span-3 text-sm font-semibold text-gray-700",children:["Customer: ",P]})]}),t.jsx("div",{className:"flex gap-2 mt-3",children:r?t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:ve,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[t.jsx(ne,{className:"h-5 w-5"}),"Update"]}),t.jsx("button",{onClick:Se,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:"Cancel"}),t.jsx("button",{onClick:je,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:"Delete"})]}):t.jsxs("button",{onClick:Ne,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700",children:[t.jsx(ne,{className:"h-5 w-5"}),"Save"]})})]}),t.jsxs("div",{ref:Q,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),W&&t.jsx(Oe,{ref:b,data:h,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,a)=>{const s=Re;if(!e)return a(s);const n=String(e).toLowerCase();a(s.filter(o=>o.toLowerCase().includes(n)))},filter:!0,strict:!0,allowInvalid:!1,visibleRows:12,readOnly:A,renderer:(e,a,s,n,o,p,i)=>{const $=T(String(p??""));re.renderers.TextRenderer(e,a,s,n,o,$,i)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:x},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:x}],afterBeginEditing:$e,afterSelectionEnd:Le,afterChange:(e,a)=>{if(!e||a!=="edit")return;const s=[...h];e.forEach(([n,o,,p])=>{const i=s[n]||{};if(o==="acct_code"){const $=String(p||""),Ae=T($);i.acct_code=$,i.acct_desc=ee(Ae)}o==="debit"&&(i.debit=Number(p||0)),o==="credit"&&(i.credit=Number(p||0)),s[n]=i,setTimeout(()=>De(i,n),0)}),s.find(n=>!n.acct_code)||s.push(m()),f(s)},contextMenu:{items:{remove_row:{name:"ðŸ—‘ï¸ Remove row",callback:async(e,a)=>{const s=a[0].start.row,n=h[s];if(!n?.id){const i=[...h];i.splice(s,1),f(i);return}if(!(await L.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed)return;await u.post("/api/sales/delete-detail",{id:n.id,transaction_id:r});const p=[...h];p.splice(s,1),f(p),d.success("Row deleted")}}}},manualColumnResize:!0,stretchH:"all",height:ye,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>V(!0),onMouseLeave:()=>V(!1),children:[t.jsxs("button",{type:"button",disabled:!r,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${r?"bg-white text-emerald-700 border-emerald-300 hover:bg-emerald-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(Ue,{className:`h-5 w-5 ${r?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(se,{className:"h-4 w-4 opacity-70"})]}),ue&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:Te,disabled:!r,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${r?"text-gray-800 hover:bg-emerald-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx(Be,{className:`h-5 w-5 ${r?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Sales Voucher â€“ Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>J(!0),onMouseLeave:()=>J(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx(Ie,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(se,{className:"h-4 w-4 opacity-70"})]}),de&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsxs("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:[t.jsxs("button",{type:"button",onClick:ke,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(ce,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Sales Voucher â€“ PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]}),t.jsxs("button",{type:"button",onClick:()=>{if(!r)return d.info("Select or save a transaction.");window.open(`/api/sales/check-pdf/${r}?company_id=${encodeURIComponent(l?.company_id||"")}`,"_blank")},className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(ce,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Print Check â€“ PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})]})})]}),t.jsxs("button",{type:"button",onClick:Fe,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 focus:outline-none",title:"Start a new transaction",children:[t.jsx(Pe,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]})]}),he&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>K(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"âœ•"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Sales Voucher PDF",src:me,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{Je as default};
