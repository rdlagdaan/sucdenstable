import{n as l,j as a,F as ge}from"./index-DxPw8zrQ.js";import{r as c,H as ut,a as we,N as mt}from"./handsontable-7BBM75Z1.js";/* empty css                              */import{S as x,F as ht,a as xt,b as fe}from"./sweetalert2.esm.all-B4pNkPRF.js";import{L as bt,D as f,b as ye,y as u,F as gt,a as ft}from"./DropdownWithHeaders-ByoIFoOD.js";import"./react-Csw2ODfV.js";we.cellTypes.registerCellType("numeric",mt);const k=m=>(m||"").split(";")[0],_e=m=>m?new Date(m).toString()==="Invalid Date"?(m||"").split("T")[0]:new Date(m).toISOString().slice(0,10):"";function jt(){const m=c.useRef(null),[Se,P]=c.useState(""),[y,A]=c.useState(""),[q,E]=c.useState(""),[C,$]=c.useState(""),[_,M]=c.useState(""),[w,F]=c.useState(""),[X,L]=c.useState(""),[G,O]=c.useState(""),[K,B]=c.useState(""),[yt,J]=c.useState(""),[r,H]=c.useState(null),[Q,S]=c.useState(!1),[j,v]=c.useState(!0),[I,Z]=c.useState([]),[U,ee]=c.useState([]),[ve,te]=c.useState([]),[Ne,ae]=c.useState([]),[Ce,se]=c.useState([]),[je,De]=c.useState(""),[Te,Re]=c.useState(""),[ke,Pe]=c.useState(""),[Ae,Ee]=c.useState(""),[$e,ne]=c.useState(""),[V,ce]=c.useState(""),[ie,oe]=c.useState([]),[N,b]=c.useState([{acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}]),[Me,Y]=c.useState(!1),[Fe,re]=c.useState(!1),[Le,de]=c.useState(!1),[Oe,Be]=c.useState(void 0),[He,le]=c.useState(!1),[Ie,pe]=c.useState([]),[W,Ue]=c.useState(""),ue=c.useRef(null),[me,Ve]=c.useState(600);c.useLayoutEffect(()=>{const e=()=>{const t=ue.current?.getBoundingClientRect()?.top??0,n=window.innerHeight-t-140;Ve(Math.max(320,Math.floor(n)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const Ye=28,We=32,ze=240,qe=c.useMemo(()=>{const e=Math.max(N.length,6),s=We+e*Ye+ze;return Math.min(s,me)},[N.length,me]),d=c.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);c.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/pj/vendors",{params:{company_id:d?.company_id}}),s=(e||[]).map(t=>({code:String(t.code??t.vend_code??t.vend_id??""),description:t.description??t.vend_name??t.vendor_name??"",label:t.label??t.code??""}));Z(s)}catch{Z([])}})()},[d?.company_id]),c.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/pj/accounts",{params:{company_id:d?.company_id}});ee(Array.isArray(e)?e:[])}catch{ee([])}})()},[d?.company_id]),c.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/sugar-types"),s=(Array.isArray(e)?e:[]).map(t=>({code:String(t.code??t.sugar_code??t.sugar_type??t.type??""),description:String(t.description??t.sugar_desc??t.name??t.code??""),label:String(t.code??t.sugar_code??t.sugar_type??"")}));te(s)}catch{te([])}})()},[]),c.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/crop-years"),s=(Array.isArray(e)?e:[]).map(t=>({code:String(t.code??t.crop_year??t.year??""),description:String(t.description??t.crop_year??t.year??""),label:String(t.code??t.crop_year??t.year??"")}));ae(s)}catch{ae([])}})()},[]);const Xe=async e=>{try{const s={company_id:d?.company_id};e&&(s.as_of=e);const t=e?"/api/mills/effective":"/api/mills",{data:n}=await l.get(t,{params:s}),i=(Array.isArray(n)?n:[]).map(o=>{const p=String(o.mill_id??"").trim();return{code:p&&p!=="0"&&p.toLowerCase()!=="null"?p:String(o.prefix??"").trim(),description:String(o.mill_name??"").trim()}}).filter(o=>o.code);se(i)}catch{se([])}};c.useEffect(()=>{Xe(C||void 0)},[C]);const D=async()=>{try{const{data:e}=await l.get("/api/purchase/list",{params:{company_id:d?.company_id||"",q:V||""}});oe(Array.isArray(e)?e:[])}catch{oe([])}};c.useEffect(()=>{D()},[V]);const Ge=c.useMemo(()=>(ie||[]).map(e=>({code:String(e.id),cp_no:e.cp_no,vend_id:e.vend_id,purchase_date:_e(e.purchase_date),purchase_amount:e.purchase_amount,invoice_no:e.invoice_no,label:e.cp_no,description:e.vend_id})),[ie]),Ke=c.useMemo(()=>U.map(e=>`${e.acct_code};${e.acct_desc}`),[U]),z=e=>U.find(s=>s.acct_code===e)?.acct_desc||"",g=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),he=()=>{ne(""),ce(""),P(""),A(""),E(""),$(""),M(""),F(""),L(""),O(""),B(""),J(""),H(null),S(!1),v(!1),Y(!1),b([g()])},Je=async()=>{if((await x.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed){try{if((await l.get("/api/purchase/unbalanced-exists",{params:{company_id:d?.company_id||""}})).data?.exists){const t=await l.get("/api/purchase/unbalanced",{params:{company_id:d?.company_id||"",limit:20}}),o=`
          <div style="text-align:left">
            <div style="margin-bottom:8px">There are unbalanced purchase transactions. Please balance them first.</div>
            <table style="width:100%;border-collapse:collapse;font-size:12px">
              <thead>
                <tr>
                  <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 8px">CP #</th>
                  <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 8px">Vendor</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Debit</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Credit</th>
                </tr>
              </thead>
              <tbody>${(Array.isArray(t.data?.items)?t.data.items:[]).map(p=>`
          <tr>
            <td style="padding:6px 8px">${p.cp_no}</td>
            <td style="padding:6px 8px">${p.vend_id}</td>
            <td style="padding:6px 8px;text-align:right">${Number(p.sum_debit||0).toLocaleString()}</td>
            <td style="padding:6px 8px;text-align:right">${Number(p.sum_credit||0).toLocaleString()}</td>
          </tr>`).join("")||'<tr><td colspan="4" style="padding:6px 8px;color:#6b7280">No detail</td></tr>'}</tbody>
            </table>
          </div>`;await x.fire({icon:"warning",title:"Unbalanced transactions found",html:o,confirmButtonText:"OK"});return}}catch{}try{const s=await l.get("/api/purchase/generate-cp-number",{params:{company_id:d?.company_id}}),t=s.data?.cp_no??s.data;P(t);const n=await l.post("/api/purchase/save-main",{cp_no:t,vend_id:y,purchase_date:C,explanation:G,company_id:d?.company_id,user_id:d?.id,crop_year:_,sugar_type:w,mill_id:X,booking_no:K});H(n.data.id),Y(!0),b([g(),g()]),u.success("Main saved. You can now input details."),D(),S(!0),v(!1)}catch(s){u.error(s?.response?.data?.message||"Failed to save.")}}},Qe=()=>{S(!1),v(!1),u.success("Editing enabled.")},Ze=async()=>{if(!(!r||!(await x.fire({title:"Cancel this transaction?",text:"This will mark the transaction as CANCELLED.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, cancel it"})).isConfirmed))try{await l.post("/api/purchase/cancel",{id:r,flag:"1",company_id:d?.company_id||""}),S(!0),v(!0),u.success("Transaction has been cancelled."),D()}catch{u.error("Failed to cancel transaction.")}},et=async()=>{if(!(!r||!(await x.fire({title:"Delete this transaction?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await l.delete(`/api/purchase/${r}`),he(),u.success("Transaction deleted."),D()}catch{u.error("Failed to delete transaction.")}},tt=e=>!!k(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,xe=async(e,s)=>{if(!r||!tt(e))return;const t=k(e.acct_code);try{if(e.persisted)await l.post("/api/purchase/update-detail",{id:e.id,transaction_id:r,acct_code:t,debit:e.debit||0,credit:e.credit||0});else{const n=await l.post("/api/purchase/save-detail",{transaction_id:r,acct_code:t,debit:e.debit||0,credit:e.credit||0,company_id:d?.company_id,user_id:d?.id}),i=m.current?.hotInstance?.getSourceData()||[];i[s]&&(i[s].persisted=!0,i[s].id=n.data.detail_id),b([...i,...i.find(o=>!o.acct_code)?[]:[g()]])}}catch(n){u.error(n?.response?.data?.message||"Row save failed")}},at=async e=>{if(e)try{ne(e);const{data:s}=await l.get(`/api/purchase/${e}`,{params:{company_id:d?.company_id}}),t=s.main??s;H(t.id),P(t.cp_no),A(String(t.vend_id||""));const n=I.find(o=>String(o.code)===String(t.vend_id));E(n?.description||n?.label||""),$(_e(t.purchase_date)),O(t.explanation??""),J(t.invoice_no??""),M(String(t.crop_year??"")),F(String(t.sugar_type??"")),L(String(t.mill_id??"")),B(String(t.booking_no??""));const i=(s.details||[]).map(o=>({id:o.id,acct_code:`${o.acct_code};${o.acct_desc||z(o.acct_code)}`,acct_desc:o.acct_desc,debit:Number(o.debit??0),credit:Number(o.credit??0),persisted:!0}));b(i.length?i.concat([g()]):[g()]),Y(!0),S(!0),v(!0),u.success("Transaction loaded.")}catch{u.error("Unable to load the selected transaction.")}},st=()=>{if(!r)return u.info("Select or save a transaction first.");const e=`/api/purchase/form-pdf/${r}?company_id=${encodeURIComponent(d?.company_id||"")}`;Be(e),le(!0)},nt=async()=>{if(!r)return u.info("Select or save a transaction first.");const e=await l.get(`/api/purchase/form-excel/${r}`,{responseType:"blob",params:{company_id:d?.company_id||""}}),s=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`PurchaseVoucher_${Se||r}.xlsx`,t=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=s,document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(n)},ct=0,it=(e,s)=>{if(j||s!==ct)return;const n=m.current?.hotInstance?.getActiveEditor();n?.cellProperties?.type==="autocomplete"&&(n.TEXTAREA.value="",n.query="",n.open(),n.refreshDropdown?.())},ot=e=>{const s=e.reduce((i,o)=>i+(Number(o.debit)||0),0),t=e.reduce((i,o)=>i+(Number(o.credit)||0),0),n=Math.abs(s-t)<.005;return{sumD:s,sumC:t,balanced:n}},be=e=>(Number(e)||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),rt=async()=>{if(N.some(s=>s.acct_code&&s.acct_code.trim()!==""||(Number(s.debit)||0)>0||(Number(s.credit)||0)>0)){const{sumD:s,sumC:t,balanced:n}=ot(N);if(!n){await x.fire({title:"Transaction not balanced",html:`Debit <b>${be(s)}</b> must equal Credit <b>${be(t)}</b> before starting a new one.`,icon:"error",confirmButtonText:"OK"});return}if(!(await x.fire({title:"Start a new transaction?",text:"This will clear the current form.",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, New"})).isConfirmed)return}else if(!(await x.fire({title:"Start a new transaction?",text:"This will clear the current form.",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, New"})).isConfirmed)return;he(),u.success("Form is ready for a new entry.")},dt=e=>e?new Date(e).toLocaleDateString():"",lt=async()=>{try{const e={company_id:d?.company_id||"",q:W||""};y&&(e.vend_code=y),w&&(e.sugar_type=w),_&&(e.crop_year=_);const{data:s}=await l.get("/api/pbn/list",{params:e}),t=(Array.isArray(s)?s:[]).map(n=>({code:String(n.pbn_number),label:String(n.pbn_number),description:dt(n.pbn_date),vendor_name:n.vendor_name,vend_code:n.vend_code,sugar_type:n.sugar_type,crop_year:n.crop_year}));pe(t)}catch{pe([])}};return c.useEffect(()=>{lt()},[d?.company_id,y,w,_,W]),a.jsxs("div",{className:"space-y-4 p-6",children:[a.jsx(bt,{position:"top-right",autoClose:3e3}),a.jsxs("div",{className:"bg-blue-50 shadow-md rounded-lg p-6 space-y-4 border border-blue-300",children:[a.jsx("h2",{className:"text-xl font-bold text-blue-800 mb-2",children:"PURCHASE JOURNAL"}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsx("div",{className:"col-span-2",children:a.jsx(f,{label:"Search Transaction",value:$e,onChange:e=>at(e),items:Ge,search:V,onSearchChange:ce,headers:["Id","Purchase No","Vendor","Date","Amount","Vendor Inv #"],columnWidths:["60px","120px","160px","110px","120px","120px"],dropdownPositionStyle:{width:"820px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsxs("div",{children:[a.jsx(f,{label:"Vendor",value:y,onChange:e=>{A(e);const s=I.find(t=>String(t.code)===String(e));E(s?.description||"")},items:I,search:je,onSearchChange:De,headers:["Code","Description"],columnWidths:["140px","520px"],dropdownPositionStyle:{width:"700px"},inputClassName:"p-2 text-sm bg-white"}),q&&a.jsxs("div",{className:"mt-1 text-xs font-semibold text-gray-700",children:["Vendor: ",q]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1",children:"Date"}),a.jsx("input",{type:"date",value:C,disabled:Q,onChange:e=>$(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),a.jsx("div",{children:a.jsx(f,{label:"Crop Year",value:_,onChange:M,items:Ne,search:ke,onSearchChange:Pe,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsx("div",{children:a.jsx(f,{label:"Sugar Type",value:w,onChange:F,items:ve,search:Te,onSearchChange:Re,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsx("div",{children:a.jsx(f,{label:"Mill Code",value:X,onChange:L,items:Ce,search:Ae,onSearchChange:Ee,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1",children:"Explanation"}),a.jsx("input",{value:G,disabled:Q,onChange:e=>O(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),a.jsx("div",{children:a.jsx(f,{label:"Booking #",value:K,onChange:B,items:Ie,search:W,onSearchChange:Ue,headers:["PBN No","PBN Date"],columnWidths:["140px","140px"],dropdownPositionStyle:{width:"360px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsx("div",{})]}),a.jsx("div",{className:"flex gap-2 mt-3",children:r?a.jsxs(a.Fragment,{children:[a.jsxs("button",{onClick:Qe,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700",children:[a.jsx(ye,{className:"h-5 w-5"}),"Update"]}),a.jsx("button",{onClick:Ze,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:"Cancel"}),a.jsx("button",{onClick:et,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:"Delete"})]}):a.jsxs("button",{onClick:Je,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[a.jsx(ye,{className:"h-5 w-5"}),"Save"]})})]}),a.jsxs("div",{ref:ue,className:"relative z-0",children:[a.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),Me&&a.jsx(ut,{className:"hot-enhanced",ref:m,data:N,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,s)=>{const t=Ke;if(!e)return s(t);const n=String(e).toLowerCase();s(t.filter(i=>i.toLowerCase().includes(n)))},filter:!0,strict:!0,allowInvalid:!1,visibleRows:12,readOnly:j,renderer:(e,s,t,n,i,o,p)=>{const h=k(String(o??""));we.renderers.TextRenderer(e,s,t,n,i,h,p)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:j},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:j}],afterBeginEditing:it,afterChange:(e,s)=>{const t=m.current?.hotInstance;!e||!t||s==="edit"&&(e.forEach(([n,i,o,p])=>{if(i==="acct_code"){const h=String(p||""),T=k(h);t.setDataAtRowProp(n,"acct_desc",z(T));const R={...t.getSourceDataAtRow(n)},pt={id:R.id,acct_code:h,acct_desc:z(T),debit:Number(R.debit||0),credit:Number(R.credit||0),persisted:!!R.persisted};setTimeout(()=>xe(pt,n),0)}if(i==="debit"||i==="credit"){const h={...t.getSourceDataAtRow(n)},T={...h,acct_code:h.acct_code,debit:Number(i==="debit"?p:h.debit||0),credit:Number(i==="credit"?p:h.credit||0)};setTimeout(()=>xe(T,n),0)}}),requestAnimationFrame(()=>{const n=t.getSourceData();n.find(i=>!i.acct_code)||n.push(g()),b([...n])}))},contextMenu:{items:{remove_row:{name:"🗑️ Remove row",callback:async(e,s)=>{const t=m.current?.hotInstance,n=s[0].start.row,i=t?.getSourceData()||[],o=i[n];if(!o?.id){i.splice(n,1),b([...i]);return}(await x.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed&&(await l.post("/api/purchase/delete-detail",{id:o.id,transaction_id:r}),i.splice(n,1),b([...i]),u.success("Row deleted"))}}}},manualColumnResize:!0,stretchH:"all",height:qe,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),a.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[a.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>de(!0),onMouseLeave:()=>de(!1),children:[a.jsxs("button",{type:"button",disabled:!r,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${r?"bg-white text-blue-700 border-blue-300 hover:bg-blue-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[a.jsx(ht,{className:`h-5 w-5 ${r?"text-blue-600":"text-gray-400"}`}),a.jsx("span",{children:"Download"}),a.jsx(ge,{className:"h-4 w-4 opacity-70"})]}),Le&&a.jsx("div",{className:"absolute left-0 top-full z-50",children:a.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:a.jsxs("button",{type:"button",onClick:nt,disabled:!r,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${r?"text-gray-800 hover:bg-blue-50":"text-gray-400 cursor-not-allowed"}`,children:[a.jsx(xt,{className:`h-5 w-5 ${r?"text-blue-600":"text-gray-400"}`}),a.jsx("span",{className:"truncate",children:"Purchase Voucher – Excel"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),a.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>re(!0),onMouseLeave:()=>re(!1),children:[a.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[a.jsx(gt,{className:"h-5 w-5"}),a.jsx("span",{children:"Print"}),a.jsx(ge,{className:"h-4 w-4 opacity-70"})]}),Fe&&a.jsx("div",{className:"absolute left-0 top-full z-50",children:a.jsxs("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:[a.jsxs("button",{type:"button",onClick:st,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[a.jsx(fe,{className:"h-5 w-5 text-red-600"}),a.jsx("span",{className:"truncate",children:"Purchase Voucher – PDF"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]}),a.jsxs("button",{type:"button",onClick:()=>{if(!r)return u.info("Select or save a transaction.");window.open(`/api/purchase/check-pdf/${r}?company_id=${encodeURIComponent(d?.company_id||"")}`,"_blank")},className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[a.jsx(fe,{className:"h-5 w-5 text-red-600"}),a.jsx("span",{className:"truncate",children:"Print Check – PDF"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})]})})]}),a.jsxs("button",{type:"button",onClick:rt,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700",title:"Start a new transaction",children:[a.jsx(ft,{className:"h-5 w-5"}),a.jsx("span",{children:"New"})]})]}),He&&a.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:a.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[a.jsx("button",{onClick:()=>le(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"✕"}),a.jsx("div",{className:"h-full w-full pt-8",children:a.jsx("iframe",{title:"Purchase Voucher PDF",src:Oe,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{jt as default};
