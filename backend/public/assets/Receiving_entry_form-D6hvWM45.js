import{j as t,n as u,F as rt}from"./index-BN1rWdEK.js";import{r as a,H as ot,a as ct,N as it}from"./handsontable-7BBM75Z1.js";import{L as lt,D as dt,y as c,F as ut,a as mt,b as pt}from"./DropdownWithHeaders-U6dCYxQX.js";import"./react-Csw2ODfV.js";function we({value:_,displayValue:k,readOnlyInput:Y,onChange:C,items:j,headers:x,columns:b,search:l,onSearchChange:R,inputClassName:h,dropdownClassName:M,columnWidths:m,placeholder:P="- -"}){const[y,p]=a.useState(!1),[S,$]=a.useState(""),v=a.useRef(null),D=a.useRef(null),I=a.useRef(null),F=(l??S).trim().toLowerCase(),w=a.useMemo(()=>F?j.filter(n=>b.some(d=>String(n[d]??"").toLowerCase().includes(F))):j,[j,b,F]);a.useEffect(()=>{const n=f=>{const A=v.current;A&&(A.contains(f.target)||p(!1))},d=f=>{f.key==="Escape"&&p(!1)};return document.addEventListener("mousedown",n,!0),document.addEventListener("touchstart",n,!0),document.addEventListener("keydown",d,!0),()=>{document.removeEventListener("mousedown",n,!0),document.removeEventListener("touchstart",n,!0),document.removeEventListener("keydown",d,!0)}},[]),a.useEffect(()=>{y&&setTimeout(()=>I.current?.focus(),0)},[y]);const T=()=>setTimeout(()=>{const n=v.current;n&&!n.contains(document.activeElement)&&p(!1)},0);return t.jsxs("div",{className:"relative w-full",ref:v,children:[t.jsx("input",{ref:D,value:k??_??"",onChange:n=>{Y||C(n.target.value)},onFocus:()=>p(!0),onClick:()=>p(!0),onKeyDown:n=>{(n.key==="ArrowDown"||n.key==="Enter")&&(p(!0),setTimeout(()=>I.current?.focus(),0),n.preventDefault())},readOnly:!!Y,onBlur:T,className:`w-full border rounded px-3 py-2 h-11 text-sm ${h||""}`,placeholder:P,autoComplete:"off"}),y&&t.jsxs("div",{className:`absolute z-50 mt-1 min-w-full bg-white border rounded shadow ${M||""}`,onMouseDown:n=>{n.target.closest("input")||n.preventDefault()},children:[t.jsx("div",{className:"p-2 border-b sticky top-0 bg-white",children:t.jsx("input",{ref:I,value:l??S,onChange:n=>R?R(n.target.value):$(n.target.value),onBlur:T,onKeyDown:n=>{if(n.key==="Enter"){const d=w[0];d&&(C(String(d.code??d[b[0]])),p(!1))}},className:"w-full border px-2 py-1 rounded text-sm",placeholder:"Search..."})}),t.jsx("div",{className:"grid text-xs font-semibold text-gray-600 px-2 py-2 border-b",style:{gridTemplateColumns:m&&m.length?m.join(" "):`repeat(${x.length}, minmax(0, 1fr))`},children:x.map(n=>t.jsx("div",{className:"truncate pr-2",children:n},n))}),t.jsx("div",{className:"max-h-72 overflow-auto",children:w.length===0?t.jsx("div",{className:"px-3 py-3 text-sm text-gray-500",children:"No results"}):w.map(n=>t.jsx("button",{type:"button",className:"grid w-full text-left px-2 py-1 hover:bg-gray-100 text-sm",style:{gridTemplateColumns:m&&m.length?m.join(" "):`repeat(${x.length}, minmax(0, 1fr))`},onMouseDown:d=>{d.preventDefault(),C(String(n.code??n[b[0]])),p(!1)},children:b.map((d,f)=>t.jsx("div",{className:"truncate pr-2",children:String(n[d]??"")},`${n.code??n[b[0]]}-${f}`))},String(n.code??n[b[0]])))})]})]})}ct.cellTypes.registerCellType("numeric",it);const O=_=>Number(Math.round((_||0)*100)/100).toLocaleString("en-US",{minimumFractionDigits:2}),L=_=>_?new Date(_).toISOString().slice(0,10):"";function Nt(){const _=a.useRef(null),[k,Y]=a.useState(!1),[C,j]=a.useState([]),[x,b]=a.useState(""),[l,R]=a.useState(""),[h,M]=a.useState(""),[m,P]=a.useState(""),[y,p]=a.useState(""),[S,$]=a.useState(""),[v,D]=a.useState(""),[I,F]=a.useState(""),[w,T]=a.useState(""),[n,d]=a.useState(""),[f,A]=a.useState(!1),[G,z]=a.useState(!1),[J,X]=a.useState(""),[Z,ee]=a.useState(""),[q,je]=a.useState([]),[te,Se]=a.useState(""),[de,ue]=a.useState([]),[gt,xt]=a.useState(""),[U,se]=a.useState(0),[ae,ne]=a.useState(0),[me,pe]=a.useState(0),[ge,xe]=a.useState(0),[be,he]=a.useState(0),[B,H]=a.useState([]),[ke,Q]=a.useState(!1),[Ce,Re]=a.useState(0),[De,Ie]=a.useState(0),[Fe,Te]=a.useState(0),[Ae,Ee]=a.useState(0),[Oe,Le]=a.useState(0),[Me,Pe]=a.useState(0),$e=(...e)=>{const s=e.filter(([,r])=>!r||String(r).trim()==="").map(([r])=>r);return s.length?(c.error(`Please fill: ${s.join(", ")}`),!1):!0},ye="h-8 px-3 py-2.5 text-base leading-6 rounded border border-gray-300",qe=m?`${m} — ${S||""}`:"",Be=a.useRef(null),Ve=y?`${y} — ${v||""}`:"";a.useEffect(()=>{(async()=>{const{data:e}=await u.get("/api/receiving/rr-list",{params:{include_posted:k?"1":"0",q:x}});j(e||[])})().catch(console.error)},[k,x]),a.useEffect(()=>{(async()=>{const e=await u.get("/api/pbn/list",{params:{q:te}}),s=Array.isArray(e.data)?e.data:Array.isArray(e.data?.data)?e.data.data:[];je(s),console.log("PBN items →",q.length,q[0])})().catch(console.error)},[te]);const We=a.useMemo(()=>{const e=x.toLowerCase();return C.filter(s=>(s.receipt_no||"").toLowerCase().includes(e)||(s.pbn_number||"").toLowerCase().includes(e)||(s.vendor_name||"").toLowerCase().includes(e))},[C,x]),fe=async e=>{p(String(e.row)),D(e.mill||""),se(Number(e.unit_cost||0)),ne(Number(e.commission||0));try{const{data:s}=await u.get("/api/mills/rate",{params:{mill_name:e.mill,as_of:h||void 0}});pe(Number(s?.insurance_rate||0)),xe(Number(s?.storage_rate||0)),he(Number(s?.days_free||0))}catch{}},Ye=async e=>{try{R(e);const{data:s}=await u.get("/api/receiving/entry",{params:{receipt_no:e}});if(M(L(s.receipt_date)||""),P(s.pbn_number||""),p(s.item_number||""),$(s.vendor_name||""),D(s.mill||""),F(s.gl_account_key||""),T(s.assoc_dues??""),d(s.others??""),A(!!s.no_storage),z(!!s.no_insurance),ee(s.insurance_week?L(s.insurance_week):""),X(s.storage_week?L(s.storage_week):""),s.pbn_number){const[{data:o},{data:i},{data:g}]=await Promise.all([u.get("/api/pbn/items",{params:{pbn_number:s.pbn_number}}),u.get("/api/receiving/pbn-item",{params:{pbn_number:s.pbn_number,item_no:s.item_number}}),u.get("/api/mills/rate",{params:{mill_name:s.mill,as_of:L(s.receipt_date)}})]);ue(Array.isArray(o)?o:[]),se(Number(i?.unit_cost||0)),ne(Number(i?.commission||0)),pe(Number(g?.insurance_rate||0)),xe(Number(g?.storage_rate||0)),he(Number(g?.days_free||0))}const{data:r}=await u.get("/api/receiving/details",{params:{receipt_no:e}});H(Array.isArray(r)?r.map(o=>({...o,persisted:!0})):[]),Q(!0)}catch(s){console.error(s),c.error("Failed to load Receiving Entry.")}},Ue=async e=>{try{P(e);const s=q.find(i=>i.pbn_number===e);s&&$(s.vendor_name||"");const{data:r}=await u.get("/api/pbn/items",{params:{pbn_number:e}}),o=Array.isArray(r)?r:[];ue(o),o.length===1?await fe(o[0]):(p(""),D(""),se(0),ne(0),setTimeout(()=>{Be.current?.querySelector("input")?.focus()},0))}catch(s){console.error(s),c.error("Failed to load PBN items.")}},He=async e=>{const s=typeof e=="string"?de.find(r=>String(r.row)===String(e)):e;if(!s){typeof e=="string"&&p(e);return}await fe(s)},Qe=(e,s)=>{const r=(new Date(s).getTime()-new Date(e).getTime())/864e5;return Math.ceil(Math.abs(r)/30)},Ke=(e,s,r)=>{let o=(new Date(s).getTime()-new Date(e).getTime())/864e5;return o-=r,o<0&&(o=0),Math.floor(o/30)},Ge=e=>{let s=0,r=0,o=0,i=0,g=0,K=0;const N=h||"",V=Z||"",oe=J||"";e.forEach(E=>{const W=Number(E.quantity||0),at=Number(E.liens||0);s+=W,r+=at;const _e=V||(E.week_ending?L(E.week_ending):""),ve=oe||(E.week_ending?L(E.week_ending):"");let ce=0;if(_e&&N&&!G){const le=Qe(_e,N);ce=W*(me||0)*le}let ie=0;if(ve&&N&&!f){const le=Ke(ve,N,be||0);ie=W*(ge||0)*le}const nt=W*(U||0)-(ae||0);i+=ce,o+=ie,g+=nt,K+=W*(U||0)-ce-ie}),Re(s),Ie(r),Te(o),Ee(i),Le(g),Pe(K)};a.useEffect(()=>{Ge(B)},[B,h,Z,J,G,f,U,ae,me,ge,be]);const Ne=async(e,s)=>{l&&await u.post("/api/receiving/update-flag",{receipt_no:l,field:e,value:s?1:0})},re=async(e,s)=>{l&&await u.post("/api/receiving/update-date",{receipt_no:l,field:e,value:s||null})},ze=async e=>{A(e);try{await Ne("no_storage",e),c.success("Storage flag updated")}catch{c.error("Failed to update storage flag")}},Je=async e=>{z(e);try{await Ne("no_insurance",e),c.success("Insurance flag updated")}catch{c.error("Failed to update insurance flag")}},Xe=async e=>{X(e);try{await re("storage_week",e)}catch{c.error("Failed to update Storage Week")}},Ze=async e=>{ee(e);try{await re("insurance_week",e)}catch{c.error("Failed to update Insurance Week")}},et=async e=>{M(e);try{await re("receipt_date",e),c.success("Date Received updated")}catch{c.error("Failed to update Date Received")}},tt=async(e,s)=>{if(l)try{const r={receipt_no:l,row_index:s,row:e},{data:o}=await u.post("/api/receiving/batch-insert",r),i=o?.id;if(i){const g=[...B];g[s]={...e,id:i,persisted:!0},H(g)}}catch(r){console.error(r),c.error("Auto-save failed.")}},st=async()=>{if(!$e(["Date Received",h],["PBN #",m],["Item #",y],["Vendor Name",S],["Mill",v]))return;if(l){c.info("Receiving already created."),Q(!0);return}const s=localStorage.getItem("user"),r=s?JSON.parse(s):null,o=r?.company_id,i=r?.id??r?.user_id;if(!o){c.error("Missing company id; please sign in again.");return}try{const g={company_id:o,user_id:i,pbn_number:m,item_number:y,receipt_date:h,mill:v},{data:K}=await u.post("/api/receiving/create-entry",g),N=K?.receipt_no;if(!N)throw new Error("Server did not return receipt_no");R(N),j(V=>[{receipt_no:N,quantity:0,sugar_type:q.find(oe=>oe.pbn_number===m)?.sugar_type??"",pbn_number:m,receipt_date:h,vendor_code:"",vendor_name:S||""},...V]);try{const{data:V}=await u.get("/api/receiving/rr-list",{params:{include_posted:k?"1":"0",q:""}});j(V||[])}catch{}Q(!0),c.success(`Created ${N}`)}catch(g){console.error(g),c.error("Failed to create Receiving Entry.")}};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(lt,{position:"top-right",autoClose:2500}),t.jsxs("div",{className:"bg-yellow-50 shadow rounded-lg p-4 border border-yellow-300 space-y-4",children:[t.jsx("h2",{className:"text-lg font-bold text-slate-700",children:"RECEIVING ENTRY"}),t.jsxs("div",{className:"grid grid-cols-12 gap-3 items-end",children:[t.jsxs("div",{className:"col-span-8",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Receiving #"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:k,onChange:()=>Y(e=>!e),title:"Include posted"}),t.jsx("div",{className:"flex-1",children:t.jsx(dt,{label:"",value:l,onChange:Ye,items:We.map(e=>({code:e.receipt_no,label:e.receipt_no,description:e.vendor_name,quantity:e.quantity,pbn_number:e.pbn_number,sugar_type:e.sugar_type,receipt_date:e.receipt_date})),search:x,onSearchChange:b,headers:["Receipt No","Quantity","Sugar Type","PBN No","RDate","Vendor ID","Vendor Name"],columnWidths:["120px","90px","70px","110px","110px","110px","220px"],customKey:"rr",inputClassName:`${ye} bg-green-100 text-green-900`})})]})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Date Received"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"date",value:h,onChange:e=>et(e.target.value),className:"w-full border p-2 rounded bg-yellow-100"}),t.jsx("span",{className:"inline-flex items-center text-xs px-2 rounded border",children:"UD"})]})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-8",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"PBN #"}),t.jsx(we,{value:m,displayValue:qe,readOnlyInput:!0,onChange:Ue,items:q.map(e=>({code:e.pbn_number,pbn_number:e.pbn_number,sugar_type:e.sugar_type,vendor_id:e.vendor_code,vendor_name:e.vendor_name,crop_year:e.crop_year,pbn_date:e.pbn_date})),headers:["PBN #","Sugar Type","Vendor ID","Vendor Name","Crop Year","PBN Date"],columns:["pbn_number","sugar_type","vendor_id","vendor_name","crop_year","pbn_date"],search:te,onSearchChange:Se,inputClassName:"bg-yellow-100",dropdownClassName:"min-w-[1000px]",columnWidths:["100px","70px","110px","350px","90px","110px"]})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Item #"}),t.jsx(we,{value:y,displayValue:Ve,readOnlyInput:!0,onChange:He,items:de.map(e=>({code:String(e.row),item:String(e.row),millmark:e.mill??"",quantity:e.quantity??0,bcost:e.unit_cost??0,ccost:e.commission??0})),headers:["Item","MillMark","Quantity","BCost","CCost"],columns:["item","millmark","quantity","bcost","ccost"],inputClassName:`${ye} bg-yellow-100`,dropdownClassName:"min-w-[980px]",columnWidths:["50px","200px","60px","60px","60px"]})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-8",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Vendor Name"}),t.jsx("input",{value:S,disabled:!0,className:"w-full border p-2 bg-yellow-100 rounded"})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Mill"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{value:v,disabled:!0,className:"w-full border p-2 bg-yellow-100 rounded"}),t.jsx("span",{className:"inline-flex items-center text-xs px-2 rounded border",children:"UM"})]})]})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-gray-800 mb-2",children:"Details"}),ke&&t.jsx(ot,{ref:_,data:B,colHeaders:["Quedan #","Quantity","Liens","Week Ending","Date Issued","Planter TIN","Planter Name","Item","Mill","Unit Cost","Commission","Storage","Insurance","Total AP"],columns:[{data:"quedan_no",type:"text"},{data:"quantity",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"liens",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"week_ending",type:"date",dateFormat:"YYYY-MM-DD",correctFormat:!0},{data:"date_issued",type:"date",dateFormat:"YYYY-MM-DD",correctFormat:!0},{data:"planter_tin",type:"text"},{data:"planter_name",readOnly:!0},{data:"item_no",readOnly:!0},{data:"mill",readOnly:!0},{data:"unit_cost",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"commission",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"storage",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"insurance",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"total_ap",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}}],stretchH:"all",height:560,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation",afterChange:(e,s)=>{if(!e||s!=="edit")return;const r=[...B];e.forEach(([o])=>{const i={...r[o]||{}};i.unit_cost=U,i.commission=ae,r[o]=i,i.quedan_no&&i.quantity!=null&&tt(i,o)}),H(r)}})]}),t.jsxs("div",{className:"mt-4 border border-slate-300 rounded-lg bg-white shadow-sm p-4 space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-3 gap-4 text-slate-800",children:[t.jsxs("div",{children:[" Total Quantity__ ",t.jsx("span",{className:"font-semibold",children:O(Ce)})," "]}),t.jsxs("div",{children:[" Total Insurance_ ",t.jsx("span",{className:"font-semibold",children:O(Ae)})," "]}),t.jsxs("div",{children:[" Total Cost_____ ",t.jsx("span",{className:"font-semibold",children:O(Oe)})," "]}),t.jsxs("div",{children:[" Total Liens____ ",t.jsx("span",{className:"font-semibold",children:O(De)})," "]}),t.jsxs("div",{children:[" Total Storage__ ",t.jsx("span",{className:"font-semibold",children:O(Fe)})," "]}),t.jsxs("div",{children:["Total AP Cost___"," ",t.jsx("span",{className:"font-semibold",children:O(Me+Number(w||0)+Number(n||0))})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[t.jsxs("div",{className:"col-span-6 grid grid-cols-6 gap-4",children:[t.jsxs("div",{className:"col-span-6",children:[t.jsx("label",{className:"block text-xs font-semibold text-slate-600",children:"GL Account"}),t.jsx("input",{value:I,onChange:e=>F(e.target.value),onBlur:async()=>{if(l)try{await u.post("/api/receiving/update-gl",{receipt_no:l,gl_account_key:I}),c.success("GL Account updated")}catch{c.error("Failed to update GL Account")}},className:"w-full border p-2 rounded bg-yellow-50"})]}),t.jsxs("div",{className:"col-span-3",children:[t.jsx("label",{className:"block text-xs font-semibold text-slate-600",children:"Assoc Dues"}),t.jsx("input",{type:"number",step:"0.01",value:w,onChange:e=>T(e.target.value===""?"":Number(e.target.value)),onBlur:async()=>{if(l)try{await u.post("/api/receiving/update-assoc-others",{receipt_no:l,assoc_dues:Number(w||0),others:Number(n||0)}),c.success("Assoc/Others saved")}catch{c.error("Failed to save Assoc/Others")}},className:"w-full border p-2 rounded bg-yellow-50"})]}),t.jsxs("div",{className:"col-span-3",children:[t.jsx("label",{className:"block text-xs font-semibold text-slate-600",children:"Others"}),t.jsx("input",{type:"number",step:"0.01",value:n,onChange:e=>d(e.target.value===""?"":Number(e.target.value)),onBlur:async()=>{if(l)try{await u.post("/api/receiving/update-assoc-others",{receipt_no:l,assoc_dues:Number(w||0),others:Number(n||0)}),c.success("Assoc/Others saved")}catch{c.error("Failed to save Assoc/Others")}},className:"w-full border p-2 rounded bg-yellow-50"})]})]}),t.jsxs("div",{className:"col-span-6 grid grid-cols-6 gap-4",children:[t.jsxs("div",{className:"col-span-3",children:[t.jsx("label",{className:"block text-xs font-semibold text-slate-600",children:"Storage Week"}),t.jsx("input",{type:"date",value:J,onChange:e=>Xe(e.target.value),className:"w-full border p-2 rounded bg-white"})]}),t.jsxs("div",{className:"col-span-3",children:[t.jsx("label",{className:"block text-xs font-semibold text-slate-600",children:"Insurance Week"}),t.jsx("input",{type:"date",value:Z,onChange:e=>Ze(e.target.value),className:"w-full border p-2 rounded bg-white"})]}),t.jsxs("div",{className:"col-span-6 flex items-center gap-8 pt-1",children:[t.jsxs("label",{className:"inline-flex items-center gap-2 text-slate-700",children:[t.jsx("input",{type:"checkbox",className:"h-4 w-4 accent-blue-600",checked:f,onChange:e=>ze(e.target.checked)}),t.jsx("span",{className:"text-sm font-medium",children:"No Storage"})]}),t.jsxs("label",{className:"inline-flex items-center gap-2 text-slate-700",children:[t.jsx("input",{type:"checkbox",className:"h-4 w-4 accent-blue-600",checked:G,onChange:e=>Je(e.target.checked)}),t.jsx("span",{className:"text-sm font-medium",children:"No Insurance"})]})]})]})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white",children:[t.jsx(ut,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(rt,{className:"h-4 w-4"})]}),t.jsxs("button",{className:"inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700",onClick:()=>{R(""),Q(!1),H([]),M(""),P(""),p(""),$(""),D(""),T(""),d(""),z(!1),A(!1),ee(""),X(""),c.success("Ready for new Receiving Entry")},children:[t.jsx(mt,{className:"h-5 w-5"}),"New"]}),t.jsxs("button",{disabled:!!l,className:`inline-flex items-center gap-2 px-4 py-2 rounded 
                      ${l?"bg-green-400 cursor-not-allowed opacity-60":"bg-green-600 hover:bg-green-700"} 
                      text-white`,onClick:st,children:[t.jsx(pt,{className:"h-5 w-5"}),"Save"]})]})]})}export{Nt as default};
