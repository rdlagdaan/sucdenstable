import{n as p,j as t,F as ge}from"./index-AC0z2Zqz.js";import{r as a,H as ct,a as _e,N as ot}from"./handsontable-7BBM75Z1.js";import{S as R,F as rt,a as it,b as lt}from"./sweetalert2.esm.all-B4pNkPRF.js";import{y as l,L as dt,D as L,b as we,F as ut,a as mt}from"./DropdownWithHeaders-C7hsf4kw.js";import{F as pt}from"./XMarkIcon-B-Tbi0qp.js";import{F as ht}from"./TrashIcon-I-_qGSbO.js";import"./react-Csw2ODfV.js";function xt({title:i,titleId:r,...u},m){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:m,"aria-labelledby":r},u),i?a.createElement("title",{id:r},i):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3"}))}const ft=a.forwardRef(xt);_e.cellTypes.registerCellType("numeric",ot);const P=i=>(i||"").split(";")[0];function bt(i){const r=["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],u=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];let m="";const f=Math.floor(i/100),h=i%100;if(f&&(m+=r[f]+" hundred"+(h?" ":"")),h)if(h<20)m+=r[h];else{const y=Math.floor(h/10),C=h%10;m+=u[y]+(C?"-"+r[C]:"")}return m}function gt(i){if(i===0)return"zero";const r=[""," thousand"," million"," billion"," trillion"];let u="",m=0;for(;i>0;){const f=i%1e3;f&&(u=bt(f)+r[m]+(u?" "+u:"")),i=Math.floor(i/1e3),m++}return u}function ye(i){const[r,u]=Number(i||0).toFixed(2).split("."),m=parseInt(r,10)||0,f=parseInt(u,10)||0,h=gt(m).toUpperCase(),y=f===0?" PESOS ONLY":` PESOS AND ${String(f).padStart(2,"0")}/100 ONLY`;return`*** ${h}${y} ***`}const wt=i=>(Number(i)||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2});function Rt(){const i=a.useRef(null),[r,u]=a.useState(null),[m,f]=a.useState(""),[h,y]=a.useState(""),[C,$]=a.useState(""),[B,W]=a.useState(()=>new Date().toISOString().slice(0,10)),[D,H]=a.useState(0),[Se,Ne]=a.useState("*** ZERO PESOS ONLY ***"),[U,z]=a.useState(""),[V,q]=a.useState(""),[te,X]=a.useState(""),[Y,G]=a.useState(""),[yt,_]=a.useState(!1),[E,S]=a.useState(!0),[N,O]=a.useState(!1),g=a.useMemo(()=>r!=null,[r]),[M,se]=a.useState([]),[ve,ae]=a.useState([]),[Ce,ne]=a.useState([]),[K,J]=a.useState([]),je=a.useMemo(()=>K.map(e=>`${e.acct_code};${e.acct_desc}`),[K]),A=e=>K.find(n=>n.acct_code===e)?.acct_desc||"",[ke,Re]=a.useState(""),[De,Ee]=a.useState(""),[Oe,Me]=a.useState(""),[Ae,ce]=a.useState(""),[Z,oe]=a.useState(""),[re,ie]=a.useState([]),Fe=a.useMemo(()=>(re||[]).map(e=>({code:String(e.id),cr_no:e.cr_no,cust_name:e.cust_name||"",receipt_date:(e.receipt_date||"").slice(0,10),receipt_amount:e.receipt_amount,collection_receipt:e.collection_receipt||"",label:e.cr_no,description:e.cust_name||e.cust_id})),[re]),[F,j]=a.useState([{acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}]),T=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),le=a.useRef(null),[de,Te]=a.useState(600);a.useLayoutEffect(()=>{const e=()=>{const s=le.current?.getBoundingClientRect()?.top??0,o=window.innerHeight-s-140;Te(Math.max(320,Math.floor(o)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const Ie=28,Le=32,Pe=240,$e=a.useMemo(()=>{const e=Math.max(F.length,6),n=Le+e*Ie+Pe;return Math.min(n,de)},[F.length,de]),Q=a.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]),b=Q?.company_id;a.useEffect(()=>{Ne(ye(D))},[D]),a.useEffect(()=>{(async()=>{try{const[e,n,s,o]=await Promise.all([p.get("/api/cr/customers",{params:{company_id:b}}),p.get("/api/cr/banks",{params:{company_id:b}}),p.get("/api/cr/payment-methods"),p.get("/api/cr/accounts",{params:{company_id:b}})]);se((e.data||[]).map(c=>({code:String(c.cust_id??c.code),description:c.cust_name??c.description??""}))),ae((n.data||[]).map(c=>({code:String(c.bank_id??c.code),description:c.bank_name??c.description??""}))),ne((s.data||[]).map(c=>({code:String(c.pay_method_id??c.code),description:c.pay_method??c.description??""}))),J(Array.isArray(o.data)?o.data:[])}catch{se([]),ae([]),ne([]),J([])}})()},[b]);const v=a.useCallback(async()=>{try{const{data:e}=await p.get("/api/cash-receipt/list",{params:{company_id:b||"",q:Z||""}});ie(Array.isArray(e)?e:[])}catch{ie([])}},[b,Z]);a.useEffect(()=>{v()},[v]);const ue=a.useCallback((e,n)=>{e&&J(s=>s.some(o=>o.acct_code===e)?s:[...s,{acct_code:e,acct_desc:n||""}])},[]),k=a.useCallback(async e=>{try{const{data:n}=await p.get(`/api/cash-receipt/${e}`,{params:{company_id:b}}),s=n.main??n;u(s.id),f(s.cr_no||""),y(String(s.cust_id||""));const o=M.find(d=>String(d.code)===String(s.cust_id));$(o?.description||""),W((s.receipt_date||"").slice(0,10)),H(Number(s.receipt_amount||0)),z(String(s.bank_id||"")),q(String(s.pay_method||"")),G(s.collection_receipt||""),X(s.details||""),O((s.is_cancel||s.is_cancelled)==="y");const c=(n.details||[]).map(d=>{const w=String(d.acct_code??""),x=A(w)||String(d.acct_desc??"");return ue(w,x),{id:d.id,acct_code:x?`${w};${x}`:`${w};`,acct_desc:x,debit:Number(d.debit??0),credit:Number(d.credit??0),workstation_id:d.workstation_id||"",persisted:!0}});j(c.length?c.concat([T()]):[T()]),_(!0),S((s.is_cancel||s.is_cancelled)==="y"),l.success("Receipt loaded.")}catch{l.error("Unable to load the selected receipt.")}},[b,M,A,ue]),Be=async e=>{e&&(ce(e),await k(e))},We=async()=>{if(!h||!B||!U||!V||!Y)return l.error("Please complete Customer, Date, Bank, Payment Method, and Collection Receipt.");if((await R.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Save"})).isConfirmed)try{const n=await p.post("/api/cash-receipt/save-main",{cr_no:m||void 0,cust_id:h,receipt_date:B,receipt_amount:0,pay_method:V,bank_id:U,collection_receipt:Y,details:te,amount_in_words:ye(D).replace(/^\*\*\*\s|\s\*\*\*$/g,""),company_id:b,user_id:Q?.id}),s=n.data.id;u(s),f(n.data.cr_no||""),_(!0),S(!1),await k(s),l.success("Main saved. You can now input details."),v()}catch(n){l.error(n?.response?.data?.message||"Failed to save.")}},He=()=>{_(!1),S(!1),l.success("Editing enabled.")},Ue=async()=>{if(!(!r||!(await R.fire({title:"Cancel this receipt?",icon:"warning",showCancelButton:!0,confirmButtonText:"Cancel"})).isConfirmed))try{const{data:n}=await p.post("/api/cash-receipt/cancel",{id:r,flag:1});O((n?.is_cancel||n?.is_cancelled)==="y"),_(!0),S(!0),l.success("Receipt marked CANCELLED."),v()}catch{l.error("Failed to cancel receipt.")}},ze=async()=>{if(!(!r||!(await R.fire({title:"Uncancel this receipt?",icon:"question",showCancelButton:!0,confirmButtonText:"Uncancel"})).isConfirmed))try{const{data:n}=await p.post("/api/cash-receipt/cancel",{id:r,flag:0});O((n?.is_cancel||n?.is_cancelled)!=="y"),_(!0),S(!1),l.success("Receipt is now ACTIVE."),v()}catch{l.error("Failed to uncancel receipt.")}},Ve=async()=>{if(!(!r||!(await R.fire({title:"Delete this receipt?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await p.delete(`/api/cash-receipt/${r}`),me(),l.success("Receipt deleted."),v()}catch{l.error("Failed to delete receipt.")}},me=()=>{ce(""),oe(""),u(null),f(""),y(""),$(""),W(new Date().toISOString().slice(0,10)),H(0),z(""),q(""),G(""),X(""),O(!1),_(!1),S(!0),j([T()])},qe=e=>!!P(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,ee=e=>{e&&H(Number(e.sum_credit??e.total_credit??e.credit??0))},Xe=async e=>{const{data:n}=await p.post("/api/cash-receipt/delete-detail",e);ee(n?.totals),await k(e.transaction_id)},pe=async(e,n)=>{if(!r||!qe(e))return;const s=P(e.acct_code);try{if(e.persisted){const{data:o}=await p.post("/api/cash-receipt/update-detail",{id:e.id,transaction_id:r,acct_code:s,debit:e.debit||0,credit:e.credit||0});ee(o?.totals),await k(r)}else{const{data:o}=await p.post("/api/cash-receipt/save-detail",{transaction_id:r,acct_code:s,debit:e.debit||0,credit:e.credit||0,company_id:b,user_id:Q?.id});ee(o?.totals),await k(r)}}catch(o){l.error(o?.response?.data?.message||"Row save failed")}},Ye=0,Ge=(e,n)=>{if(E||n!==Ye)return;const o=i.current?.hotInstance?.getActiveEditor();o?.cellProperties?.type==="autocomplete"&&(o.TEXTAREA.value="",o.query="",o.open(),o.refreshDropdown?.())},[Ke,he]=a.useState(!1),[Je,xe]=a.useState(!1),[Ze,Qe]=a.useState(void 0),[et,fe]=a.useState(!1),tt=()=>{if(!r)return l.info("Save or select a receipt first.");const e=`/api/cash-receipt/form-pdf/${r}?company_id=${encodeURIComponent(b||"")}`;Qe(e),fe(!0)},st=async()=>{if(!r)return l.info("Save or select a receipt first.");const e=await p.get(`/api/cash-receipt/form-excel/${r}`,{responseType:"blob",params:{company_id:b||""}}),n=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`ReceiptVoucher_${m||r}.xlsx`,s=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),o=URL.createObjectURL(s),c=document.createElement("a");c.href=o,c.download=n,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(o)},at=(e,n)=>{const s={};return(i.current?.hotInstance?.getSourceData()??F)?.[e]?.workstation_id==="BANK"&&(s.readOnly=!0,s.className="htDimmed"),s};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(dt,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-blue-50 shadow-md rounded-lg p-6 space-y-4 border border-blue-200",children:[t.jsx("h2",{className:"text-xl font-bold text-blue-800 mb-2",children:"CASH RECEIPTS"}),t.jsxs("div",{className:"grid grid-cols-3 auto-rows-auto gap-4",children:[t.jsx("div",{className:"col-span-3",children:t.jsx(L,{label:"Search Transaction",value:Ae,onChange:Be,items:Fe,search:Z,onSearchChange:oe,headers:["ID","RV #","Customer","Date","Amount","Collection Rcpt"],columnWidths:["60px","90px","250px","110px","110px","110px"],dropdownPositionStyle:{width:"750px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-2 row-span-2",children:t.jsx(L,{label:"Customer",value:h,onChange:e=>{y(e);const n=M.find(s=>String(s.code)===String(e));$(n?.description||"")},items:M,search:ke,onSearchChange:Re,headers:["Code","Description"],columnWidths:["140px","520px"],dropdownPositionStyle:{width:"700px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{className:"col-span-1",children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:B,disabled:g,onChange:e=>W(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsx("div",{className:"col-span-2 row-span-2",children:t.jsx(L,{label:"Bank Name",value:U,onChange:z,items:ve.map(e=>({code:String(e.bank_id??e.code),description:e.bank_name??e.description})),search:De,onSearchChange:Ee,headers:["Code","Bank"],columnWidths:["100px","350px"],dropdownPositionStyle:{width:"500px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-1",children:t.jsx(L,{label:"Payment Method",value:V,onChange:q,items:Ce.map(e=>({code:String(e.pay_method_id??e.code),description:e.pay_method??e.description})),search:Oe,onSearchChange:Me,headers:["Code","Method"],columnWidths:["80px","200px"],dropdownPositionStyle:{width:"280px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{className:"col-span-2  row-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Details"}),t.jsx("input",{value:te,disabled:g&&N,onChange:e=>X(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsxs("div",{className:"col-span-1",children:[t.jsx("label",{className:"block mb-1",children:"Collection Receipt #"}),t.jsx("input",{value:Y,disabled:g&&N,onChange:e=>G(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsxs("div",{className:"col-span-2   row-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Amount in Words"}),t.jsx("div",{className:"w-full border p-2 bg-white text-blue-900 text-sm font-semibold",children:Se})]}),t.jsxs("div",{className:"col-span-1",children:[t.jsx("label",{className:"block mb-1",children:"Amount"}),t.jsx("input",{value:wt(D),readOnly:!0,className:"w-full border p-2 bg-yellow-50 text-right font-bold"})]}),!!C&&t.jsxs("div",{className:"col-span-3 text-sm font-semibold text-gray-700",children:["Customer: ",C]})]}),t.jsx("div",{className:"flex gap-2 mt-3",children:g?t.jsxs(t.Fragment,{children:[!N&&t.jsxs("button",{onClick:He,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700",children:[t.jsx(we,{className:"h-5 w-5"}),"Update"]}),N?t.jsxs("button",{onClick:ze,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-600 text-white hover:bg-amber-700",children:[t.jsx(ft,{className:"h-5 w-5"}),"Uncancel"]}):t.jsxs("button",{onClick:Ue,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:[t.jsx(pt,{className:"h-5 w-5"}),"Cancel"]}),t.jsxs("button",{onClick:Ve,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:[t.jsx(ht,{className:"h-5 w-5"}),"Delete"]})]}):t.jsxs("button",{onClick:We,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[t.jsx(we,{className:"h-5 w-5"}),"Save"]})}),N&&t.jsx("div",{className:"text-red-600 font-bold mt-2",children:"CANCELLED"})]}),t.jsxs("div",{ref:le,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),g&&t.jsx(ct,{className:"hot-enhanced hot-zebra",ref:i,data:F,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,n)=>{const s=je;if(!e)return n(s);const o=String(e).toLowerCase();n(s.filter(c=>c.toLowerCase().includes(o)))},strict:!0,allowInvalid:!1,visibleRows:12,readOnly:E,renderer:(e,n,s,o,c,d,w)=>{const x=P(String(d??""));_e.renderers.TextRenderer(e,n,s,o,c,x,w)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:E},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:E}],cells:at,afterBeginEditing:Ge,afterChange:(e,n)=>{const s=i.current?.hotInstance;!e||!s||N||n==="edit"&&(e.forEach(([o,c,d,w])=>{const x={...s.getSourceDataAtRow(o)};if(c==="acct_code"){const I=String(w||""),be=P(I);s.setDataAtRowProp(o,"acct_desc",A(be));const nt={...x,acct_code:I,acct_desc:A(be),debit:Number(x.debit||0),credit:Number(x.credit||0)};setTimeout(()=>pe(nt),0)}if(c==="debit"||c==="credit"){const I={...x,debit:Number(c==="debit"?w:x.debit||0),credit:Number(c==="credit"?w:x.credit||0)};setTimeout(()=>pe(I),0)}}),requestAnimationFrame(()=>{const o=s.getSourceData();o.find(c=>!c.acct_code)||o.push(T()),j([...o])}))},contextMenu:{items:{remove_row:{name:"ðŸ—‘ï¸ Remove row",callback:async(e,n)=>{const s=i.current?.hotInstance,o=n[0].start.row,c=s?.getSourceData()||[],d=c[o];if(d?.workstation_id==="BANK"){l.info("Bank line cannot be deleted.");return}if(!d?.id){c.splice(o,1),j([...c]);return}(await R.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed&&(await Xe({id:d.id,transaction_id:r}),c.splice(o,1),j([...c]),l.success("Row deleted."))}}}},manualColumnResize:!0,stretchH:"all",height:$e,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>xe(!0),onMouseLeave:()=>xe(!1),children:[t.jsxs("button",{type:"button",disabled:!g,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${g?"bg-white text-blue-700 border-blue-300 hover:bg-blue-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(rt,{className:`h-5 w-5 ${g?"text-blue-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(ge,{className:"h-4 w-4 opacity-70"})]}),Je&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:st,disabled:!g,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${g?"text-gray-800 hover:bg-blue-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx(it,{className:`h-5 w-5 ${g?"text-blue-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Receipt Voucher â€“ Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>he(!0),onMouseLeave:()=>he(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx(ut,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(ge,{className:"h-4 w-4 opacity-70"})]}),Ke&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:tt,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(lt,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Receipt Voucher â€“ PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})})})]}),t.jsxs("button",{type:"button",onClick:me,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-blue-600 text-white hover:bg-blue-700",title:"Start a new transaction",children:[t.jsx(mt,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]})]}),et&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>fe(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"âœ•"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Receipt Voucher PDF",src:Ze,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{Rt as default};
