import{n as u,j as t,F as ge}from"./index-C4qoQ9JB.js";import{r as c,H as rt,a as Ne,N as it}from"./handsontable-7BBM75Z1.js";import{F as lt}from"./handsontable.full-BBVTP-3y.js";import{S as y,F as dt,a as ut,b as mt}from"./sweetalert2.esm.all-B4pNkPRF.js";import{y as d,L as pt,D as $,b as ye,F as ht,a as bt}from"./DropdownWithHeaders-Cpp3IEzZ.js";import{F as ft}from"./XMarkIcon-B-Tbi0qp.js";import{F as xt}from"./TrashIcon-I-_qGSbO.js";import"./react-Csw2ODfV.js";Ne.cellTypes.registerCellType("numeric",it);const P=i=>(i||"").split(";")[0];function wt(i){const r=["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],h=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];let b="";const f=Math.floor(i/100),m=i%100;if(f&&(b+=r[f]+" hundred"+(m?" ":"")),m)if(m<20)b+=r[m];else{const _=Math.floor(m/10),R=m%10;b+=h[_]+(R?"-"+r[R]:"")}return b}function gt(i){if(i===0)return"zero";const r=[""," thousand"," million"," billion"," trillion"];let h="",b=0;for(;i>0;){const f=i%1e3;f&&(h=wt(f)+r[b]+(h?" "+h:"")),i=Math.floor(i/1e3),b++}return h}function _e(i){const[r,h]=Number(i||0).toFixed(2).split("."),b=parseInt(r,10)||0,f=parseInt(h,10)||0,m=gt(b).toUpperCase(),_=f===0?" PESOS ONLY":` PESOS AND ${String(f).padStart(2,"0")}/100 ONLY`;return`*** ${m}${_} ***`}const B=i=>(Number(i)||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2});function Dt(){const i=c.useRef(null),[r,h]=c.useState(null),[b,f]=c.useState(""),[m,_]=c.useState(""),[R,L]=c.useState(""),[H,W]=c.useState(()=>new Date().toISOString().slice(0,10)),[E,U]=c.useState(0),[Se,Ce]=c.useState("*** ZERO PESOS ONLY ***"),[z,q]=c.useState(""),[V,Y]=c.useState(""),[se,X]=c.useState(""),[G,K]=c.useState(""),[yt,N]=c.useState(!1),[S,C]=c.useState(!0),[v,A]=c.useState(!1),w=c.useMemo(()=>r!=null,[r]),[M,ae]=c.useState([]),[ve,ne]=c.useState([]),[je,ce]=c.useState([]),[J,Z]=c.useState([]),ke=c.useMemo(()=>J.map(e=>`${e.acct_code};${e.acct_desc}`),[J]),F=e=>J.find(a=>a.acct_code===e)?.acct_desc||"",[Re,De]=c.useState(""),[Oe,Te]=c.useState(""),[Ee,Ae]=c.useState(""),[Me,oe]=c.useState(""),[Q,re]=c.useState(""),[ie,le]=c.useState([]),Fe=c.useMemo(()=>(ie||[]).map(e=>({code:String(e.id),cr_no:e.cr_no,cust_name:e.cust_name||"",receipt_date:(e.receipt_date||"").slice(0,10),receipt_amount:B(Number(e.receipt_amount||0)),collection_receipt:e.collection_receipt||"",label:e.cr_no,description:e.cust_name||e.cust_id})),[ie]),[j,D]=c.useState([{acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}]),O=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),de=c.useRef(null),[ue,Ie]=c.useState(600);c.useLayoutEffect(()=>{const e=()=>{const s=de.current?.getBoundingClientRect()?.top??0,o=window.innerHeight-s-140;Ie(Math.max(320,Math.floor(o)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const $e=28,Pe=32,Be=240,Le=c.useMemo(()=>{const e=Math.max(j.length,6),a=Pe+e*$e+Be;return Math.min(a,ue)},[j.length,ue]),ee=c.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]),x=ee?.company_id;c.useEffect(()=>{Ce(_e(E))},[E]),c.useEffect(()=>{(async()=>{try{const[e,a,s,o]=await Promise.all([u.get("/api/cr/customers",{params:{company_id:x}}),u.get("/api/cr/banks",{params:{company_id:x}}),u.get("/api/cr/payment-methods"),u.get("/api/cr/accounts",{params:{company_id:x}})]);ae((e.data||[]).map(n=>({code:String(n.cust_id??n.code),description:n.cust_name??n.description??""}))),ne((a.data||[]).map(n=>({code:String(n.bank_id??n.code),description:n.bank_name??n.description??""}))),ce((s.data||[]).map(n=>({code:String(n.pay_method_id??n.code),description:n.pay_method??n.description??""}))),Z(Array.isArray(o.data)?o.data:[])}catch{ae([]),ne([]),ce([]),Z([])}})()},[x]);const k=c.useCallback(async()=>{try{const{data:e}=await u.get("/api/cash-receipt/list",{params:{company_id:x||"",q:Q||""}});le(Array.isArray(e)?e:[])}catch{le([])}},[x,Q]);c.useEffect(()=>{k()},[k]);const me=c.useCallback((e,a)=>{e&&Z(s=>s.some(o=>o.acct_code===e)?s:[...s,{acct_code:e,acct_desc:a||""}])},[]),T=c.useCallback(async e=>{try{const{data:a}=await u.get(`/api/cash-receipt/${e}`,{params:{company_id:x}}),s=a.main??a;h(s.id),f(s.cr_no||""),_(String(s.cust_id||""));const o=M.find(l=>String(l.code)===String(s.cust_id));L(o?.description||""),W((s.receipt_date||"").slice(0,10)),U(Number(s.receipt_amount||0)),q(String(s.bank_id||"")),Y(String(s.pay_method||"")),K(s.collection_receipt||""),X(s.details||""),A((s.is_cancel||s.is_cancelled)==="y");const n=(a.details||[]).map(l=>{const g=String(l.acct_code??""),p=F(g)||String(l.acct_desc??"");return me(g,p),{id:l.id,acct_code:p?`${g};${p}`:`${g};`,acct_desc:p,debit:Number(l.debit??0),credit:Number(l.credit??0),workstation_id:l.workstation_id||"",persisted:!0}});D(n.length?n.concat([O()]):[O()]),N(!0),d.success("Receipt loaded.")}catch{d.error("Unable to load the selected receipt.")}},[x,M,F,me]),He=async e=>{e&&(oe(e),await T(e),C(!0),i.current?.hotInstance?.updateSettings?.({readOnly:!0}))},We=async()=>{if(!m||!H||!z||!V||!G)return d.error("Please complete Customer, Date, Bank, Payment Method, and Collection Receipt.");if((await y.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Save"})).isConfirmed)try{const a=await u.post("/api/cash-receipt/save-main",{cr_no:b||void 0,cust_id:m,receipt_date:H,receipt_amount:0,pay_method:V,bank_id:z,collection_receipt:G,details:se,amount_in_words:_e(E).replace(/^\*\*\*\s|\s\*\*\*$/g,""),company_id:x,user_id:ee?.id}),s=a.data.id;h(s),f(a.data.cr_no||""),N(!0),C(!1),await T(s),d.success("Main saved. You can now input details."),k()}catch(a){d.error(a?.response?.data?.message||"Failed to save.")}},Ue=()=>{N(!1),C(!1),d.success("Editing enabled.")},ze=async()=>{if(!(!r||!(await y.fire({title:"Cancel this receipt?",icon:"warning",showCancelButton:!0,confirmButtonText:"Cancel"})).isConfirmed))try{const{data:a}=await u.post("/api/cash-receipt/cancel",{id:r,flag:1});A((a?.is_cancel||a?.is_cancelled)==="y"),N(!0),C(!0),d.success("Receipt marked CANCELLED."),k()}catch{d.error("Failed to cancel receipt.")}},qe=async()=>{if(!(!r||!(await y.fire({title:"Uncancel this receipt?",icon:"question",showCancelButton:!0,confirmButtonText:"Uncancel"})).isConfirmed))try{const{data:a}=await u.post("/api/cash-receipt/cancel",{id:r,flag:0});A((a?.is_cancel||a?.is_cancelled)!=="y"),N(!0),C(!1),d.success("Receipt is now ACTIVE."),k()}catch{d.error("Failed to uncancel receipt.")}},Ve=async()=>{if(!(!r||!(await y.fire({title:"Delete this receipt?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await u.delete(`/api/cash-receipt/${r}`),pe(),d.success("Receipt deleted."),k()}catch{d.error("Failed to delete receipt.")}},Ye=e=>{const a=e.reduce((n,l)=>n+Number(l.debit||0),0),s=e.reduce((n,l)=>n+Number(l.credit||0),0),o=Math.abs(a-s)<.005;return{sumD:a,sumC:s,balanced:o}},pe=async()=>{if(j.some(a=>a.acct_code&&a.acct_code.trim()!==""||(Number(a.debit)||0)>0||(Number(a.credit)||0)>0)){const{sumD:a,sumC:s,balanced:o}=Ye(j);if(!o){await y.fire({title:"Transaction not balanced",html:`Debit <b>${B(a)}</b> must equal Credit <b>${B(s)}</b> before starting a new one.`,icon:"error"});return}if(!(await y.fire({title:"Start a new transaction?",text:"This will clear the current form.",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, New"})).isConfirmed)return}else if(!(await y.fire({title:"Start a new transaction?",text:"This will clear the current form.",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, New"})).isConfirmed)return;oe(""),re(""),h(null),f(""),_(""),L(""),W(new Date().toISOString().slice(0,10)),U(0),X(""),K(""),q(""),Y(""),A(!1),N(!1),C(!0),D([O()]),i.current?.hotInstance?.loadData?.([O()]),d.success("Ready for a new transaction.")},Xe=e=>!!P(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,te=e=>{e&&U(Number(e.sum_credit??e.total_credit??e.credit??0))},Ge=async e=>{const{data:a}=await u.post("/api/cash-receipt/delete-detail",e);te(a?.totals),await T(e.transaction_id)},he=async(e,a)=>{if(!r||!Xe(e))return;const s=P(e.acct_code);try{if(e.persisted){const{data:o}=await u.post("/api/cash-receipt/update-detail",{id:e.id,transaction_id:r,acct_code:s,debit:e.debit||0,credit:e.credit||0});te(o?.totals),await T(r)}else{const{data:o}=await u.post("/api/cash-receipt/save-detail",{transaction_id:r,acct_code:s,debit:e.debit||0,credit:e.credit||0,company_id:x,user_id:ee?.id});te(o?.totals),await T(r)}}catch(o){d.error(o?.response?.data?.message||"Row save failed")}},Ke=0,Je=(e,a)=>{if(S||a!==Ke)return;const o=i.current?.hotInstance?.getActiveEditor();o?.cellProperties?.type==="autocomplete"&&(o.TEXTAREA.value="",o.query="",o.open(),o.refreshDropdown?.())},[Ze,be]=c.useState(!1),[Qe,fe]=c.useState(!1),[et,tt]=c.useState(void 0),[st,xe]=c.useState(!1),at=()=>{if(!r)return d.info("Save or select a receipt first.");const e=`/api/cash-receipt/form-pdf/${r}?company_id=${encodeURIComponent(x||"")}`;tt(e),xe(!0)},nt=async()=>{if(!r)return d.info("Save or select a receipt first.");const e=await u.get(`/api/cash-receipt/form-excel/${r}`,{responseType:"blob",params:{company_id:x||""}}),a=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`ReceiptVoucher_${b||r}.xlsx`,s=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),o=URL.createObjectURL(s),n=document.createElement("a");n.href=o,n.download=a,document.body.appendChild(n),n.click(),n.remove(),URL.revokeObjectURL(o)},ct=(e,a)=>{const s={};return S?(s.readOnly=!0,s):((i.current?.hotInstance?.getSourceData()??j)?.[e]?.workstation_id==="BANK"&&(s.readOnly=!0,s.className="htDimmed"),s)};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(pt,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-blue-50 shadow-md rounded-lg p-6 space-y-4 border border-blue-200",children:[t.jsx("h2",{className:"text-xl font-bold text-blue-800 mb-2",children:"CASH RECEIPTS"}),t.jsxs("div",{className:"grid grid-cols-3 auto-rows-auto gap-4",children:[t.jsx("div",{className:"col-span-3",children:t.jsx($,{label:"Search Transaction",value:Me,onChange:He,items:Fe,search:Q,onSearchChange:re,headers:["ID","RV #","Customer","Date","Amount","Collection Rcpt"],columnWidths:["60px","90px","250px","110px","110px","110px"],dropdownPositionStyle:{width:"750px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-2 row-span-2",children:t.jsx($,{label:"Customer",value:m,onChange:e=>{_(e);const a=M.find(s=>String(s.code)===String(e));L(a?.description||"")},items:M,search:Re,onSearchChange:De,headers:["Code","Description"],columnWidths:["140px","520px"],dropdownPositionStyle:{width:"700px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{className:"col-span-1",children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:H,disabled:w,onChange:e=>W(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsx("div",{className:"col-span-2 row-span-2",children:t.jsx($,{label:"Bank Name",value:z,onChange:q,items:ve.map(e=>({code:String(e.bank_id??e.code),description:e.bank_name??e.description})),search:Oe,onSearchChange:Te,headers:["Code","Bank"],columnWidths:["100px","350px"],dropdownPositionStyle:{width:"500px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-1",children:t.jsx($,{label:"Payment Method",value:V,onChange:Y,items:je.map(e=>({code:String(e.pay_method_id??e.code),description:e.pay_method??e.description})),search:Ee,onSearchChange:Ae,headers:["Code","Method"],columnWidths:["80px","200px"],dropdownPositionStyle:{width:"280px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{className:"col-span-2  row-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Details"}),t.jsx("input",{value:se,disabled:w&&v,onChange:e=>X(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsxs("div",{className:"col-span-1",children:[t.jsx("label",{className:"block mb-1",children:"Collection Receipt #"}),t.jsx("input",{value:G,disabled:w&&v,onChange:e=>K(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsxs("div",{className:"col-span-2   row-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Amount in Words"}),t.jsx("div",{className:"w-full border p-2 bg-white text-blue-900 text-sm font-semibold",children:Se})]}),t.jsxs("div",{className:"col-span-1",children:[t.jsx("label",{className:"block mb-1",children:"Amount"}),t.jsx("input",{value:B(E),readOnly:!0,className:"w-full border p-2 bg-yellow-50 text-right font-bold"})]}),!!R&&t.jsxs("div",{className:"col-span-3 text-sm font-semibold text-gray-700",children:["Customer: ",R]})]}),t.jsx("div",{className:"flex gap-2 mt-3",children:w?t.jsxs(t.Fragment,{children:[!v&&t.jsxs("button",{onClick:Ue,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700",children:[t.jsx(ye,{className:"h-5 w-5"}),"Update"]}),v?t.jsxs("button",{onClick:qe,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-600 text-white hover:bg-amber-700",children:[t.jsx(lt,{className:"h-5 w-5"}),"Uncancel"]}):t.jsxs("button",{onClick:ze,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:[t.jsx(ft,{className:"h-5 w-5"}),"Cancel"]}),t.jsxs("button",{onClick:Ve,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:[t.jsx(xt,{className:"h-5 w-5"}),"Delete"]})]}):t.jsxs("button",{onClick:We,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[t.jsx(ye,{className:"h-5 w-5"}),"Save"]})}),v&&t.jsx("div",{className:"text-red-600 font-bold mt-2",children:"CANCELLED"})]}),t.jsxs("div",{ref:de,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),w&&t.jsx(rt,{className:"hot-enhanced hot-zebra",ref:i,data:j,readOnly:S,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,a)=>{const s=ke;if(!e)return a(s);const o=String(e).toLowerCase();a(s.filter(n=>n.toLowerCase().includes(o)))},strict:!0,allowInvalid:!1,visibleRows:12,readOnly:S,renderer:(e,a,s,o,n,l,g)=>{const p=P(String(l??""));Ne.renderers.TextRenderer(e,a,s,o,n,p,g)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:S},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:S}],cells:ct,afterBeginEditing:Je,afterChange:(e,a)=>{const s=i.current?.hotInstance;!e||!s||v||a==="edit"&&(e.forEach(([o,n,l,g])=>{const p={...s.getSourceDataAtRow(o)};if(n==="acct_code"){const I=String(g||""),we=P(I);s.setDataAtRowProp(o,"acct_desc",F(we));const ot={...p,acct_code:I,acct_desc:F(we),debit:Number(p.debit||0),credit:Number(p.credit||0)};setTimeout(()=>he(ot),0)}if(n==="debit"||n==="credit"){const I={...p,debit:Number(n==="debit"?g:p.debit||0),credit:Number(n==="credit"?g:p.credit||0)};setTimeout(()=>he(I),0)}}),requestAnimationFrame(()=>{const o=s.getSourceData();o.find(n=>!n.acct_code)||o.push(O()),D([...o])}))},contextMenu:{items:{remove_row:{name:"🗑️ Remove row",callback:async(e,a)=>{const s=i.current?.hotInstance,o=a[0].start.row,n=s?.getSourceData()||[],l=n[o];if(l?.workstation_id==="BANK"){d.info("Bank line cannot be deleted.");return}if(!l?.id){n.splice(o,1),D([...n]);return}(await y.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed&&(await Ge({id:l.id,transaction_id:r}),n.splice(o,1),D([...n]),d.success("Row deleted."))}}}},manualColumnResize:!0,stretchH:"all",height:Le,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>fe(!0),onMouseLeave:()=>fe(!1),children:[t.jsxs("button",{type:"button",disabled:!w,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${w?"bg-white text-blue-700 border-blue-300 hover:bg-blue-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(dt,{className:`h-5 w-5 ${w?"text-blue-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(ge,{className:"h-4 w-4 opacity-70"})]}),Qe&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:nt,disabled:!w,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${w?"text-gray-800 hover:bg-blue-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx(ut,{className:`h-5 w-5 ${w?"text-blue-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Receipt Voucher – Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>be(!0),onMouseLeave:()=>be(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx(ht,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(ge,{className:"h-4 w-4 opacity-70"})]}),Ze&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:at,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(mt,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Receipt Voucher – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})})})]}),t.jsxs("button",{type:"button",onClick:pe,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-blue-600 text-white hover:bg-blue-700",title:"Start a new transaction",children:[t.jsx(bt,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]})]}),st&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>xe(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"✕"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Receipt Voucher PDF",src:et,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{Dt as default};
