import{n as l,j as a,F as xe}from"./index-v6kpnWgp.js";import{r as s,H as ct,a as ye,N as ot}from"./handsontable-7BBM75Z1.js";/* empty css                              */import{S as b,F as it,a as rt,b as ge}from"./sweetalert2.esm.all-B4pNkPRF.js";import{L as dt,D as _,b as be,y as p,F as lt,a as pt}from"./DropdownWithHeaders-Dci3zufc.js";import"./react-Csw2ODfV.js";ye.cellTypes.registerCellType("numeric",ot);const k=u=>(u||"").split(";")[0],fe=u=>u?new Date(u).toString()==="Invalid Date"?(u||"").split("T")[0]:new Date(u).toISOString().slice(0,10):"";function ft(){const u=s.useRef(null),[we,T]=s.useState(""),[Y,E]=s.useState(""),[z,A]=s.useState(""),[S,P]=s.useState(""),[W,$]=s.useState(""),[q,F]=s.useState(""),[X,L]=s.useState(""),[G,M]=s.useState(""),[J,O]=s.useState(""),[_e,K]=s.useState(""),[i,B]=s.useState(null),[v,f]=s.useState(!1),[y,w]=s.useState(!0),[H,Q]=s.useState([]),[N,Z]=s.useState([]),[Se,ee]=s.useState([]),[ve,te]=s.useState([]),[Ne,ae]=s.useState([]),[je,Ce]=s.useState(""),[De,Re]=s.useState(""),[ke,Te]=s.useState(""),[Ee,Ae]=s.useState(""),[Pe,se]=s.useState(""),[I,ne]=s.useState(""),[ce,oe]=s.useState([]),[j,x]=s.useState([{acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}]),[ie,U]=s.useState(!1),[$e,re]=s.useState(!1),[Fe,de]=s.useState(!1),[Le,Me]=s.useState(void 0),[Oe,le]=s.useState(!1),pe=s.useRef(null),[ue,Be]=s.useState(600);s.useLayoutEffect(()=>{const e=()=>{const t=pe.current?.getBoundingClientRect()?.top??0,o=window.innerHeight-t-140;Be(Math.max(320,Math.floor(o)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const He=28,Ie=32,Ue=240,Ve=s.useMemo(()=>{const e=Math.max(j.length,6),n=Ie+e*He+Ue;return Math.min(n,ue)},[j.length,ue]),d=s.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);s.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/pj/vendors",{params:{company_id:d?.company_id}}),n=(e||[]).map(t=>({code:String(t.code??t.vend_code??t.vendor_id??""),description:t.description??t.vend_name??t.vendor_name??"",label:t.label??t.code??""}));Q(n)}catch{Q([])}})()},[d?.company_id]),s.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/pj/accounts",{params:{company_id:d?.company_id}});Z(Array.isArray(e)?e:[])}catch{Z([])}})()},[d?.company_id]),s.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/sugar-types"),n=(Array.isArray(e)?e:[]).map(t=>({code:String(t.code??t.sugar_code??t.sugar_type??t.type??""),description:String(t.description??t.sugar_desc??t.name??t.code??""),label:String(t.code??t.sugar_code??t.sugar_type??"")}));ee(n)}catch{ee([])}})()},[]),s.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/crop-years"),n=(Array.isArray(e)?e:[]).map(t=>({code:String(t.code??t.crop_year??t.year??""),description:String(t.description??t.crop_year??t.year??""),label:String(t.code??t.crop_year??t.year??"")}));te(n)}catch{te([])}})()},[]);const Ye=async e=>{try{const n=e?"/api/mills/effective":"/api/mills",{data:t}=await l.get(n,{params:e?{as_of:e}:{}}),o=(Array.isArray(t)?t:[]).map(c=>({code:String(c.code??c.mill_code??c.code_id??""),description:String(c.description??c.mill_name??c.name??""),label:String(c.code??c.mill_code??"")}));ae(o)}catch{ae([])}};s.useEffect(()=>{Ye(S||void 0)},[S]);const C=async()=>{try{const{data:e}=await l.get("/api/purchase/list",{params:{company_id:d?.company_id||"",q:I||""}});oe(Array.isArray(e)?e:[])}catch{oe([])}};s.useEffect(()=>{C()},[I]);const ze=s.useMemo(()=>(ce||[]).map(e=>({code:String(e.id),cp_no:e.cp_no,vendor_id:e.vendor_id,purchase_date:fe(e.purchase_date),purchase_amount:e.purchase_amount,invoice_no:e.invoice_no,label:e.cp_no,description:e.vendor_id})),[ce]),We=s.useMemo(()=>N.map(e=>`${e.acct_code};${e.acct_desc}`),[N]),V=e=>N.find(n=>n.acct_code===e)?.acct_desc||"",g=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),me=()=>{se(""),ne(""),T(""),E(""),A(""),P(""),$(""),F(""),L(""),M(""),O(""),K(""),B(null),f(!1),w(!1),U(!1),x([g()])},qe=async()=>{if((await b.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed){try{if((await l.get("/api/purchase/unbalanced-exists",{params:{company_id:d?.company_id||""}})).data?.exists){const t=await l.get("/api/purchase/unbalanced",{params:{company_id:d?.company_id||"",limit:20}}),r=`
          <div style="text-align:left">
            <div style="margin-bottom:8px">There are unbalanced purchase transactions. Please balance them first.</div>
            <table style="width:100%;border-collapse:collapse;font-size:12px">
              <thead>
                <tr>
                  <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 8px">CP #</th>
                  <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 8px">Vendor</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Debit</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Credit</th>
                </tr>
              </thead>
              <tbody>${(Array.isArray(t.data?.items)?t.data.items:[]).map(m=>`
          <tr>
            <td style="padding:6px 8px">${m.cp_no}</td>
            <td style="padding:6px 8px">${m.vendor_id}</td>
            <td style="padding:6px 8px;text-align:right">${Number(m.sum_debit||0).toLocaleString()}</td>
            <td style="padding:6px 8px;text-align:right">${Number(m.sum_credit||0).toLocaleString()}</td>
          </tr>`).join("")||'<tr><td colspan="4" style="padding:6px 8px;color:#6b7280">No detail</td></tr>'}</tbody>
            </table>
          </div>`;await b.fire({icon:"warning",title:"Unbalanced transactions found",html:r,confirmButtonText:"OK"});return}}catch{}try{const n=await l.get("/api/purchase/generate-cp-number",{params:{company_id:d?.company_id}}),t=n.data?.cp_no??n.data;T(t);const o=await l.post("/api/purchase/save-main",{cp_no:t,vendor_id:Y,purchase_date:S,explanation:G,invoice_no:_e,company_id:d?.company_id,user_id:d?.id,crop_year:W,sugar_type:q,mill_code:X,booking_no:J});B(o.data.id),U(!0),x([g(),g()]),p.success("Main saved. You can now input details."),C(),f(!0),w(!1)}catch(n){p.error(n?.response?.data?.message||"Failed to save.")}}},Xe=()=>{f(!1),w(!1),p.success("Editing enabled.")},Ge=async()=>{if(!(!i||!(await b.fire({title:"Cancel this transaction?",text:"This will mark the transaction as CANCELLED.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, cancel it"})).isConfirmed))try{await l.post("/api/purchase/cancel",{id:i,flag:"1",company_id:d?.company_id||""}),f(!0),w(!0),p.success("Transaction has been cancelled."),C()}catch{p.error("Failed to cancel transaction.")}},Je=async()=>{if(!(!i||!(await b.fire({title:"Delete this transaction?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await l.delete(`/api/purchase/${i}`),me(),p.success("Transaction deleted."),C()}catch{p.error("Failed to delete transaction.")}},Ke=e=>!!k(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,he=async(e,n)=>{if(!i||!Ke(e))return;const t=k(e.acct_code);try{if(e.persisted)await l.post("/api/purchase/update-detail",{id:e.id,transaction_id:i,acct_code:t,debit:e.debit||0,credit:e.credit||0});else{const o=await l.post("/api/purchase/save-detail",{transaction_id:i,acct_code:t,debit:e.debit||0,credit:e.credit||0,company_id:d?.company_id,user_id:d?.id}),c=u.current?.hotInstance?.getSourceData()||[];c[n]&&(c[n].persisted=!0,c[n].id=o.data.detail_id),x([...c,...c.find(r=>!r.acct_code)?[]:[g()]])}}catch(o){p.error(o?.response?.data?.message||"Row save failed")}},Qe=async e=>{if(e)try{se(e);const{data:n}=await l.get(`/api/purchase/${e}`,{params:{company_id:d?.company_id}}),t=n.main??n;B(t.id),T(t.cp_no),E(String(t.vendor_id||""));const o=H.find(r=>String(r.code)===String(t.vendor_id));A(o?.description||o?.label||""),P(fe(t.purchase_date)),M(t.explanation??""),K(t.invoice_no??""),$(String(t.crop_year??"")),F(String(t.sugar_type??"")),L(String(t.mill_code??"")),O(String(t.booking_no??""));const c=(n.details||[]).map(r=>({id:r.id,acct_code:`${r.acct_code};${r.acct_desc||V(r.acct_code)}`,acct_desc:r.acct_desc,debit:Number(r.debit??0),credit:Number(r.credit??0),persisted:!0}));x(c.length?c.concat([g()]):[g()]),U(!0),f(!0),w(!0),p.success("Transaction loaded.")}catch{p.error("Unable to load the selected transaction.")}},Ze=()=>{if(!i)return p.info("Select or save a transaction first.");const e=`/api/purchase/form-pdf/${i}?company_id=${encodeURIComponent(d?.company_id||"")}`;Me(e),le(!0)},et=async()=>{if(!i)return p.info("Select or save a transaction first.");const e=await l.get(`/api/purchase/form-excel/${i}`,{responseType:"blob",params:{company_id:d?.company_id||""}}),n=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`PurchaseVoucher_${we||i}.xlsx`,t=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),o=URL.createObjectURL(t),c=document.createElement("a");c.href=o,c.download=n,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(o)},tt=0,at=(e,n)=>{if(y||n!==tt)return;const o=u.current?.hotInstance?.getActiveEditor();o?.cellProperties?.type==="autocomplete"&&(o.TEXTAREA.value="",o.query="",o.open(),o.refreshDropdown?.())},st=async()=>{const e=j.some(t=>t.acct_code&&t.acct_code.trim()!==""||(Number(t.debit)||0)>0||(Number(t.credit)||0)>0);(await b.fire({title:"Start a new transaction?",text:e?"This will clear the current form.":"",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, New"})).isConfirmed&&(me(),p.success("Form is ready for a new entry."))};return a.jsxs("div",{className:"space-y-4 p-6",children:[a.jsx(dt,{position:"top-right",autoClose:3e3}),a.jsxs("div",{className:"bg-blue-50 shadow-md rounded-lg p-6 space-y-4 border border-blue-300",children:[a.jsx("h2",{className:"text-xl font-bold text-blue-800 mb-2",children:"PURCHASE JOURNAL"}),a.jsxs("div",{className:"text-xs text-gray-500",children:["accounts: ",N.length," | hotEnabled: ",String(ie)," | locked: ",String(v)," | gridLocked: ",String(y)]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsx("div",{className:"col-span-2",children:a.jsx(_,{label:"Search Transaction",value:Pe,onChange:e=>Qe(e),items:ze,search:I,onSearchChange:ne,headers:["Id","Purchase No","Vendor","Date","Amount","Vendor Inv #"],columnWidths:["60px","120px","160px","110px","120px","120px"],dropdownPositionStyle:{width:"820px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsxs("div",{children:[a.jsx(_,{label:"Vendor",value:Y,onChange:e=>{E(e);const n=H.find(t=>String(t.code)===String(e));A(n?.description||"")},items:H,search:je,onSearchChange:Ce,headers:["Code","Description"],columnWidths:["140px","520px"],dropdownPositionStyle:{width:"700px"},inputClassName:"p-2 text-sm bg-white"}),z&&a.jsxs("div",{className:"mt-1 text-xs font-semibold text-gray-700",children:["Vendor: ",z]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1",children:"Date"}),a.jsx("input",{type:"date",value:S,disabled:v,onChange:e=>P(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),a.jsx("div",{children:a.jsx(_,{label:"Crop Year",value:W,onChange:$,items:ve,search:ke,onSearchChange:Te,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsx("div",{children:a.jsx(_,{label:"Sugar Type",value:q,onChange:F,items:Se,search:De,onSearchChange:Re,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsx("div",{children:a.jsx(_,{label:"Mill Code",value:X,onChange:L,items:Ne,search:Ee,onSearchChange:Ae,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1",children:"Explanation"}),a.jsx("input",{value:G,disabled:v,onChange:e=>M(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1",children:"Booking #"}),a.jsx("input",{value:J,disabled:v,onChange:e=>O(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),a.jsx("div",{})]}),a.jsx("div",{className:"flex gap-2 mt-3",children:i?a.jsxs(a.Fragment,{children:[a.jsxs("button",{onClick:Xe,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700",children:[a.jsx(be,{className:"h-5 w-5"}),"Update"]}),a.jsx("button",{onClick:Ge,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:"Cancel"}),a.jsx("button",{onClick:Je,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:"Delete"})]}):a.jsxs("button",{onClick:qe,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[a.jsx(be,{className:"h-5 w-5"}),"Save"]})})]}),a.jsxs("div",{ref:pe,className:"relative z-0",children:[a.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),ie&&a.jsx(ct,{className:"hot-enhanced",ref:u,data:j,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,n)=>{const t=We;if(!e)return n(t);const o=String(e).toLowerCase();n(t.filter(c=>c.toLowerCase().includes(o)))},filter:!0,strict:!0,allowInvalid:!1,visibleRows:12,readOnly:y,renderer:(e,n,t,o,c,r,m)=>{const h=k(String(r??""));ye.renderers.TextRenderer(e,n,t,o,c,h,m)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:y},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:y}],afterBeginEditing:at,afterChange:(e,n)=>{const t=u.current?.hotInstance;!e||!t||n==="edit"&&(e.forEach(([o,c,r,m])=>{if(c==="acct_code"){const h=String(m||""),D=k(h);t.setDataAtRowProp(o,"acct_desc",V(D));const R={...t.getSourceDataAtRow(o)},nt={id:R.id,acct_code:h,acct_desc:V(D),debit:Number(R.debit||0),credit:Number(R.credit||0),persisted:!!R.persisted};setTimeout(()=>he(nt,o),0)}if(c==="debit"||c==="credit"){const h={...t.getSourceDataAtRow(o)},D={...h,acct_code:h.acct_code,debit:Number(c==="debit"?m:h.debit||0),credit:Number(c==="credit"?m:h.credit||0)};setTimeout(()=>he(D,o),0)}}),requestAnimationFrame(()=>{const o=t.getSourceData();o.find(c=>!c.acct_code)||o.push(g()),x([...o])}))},contextMenu:{items:{remove_row:{name:"ðŸ—‘ï¸ Remove row",callback:async(e,n)=>{const t=u.current?.hotInstance,o=n[0].start.row,c=t?.getSourceData()||[],r=c[o];if(!r?.id){c.splice(o,1),x([...c]);return}(await b.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed&&(await l.post("/api/purchase/delete-detail",{id:r.id,transaction_id:i}),c.splice(o,1),x([...c]),p.success("Row deleted"))}}}},manualColumnResize:!0,stretchH:"all",height:Ve,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),a.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[a.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>de(!0),onMouseLeave:()=>de(!1),children:[a.jsxs("button",{type:"button",disabled:!i,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${i?"bg-white text-blue-700 border-blue-300 hover:bg-blue-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[a.jsx(it,{className:`h-5 w-5 ${i?"text-blue-600":"text-gray-400"}`}),a.jsx("span",{children:"Download"}),a.jsx(xe,{className:"h-4 w-4 opacity-70"})]}),Fe&&a.jsx("div",{className:"absolute left-0 top-full z-50",children:a.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:a.jsxs("button",{type:"button",onClick:et,disabled:!i,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${i?"text-gray-800 hover:bg-blue-50":"text-gray-400 cursor-not-allowed"}`,children:[a.jsx(rt,{className:`h-5 w-5 ${i?"text-blue-600":"text-gray-400"}`}),a.jsx("span",{className:"truncate",children:"Purchase Voucher â€“ Excel"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),a.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>re(!0),onMouseLeave:()=>re(!1),children:[a.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[a.jsx(lt,{className:"h-5 w-5"}),a.jsx("span",{children:"Print"}),a.jsx(xe,{className:"h-4 w-4 opacity-70"})]}),$e&&a.jsx("div",{className:"absolute left-0 top-full z-50",children:a.jsxs("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:[a.jsxs("button",{type:"button",onClick:Ze,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[a.jsx(ge,{className:"h-5 w-5 text-red-600"}),a.jsx("span",{className:"truncate",children:"Purchase Voucher â€“ PDF"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]}),a.jsxs("button",{type:"button",onClick:()=>{if(!i)return p.info("Select or save a transaction.");window.open(`/api/purchase/check-pdf/${i}?company_id=${encodeURIComponent(d?.company_id||"")}`,"_blank")},className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[a.jsx(ge,{className:"h-5 w-5 text-red-600"}),a.jsx("span",{className:"truncate",children:"Print Check â€“ PDF"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})]})})]}),a.jsxs("button",{type:"button",onClick:st,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700",title:"Start a new transaction",children:[a.jsx(pt,{className:"h-5 w-5"}),a.jsx("span",{children:"New"})]})]}),Oe&&a.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:a.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[a.jsx("button",{onClick:()=>le(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"âœ•"}),a.jsx("div",{className:"h-full w-full pt-8",children:a.jsx("iframe",{title:"Purchase Voucher PDF",src:Le,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{ft as default};
