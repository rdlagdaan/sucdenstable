import{n as h,j as t,F as xe}from"./index-EF5A4XVb.js";import{r as s,H as ct,a as ye,N as nt}from"./handsontable-7BBM75Z1.js";import{S as R,F as it,a as ot,b as rt}from"./sweetalert2.esm.all-B4pNkPRF.js";import{y as d,L as lt,D as L,b as ge,F as dt,a as ut}from"./DropdownWithHeaders-DRZ0nhu7.js";import{F as pt}from"./XMarkIcon-B-Tbi0qp.js";import{F as mt}from"./TrashIcon-I-_qGSbO.js";import"./react-Csw2ODfV.js";function ht({title:r,titleId:o,...u},p){return s.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:p,"aria-labelledby":o},u),r?s.createElement("title",{id:o},r):null,s.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3"}))}const ft=s.forwardRef(ht);ye.cellTypes.registerCellType("numeric",nt);const P=r=>(r||"").split(";")[0];function bt(r){const o=["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],u=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];let p="";const b=Math.floor(r/100),f=r%100;if(b&&(p+=o[b]+" hundred"+(f?" ":"")),f)if(f<20)p+=o[f];else{const y=Math.floor(f/10),j=f%10;p+=u[y]+(j?"-"+o[j]:"")}return p}function xt(r){if(r===0)return"zero";const o=[""," thousand"," million"," billion"," trillion"];let u="",p=0;for(;r>0;){const b=r%1e3;b&&(u=bt(b)+o[p]+(u?" "+u:"")),r=Math.floor(r/1e3),p++}return u}function we(r){const[o,u]=Number(r||0).toFixed(2).split("."),p=parseInt(o,10)||0,b=parseInt(u,10)||0,f=xt(p).toUpperCase(),y=b===0?" PESOS ONLY":` PESOS AND ${String(b).padStart(2,"0")}/100 ONLY`;return`*** ${f}${y} ***`}const gt=r=>(Number(r)||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2});function kt(){const r=s.useRef(null),[o,u]=s.useState(null),[p,b]=s.useState(""),[f,y]=s.useState(""),[j,$]=s.useState(""),[I,B]=s.useState(()=>new Date().toISOString().slice(0,10)),[D,W]=s.useState(0),[_e,Se]=s.useState("*** ZERO PESOS ONLY ***"),[H,U]=s.useState(""),[z,V]=s.useState(""),[ee,q]=s.useState(""),[X,Y]=s.useState(""),[wt,_]=s.useState(!1),[E,S]=s.useState(!0),[N,M]=s.useState(!1),g=s.useMemo(()=>o!=null,[o]),[O,te]=s.useState([]),[Ne,se]=s.useState([]),[ve,ae]=s.useState([]),[G,K]=s.useState([]),Ce=s.useMemo(()=>G.map(e=>`${e.acct_code};${e.acct_desc}`),[G]),A=e=>G.find(n=>n.acct_code===e)?.acct_desc||"",[je,ke]=s.useState(""),[Re,De]=s.useState(""),[Ee,Me]=s.useState(""),[Oe,ce]=s.useState(""),[J,ne]=s.useState(""),[ie,oe]=s.useState([]),Ae=s.useMemo(()=>(ie||[]).map(e=>({code:String(e.id),cr_no:e.cr_no,cust_id:e.cust_id,cust_name:e.cust_name||"",receipt_date:(e.receipt_date||"").slice(0,10),receipt_amount:e.receipt_amount,collection_receipt:e.collection_receipt||"",label:e.cr_no,description:e.cust_name||e.cust_id})),[ie]),[Z,v]=s.useState([{acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}]),k=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),re=s.useRef(null),[le,Fe]=s.useState(600);s.useLayoutEffect(()=>{const e=()=>{const c=re.current?.getBoundingClientRect()?.top??0,i=window.innerHeight-c-140;Fe(Math.max(320,Math.floor(i)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const Te=28,Le=32,Pe=240,$e=s.useMemo(()=>{const e=Math.max(Z.length,6),n=Le+e*Te+Pe;return Math.min(n,le)},[Z.length,le]),Q=s.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]),x=Q?.company_id;s.useEffect(()=>{Se(we(D))},[D]),s.useEffect(()=>{(async()=>{try{const[e,n,c,i]=await Promise.all([h.get("/api/cr/customers",{params:{company_id:x}}),h.get("/api/cr/banks",{params:{company_id:x}}),h.get("/api/cr/payment-methods"),h.get("/api/cr/accounts",{params:{company_id:x}})]);te((e.data||[]).map(a=>({code:String(a.cust_id??a.code),description:a.cust_name??a.description??""}))),se((n.data||[]).map(a=>({code:String(a.bank_id??a.code),description:a.bank_name??a.description??""}))),ae((c.data||[]).map(a=>({code:String(a.pay_method_id??a.code),description:a.pay_method??a.description??""}))),K(Array.isArray(i.data)?i.data:[])}catch{te([]),se([]),ae([]),K([])}})()},[x]);const C=s.useCallback(async()=>{try{const{data:e}=await h.get("/api/cash-receipt/list",{params:{company_id:x||"",q:J||""}});oe(Array.isArray(e)?e:[])}catch{oe([])}},[x,J]);s.useEffect(()=>{C()},[C]);const de=s.useCallback((e,n)=>{e&&K(c=>c.some(i=>i.acct_code===e)?c:[...c,{acct_code:e,acct_desc:n||""}])},[]),F=s.useCallback(async e=>{try{const{data:n}=await h.get(`/api/cash-receipt/${e}`,{params:{company_id:x}}),c=n.main??n;u(c.id),b(c.cr_no||""),y(String(c.cust_id||""));const i=O.find(l=>String(l.code)===String(c.cust_id));$(i?.description||""),B((c.receipt_date||"").slice(0,10)),W(Number(c.receipt_amount||0)),U(String(c.bank_id||"")),V(String(c.pay_method||"")),Y(c.collection_receipt||""),q(c.details||""),M((c.is_cancel||c.is_cancelled)==="y");const a=(n.details||[]).map(l=>{const w=String(l.acct_code??""),m=A(w)||String(l.acct_desc??"");return de(w,m),{id:l.id,acct_code:m?`${w};${m}`:`${w};`,acct_desc:m,debit:Number(l.debit??0),credit:Number(l.credit??0),workstation_id:l.workstation_id||"",persisted:!0}});v(a.length?a.concat([k()]):[k()]),_(!0),S((c.is_cancel||c.is_cancelled)==="y"),d.success("Receipt loaded.")}catch{d.error("Unable to load the selected receipt.")}},[x,O,A,de]),Ie=async e=>{e&&(ce(e),await F(e))},Be=async()=>{if(!f||!I||!H||!z||!X)return d.error("Please complete Customer, Date, Bank, Payment Method, and Collection Receipt.");if((await R.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Save"})).isConfirmed)try{const n=await h.post("/api/cash-receipt/save-main",{cr_no:p||void 0,cust_id:f,receipt_date:I,receipt_amount:0,pay_method:z,bank_id:H,collection_receipt:X,details:ee,amount_in_words:we(D).replace(/^\*\*\*\s|\s\*\*\*$/g,""),company_id:x,user_id:Q?.id}),c=n.data.id;u(c),b(n.data.cr_no||""),_(!0),S(!1),await F(c),d.success("Main saved. You can now input details."),C()}catch(n){d.error(n?.response?.data?.message||"Failed to save.")}},We=()=>{_(!1),S(!1),d.success("Editing enabled.")},He=async()=>{if(!(!o||!(await R.fire({title:"Cancel this receipt?",icon:"warning",showCancelButton:!0,confirmButtonText:"Cancel"})).isConfirmed))try{const{data:n}=await h.post("/api/cash-receipt/cancel",{id:o,flag:1});M((n?.is_cancel||n?.is_cancelled)==="y"),_(!0),S(!0),d.success("Receipt marked CANCELLED."),C()}catch{d.error("Failed to cancel receipt.")}},Ue=async()=>{if(!(!o||!(await R.fire({title:"Uncancel this receipt?",icon:"question",showCancelButton:!0,confirmButtonText:"Uncancel"})).isConfirmed))try{const{data:n}=await h.post("/api/cash-receipt/cancel",{id:o,flag:0});M((n?.is_cancel||n?.is_cancelled)!=="y"),_(!0),S(!1),d.success("Receipt is now ACTIVE."),C()}catch{d.error("Failed to uncancel receipt.")}},ze=async()=>{if(!(!o||!(await R.fire({title:"Delete this receipt?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await h.delete(`/api/cash-receipt/${o}`),ue(),d.success("Receipt deleted."),C()}catch{d.error("Failed to delete receipt.")}},ue=()=>{ce(""),ne(""),u(null),b(""),y(""),$(""),B(new Date().toISOString().slice(0,10)),W(0),U(""),V(""),Y(""),q(""),M(!1),_(!1),S(!0),v([k()])},Ve=e=>!!P(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,qe=e=>{e&&W(Number(e.sum_credit??e.total_credit??e.credit??0))},Xe=async e=>{const{data:n}=await h.post("/api/cash-receipt/delete-detail",e);qe(n?.totals),await F(e.transaction_id)},pe=async(e,n)=>{if(!o||!Ve(e))return;const c=P(e.acct_code);try{if(e.persisted)await h.post("/api/cash-receipt/update-detail",{id:e.id,transaction_id:o,acct_code:c,debit:e.debit||0,credit:e.credit||0});else{const i=await h.post("/api/cash-receipt/save-detail",{transaction_id:o,acct_code:c,debit:e.debit||0,credit:e.credit||0,company_id:x,user_id:Q?.id}),a=r.current?.hotInstance?.getSourceData()||[];a[n]&&(a[n].persisted=!0,a[n].id=i.data.detail_id),v([...a,...a.find(l=>!l.acct_code)?[]:[k()]])}}catch(i){d.error(i?.response?.data?.message||"Row save failed")}},Ye=0,Ge=(e,n)=>{if(E||n!==Ye)return;const i=r.current?.hotInstance?.getActiveEditor();i?.cellProperties?.type==="autocomplete"&&(i.TEXTAREA.value="",i.query="",i.open(),i.refreshDropdown?.())},[Ke,me]=s.useState(!1),[Je,he]=s.useState(!1),[Ze,Qe]=s.useState(void 0),[et,fe]=s.useState(!1),tt=()=>{if(!o)return d.info("Save or select a receipt first.");const e=`/api/cash-receipt/form-pdf/${o}?company_id=${encodeURIComponent(x||"")}`;Qe(e),fe(!0)},st=async()=>{if(!o)return d.info("Save or select a receipt first.");const e=await h.get(`/api/cash-receipt/form-excel/${o}`,{responseType:"blob",params:{company_id:x||""}}),n=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`ReceiptVoucher_${p||o}.xlsx`,c=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),i=URL.createObjectURL(c),a=document.createElement("a");a.href=i,a.download=n,document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(i)};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(lt,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-blue-50 shadow-md rounded-lg p-6 space-y-4 border border-blue-200",children:[t.jsx("h2",{className:"text-xl font-bold text-blue-800 mb-2",children:"CASH RECEIPTS"}),t.jsxs("div",{className:"grid grid-cols-3 auto-rows-auto gap-4",children:[t.jsx("div",{className:"col-span-3",children:t.jsx(L,{label:"Search Transaction",value:Oe,onChange:Ie,items:Ae,search:J,onSearchChange:ne,headers:["ID","RV #","Customer","Date","Amount","Collection Rcpt"],columnWidths:["60px","110px","220px","110px","110px","160px"],dropdownPositionStyle:{width:"820px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-2 row-span-2",children:t.jsx(L,{label:"Customer",value:f,onChange:e=>{y(e);const n=O.find(c=>String(c.code)===String(e));$(n?.description||"")},items:O,search:je,onSearchChange:ke,headers:["Code","Description"],columnWidths:["140px","520px"],dropdownPositionStyle:{width:"700px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{className:"col-span-1",children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:I,disabled:g,onChange:e=>B(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsx("div",{className:"col-span-2 row-span-2",children:t.jsx(L,{label:"Bank Name",value:H,onChange:U,items:Ne.map(e=>({code:String(e.bank_id??e.code),description:e.bank_name??e.description})),search:Re,onSearchChange:De,headers:["Code","Bank"],columnWidths:["100px","350px"],dropdownPositionStyle:{width:"500px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-1",children:t.jsx(L,{label:"Payment Method",value:z,onChange:V,items:ve.map(e=>({code:String(e.pay_method_id??e.code),description:e.pay_method??e.description})),search:Ee,onSearchChange:Me,headers:["Code","Method"],columnWidths:["80px","200px"],dropdownPositionStyle:{width:"280px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{className:"col-span-2  row-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Details"}),t.jsx("input",{value:ee,disabled:g&&N,onChange:e=>q(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsxs("div",{className:"col-span-1",children:[t.jsx("label",{className:"block mb-1",children:"Collection Receipt #"}),t.jsx("input",{value:X,disabled:g&&N,onChange:e=>Y(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsxs("div",{className:"col-span-2   row-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Amount in Words"}),t.jsx("div",{className:"w-full border p-2 bg-white text-blue-900 text-sm font-semibold",children:_e})]}),t.jsxs("div",{className:"col-span-1",children:[t.jsx("label",{className:"block mb-1",children:"Amount"}),t.jsx("input",{value:gt(D),readOnly:!0,className:"w-full border p-2 bg-yellow-50 text-right font-bold"})]}),!!j&&t.jsxs("div",{className:"col-span-3 text-sm font-semibold text-gray-700",children:["Customer: ",j]})]}),t.jsx("div",{className:"flex gap-2 mt-3",children:g?t.jsxs(t.Fragment,{children:[!N&&t.jsxs("button",{onClick:We,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700",children:[t.jsx(ge,{className:"h-5 w-5"}),"Update"]}),N?t.jsxs("button",{onClick:Ue,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-600 text-white hover:bg-amber-700",children:[t.jsx(ft,{className:"h-5 w-5"}),"Uncancel"]}):t.jsxs("button",{onClick:He,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:[t.jsx(pt,{className:"h-5 w-5"}),"Cancel"]}),t.jsxs("button",{onClick:ze,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:[t.jsx(mt,{className:"h-5 w-5"}),"Delete"]})]}):t.jsxs("button",{onClick:Be,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[t.jsx(ge,{className:"h-5 w-5"}),"Save"]})}),N&&t.jsx("div",{className:"text-red-600 font-bold mt-2",children:"CANCELLED"})]}),t.jsxs("div",{ref:re,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),g&&t.jsx(ct,{className:"hot-enhanced hot-zebra",ref:r,data:Z,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,n)=>{const c=Ce;if(!e)return n(c);const i=String(e).toLowerCase();n(c.filter(a=>a.toLowerCase().includes(i)))},strict:!0,allowInvalid:!1,visibleRows:12,readOnly:E,renderer:(e,n,c,i,a,l,w)=>{const m=P(String(l??""));ye.renderers.TextRenderer(e,n,c,i,a,m,w)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:E},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:E}],afterBeginEditing:Ge,afterChange:(e,n)=>{const c=r.current?.hotInstance;!e||!c||N||n==="edit"&&(e.forEach(([i,a,l,w])=>{const m={...c.getSourceDataAtRow(i)};if(m.workstation_id==="BANK"){o&&F(o);return}if(a==="acct_code"){const T=String(w||""),be=P(T);c.setDataAtRowProp(i,"acct_desc",A(be));const at={...m,acct_code:T,acct_desc:A(be),debit:Number(m.debit||0),credit:Number(m.credit||0)};setTimeout(()=>pe(at,i),0)}if(a==="debit"||a==="credit"){const T={...m,debit:Number(a==="debit"?w:m.debit||0),credit:Number(a==="credit"?w:m.credit||0)};setTimeout(()=>pe(T,i),0)}}),requestAnimationFrame(()=>{const i=c.getSourceData();i.find(a=>!a.acct_code)||i.push(k()),v([...i])}))},contextMenu:{items:{remove_row:{name:"🗑️ Remove row",callback:async(e,n)=>{const c=r.current?.hotInstance,i=n[0].start.row,a=c?.getSourceData()||[],l=a[i];if(l?.workstation_id==="BANK"){d.info("Bank line cannot be deleted.");return}if(!l?.id){a.splice(i,1),v([...a]);return}(await R.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed&&(await Xe({id:l.id,transaction_id:o}),a.splice(i,1),v([...a]),d.success("Row deleted."))}}}},manualColumnResize:!0,stretchH:"all",height:$e,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>he(!0),onMouseLeave:()=>he(!1),children:[t.jsxs("button",{type:"button",disabled:!g,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${g?"bg-white text-blue-700 border-blue-300 hover:bg-blue-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(it,{className:`h-5 w-5 ${g?"text-blue-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(xe,{className:"h-4 w-4 opacity-70"})]}),Je&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:st,disabled:!g,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${g?"text-gray-800 hover:bg-blue-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx(ot,{className:`h-5 w-5 ${g?"text-blue-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Receipt Voucher – Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>me(!0),onMouseLeave:()=>me(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx(dt,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(xe,{className:"h-4 w-4 opacity-70"})]}),Ke&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:tt,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(rt,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Receipt Voucher – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})})})]}),t.jsxs("button",{type:"button",onClick:ue,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-blue-600 text-white hover:bg-blue-700",title:"Start a new transaction",children:[t.jsx(ut,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]})]}),et&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>fe(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"✕"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Receipt Voucher PDF",src:Ze,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{kt as default};
