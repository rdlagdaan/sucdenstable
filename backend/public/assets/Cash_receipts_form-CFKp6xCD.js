import{n as m,j as t,F as be}from"./index-BrmeyXGX.js";import{r as a,H as at,a as we,N as ct}from"./handsontable-7BBM75Z1.js";import{S as R,F as nt,a as it,b as ot}from"./sweetalert2.esm.all-B4pNkPRF.js";import{y as d,L as rt,D as T,b as xe,F as lt,a as dt}from"./DropdownWithHeaders-DC_sJG_v.js";import{F as ut}from"./XMarkIcon-B-Tbi0qp.js";import{F as pt}from"./TrashIcon-I-_qGSbO.js";import"./react-Csw2ODfV.js";function mt({title:r,titleId:o,...u},p){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:p,"aria-labelledby":o},u),r?a.createElement("title",{id:o},r):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3"}))}const ht=a.forwardRef(mt);we.cellTypes.registerCellType("numeric",ct);const L=r=>(r||"").split(";")[0];function ft(r){const o=["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],u=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];let p="";const f=Math.floor(r/100),h=r%100;if(f&&(p+=o[f]+" hundred"+(h?" ":"")),h)if(h<20)p+=o[h];else{const w=Math.floor(h/10),k=h%10;p+=u[w]+(k?"-"+o[k]:"")}return p}function bt(r){if(r===0)return"zero";const o=[""," thousand"," million"," billion"," trillion"];let u="",p=0;for(;r>0;){const f=r%1e3;f&&(u=ft(f)+o[p]+(u?" "+u:"")),r=Math.floor(r/1e3),p++}return u}function ge(r){const[o,u]=Number(r||0).toFixed(2).split("."),p=parseInt(o,10)||0,f=parseInt(u,10)||0,h=bt(p).toUpperCase(),w=f===0?" PESOS ONLY":` PESOS AND ${String(f).padStart(2,"0")}/100 ONLY`;return`*** ${h}${w} ***`}const xt=r=>(Number(r)||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2});function jt(){const r=a.useRef(null),[o,u]=a.useState(null),[p,f]=a.useState(""),[h,w]=a.useState(""),[k,P]=a.useState(""),[$,B]=a.useState(()=>new Date().toISOString().slice(0,10)),[D,I]=a.useState(0),[ye,_e]=a.useState("*** ZERO PESOS ONLY ***"),[W,H]=a.useState(""),[U,z]=a.useState(""),[Q,V]=a.useState(""),[q,X]=a.useState(""),[gt,S]=a.useState(!1),[E,N]=a.useState(!0),[v,M]=a.useState(!1),x=a.useMemo(()=>o!=null,[o]),[O,ee]=a.useState([]),[Se,te]=a.useState([]),[Ne,se]=a.useState([]),[Y,ae]=a.useState([]),ve=a.useMemo(()=>Y.map(e=>`${e.acct_code};${e.acct_desc}`),[Y]),A=e=>Y.find(c=>c.acct_code===e)?.acct_desc||"",[Ce,je]=a.useState(""),[ke,Re]=a.useState(""),[De,Ee]=a.useState(""),[Me,ce]=a.useState(""),[G,ne]=a.useState(""),[ie,oe]=a.useState([]),Oe=a.useMemo(()=>(ie||[]).map(e=>({code:String(e.id),cr_no:e.cr_no,cust_id:e.cust_id,cust_name:e.cust_name||"",receipt_date:(e.receipt_date||"").slice(0,10),receipt_amount:e.receipt_amount,collection_receipt:e.collection_receipt||"",label:e.cr_no,description:e.cust_name||e.cust_id})),[ie]),[K,y]=a.useState([{acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}]),_=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),re=a.useRef(null),[le,Ae]=a.useState(600);a.useLayoutEffect(()=>{const e=()=>{const n=re.current?.getBoundingClientRect()?.top??0,i=window.innerHeight-n-140;Ae(Math.max(320,Math.floor(i)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const Fe=28,Te=32,Le=240,Pe=a.useMemo(()=>{const e=Math.max(K.length,6),c=Te+e*Fe+Le;return Math.min(c,le)},[K.length,le]),J=a.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]),b=J?.company_id;a.useEffect(()=>{_e(ge(D))},[D]),a.useEffect(()=>{(async()=>{try{const[e,c,n,i]=await Promise.all([m.get("/api/cr/customers",{params:{company_id:b}}),m.get("/api/cr/banks",{params:{company_id:b}}),m.get("/api/cr/payment-methods"),m.get("/api/cr/accounts",{params:{company_id:b}})]);ee((e.data||[]).map(s=>({code:String(s.cust_id??s.code),description:s.cust_name??s.description??""}))),te((c.data||[]).map(s=>({code:String(s.bank_id??s.code),description:s.bank_name??s.description??""}))),se((n.data||[]).map(s=>({code:String(s.pay_method_id??s.code),description:s.pay_method??s.description??""}))),ae(Array.isArray(i.data)?i.data:[])}catch{ee([]),te([]),se([]),ae([])}})()},[b]);const C=a.useCallback(async()=>{try{const{data:e}=await m.get("/api/cash-receipt/list",{params:{company_id:b||"",q:G||""}});oe(Array.isArray(e)?e:[])}catch{oe([])}},[b,G]);a.useEffect(()=>{C()},[C]);const Z=a.useCallback(async e=>{try{const{data:c}=await m.get(`/api/cash-receipt/${e}`,{params:{company_id:b}}),n=c.main??c;u(n.id),f(n.cr_no||""),w(String(n.cust_id||""));const i=O.find(l=>String(l.code)===String(n.cust_id));P(i?.description||""),B((n.receipt_date||"").slice(0,10)),I(Number(n.receipt_amount||0)),H(String(n.bank_id||"")),z(String(n.pay_method||"")),X(n.collection_receipt||""),V(n.details||""),M((n.is_cancel||n.is_cancelled)==="y");const s=(c.details||[]).map(l=>({id:l.id,acct_code:`${l.acct_code};${l.acct_desc||A(l.acct_code)}`,acct_desc:l.acct_desc,debit:Number(l.debit||0),credit:Number(l.credit||0),workstation_id:l.workstation_id||"",persisted:!0}));y(s.length?s.concat([_()]):[_()]),S(!0),N((n.is_cancel||n.is_cancelled)==="y"),d.success("Receipt loaded.")}catch{d.error("Unable to load the selected receipt.")}},[b,O,A]),$e=async e=>{e&&(ce(e),await Z(e))},Be=async()=>{if(!h||!$||!W||!U||!q)return d.error("Please complete Customer, Date, Bank, Payment Method, and Collection Receipt.");if((await R.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Save"})).isConfirmed)try{const c=await m.post("/api/cash-receipt/save-main",{cr_no:p||void 0,cust_id:h,receipt_date:$,receipt_amount:0,pay_method:U,bank_id:W,collection_receipt:q,details:Q,amount_in_words:ge(D).replace(/^\*\*\*\s|\s\*\*\*$/g,""),company_id:b,user_id:J?.id});u(c.data.id),f(c.data.cr_no||""),S(!0),N(!1),y([_(),_()]),d.success("Main saved. You can now input details."),C()}catch(c){d.error(c?.response?.data?.message||"Failed to save.")}},Ie=()=>{S(!1),N(!1),d.success("Editing enabled.")},We=async()=>{if(!(!o||!(await R.fire({title:"Cancel this receipt?",icon:"warning",showCancelButton:!0,confirmButtonText:"Cancel"})).isConfirmed))try{const{data:c}=await m.post("/api/cash-receipt/cancel",{id:o,flag:1});M((c?.is_cancel||c?.is_cancelled)==="y"),S(!0),N(!0),d.success("Receipt marked CANCELLED."),C()}catch{d.error("Failed to cancel receipt.")}},He=async()=>{if(!(!o||!(await R.fire({title:"Uncancel this receipt?",icon:"question",showCancelButton:!0,confirmButtonText:"Uncancel"})).isConfirmed))try{const{data:c}=await m.post("/api/cash-receipt/cancel",{id:o,flag:0});M((c?.is_cancel||c?.is_cancelled)!=="y"),S(!0),N(!1),d.success("Receipt is now ACTIVE."),C()}catch{d.error("Failed to uncancel receipt.")}},Ue=async()=>{if(!(!o||!(await R.fire({title:"Delete this receipt?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await m.delete(`/api/cash-receipt/${o}`),de(),d.success("Receipt deleted."),C()}catch{d.error("Failed to delete receipt.")}},de=()=>{ce(""),ne(""),u(null),f(""),w(""),P(""),B(new Date().toISOString().slice(0,10)),I(0),H(""),z(""),X(""),V(""),M(!1),S(!1),N(!0),y([_()])},ze=e=>!!L(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,Ve=e=>{e&&I(Number(e.sum_credit??e.total_credit??e.credit??0))},qe=async e=>{const{data:c}=await m.post("/api/cash-receipt/delete-detail",e);Ve(c?.totals),await Z(e.transaction_id)},ue=async(e,c)=>{if(!o||!ze(e))return;const n=L(e.acct_code);try{if(e.persisted)await m.post("/api/cash-receipt/update-detail",{id:e.id,transaction_id:o,acct_code:n,debit:e.debit||0,credit:e.credit||0});else{const i=await m.post("/api/cash-receipt/save-detail",{transaction_id:o,acct_code:n,debit:e.debit||0,credit:e.credit||0,company_id:b,user_id:J?.id}),s=r.current?.hotInstance?.getSourceData()||[];s[c]&&(s[c].persisted=!0,s[c].id=i.data.detail_id),y([...s,...s.find(l=>!l.acct_code)?[]:[_()]])}}catch(i){d.error(i?.response?.data?.message||"Row save failed")}},Xe=0,Ye=(e,c)=>{if(E||c!==Xe)return;const i=r.current?.hotInstance?.getActiveEditor();i?.cellProperties?.type==="autocomplete"&&(i.TEXTAREA.value="",i.query="",i.open(),i.refreshDropdown?.())},[Ge,pe]=a.useState(!1),[Ke,me]=a.useState(!1),[Je,Ze]=a.useState(void 0),[Qe,he]=a.useState(!1),et=()=>{if(!o)return d.info("Save or select a receipt first.");const e=`/api/cash-receipt/form-pdf/${o}?company_id=${encodeURIComponent(b||"")}`;Ze(e),he(!0)},tt=async()=>{if(!o)return d.info("Save or select a receipt first.");const e=await m.get(`/api/cash-receipt/form-excel/${o}`,{responseType:"blob",params:{company_id:b||""}}),c=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`ReceiptVoucher_${p||o}.xlsx`,n=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=c,document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(i)};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(rt,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-blue-50 shadow-md rounded-lg p-6 space-y-4 border border-blue-200",children:[t.jsx("h2",{className:"text-xl font-bold text-blue-800 mb-2",children:"CASH RECEIPTS"}),t.jsxs("div",{className:"grid grid-cols-3 auto-rows-auto gap-4",children:[t.jsx("div",{className:"col-span-3",children:t.jsx(T,{label:"Search Transaction",value:Me,onChange:$e,items:Oe,search:G,onSearchChange:ne,headers:["ID","RV #","Customer","Date","Amount","Collection Rcpt"],columnWidths:["60px","110px","220px","110px","110px","160px"],dropdownPositionStyle:{width:"820px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-2 row-span-2",children:t.jsx(T,{label:"Customer",value:h,onChange:e=>{w(e);const c=O.find(n=>String(n.code)===String(e));P(c?.description||"")},items:O,search:Ce,onSearchChange:je,headers:["Code","Description"],columnWidths:["140px","520px"],dropdownPositionStyle:{width:"700px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{className:"col-span-1",children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:$,disabled:x,onChange:e=>B(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsx("div",{className:"col-span-2 row-span-2",children:t.jsx(T,{label:"Bank Name",value:W,onChange:H,items:Se.map(e=>({code:String(e.bank_id??e.code),description:e.bank_name??e.description})),search:ke,onSearchChange:Re,headers:["Code","Bank"],columnWidths:["100px","480px"],dropdownPositionStyle:{width:"620px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{className:"col-span-1",children:[t.jsx("label",{className:"block mb-1",children:"Collection Receipt #"}),t.jsx("input",{value:q,disabled:x&&v,onChange:e=>X(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsx("div",{className:"col-span-1",children:t.jsx(T,{label:"Payment Method",value:U,onChange:z,items:Ne.map(e=>({code:String(e.pay_method_id??e.code),description:e.pay_method??e.description})),search:De,onSearchChange:Ee,headers:["Code","Method"],columnWidths:["100px","420px"],dropdownPositionStyle:{width:"560px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Details"}),t.jsx("input",{value:Q,disabled:x&&v,onChange:e=>V(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsxs("div",{className:"col-span-1",children:[t.jsx("label",{className:"block mb-1",children:"Amount"}),t.jsx("input",{value:xt(D),readOnly:!0,className:"w-full border p-2 bg-yellow-50 text-right font-bold"})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Amount in Words"}),t.jsx("div",{className:"w-full border p-2 bg-white text-blue-900 text-sm font-semibold",children:ye})]}),!!k&&t.jsxs("div",{className:"col-span-3 text-sm font-semibold text-gray-700",children:["Customer: ",k]})]}),t.jsx("div",{className:"flex gap-2 mt-3",children:x?t.jsxs(t.Fragment,{children:[!v&&t.jsxs("button",{onClick:Ie,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700",children:[t.jsx(xe,{className:"h-5 w-5"}),"Update"]}),v?t.jsxs("button",{onClick:He,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-600 text-white hover:bg-amber-700",children:[t.jsx(ht,{className:"h-5 w-5"}),"Uncancel"]}):t.jsxs("button",{onClick:We,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:[t.jsx(ut,{className:"h-5 w-5"}),"Cancel"]}),t.jsxs("button",{onClick:Ue,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:[t.jsx(pt,{className:"h-5 w-5"}),"Delete"]})]}):t.jsxs("button",{onClick:Be,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[t.jsx(xe,{className:"h-5 w-5"}),"Save"]})}),v&&t.jsx("div",{className:"text-red-600 font-bold mt-2",children:"CANCELLED"})]}),t.jsxs("div",{ref:re,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),x&&t.jsx(at,{className:"hot-enhanced hot-zebra",ref:r,data:K,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,c)=>{const n=ve;if(!e)return c(n);const i=String(e).toLowerCase();c(n.filter(s=>s.toLowerCase().includes(i)))},strict:!0,allowInvalid:!1,visibleRows:12,readOnly:E,renderer:(e,c,n,i,s,l,j)=>{const g=L(String(l??""));we.renderers.TextRenderer(e,c,n,i,s,g,j)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:E},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:E}],afterBeginEditing:Ye,afterChange:(e,c)=>{const n=r.current?.hotInstance;!e||!n||v||c==="edit"&&(e.forEach(([i,s,l,j])=>{const g={...n.getSourceDataAtRow(i)};if(g.workstation_id==="BANK"){o&&Z(o);return}if(s==="acct_code"){const F=String(j||""),fe=L(F);n.setDataAtRowProp(i,"acct_desc",A(fe));const st={...g,acct_code:F,acct_desc:A(fe),debit:Number(g.debit||0),credit:Number(g.credit||0)};setTimeout(()=>ue(st,i),0)}if(s==="debit"||s==="credit"){const F={...g,debit:Number(s==="debit"?j:g.debit||0),credit:Number(s==="credit"?j:g.credit||0)};setTimeout(()=>ue(F,i),0)}}),requestAnimationFrame(()=>{const i=n.getSourceData();i.find(s=>!s.acct_code)||i.push(_()),y([...i])}))},contextMenu:{items:{remove_row:{name:"🗑️ Remove row",callback:async(e,c)=>{const n=r.current?.hotInstance,i=c[0].start.row,s=n?.getSourceData()||[],l=s[i];if(l?.workstation_id==="BANK"){d.info("Bank line cannot be deleted.");return}if(!l?.id){s.splice(i,1),y([...s]);return}(await R.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed&&(await qe({id:l.id,transaction_id:o}),s.splice(i,1),y([...s]),d.success("Row deleted."))}}}},manualColumnResize:!0,stretchH:"all",height:Pe,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>me(!0),onMouseLeave:()=>me(!1),children:[t.jsxs("button",{type:"button",disabled:!x,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${x?"bg-white text-blue-700 border-blue-300 hover:bg-blue-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(nt,{className:`h-5 w-5 ${x?"text-blue-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(be,{className:"h-4 w-4 opacity-70"})]}),Ke&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:tt,disabled:!x,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${x?"text-gray-800 hover:bg-blue-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx(it,{className:`h-5 w-5 ${x?"text-blue-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Receipt Voucher – Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>pe(!0),onMouseLeave:()=>pe(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx(lt,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(be,{className:"h-4 w-4 opacity-70"})]}),Ge&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:et,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(ot,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Receipt Voucher – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})})})]}),t.jsxs("button",{type:"button",onClick:de,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-blue-600 text-white hover:bg-blue-700",title:"Start a new transaction",children:[t.jsx(dt,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]})]}),Qe&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>he(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"✕"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Receipt Voucher PDF",src:Je,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{jt as default};
