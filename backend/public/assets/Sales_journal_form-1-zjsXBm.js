import{n as u,j as t,F as K}from"./index-BPes6wbd.js";import{r as n,H as ke,a as Fe,N as Ee}from"./handsontable-7BBM75Z1.js";import{L as Te,D as Q,b as Z,y as l,F as $e,a as Me}from"./DropdownWithHeaders-C7pkzoIK.js";import{S as F,F as Le,a as Oe,b as ee}from"./sweetalert2.esm.all-B4pNkPRF.js";import"./react-Csw2ODfV.js";Fe.cellTypes.registerCellType("numeric",Ee);function He(_){if(!_)return"";const f=new Date(_);if(isNaN(f.getTime()))return"";const b=f.getFullYear(),N=String(f.getMonth()+1).padStart(2,"0"),g=String(f.getDate()).padStart(2,"0");return`${b}-${N}-${g}`}function Ye(){const _=n.useRef(null),[f,b]=n.useState(""),[N,g]=n.useState(""),[H,v]=n.useState(""),[A,j]=n.useState(""),[P,S]=n.useState(""),[I,C]=n.useState(""),[o,D]=n.useState(null),[y,w]=n.useState(!1),[E,U]=n.useState([]),[T,B]=n.useState([]),[te,se]=n.useState(""),[ae,$]=n.useState(""),[M,L]=n.useState(""),[Y,z]=n.useState([]),[h,x]=n.useState([]),[ne,R]=n.useState(!1),[ce,G]=n.useState(!1),[oe,W]=n.useState(!1),[re,ie]=n.useState(void 0),[le,J]=n.useState(!1),V=n.useRef(null),[X,de]=n.useState(600);n.useLayoutEffect(()=>{const e=()=>{const s=V.current?.getBoundingClientRect()?.top??0,c=window.innerHeight-s-140;de(Math.max(320,Math.floor(c)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const ue=28,me=32,pe=240,he=n.useMemo(()=>{const e=Math.max(h.length,6),a=me+e*ue+pe;return Math.min(a,X)},[h.length,X]),i=n.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);n.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/customers",{params:{company_id:i?.company_id}}),a=(e||[]).map(s=>({code:String(s.cust_id??s.code),label:s.cust_name??s.label??"",description:s.cust_name??s.description??""}));U(a)}catch(e){console.error("Failed to load customers",e),U([])}})()},[i?.company_id]),n.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/accounts",{params:{company_id:i?.company_id}});B(Array.isArray(e)?e:[])}catch(e){console.error("Failed to load accounts",e),B([])}})()},[i?.company_id]);const k=async()=>{try{const{data:e}=await u.get("/api/sales/list",{params:{company_id:i?.company_id||"",q:M||""}}),a=Array.isArray(e)?e:[];z(a)}catch(e){console.error("Failed to load cash sales list",e),z([])}};n.useEffect(()=>{k()},[M]);const xe=n.useMemo(()=>(Y||[]).map(e=>({code:String(e.id),cs_no:e.cs_no,cust_id:e.cust_id,sales_date:e.sales_date,sales_amount:e.sales_amount,si_no:e.si_no,label:e.cs_no,description:e.cust_id})),[Y]),m=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),fe=()=>{$(""),L(""),b(""),g(""),v(""),j(""),S(""),C(""),D(null),w(!1),R(!1),x([m()])},be=async()=>{if((await F.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed)try{const a=await u.get("/api/sales/generate-cs-number",{params:{company_id:i?.company_id}}),s=a.data?.cs_no??a.data;b(s);const c=await u.post("/api/sales/save-main",{cs_no:s,cust_id:N,sales_date:A,explanation:P,si_no:I,company_id:i?.company_id,user_id:i?.id});D(c.data.id),R(!0),x([m(),m()]),l.success("Main saved. You can now input details."),k(),w(!0)}catch(a){console.error(a),l.error(a?.response?.data?.message||"Failed to save.")}},ge=()=>{w(!1),l.success("Editing enabled. You can now update this transaction.")},ye=async()=>{if(!(!o||!(await F.fire({title:"Cancel this transaction?",text:"This will mark the transaction as CANCELLED.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, cancel it"})).isConfirmed))try{await u.post("/api/sales/cancel",{id:o,is_cancel:"y",company_id:i?.company_id||""}),w(!0),l.success("Transaction has been cancelled."),k()}catch(a){console.error(a),l.error("Failed to cancel transaction.")}},we=async()=>{if(!(!o||!(await F.fire({title:"Delete this transaction?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await u.delete(`/api/sales/${o}`),fe(),l.success("Transaction deleted."),k()}catch(a){console.error(a),l.error("Failed to delete transaction.")}},_e=e=>e.acct_code&&(e.debit??0)>0!=(e.credit??0)>0,Ne=async(e,a)=>{if(o&&_e(e))try{if(e.persisted)await u.post("/api/sales/update-detail",{id:e.id,transaction_id:o,acct_code:e.acct_code,debit:e.debit||0,credit:e.credit||0});else{const s=await u.post("/api/sales/save-detail",{transaction_id:o,acct_code:e.acct_code,debit:e.debit||0,credit:e.credit||0,company_id:i?.company_id,user_id:i?.id}),c=[...h];c[a]={...e,id:s.data.detail_id,persisted:!0},a===c.length-1&&c.push(m()),x(c)}}catch(s){console.error(s),l.error(s?.response?.data?.message||"Row save failed")}},ve=async e=>{if(e)try{$(e);const{data:a}=await u.get(`/api/sales/${e}`,{params:{company_id:i?.company_id}}),s=a.main??a;D(s.id),b(s.cs_no),g(String(s.cust_id||""));const c=E.find(r=>String(r.code)===String(s.cust_id));v(c?.description||c?.label||"");const d=He(s.sales_date);j(d),S(s.explanation??""),C(s.si_no??"");const p=(a.details||[]).map(r=>({id:r.id,acct_code:r.acct_code,acct_desc:r.acct_desc,debit:Number(r.debit??0),credit:Number(r.credit??0),persisted:!0}));x(p.length?p.concat([m()]):[m()]),R(!0),w(!0),l.success("Transaction loaded.")}catch(a){console.error(a),l.error("Unable to load the selected transaction.")}},je=n.useMemo(()=>T.map(e=>`${e.acct_code};${e.acct_desc}`),[T]),Se=e=>T.find(s=>s.acct_code===e)?.acct_desc||"",Ce=()=>{if(!o)return l.info("Select or save a transaction first.");const e=`/api/sales/form-pdf/${o}?company_id=${encodeURIComponent(i?.company_id||"")}`;ie(e),J(!0)},De=async()=>{if(!o)return l.info("Select or save a transaction first.");const e=await u.get(`/api/sales/form-excel/${o}`,{responseType:"blob",params:{company_id:i?.company_id||""}}),a=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`SalesVoucher_${f||o}.xlsx`,s=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),c=URL.createObjectURL(s),d=document.createElement("a");d.href=c,d.download=a,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(c)},Re=()=>{$(""),L(""),D(null),b(""),g(""),v(""),j(""),S(""),C(""),w(!1),x([m(),m(),m(),m()]),R(!1),l.success("Form is ready for a new entry.")};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(Te,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-yellow-50 shadow-md rounded-lg p-6 space-y-4 border border-yellow-400",children:[t.jsx("h2",{className:"text-xl font-bold text-green-800 mb-2",children:"SALES JOURNAL"}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsx("div",{className:"col-span-3",children:t.jsx(Q,{label:"Search Transaction",value:ae,onChange:e=>ve(e),items:xe,search:M,onSearchChange:L,headers:["ID","Sales No","Customer","Date","Amount","S.I. #"],inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-2",children:t.jsx(Q,{label:"Customer",value:N,onChange:e=>{g(e);const a=E.find(s=>String(s.code)===String(e));v(a?.description||a?.label||"")},items:E,search:te,onSearchChange:se,headers:["Code","Label","Description"],inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:A,disabled:y,onChange:e=>j(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Explanation"}),t.jsx("input",{value:P,disabled:y,onChange:e=>S(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"S.I. #"}),t.jsx("input",{value:I,disabled:y,onChange:e=>C(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),H&&t.jsxs("div",{className:"col-span-3 text-sm font-semibold text-gray-700",children:["Customer: ",H]})]}),t.jsx("div",{className:"flex gap-2 mt-3",children:o?t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:ge,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[t.jsx(Z,{className:"h-5 w-5"}),"Update"]}),t.jsx("button",{onClick:ye,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:"Cancel"}),t.jsx("button",{onClick:we,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:"Delete"})]}):t.jsxs("button",{onClick:be,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700",children:[t.jsx(Z,{className:"h-5 w-5"}),"Save"]})})]}),t.jsxs("div",{ref:V,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),ne&&t.jsx(ke,{ref:_,data:h,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,a)=>{const s=je;if(!e)return a(s);const c=String(e).toLowerCase();a(s.filter(d=>d.toLowerCase().includes(c)))},strict:!1,visibleRows:10,allowInvalid:!1,readOnly:y},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:y},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:y}],afterChange:(e,a)=>{if(!e||a!=="edit")return;const s=[...h];e.forEach(([c,d,,p])=>{const r=s[c]||{};if(d==="acct_code"){const O=String(p||""),q=O.includes(";")?O.split(";")[0]:O;r.acct_code=q,r.acct_desc=Se(q)}d==="debit"&&(r.debit=Number(p||0)),d==="credit"&&(r.credit=Number(p||0)),s[c]=r,setTimeout(()=>Ne(r,c),0)}),s.find(c=>!c.acct_code)||s.push(m()),x(s)},contextMenu:{items:{remove_row:{name:"🗑️ Remove row",callback:async(e,a)=>{const s=a[0].start.row,c=h[s];if(!c?.id){const r=[...h];r.splice(s,1),x(r);return}if(!(await F.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed)return;await u.post("/api/sales/delete-detail",{id:c.id,transaction_id:o});const p=[...h];p.splice(s,1),x(p),l.success("Row deleted")}}}},manualColumnResize:!0,stretchH:"all",height:he,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>W(!0),onMouseLeave:()=>W(!1),children:[t.jsxs("button",{type:"button",disabled:!o,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${o?"bg-white text-emerald-700 border-emerald-300 hover:bg-emerald-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(Le,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(K,{className:"h-4 w-4 opacity-70"})]}),oe&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:De,disabled:!o,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${o?"text-gray-800 hover:bg-emerald-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx(Oe,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Sales Voucher – Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>G(!0),onMouseLeave:()=>G(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx($e,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(K,{className:"h-4 w-4 opacity-70"})]}),ce&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsxs("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:[t.jsxs("button",{type:"button",onClick:Ce,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(ee,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Sales Voucher – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]}),t.jsxs("button",{type:"button",onClick:()=>{if(!o)return l.info("Select or save a transaction.");window.open(`/api/sales/check-pdf/${o}?company_id=${encodeURIComponent(i?.company_id||"")}`,"_blank")},className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(ee,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Print Check – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})]})})]}),t.jsxs("button",{type:"button",onClick:Re,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 focus:outline-none",title:"Start a new transaction",children:[t.jsx(Me,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]})]}),le&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>J(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"✕"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Sales Voucher PDF",src:re,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{Ye as default};
