import{n as h,j as t,F as fe}from"./index-DSN8SQvo.js";import{r as i,H as Ve,a as ze,N as Ge}from"./handsontable-7BBM75Z1.js";/* empty css                              */import{S as he,F as Je,a as Ke,b as Xe}from"./sweetalert2.esm.all-B4pNkPRF.js";import{L as Qe,D as O,y as b,F as Ze,a as et,b as tt}from"./DropdownWithHeaders-E_5Yn7-f.js";import{F as st}from"./XMarkIcon-B-Tbi0qp.js";import"./react-Csw2ODfV.js";function J(m){const[_,j]=i.useState([]),[u,N]=i.useState("");return i.useEffect(()=>{(async()=>{try{const x=await h.get(m);let w=[];m==="/api/vendors"?w=x.data.map(l=>({code:l.vend_code,description:l.vend_name})):m==="/api/crop-years"?w=x.data.map(l=>({code:l.crop_year,label:l.begin_year,description:l.end_year})):w=x.data.map(l=>({code:l.code??l.sugar_type??l.vend_code??l.crop_year,description:l.description??l.vendor_name??l.sugar_type??l.crop_year})),j(w)}catch(x){console.error(`Error fetching dropdown from ${m}`,x)}})()},[m]),{items:_.filter(y=>y.code.toString().toLowerCase().includes(u.toLowerCase())||y.label?.toString().toLowerCase().includes(u.toLowerCase())||y.description?.toString().toLowerCase().includes(u.toLowerCase())),setSearch:N,search:u}}ze.cellTypes.registerCellType("numeric",Ge);function nt(m){if(!m)return"";const _=new Date(m),j=_.getFullYear(),u=String(_.getMonth()+1).padStart(2,"0"),N=String(_.getDate()).padStart(2,"0");return`${j}-${u}-${N}`}function pt(){const m=i.useRef(null),[_,j]=i.useState(!1),[u,N]=i.useState(""),[R,y]=i.useState(""),[x,w]=i.useState(""),[l,L]=i.useState(""),[K,T]=i.useState(""),[X,k]=i.useState(""),[ge,F]=i.useState(!1),[p,q]=i.useState(null),[be,Q]=i.useState(!1),[$,ye]=i.useState(void 0),[xe,Z]=i.useState(!1),[we,ee]=i.useState(!1),g=!!p,_e=28,Ne=320,M=6,ve=220,te=(e,s)=>{const o=m.current?.hotInstance;if(!o)return;const a=o.getCell(e,s),n=document.querySelector(".handsontableEditor.autocompleteEditor");if(!a||!n)return;const r=a.getBoundingClientRect(),c=r.top-M,d=window.innerHeight-r.bottom-M,f=d>=ve||d>=c,ue=Math.min(Ne,f?d:c,420),pe=Math.max(r.width,300),Ye=Math.max(8,Math.min(r.left,window.innerWidth-pe-8)),We=f?r.bottom+M:Math.max(8,r.top-ue-M);n.style.left=`${Ye}px`,n.style.top=`${We}px`,n.style.maxHeight=`${Math.max(160,ue)}px`,n.style.width=`${pe}px`,document.querySelector(".handsontableInput")?.focus()},[v,S]=i.useState([]),[se,Se]=i.useState([]),[ne,je]=i.useState([]),[H,U]=i.useState(""),[A,Ce]=i.useState(""),[B,Pe]=i.useState(!1),[ot,Ee]=i.useState(null),[oe,Y]=i.useState(!1),W=J("/api/sugar-types"),V=J("/api/crop-years"),E=J("/api/vendors"),[C,z]=i.useState([]),ae=i.useRef(null),[Re,re]=i.useState(!1),P=i.useRef(!1),ce=260,Fe=28,ie=(e,s)=>{const o=m.current?.hotInstance;if(!o)return;const a=o.getCell(e,s);if(!a)return;const n=a.getBoundingClientRect(),r=window.innerHeight-n.bottom;if(r>=ce)return;const c=ce-r,d=Math.ceil(c/Fe)+1,f=Math.max(0,e-d);o.scrollViewportTo(f,s)},le=i.useRef(null),[de,Me]=i.useState(600);i.useLayoutEffect(()=>{const e=()=>{const o=le.current?.getBoundingClientRect()?.top??0,n=window.innerHeight-o-140;Me(Math.max(320,Math.floor(n)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const Be=32,De=240,Ie=i.useMemo(()=>{const e=Math.max(v.length,6),s=Be*1+e*_e+De;return Math.min(s,de)},[v.length,de]),D=e=>e.mill&&e.quantity!==void 0&&e.unit_cost!==void 0&&e.commission!==void 0&&e.mill!==""&&e.quantity!==""&&e.unit_cost!==""&&e.commission!=="",Oe=4,G=()=>({mill:"",quantity:0,unit_cost:0,commission:0,cost:0,total_commission:0,total_cost:0,persisted:!1}),Le=e=>!e?.mill&&!e?.quantity&&!e?.unit_cost&&!e?.commission,I=e=>{const s=[...e];let o=0;for(let n=s.length-1;n>=0&&Le(s[n]);n--)o++;const a=Math.max(0,Oe-o);for(let n=0;n<a;n++)s.push(G());return s},me=async()=>{const e=localStorage.getItem("user"),s=e?JSON.parse(e):null,o=await h.get("/api/pbn/dropdown-list",{params:{include_posted:B.toString(),company_id:s?.company_id||""}}),a=o.data.map(n=>({...n,code:n.id.toString(),label:n.pbn_number,description:n.vendor_name??""}));console.log(o),je(a)};i.useEffect(()=>{me()},[B]),i.useEffect(()=>{const e=localStorage.getItem("user"),o=(e?JSON.parse(e):null)?.company_id;let a=!1;async function n(){try{const{data:r}=await h.get("/api/mills",{params:{company_id:o}});a||Se((r||[]).map(c=>({mill_id:String(c.mill_id),mill_name:c.mill_name})))}catch(r){console.error("Failed to load mills",r)}}return n(),()=>{a=!0}},[]),i.useEffect(()=>{const e=E.items.find(s=>s.code===l);T(e?.description||"")},[l,E.items]),i.useEffect(()=>{p&&C.length>0&&(S(C),F(!0),z([]))},[p,C]),i.useEffect(()=>{ae.current=p},[p]),i.useEffect(()=>{p&&C.length>0&&(S(I(C)),F(!0),z([]))},[p,C]);const Te=()=>{N(""),U(""),y(""),w(""),L(""),T(""),k(""),j(!1),F(!1),q(null),S(I([G()])),Y(!1),b.success("âœ… PBN Entry form is now ready for new entry")},ke=async()=>{if((await he.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save it!"})).isConfirmed)try{const s=localStorage.getItem("user"),a=(s?JSON.parse(s):null)?.company_id;if(!a){b.error("Company ID not found in session.");return}const{data:n}=await h.get("/api/pbn/generate-pbn-number",{params:{company_id:a,sugar_type:R}}),r=n.pbn_number;N(r);const c=await h.post("/api/pbn/save-main",{sugar_type:R,crop_year:x,pbn_date:X,vend_code:l,vendor_name:K,pbn_number:r,posted_flag:_,company_id:a});await me();const{id:d}=c.data;q(d),U(d.toString()),S(I([G()])),F(!0),Y(!0),b.success("Main PBN Entry saved. You can now input details.")}catch(s){b.error("Failed to save PBN Entry."),console.error(s)}},qe=async(e,s)=>{const o=ae.current;if(console.log("here"),console.log("mainEntryId:",o),console.log("pbnNumber:",u),console.log("row complete?",D(e)),!o||!u||!D(e))return;const a=localStorage.getItem("user"),n=a?JSON.parse(a):null,r={...e,mill_code:se.find(c=>c.mill_name===e.mill)?.mill_id||"",pbn_entry_id:o,pbn_number:u,row:s,company_id:n.company_id,user_id:n.id,cost:Math.round(e.quantity*e.unit_cost*100)/100,total_commission:e.quantity*e.commission,total_cost:e.quantity*e.unit_cost+e.quantity*e.commission};try{if(e.persisted)await h.post("/api/pbn/update-detail",r);else{const c=await h.post("/api/pbn/save-detail",r),d={...e,id:c.data.detail_id,persisted:!0},f=[...v];f[s]=d,s===f.length-1&&f.push({mill:"",quantity:0,unit_cost:0,commission:0,cost:0,total_commission:0,total_cost:0}),S(f)}}catch(c){console.error("Auto-save failed",c)}},$e=async e=>{try{const s=localStorage.getItem("user"),o=s?JSON.parse(s):null,n=(await h.get(`/api/id/${e}`,{params:{company_id:o?.company_id}})).data;Ee(n),U(n.main.id.toString()),y(n.main.sugar_type),w(n.main.crop_year),L(n.main.vend_code),T(n.main.vendor_name),j(n.main.posted_flag===1),k(nt(n.main.pbn_date)),Y(!0);const r=Array.isArray(n.details)&&n.details.length>0?n.details.map(c=>({mill:c.mill||"",quantity:c.quantity??0,unit_cost:c.unit_cost??0,commission:c.commission??0,cost:Math.round((c.quantity??0)*(c.unit_cost??0)*100)/100,total_commission:(c.quantity??0)*(c.commission??0),total_cost:(c.quantity??0)*(c.unit_cost??0)+(c.quantity??0)*(c.commission??0),id:c.id,row:c.row,pbn_entry_id:c.pbn_entry_id,pbn_number:c.pbn_number,persisted:!0})):[{mill:"",quantity:0,unit_cost:0,commission:0,cost:0,total_commission:0,total_cost:0,persisted:!1}];z(r),q(n.main.id),N(n.main.pbn_number)}catch(s){console.error("Failed to fetch PBN data:",s)}},He=i.useMemo(()=>{const e=A.toLowerCase();return ne.filter(s=>(s.pbn_number||"").toLowerCase().includes(e)||(s.vendor_name||"").toLowerCase().includes(e)||(s.pbn_date||"").toLowerCase().includes(e)||new Date(s.pbn_date).toLocaleDateString("en-US").includes(e))},[ne,A]),Ue=()=>{if(!H){b.error("Please select or save a PBN first.");return}const e=localStorage.getItem("user"),s=e?JSON.parse(e):null,o=`/api/pbn/form-pdf/${H}?company_id=${encodeURIComponent(s?.company_id||"")}`;ye(o),Z(!0)},Ae=async()=>{try{if(!p){b.info("Please save or select a PBN first.");return}const e=localStorage.getItem("user"),s=e?JSON.parse(e):null,o=await h.get(`/api/pbn/form-excel/${p}`,{responseType:"blob",params:{company_id:s?.company_id||""}}),a=`PBN_${u||p}.xlsx`,n=o.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1],r=new Blob([o.data],{type:o.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),c=URL.createObjectURL(r),d=document.createElement("a");d.href=c,d.download=n||a,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(c)}catch(e){console.error(e),b.error("Failed to download Excel.")}};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(Qe,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-yellow-50 shadow-md rounded-lg p-6 space-y-4 border border-yellow-400",children:[t.jsx("h2",{className:"text-xl font-bold text-green-800 mb-4",children:"Purchase Book Note Entry Main"}),t.jsxs("div",{className:"flex items-end gap-2 w-full",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("input",{type:"checkbox",checked:B,onChange:()=>Pe(!B),className:"form-checkbox h-4 w-4 text-blue-600"}),t.jsx("label",{className:"text-sm font-medium text-gray-700",children:"PBN #"})]}),t.jsx("div",{className:"flex-grow",children:t.jsx(O,{label:"",value:H,onChange:$e,items:He,search:A,onSearchChange:Ce,headers:["ID","PBN Number","Sugar Type","Vendor Name","Crop Year","PBN Date"],dropdownPositionStyle:{minWidth:"1200px"},columnWidths:["30px","150px","60px","200px","80px","120px"],customKey:"pbn"})})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsx(O,{label:"Sugar Type",value:R,onChange:y,items:W.items,search:W.search,onSearchChange:W.setSearch,headers:["Sugar Type","Description"]}),t.jsx(O,{label:"Crop Year",value:x,onChange:w,items:V.items,search:V.search,onSearchChange:V.setSearch,headers:["Crop Year","FYear","TYear"]}),t.jsxs("div",{children:[t.jsx("label",{children:"PBN Date"}),t.jsx("input",{type:"date",value:X,onChange:e=>k(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsx(O,{label:"Vendor",value:l,onChange:L,items:E.items,search:E.search,onSearchChange:E.setSearch,headers:["Vendor Code","Vendor Name"]}),t.jsxs("div",{children:[t.jsx("label",{className:"block",children:"Vendor Name"}),t.jsx("input",{disabled:!0,className:"w-full border p-2 bg-green-100 text-green-900",value:K})]})]})]}),t.jsxs("div",{ref:le,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-6",children:"Purchase Book Note Details"}),ge&&t.jsx(Ve,{ref:m,data:v,colHeaders:["Mill","Quantity","Unit Cost","Commission","Cost","Total Commission","Total Cost"],columns:[{data:"mill",type:"autocomplete",source:(e,s)=>{const o=se.map(n=>n.mill_name);if(!e)return s(o);const a=String(e).toLowerCase();s(o.filter(n=>n.toLowerCase().includes(a)))},strict:!1,filter:!0,allowInvalid:!1,visibleRows:10,trimDropdown:!1},{data:"quantity",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"unit_cost",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"commission",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"cost",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"total_commission",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"total_cost",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}}],afterBeginEditing:(e,s)=>{P.current=!0,requestAnimationFrame(()=>ie(e,s))},beforeKeyDown:e=>{const s=document.querySelector(".handsontableEditor.autocompleteEditor"),o=document.activeElement;if(s&&o&&s.contains(o)){const a=e.key;(a==="ArrowDown"||a==="ArrowUp"||a==="PageDown"||a==="PageUp"||a==="Home"||a==="End")&&e.stopPropagation()}if(P.current){const a=m.current?.hotInstance,n=a?.getSelectedLast();if(a&&n){const[r,c]=n;requestAnimationFrame(()=>ie(r,c))}}},afterSelectionEnd:()=>{P.current=!1},afterDeselect:()=>{P.current=!1},afterScrollVertically:()=>{if(!P.current)return;const e=m.current?.hotInstance,s=e?.getSelectedLast();if(!e||!s)return;const[o,a]=s;requestAnimationFrame(()=>te(o,a))},afterRender:()=>{if(!P.current)return;const e=m.current?.hotInstance,s=e?.getSelectedLast();if(!e||!s)return;const[o,a]=s;requestAnimationFrame(()=>te(o,a))},afterChange:(e,s)=>{if(!e||s!=="edit")return;const o=[...v];let a=!1;e.forEach(([n])=>{const r=o[n];if(!r)return;const c=r.quantity??0,d=r.unit_cost??0,f=r.commission??0;r.cost=Math.round(c*d*100)/100,r.total_commission=c*f,r.total_cost=r.cost+r.total_commission,console.log(r),D(r)&&(console.log("is it complete"),setTimeout(()=>{setTimeout(()=>{p&&D(r)&&qe(r,n)},0)},0),n===o.length-1&&(a=!0))}),a&&o.push({mill:"",quantity:0,unit_cost:0,commission:0,cost:0,total_commission:0,total_cost:0}),S(I(o))},contextMenu:{items:{remove_row:{name:"ðŸ—‘ï¸ Remove row",callback:async function(e,s){const o=s[0].start.row,a=v[o];if((await he.fire({title:"Confirm Deletion?",text:"Do you want to delete this record?",icon:"warning",showCancelButton:!0,confirmButtonText:"Delete",cancelButtonText:"Cancel"})).isConfirmed)try{await h.post("/api/pbn/delete-detail",{...a,pbn_entry_id:a.pbn_entry_id,pbn_number:a.pbn_number,row:a.id});const r=[...v];r.splice(o,1),S(r),b.success("âœ… Row deleted successfully")}catch(r){b.error("âŒ Failed to delete record"),console.error(r)}}}}},manualColumnResize:!0,stretchH:"all",width:"100%",height:Ie,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-start",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>ee(!0),onMouseLeave:()=>ee(!1),children:[t.jsxs("button",{type:"button",disabled:!g,title:g?"Download":"Save/select a PBN first",className:`inline-flex items-center gap-2 rounded border px-3 py-2 focus:outline-none ${g?"bg-white text-emerald-700 border-emerald-300 hover:bg-emerald-50 focus:ring-2 focus:ring-emerald-400":"bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed"}`,children:[t.jsx(Je,{className:`h-5 w-5 ${g?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(fe,{className:`h-4 w-4 opacity-70 ${g?"text-emerald-700":"text-gray-400"}`})]}),we&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:Ae,disabled:!g,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${g?"text-gray-800 hover:bg-emerald-50":"text-gray-400 cursor-not-allowed pointer-events-none"}`,children:[t.jsx(Ke,{className:`h-5 w-5 ${g?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"PBN Form - Excel"}),t.jsx("span",{className:`ml-auto text-[10px] font-semibold ${g?"text-emerald-600":"text-gray-400"}`,children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>re(!0),onMouseLeave:()=>re(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-400",children:[t.jsx(Ze,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(fe,{className:"h-4 w-4 opacity-70"})]}),Re&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:Ue,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(Xe,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"PBN Form - PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})})})]}),t.jsxs("button",{onClick:Te,className:"inline-flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:[t.jsx(et,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]}),t.jsxs("button",{onClick:ke,disabled:oe,className:`inline-flex items-center gap-2 px-4 py-2 rounded ${oe?"bg-gray-400 cursor-not-allowed text-white":"bg-green-600 text-white hover:bg-green-700"}`,children:[t.jsx(tt,{className:"h-5 w-5"}),t.jsx("span",{children:"Save"})]})]}),be&&t.jsx("div",{className:"fixed inset-0 z-[1000] flex items-center justify-center bg-black/50",onClick:()=>Q(!1),children:t.jsxs("div",{className:"bg-white rounded-lg shadow-2xl w-[90vw] max-w-[1100px] h-[88vh] flex flex-col",onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b",children:[t.jsx("div",{className:"font-semibold",children:"PBN Form â€“ PDF"}),t.jsx("button",{onClick:()=>Q(!1),className:"p-2 hover:bg-gray-100 rounded","aria-label":"Close",children:t.jsx(st,{className:"h-6 w-6"})})]}),t.jsx("div",{className:"flex-1",children:$?t.jsx("iframe",{title:"PBN PDF",src:$,className:"w-full h-full"}):t.jsx("div",{className:"h-full flex items-center justify-center text-gray-500",children:"Loading PDFâ€¦"})})]})}),xe&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>Z(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"âœ•"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"PBN Form PDF",src:$,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{pt as default};
