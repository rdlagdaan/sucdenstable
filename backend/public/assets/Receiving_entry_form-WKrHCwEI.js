import{n as i,j as t,F as et}from"./index-DyaD8y5Y.js";import{r as a,H as tt,a as st,N as at}from"./handsontable-7BBM75Z1.js";import{L as nt,D as G,y as o,F as rt,a as ot,S as ct,b as it}from"./DropdownWithHeaders-DlHAuVzj.js";import"./react-Csw2ODfV.js";st.cellTypes.registerCellType("numeric",at);const p=u=>Number(Math.round((u||0)*100)/100).toLocaleString("en-US",{minimumFractionDigits:2}),h=u=>u?new Date(u).toISOString().slice(0,10):"";function pt(){const u=a.useRef(null),[C,he]=a.useState(!1),[$,ge]=a.useState([]),[g,be]=a.useState(""),[l,z]=a.useState(""),[y,k]=a.useState(""),[xe,R]=a.useState(""),[ye,N]=a.useState(""),[Ne,D]=a.useState(""),[_e,_]=a.useState(""),[J,X]=a.useState(""),[f,F]=a.useState(""),[v,I]=a.useState(""),[T,O]=a.useState(!1),[A,P]=a.useState(!1),[W,L]=a.useState(""),[M,E]=a.useState(""),[Z,fe]=a.useState([]),[q,ve]=a.useState(""),[ee,te]=a.useState([]),[se,we]=a.useState(""),[w,B]=a.useState(0),[Y,H]=a.useState(0),[ae,ne]=a.useState(0),[re,oe]=a.useState(0),[ce,ie]=a.useState(0),[b,j]=a.useState([]),[je,le]=a.useState(!1),[Se,Ce]=a.useState(0),[ke,Re]=a.useState(0),[De,Fe]=a.useState(0),[Ie,Te]=a.useState(0),[Oe,Ae]=a.useState(0),[Pe,We]=a.useState(0);a.useEffect(()=>{(async()=>{const{data:e}=await i.get("/api/receiving/rr-list",{params:{include_posted:C?"1":"0",q:g}});ge(e||[])})().catch(console.error)},[C,g]),a.useEffect(()=>{(async()=>{const{data:e}=await i.get("/api/pbn/list",{params:{include_posted:"1",q}});fe(e||[])})().catch(console.error)},[q]);const Le=a.useMemo(()=>{const e=g.toLowerCase();return $.filter(s=>(s.receipt_no||"").toLowerCase().includes(e)||(s.pbn_number||"").toLowerCase().includes(e)||(s.vendor_name||"").toLowerCase().includes(e))},[$,g]),Me=async e=>{try{z(e);const{data:s}=await i.get("/api/receiving/entry",{params:{receipt_no:e}});if(k(h(s.receipt_date)||""),R(s.pbn_number||""),N(s.item_number||""),D(s.vendor_name||""),_(s.mill||""),X(s.gl_account_key||""),F(s.assoc_dues??""),I(s.others??""),O(!!s.no_storage),P(!!s.no_insurance),E(s.insurance_week?h(s.insurance_week):""),L(s.storage_week?h(s.storage_week):""),s.pbn_number){const[{data:r},{data:c},{data:d}]=await Promise.all([i.get("/api/pbn/items",{params:{pbn_number:s.pbn_number}}),i.get("/api/receiving/pbn-item",{params:{pbn_number:s.pbn_number,item_no:s.item_number}}),i.get("/api/mills/rate",{params:{mill_name:s.mill,as_of:h(s.receipt_date)}})]);te(Array.isArray(r)?r:[]),B(Number(c?.unit_cost||0)),H(Number(c?.commission||0)),ne(Number(d?.insurance_rate||0)),oe(Number(d?.storage_rate||0)),ie(Number(d?.days_free||0))}const{data:n}=await i.get("/api/receiving/details",{params:{receipt_no:e}});j(Array.isArray(n)?n.map(r=>({...r,persisted:!0})):[]),le(!0)}catch(s){console.error(s),o.error("Failed to load Receiving Entry.")}},Ee=async e=>{try{R(e);const s=Z.find(r=>r.pbn_number===e);s&&D(s.vendor_name||"");const{data:n}=await i.get("/api/pbn/items",{params:{pbn_number:e}});te(Array.isArray(n)?n:[]),N(""),_(""),B(0),H(0)}catch(s){console.error(s),o.error("Failed to load PBN items.")}},qe=async e=>{const s=ee.find(n=>String(n.row)===String(e));if(N(e),!!s){_(s.mill||""),B(Number(s.unit_cost||0)),H(Number(s.commission||0));try{const{data:n}=await i.get("/api/mills/rate",{params:{mill_name:s.mill,as_of:y||void 0}});ne(Number(n?.insurance_rate||0)),oe(Number(n?.storage_rate||0)),ie(Number(n?.days_free||0))}catch{}}},Be=(e,s)=>{const n=(new Date(s).getTime()-new Date(e).getTime())/864e5;return Math.ceil(Math.abs(n)/30)},Ye=(e,s,n)=>{let r=(new Date(s).getTime()-new Date(e).getTime())/864e5;return r-=n,r<0&&(r=0),Math.floor(r/30)},He=e=>{let s=0,n=0,r=0,c=0,d=0,ue=0;const S=y||"",ze=M||"",Je=W||"";e.forEach(m=>{const x=Number(m.quantity||0),Xe=Number(m.liens||0);s+=x,n+=Xe;const me=ze||(m.week_ending?h(m.week_ending):""),pe=Je||(m.week_ending?h(m.week_ending):"");let U=0;if(me&&S&&!A){const K=Be(me,S);U=x*(ae||0)*K}let V=0;if(pe&&S&&!T){const K=Ye(pe,S,ce||0);V=x*(re||0)*K}const Ze=x*(w||0)-(Y||0);c+=U,r+=V,d+=Ze,ue+=x*(w||0)-U-V}),Ce(s),Re(n),Fe(r),Te(c),Ae(d),We(ue)};a.useEffect(()=>{He(b)},[b,y,M,W,A,T,w,Y,ae,re,ce]);const de=async(e,s)=>{l&&await i.post("/api/receiving/update-flag",{receipt_no:l,field:e,value:s?1:0})},Q=async(e,s)=>{l&&await i.post("/api/receiving/update-date",{receipt_no:l,field:e,value:s||null})},Qe=async e=>{O(e);try{await de("no_storage",e),o.success("Storage flag updated")}catch{o.error("Failed to update storage flag")}},Ue=async e=>{P(e);try{await de("no_insurance",e),o.success("Insurance flag updated")}catch{o.error("Failed to update insurance flag")}},Ve=async e=>{L(e);try{await Q("storage_week",e)}catch{o.error("Failed to update Storage Week")}},Ke=async e=>{E(e);try{await Q("insurance_week",e)}catch{o.error("Failed to update Insurance Week")}},Ge=async e=>{k(e);try{await Q("receipt_date",e),o.success("Date Received updated")}catch{o.error("Failed to update Date Received")}},$e=async(e,s)=>{if(l)try{const n={receipt_no:l,row_index:s,row:e},{data:r}=await i.post("/api/receiving/batch-insert",n),c=r?.id;if(c){const d=[...b];d[s]={...e,id:c,persisted:!0},j(d)}}catch(n){console.error(n),o.error("Auto-save failed.")}};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(nt,{position:"top-right",autoClose:2500}),t.jsxs("div",{className:"bg-yellow-50 shadow rounded-lg p-4 border border-yellow-300 space-y-4",children:[t.jsx("h2",{className:"text-lg font-bold text-slate-700",children:"RECEIVING ENTRY"}),t.jsxs("div",{className:"grid grid-cols-12 gap-3 items-end",children:[t.jsxs("div",{className:"col-span-8",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Receiving #"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:C,onChange:()=>he(e=>!e),title:"Include posted"}),t.jsx("div",{className:"flex-1",children:t.jsx(G,{label:"",value:l,onChange:Me,items:Le.map(e=>({code:e.receipt_no,label:e.receipt_no,description:e.vendor_name,quantity:e.quantity,pbn_number:e.pbn_number,sugar_type:e.sugar_type,receipt_date:e.receipt_date})),search:g,onSearchChange:be,headers:["Receipt No","Quantity","Sugar Type","PBN No","RDate","Vendor ID","Vendor Name"],columnWidths:["140px","100px","80px","120px","110px","120px","240px"],dropdownPositionStyle:{minWidth:"1000px"},customKey:"rr",inputClassName:"w-full border p-2 rounded bg-green-100"})})]})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Date Received"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"date",value:y,onChange:e=>Ge(e.target.value),className:"w-full border p-2 rounded bg-yellow-100"}),t.jsx("span",{className:"inline-flex items-center text-xs px-2 rounded border",children:"UD"})]})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-8",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"PBN #"}),t.jsx(G,{label:"",value:xe,onChange:Ee,items:Z.map(e=>({code:e.pbn_number,label:e.pbn_number,sugar_type:e.sugar_type,vendor_code:e.vendor_code,vendor_name:e.vendor_name,crop_year:e.crop_year,pbn_date:e.pbn_date})),search:q,onSearchChange:ve,headers:["PBN No.","Sugar Type","Vendor ID","Vendor Name","Crop Year","PBN Date"],columnWidths:["120px","90px","100px","280px","90px","120px"],dropdownPositionStyle:{minWidth:"900px"},customKey:"pbn",inputClassName:"w-full border p-2 rounded bg-yellow-100"})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Item #"}),t.jsx(G,{label:"",value:ye,onChange:qe,items:ee.filter(e=>[String(e.row),e.mill,String(e.quantity??"")].join(" ").toLowerCase().includes(se.toLowerCase())).map(e=>({code:String(e.row),label:String(e.row),mill:e.mill,quantity:e.quantity,unit_cost:e.unit_cost,commission:e.commission})),search:se,onSearchChange:we,headers:["Item","MillMark","Quantity","BCost","CCost"],columnWidths:["80px","260px","120px","120px","120px"],dropdownPositionStyle:{minWidth:"750px"},customKey:"pbnitem",inputClassName:"w-full border p-2 rounded bg-yellow-100"})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-8",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Vendor Name"}),t.jsx("input",{value:Ne,disabled:!0,className:"w-full border p-2 bg-yellow-100 rounded"})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Mill"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{value:_e,disabled:!0,className:"w-full border p-2 bg-yellow-100 rounded"}),t.jsx("span",{className:"inline-flex items-center text-xs px-2 rounded border",children:"UM"})]})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-6 flex items-center gap-3",children:[t.jsxs("label",{className:"inline-flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:T,onChange:e=>Qe(e.target.checked)}),t.jsx("span",{children:"No Storage"})]}),t.jsxs("label",{className:"inline-flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:A,onChange:e=>Ue(e.target.checked)}),t.jsx("span",{children:"No Insurance"})]})]}),t.jsxs("div",{className:"col-span-3",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Storage Week"}),t.jsx("input",{type:"date",value:W,onChange:e=>Ve(e.target.value),className:"w-full border p-2 bg-white rounded"})]}),t.jsxs("div",{className:"col-span-3",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Insurance Week"}),t.jsx("input",{type:"date",value:M,onChange:e=>Ke(e.target.value),className:"w-full border p-2 bg-white rounded"})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm",children:"GL Account"}),t.jsx("input",{value:J,onChange:e=>X(e.target.value),onBlur:async()=>{if(l)try{await i.post("/api/receiving/update-gl",{receipt_no:l,gl_account_key:J}),o.success("GL Account updated")}catch{o.error("Failed to update GL Account")}},className:"w-full border p-2 rounded"})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm",children:"Assoc Dues"}),t.jsx("input",{type:"number",step:"0.01",value:f,onChange:e=>F(e.target.value===""?"":Number(e.target.value)),onBlur:async()=>{if(l)try{await i.post("/api/receiving/update-assoc-others",{receipt_no:l,assoc_dues:Number(f||0),others:Number(v||0)}),o.success("Assoc/Others saved")}catch{o.error("Failed to save Assoc/Others")}},className:"w-full border p-2 rounded"})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm",children:"Others"}),t.jsx("input",{type:"number",step:"0.01",value:v,onChange:e=>I(e.target.value===""?"":Number(e.target.value)),onBlur:async()=>{if(l)try{await i.post("/api/receiving/update-assoc-others",{receipt_no:l,assoc_dues:Number(f||0),others:Number(v||0)}),o.success("Assoc/Others saved")}catch{o.error("Failed to save Assoc/Others")}},className:"w-full border p-2 rounded"})]})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-gray-800 mb-2",children:"Details"}),je&&t.jsx(tt,{ref:u,data:b,colHeaders:["Quedan #","Quantity","Liens","Week Ending","Date Issued","Planter TIN","Planter Name","Item","Mill","Unit Cost","Commission","Storage","Insurance","Total AP"],columns:[{data:"quedan_no",type:"text"},{data:"quantity",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"liens",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"week_ending",type:"date",dateFormat:"YYYY-MM-DD",correctFormat:!0},{data:"date_issued",type:"date",dateFormat:"YYYY-MM-DD",correctFormat:!0},{data:"planter_tin",type:"text"},{data:"planter_name",readOnly:!0},{data:"item_no",readOnly:!0},{data:"mill",readOnly:!0},{data:"unit_cost",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"commission",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"storage",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"insurance",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"total_ap",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}}],stretchH:"all",height:420,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation",afterChange:(e,s)=>{if(!e||s!=="edit")return;const n=[...b];e.forEach(([r])=>{const c={...n[r]||{}};c.unit_cost=w,c.commission=Y,n[r]=c,c.quedan_no&&c.quantity!=null&&$e(c,r)}),j(n)}})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[t.jsxs("div",{children:[" Total Quantity__ ",t.jsx("span",{className:"font-semibold",children:p(Se)})," "]}),t.jsxs("div",{children:[" Total Insurance_ ",t.jsx("span",{className:"font-semibold",children:p(Ie)})," "]}),t.jsxs("div",{children:[" Total Cost______ ",t.jsx("span",{className:"font-semibold",children:p(Oe)})," "]}),t.jsxs("div",{children:[" Total Liens_____ ",t.jsx("span",{className:"font-semibold",children:p(ke)})," "]}),t.jsxs("div",{children:[" Total Storage___ ",t.jsx("span",{className:"font-semibold",children:p(De)})," "]}),t.jsxs("div",{children:["Total AP Cost___"," ",t.jsx("span",{className:"font-semibold",children:p(Pe+Number(f||0)+Number(v||0))})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white",children:[t.jsx(rt,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(et,{className:"h-4 w-4"})]}),t.jsxs("button",{className:"inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700",onClick:()=>{z(""),le(!1),j([]),k(""),R(""),N(""),D(""),_(""),F(""),I(""),P(!1),O(!1),E(""),L(""),o.success("Ready for new Receiving Entry")},children:[t.jsx(ot,{className:"h-5 w-5"}),"New"]}),t.jsxs("button",{className:"inline-flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",onClick:()=>ct.fire({title:"Saved",icon:"success",timer:1200,showConfirmButton:!1}),children:[t.jsx(it,{className:"h-5 w-5"}),"Save"]})]})]})}export{pt as default};
