import{n as l,j as a,F as xe}from"./index-CutKpBaI.js";import{r as n,H as ct,a as ye,N as ot}from"./handsontable-7BBM75Z1.js";/* empty css                              */import{S as b,F as rt,a as dt,b as ge}from"./sweetalert2.esm.all-B4pNkPRF.js";import{L as lt,D as w,b as be,y as p,F as pt,a as ut}from"./DropdownWithHeaders-DMY6N6Qu.js";import"./react-Csw2ODfV.js";ye.cellTypes.registerCellType("numeric",ot);const k=m=>(m||"").split(";")[0],fe=m=>m?new Date(m).toString()==="Invalid Date"?(m||"").split("T")[0]:new Date(m).toISOString().slice(0,10):"";function yt(){const m=n.useRef(null),[_e,T]=n.useState(""),[z,E]=n.useState(""),[Y,A]=n.useState(""),[S,P]=n.useState(""),[W,$]=n.useState(""),[q,L]=n.useState(""),[X,M]=n.useState(""),[G,F]=n.useState(""),[J,O]=n.useState(""),[we,K]=n.useState(""),[r,B]=n.useState(null),[v,f]=n.useState(!1),[y,_]=n.useState(!0),[H,Q]=n.useState([]),[N,Z]=n.useState([]),[Se,ee]=n.useState([]),[ve,te]=n.useState([]),[Ne,ae]=n.useState([]),[je,Ce]=n.useState(""),[De,Re]=n.useState(""),[ke,Te]=n.useState(""),[Ee,Ae]=n.useState(""),[Pe,se]=n.useState(""),[I,ne]=n.useState(""),[ie,ce]=n.useState([]),[j,x]=n.useState([{acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}]),[oe,U]=n.useState(!1),[$e,re]=n.useState(!1),[Le,de]=n.useState(!1),[Me,Fe]=n.useState(void 0),[Oe,le]=n.useState(!1),pe=n.useRef(null),[ue,Be]=n.useState(600);n.useLayoutEffect(()=>{const e=()=>{const t=pe.current?.getBoundingClientRect()?.top??0,i=window.innerHeight-t-140;Be(Math.max(320,Math.floor(i)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const He=28,Ie=32,Ue=240,Ve=n.useMemo(()=>{const e=Math.max(j.length,6),s=Ie+e*He+Ue;return Math.min(s,ue)},[j.length,ue]),d=n.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);n.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/pj/vendors",{params:{company_id:d?.company_id}}),s=(e||[]).map(t=>({code:String(t.code??t.vend_code??t.vendor_id??""),description:t.description??t.vend_name??t.vendor_name??"",label:t.label??t.code??""}));Q(s)}catch{Q([])}})()},[d?.company_id]),n.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/pj/accounts",{params:{company_id:d?.company_id}});Z(Array.isArray(e)?e:[])}catch{Z([])}})()},[d?.company_id]),n.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/sugar-types"),s=(Array.isArray(e)?e:[]).map(t=>({code:String(t.code??t.sugar_code??t.sugar_type??t.type??""),description:String(t.description??t.sugar_desc??t.name??t.code??""),label:String(t.code??t.sugar_code??t.sugar_type??"")}));ee(s)}catch{ee([])}})()},[]),n.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/crop-years"),s=(Array.isArray(e)?e:[]).map(t=>({code:String(t.code??t.crop_year??t.year??""),description:String(t.description??t.crop_year??t.year??""),label:String(t.code??t.crop_year??t.year??"")}));te(s)}catch{te([])}})()},[]);const ze=e=>{const s=String(e.mill_id??"").trim();if(s&&s!=="0"&&s.toLowerCase()!=="null")return s;const t=String(e.prefix??"").trim();return t||String(e.code??e.code_id??e.mill_code??"")},Ye=async e=>{try{const s={company_id:d?.company_id};e&&(s.as_of=e);const t=e?"/api/mills/effective":"/api/mills",{data:i}=await l.get(t,{params:s}),c=(Array.isArray(i)?i:[]).map(o=>{const u=ze(o);return{code:u,label:u,description:String(o.mill_name??o.description??""),mill_id:o.mill_id,mill_name:o.mill_name,prefix:o.prefix}});ae(c)}catch{ae([])}};n.useEffect(()=>{Ye(S||void 0)},[S]);const C=async()=>{try{const{data:e}=await l.get("/api/purchase/list",{params:{company_id:d?.company_id||"",q:I||""}});ce(Array.isArray(e)?e:[])}catch{ce([])}};n.useEffect(()=>{C()},[I]);const We=n.useMemo(()=>(ie||[]).map(e=>({code:String(e.id),cp_no:e.cp_no,vendor_id:e.vendor_id,purchase_date:fe(e.purchase_date),purchase_amount:e.purchase_amount,invoice_no:e.invoice_no,label:e.cp_no,description:e.vendor_id})),[ie]),qe=n.useMemo(()=>N.map(e=>`${e.acct_code};${e.acct_desc}`),[N]),V=e=>N.find(s=>s.acct_code===e)?.acct_desc||"",g=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),me=()=>{se(""),ne(""),T(""),E(""),A(""),P(""),$(""),L(""),M(""),F(""),O(""),K(""),B(null),f(!1),_(!1),U(!1),x([g()])},Xe=async()=>{if((await b.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed){try{if((await l.get("/api/purchase/unbalanced-exists",{params:{company_id:d?.company_id||""}})).data?.exists){const t=await l.get("/api/purchase/unbalanced",{params:{company_id:d?.company_id||"",limit:20}}),o=`
          <div style="text-align:left">
            <div style="margin-bottom:8px">There are unbalanced purchase transactions. Please balance them first.</div>
            <table style="width:100%;border-collapse:collapse;font-size:12px">
              <thead>
                <tr>
                  <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 8px">CP #</th>
                  <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 8px">Vendor</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Debit</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Credit</th>
                </tr>
              </thead>
              <tbody>${(Array.isArray(t.data?.items)?t.data.items:[]).map(u=>`
          <tr>
            <td style="padding:6px 8px">${u.cp_no}</td>
            <td style="padding:6px 8px">${u.vendor_id}</td>
            <td style="padding:6px 8px;text-align:right">${Number(u.sum_debit||0).toLocaleString()}</td>
            <td style="padding:6px 8px;text-align:right">${Number(u.sum_credit||0).toLocaleString()}</td>
          </tr>`).join("")||'<tr><td colspan="4" style="padding:6px 8px;color:#6b7280">No detail</td></tr>'}</tbody>
            </table>
          </div>`;await b.fire({icon:"warning",title:"Unbalanced transactions found",html:o,confirmButtonText:"OK"});return}}catch{}try{const s=await l.get("/api/purchase/generate-cp-number",{params:{company_id:d?.company_id}}),t=s.data?.cp_no??s.data;T(t);const i=await l.post("/api/purchase/save-main",{cp_no:t,vendor_id:z,purchase_date:S,explanation:G,invoice_no:we,company_id:d?.company_id,user_id:d?.id,crop_year:W,sugar_type:q,mill_id:X,booking_no:J});B(i.data.id),U(!0),x([g(),g()]),p.success("Main saved. You can now input details."),C(),f(!0),_(!1)}catch(s){p.error(s?.response?.data?.message||"Failed to save.")}}},Ge=()=>{f(!1),_(!1),p.success("Editing enabled.")},Je=async()=>{if(!(!r||!(await b.fire({title:"Cancel this transaction?",text:"This will mark the transaction as CANCELLED.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, cancel it"})).isConfirmed))try{await l.post("/api/purchase/cancel",{id:r,flag:"1",company_id:d?.company_id||""}),f(!0),_(!0),p.success("Transaction has been cancelled."),C()}catch{p.error("Failed to cancel transaction.")}},Ke=async()=>{if(!(!r||!(await b.fire({title:"Delete this transaction?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await l.delete(`/api/purchase/${r}`),me(),p.success("Transaction deleted."),C()}catch{p.error("Failed to delete transaction.")}},Qe=e=>!!k(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,he=async(e,s)=>{if(!r||!Qe(e))return;const t=k(e.acct_code);try{if(e.persisted)await l.post("/api/purchase/update-detail",{id:e.id,transaction_id:r,acct_code:t,debit:e.debit||0,credit:e.credit||0});else{const i=await l.post("/api/purchase/save-detail",{transaction_id:r,acct_code:t,debit:e.debit||0,credit:e.credit||0,company_id:d?.company_id,user_id:d?.id}),c=m.current?.hotInstance?.getSourceData()||[];c[s]&&(c[s].persisted=!0,c[s].id=i.data.detail_id),x([...c,...c.find(o=>!o.acct_code)?[]:[g()]])}}catch(i){p.error(i?.response?.data?.message||"Row save failed")}},Ze=async e=>{if(e)try{se(e);const{data:s}=await l.get(`/api/purchase/${e}`,{params:{company_id:d?.company_id}}),t=s.main??s;B(t.id),T(t.cp_no),E(String(t.vendor_id||""));const i=H.find(o=>String(o.code)===String(t.vendor_id));A(i?.description||i?.label||""),P(fe(t.purchase_date)),F(t.explanation??""),K(t.invoice_no??""),$(String(t.crop_year??"")),L(String(t.sugar_type??"")),M(String(t.mill_id??"")),O(String(t.booking_no??""));const c=(s.details||[]).map(o=>({id:o.id,acct_code:`${o.acct_code};${o.acct_desc||V(o.acct_code)}`,acct_desc:o.acct_desc,debit:Number(o.debit??0),credit:Number(o.credit??0),persisted:!0}));x(c.length?c.concat([g()]):[g()]),U(!0),f(!0),_(!0),p.success("Transaction loaded.")}catch{p.error("Unable to load the selected transaction.")}},et=()=>{if(!r)return p.info("Select or save a transaction first.");const e=`/api/purchase/form-pdf/${r}?company_id=${encodeURIComponent(d?.company_id||"")}`;Fe(e),le(!0)},tt=async()=>{if(!r)return p.info("Select or save a transaction first.");const e=await l.get(`/api/purchase/form-excel/${r}`,{responseType:"blob",params:{company_id:d?.company_id||""}}),s=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`PurchaseVoucher_${_e||r}.xlsx`,t=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),i=URL.createObjectURL(t),c=document.createElement("a");c.href=i,c.download=s,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(i)},at=0,st=(e,s)=>{if(y||s!==at)return;const i=m.current?.hotInstance?.getActiveEditor();i?.cellProperties?.type==="autocomplete"&&(i.TEXTAREA.value="",i.query="",i.open(),i.refreshDropdown?.())},nt=async()=>{const e=j.some(t=>t.acct_code&&t.acct_code.trim()!==""||(Number(t.debit)||0)>0||(Number(t.credit)||0)>0);(await b.fire({title:"Start a new transaction?",text:e?"This will clear the current form.":"",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, New"})).isConfirmed&&(me(),p.success("Form is ready for a new entry."))};return a.jsxs("div",{className:"space-y-4 p-6",children:[a.jsx(lt,{position:"top-right",autoClose:3e3}),a.jsxs("div",{className:"bg-blue-50 shadow-md rounded-lg p-6 space-y-4 border border-blue-300",children:[a.jsx("h2",{className:"text-xl font-bold text-blue-800 mb-2",children:"PURCHASE JOURNAL"}),a.jsxs("div",{className:"text-xs text-gray-500",children:["accounts: ",N.length," | hotEnabled: ",String(oe)," | locked: ",String(v)," | gridLocked: ",String(y)]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsx("div",{className:"col-span-2",children:a.jsx(w,{label:"Search Transaction",value:Pe,onChange:e=>Ze(e),items:We,search:I,onSearchChange:ne,headers:["Id","Purchase No","Vendor","Date","Amount","Vendor Inv #"],columnWidths:["60px","120px","160px","110px","120px","120px"],dropdownPositionStyle:{width:"820px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsxs("div",{children:[a.jsx(w,{label:"Vendor",value:z,onChange:e=>{E(e);const s=H.find(t=>String(t.code)===String(e));A(s?.description||"")},items:H,search:je,onSearchChange:Ce,headers:["Code","Description"],columnWidths:["140px","520px"],dropdownPositionStyle:{width:"700px"},inputClassName:"p-2 text-sm bg-white"}),Y&&a.jsxs("div",{className:"mt-1 text-xs font-semibold text-gray-700",children:["Vendor: ",Y]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1",children:"Date"}),a.jsx("input",{type:"date",value:S,disabled:v,onChange:e=>P(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),a.jsx("div",{children:a.jsx(w,{label:"Crop Year",value:W,onChange:$,items:ve,search:ke,onSearchChange:Te,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsx("div",{children:a.jsx(w,{label:"Sugar Type",value:q,onChange:L,items:Se,search:De,onSearchChange:Re,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsx("div",{children:a.jsx(w,{label:"Mill Code",value:X,onChange:M,items:Ne,search:Ee,onSearchChange:Ae,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1",children:"Explanation"}),a.jsx("input",{value:G,disabled:v,onChange:e=>F(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1",children:"Booking #"}),a.jsx("input",{value:J,disabled:v,onChange:e=>O(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),a.jsx("div",{})]}),a.jsx("div",{className:"flex gap-2 mt-3",children:r?a.jsxs(a.Fragment,{children:[a.jsxs("button",{onClick:Ge,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700",children:[a.jsx(be,{className:"h-5 w-5"}),"Update"]}),a.jsx("button",{onClick:Je,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:"Cancel"}),a.jsx("button",{onClick:Ke,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:"Delete"})]}):a.jsxs("button",{onClick:Xe,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[a.jsx(be,{className:"h-5 w-5"}),"Save"]})})]}),a.jsxs("div",{ref:pe,className:"relative z-0",children:[a.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),oe&&a.jsx(ct,{className:"hot-enhanced",ref:m,data:j,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,s)=>{const t=qe;if(!e)return s(t);const i=String(e).toLowerCase();s(t.filter(c=>c.toLowerCase().includes(i)))},filter:!0,strict:!0,allowInvalid:!1,visibleRows:12,readOnly:y,renderer:(e,s,t,i,c,o,u)=>{const h=k(String(o??""));ye.renderers.TextRenderer(e,s,t,i,c,h,u)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:y},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:y}],afterBeginEditing:st,afterChange:(e,s)=>{const t=m.current?.hotInstance;!e||!t||s==="edit"&&(e.forEach(([i,c,o,u])=>{if(c==="acct_code"){const h=String(u||""),D=k(h);t.setDataAtRowProp(i,"acct_desc",V(D));const R={...t.getSourceDataAtRow(i)},it={id:R.id,acct_code:h,acct_desc:V(D),debit:Number(R.debit||0),credit:Number(R.credit||0),persisted:!!R.persisted};setTimeout(()=>he(it,i),0)}if(c==="debit"||c==="credit"){const h={...t.getSourceDataAtRow(i)},D={...h,acct_code:h.acct_code,debit:Number(c==="debit"?u:h.debit||0),credit:Number(c==="credit"?u:h.credit||0)};setTimeout(()=>he(D,i),0)}}),requestAnimationFrame(()=>{const i=t.getSourceData();i.find(c=>!c.acct_code)||i.push(g()),x([...i])}))},contextMenu:{items:{remove_row:{name:"🗑️ Remove row",callback:async(e,s)=>{const t=m.current?.hotInstance,i=s[0].start.row,c=t?.getSourceData()||[],o=c[i];if(!o?.id){c.splice(i,1),x([...c]);return}(await b.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed&&(await l.post("/api/purchase/delete-detail",{id:o.id,transaction_id:r}),c.splice(i,1),x([...c]),p.success("Row deleted"))}}}},manualColumnResize:!0,stretchH:"all",height:Ve,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),a.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[a.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>de(!0),onMouseLeave:()=>de(!1),children:[a.jsxs("button",{type:"button",disabled:!r,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${r?"bg-white text-blue-700 border-blue-300 hover:bg-blue-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[a.jsx(rt,{className:`h-5 w-5 ${r?"text-blue-600":"text-gray-400"}`}),a.jsx("span",{children:"Download"}),a.jsx(xe,{className:"h-4 w-4 opacity-70"})]}),Le&&a.jsx("div",{className:"absolute left-0 top-full z-50",children:a.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:a.jsxs("button",{type:"button",onClick:tt,disabled:!r,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${r?"text-gray-800 hover:bg-blue-50":"text-gray-400 cursor-not-allowed"}`,children:[a.jsx(dt,{className:`h-5 w-5 ${r?"text-blue-600":"text-gray-400"}`}),a.jsx("span",{className:"truncate",children:"Purchase Voucher – Excel"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),a.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>re(!0),onMouseLeave:()=>re(!1),children:[a.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[a.jsx(pt,{className:"h-5 w-5"}),a.jsx("span",{children:"Print"}),a.jsx(xe,{className:"h-4 w-4 opacity-70"})]}),$e&&a.jsx("div",{className:"absolute left-0 top-full z-50",children:a.jsxs("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:[a.jsxs("button",{type:"button",onClick:et,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[a.jsx(ge,{className:"h-5 w-5 text-red-600"}),a.jsx("span",{className:"truncate",children:"Purchase Voucher – PDF"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]}),a.jsxs("button",{type:"button",onClick:()=>{if(!r)return p.info("Select or save a transaction.");window.open(`/api/purchase/check-pdf/${r}?company_id=${encodeURIComponent(d?.company_id||"")}`,"_blank")},className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[a.jsx(ge,{className:"h-5 w-5 text-red-600"}),a.jsx("span",{className:"truncate",children:"Print Check – PDF"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})]})})]}),a.jsxs("button",{type:"button",onClick:nt,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700",title:"Start a new transaction",children:[a.jsx(ut,{className:"h-5 w-5"}),a.jsx("span",{children:"New"})]})]}),Oe&&a.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:a.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[a.jsx("button",{onClick:()=>le(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"✕"}),a.jsx("div",{className:"h-full w-full pt-8",children:a.jsx("iframe",{title:"Purchase Voucher PDF",src:Me,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{yt as default};
