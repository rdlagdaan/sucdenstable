import{n as l,j as a,F as be}from"./index-DFJWNKDg.js";import{r as n,H as pt,a as we,N as ut}from"./handsontable-7BBM75Z1.js";/* empty css                              */import{S as b,F as mt,a as ht,b as ye}from"./sweetalert2.esm.all-B4pNkPRF.js";import{L as xt,D as y,b as fe,y as u,F as gt,a as bt}from"./DropdownWithHeaders-Cxy4pNzd.js";import"./react-Csw2ODfV.js";we.cellTypes.registerCellType("numeric",ut);const E=m=>(m||"").split(";")[0],_e=m=>m?new Date(m).toString()==="Invalid Date"?(m||"").split("T")[0]:new Date(m).toISOString().slice(0,10):"";function Nt(){const m=n.useRef(null),[Se,P]=n.useState(""),[f,A]=n.useState(""),[X,$]=n.useState(""),[j,L]=n.useState(""),[_,M]=n.useState(""),[w,F]=n.useState(""),[G,O]=n.useState(""),[J,B]=n.useState(""),[K,H]=n.useState(""),[ve,Q]=n.useState(""),[r,I]=n.useState(null),[U,S]=n.useState(!1),[v,N]=n.useState(!0),[V,Z]=n.useState([]),[C,ee]=n.useState([]),[Ne,te]=n.useState([]),[je,ae]=n.useState([]),[Ce,se]=n.useState([]),[De,Re]=n.useState(""),[ke,Te]=n.useState(""),[Ee,Pe]=n.useState(""),[Ae,$e]=n.useState(""),[Le,ne]=n.useState(""),[Y,ce]=n.useState(""),[oe,ie]=n.useState([]),[D,x]=n.useState([{acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}]),[re,W]=n.useState(!1),[Me,de]=n.useState(!1),[Fe,le]=n.useState(!1),[Oe,Be]=n.useState(void 0),[He,pe]=n.useState(!1),[Ie,ue]=n.useState([]),[z,Ue]=n.useState(""),me=n.useRef(null),[he,Ve]=n.useState(600);n.useLayoutEffect(()=>{const e=()=>{const t=me.current?.getBoundingClientRect()?.top??0,s=window.innerHeight-t-140;Ve(Math.max(320,Math.floor(s)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const Ye=28,We=32,ze=240,qe=n.useMemo(()=>{const e=Math.max(D.length,6),c=We+e*Ye+ze;return Math.min(c,he)},[D.length,he]),d=n.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);n.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/pj/vendors",{params:{company_id:d?.company_id}}),c=(e||[]).map(t=>({code:String(t.code??t.vend_code??t.vendor_id??""),description:t.description??t.vend_name??t.vendor_name??"",label:t.label??t.code??""}));Z(c)}catch{Z([])}})()},[d?.company_id]),n.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/pj/accounts",{params:{company_id:d?.company_id}});ee(Array.isArray(e)?e:[])}catch{ee([])}})()},[d?.company_id]),n.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/sugar-types"),c=(Array.isArray(e)?e:[]).map(t=>({code:String(t.code??t.sugar_code??t.sugar_type??t.type??""),description:String(t.description??t.sugar_desc??t.name??t.code??""),label:String(t.code??t.sugar_code??t.sugar_type??"")}));te(c)}catch{te([])}})()},[]),n.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/crop-years"),c=(Array.isArray(e)?e:[]).map(t=>({code:String(t.code??t.crop_year??t.year??""),description:String(t.description??t.crop_year??t.year??""),label:String(t.code??t.crop_year??t.year??"")}));ae(c)}catch{ae([])}})()},[]);const Xe=async e=>{try{const c={company_id:d?.company_id};e&&(c.as_of=e);const t=e?"/api/mills/effective":"/api/mills",{data:s}=await l.get(t,{params:c}),o=(Array.isArray(s)?s:[]).map(i=>{const p=String(i.mill_id??"").trim();return{code:p&&p!=="0"&&p.toLowerCase()!=="null"?p:String(i.prefix??"").trim(),description:String(i.mill_name??"").trim()}}).filter(i=>i.code);se(o)}catch{se([])}};n.useEffect(()=>{Xe(j||void 0)},[j]);const R=async()=>{try{const{data:e}=await l.get("/api/purchase/list",{params:{company_id:d?.company_id||"",q:Y||""}});ie(Array.isArray(e)?e:[])}catch{ie([])}};n.useEffect(()=>{R()},[Y]);const Ge=n.useMemo(()=>(oe||[]).map(e=>({code:String(e.id),cp_no:e.cp_no,vendor_id:e.vendor_id,purchase_date:_e(e.purchase_date),purchase_amount:e.purchase_amount,invoice_no:e.invoice_no,label:e.cp_no,description:e.vendor_id})),[oe]),Je=n.useMemo(()=>C.map(e=>`${e.acct_code};${e.acct_desc}`),[C]),q=e=>C.find(c=>c.acct_code===e)?.acct_desc||"",g=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),xe=()=>{ne(""),ce(""),P(""),A(""),$(""),L(""),M(""),F(""),O(""),B(""),H(""),Q(""),I(null),S(!1),N(!1),W(!1),x([g()])},Ke=async()=>{if((await b.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed){try{if((await l.get("/api/purchase/unbalanced-exists",{params:{company_id:d?.company_id||""}})).data?.exists){const t=await l.get("/api/purchase/unbalanced",{params:{company_id:d?.company_id||"",limit:20}}),i=`
          <div style="text-align:left">
            <div style="margin-bottom:8px">There are unbalanced purchase transactions. Please balance them first.</div>
            <table style="width:100%;border-collapse:collapse;font-size:12px">
              <thead>
                <tr>
                  <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 8px">CP #</th>
                  <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 8px">Vendor</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Debit</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Credit</th>
                </tr>
              </thead>
              <tbody>${(Array.isArray(t.data?.items)?t.data.items:[]).map(p=>`
          <tr>
            <td style="padding:6px 8px">${p.cp_no}</td>
            <td style="padding:6px 8px">${p.vendor_id}</td>
            <td style="padding:6px 8px;text-align:right">${Number(p.sum_debit||0).toLocaleString()}</td>
            <td style="padding:6px 8px;text-align:right">${Number(p.sum_credit||0).toLocaleString()}</td>
          </tr>`).join("")||'<tr><td colspan="4" style="padding:6px 8px;color:#6b7280">No detail</td></tr>'}</tbody>
            </table>
          </div>`;await b.fire({icon:"warning",title:"Unbalanced transactions found",html:i,confirmButtonText:"OK"});return}}catch{}try{const c=await l.get("/api/purchase/generate-cp-number",{params:{company_id:d?.company_id}}),t=c.data?.cp_no??c.data;P(t);const s=await l.post("/api/purchase/save-main",{cp_no:t,vend_id:f,purchase_date:j,explanation:J,invoice_no:ve,company_id:d?.company_id,user_id:d?.id,crop_year:_,sugar_type:w,mill_id:G,booking_no:K});I(s.data.id),W(!0),x([g(),g()]),u.success("Main saved. You can now input details."),R(),S(!0),N(!1)}catch(c){u.error(c?.response?.data?.message||"Failed to save.")}}},Qe=()=>{S(!1),N(!1),u.success("Editing enabled.")},Ze=async()=>{if(!(!r||!(await b.fire({title:"Cancel this transaction?",text:"This will mark the transaction as CANCELLED.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, cancel it"})).isConfirmed))try{await l.post("/api/purchase/cancel",{id:r,flag:"1",company_id:d?.company_id||""}),S(!0),N(!0),u.success("Transaction has been cancelled."),R()}catch{u.error("Failed to cancel transaction.")}},et=async()=>{if(!(!r||!(await b.fire({title:"Delete this transaction?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await l.delete(`/api/purchase/${r}`),xe(),u.success("Transaction deleted."),R()}catch{u.error("Failed to delete transaction.")}},tt=e=>!!E(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,ge=async(e,c)=>{if(!r||!tt(e))return;const t=E(e.acct_code);try{if(e.persisted)await l.post("/api/purchase/update-detail",{id:e.id,transaction_id:r,acct_code:t,debit:e.debit||0,credit:e.credit||0});else{const s=await l.post("/api/purchase/save-detail",{transaction_id:r,acct_code:t,debit:e.debit||0,credit:e.credit||0,company_id:d?.company_id,user_id:d?.id}),o=m.current?.hotInstance?.getSourceData()||[];o[c]&&(o[c].persisted=!0,o[c].id=s.data.detail_id),x([...o,...o.find(i=>!i.acct_code)?[]:[g()]])}}catch(s){u.error(s?.response?.data?.message||"Row save failed")}},at=async e=>{if(e)try{ne(e);const{data:c}=await l.get(`/api/purchase/${e}`,{params:{company_id:d?.company_id}}),t=c.main??c;I(t.id),P(t.cp_no),A(String(t.vendor_id||""));const s=V.find(i=>String(i.code)===String(t.vendor_id));$(s?.description||s?.label||""),L(_e(t.purchase_date)),B(t.explanation??""),Q(t.invoice_no??""),M(String(t.crop_year??"")),F(String(t.sugar_type??"")),O(String(t.mill_id??"")),H(String(t.booking_no??""));const o=(c.details||[]).map(i=>({id:i.id,acct_code:`${i.acct_code};${i.acct_desc||q(i.acct_code)}`,acct_desc:i.acct_desc,debit:Number(i.debit??0),credit:Number(i.credit??0),persisted:!0}));x(o.length?o.concat([g()]):[g()]),W(!0),S(!0),N(!0),u.success("Transaction loaded.")}catch{u.error("Unable to load the selected transaction.")}},st=()=>{if(!r)return u.info("Select or save a transaction first.");const e=`/api/purchase/form-pdf/${r}?company_id=${encodeURIComponent(d?.company_id||"")}`;Be(e),pe(!0)},nt=async()=>{if(!r)return u.info("Select or save a transaction first.");const e=await l.get(`/api/purchase/form-excel/${r}`,{responseType:"blob",params:{company_id:d?.company_id||""}}),c=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`PurchaseVoucher_${Se||r}.xlsx`,t=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),s=URL.createObjectURL(t),o=document.createElement("a");o.href=s,o.download=c,document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(s)},ct=0,ot=(e,c)=>{if(v||c!==ct)return;const s=m.current?.hotInstance?.getActiveEditor();s?.cellProperties?.type==="autocomplete"&&(s.TEXTAREA.value="",s.query="",s.open(),s.refreshDropdown?.())},it=async()=>{const e=D.some(t=>t.acct_code&&t.acct_code.trim()!==""||(Number(t.debit)||0)>0||(Number(t.credit)||0)>0);(await b.fire({title:"Start a new transaction?",text:e?"This will clear the current form.":"",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, New"})).isConfirmed&&(xe(),u.success("Form is ready for a new entry."))},rt=e=>e?new Date(e).toLocaleDateString():"",dt=async()=>{try{const e={company_id:d?.company_id||"",q:z||""};f&&(e.vend_code=f),w&&(e.sugar_type=w),_&&(e.crop_year=_);const{data:c}=await l.get("/api/pbn/list",{params:e}),t=(Array.isArray(c)?c:[]).map(s=>({code:String(s.pbn_number),label:String(s.pbn_number),description:rt(s.pbn_date),vendor_name:s.vendor_name,vend_code:s.vend_code,sugar_type:s.sugar_type,crop_year:s.crop_year}));ue(t)}catch{ue([])}};return n.useEffect(()=>{dt()},[d?.company_id,f,w,_,z]),a.jsxs("div",{className:"space-y-4 p-6",children:[a.jsx(xt,{position:"top-right",autoClose:3e3}),a.jsxs("div",{className:"bg-blue-50 shadow-md rounded-lg p-6 space-y-4 border border-blue-300",children:[a.jsx("h2",{className:"text-xl font-bold text-blue-800 mb-2",children:"PURCHASE JOURNAL"}),a.jsxs("div",{className:"text-xs text-gray-500",children:["accounts: ",C.length," | hotEnabled: ",String(re)," | locked: ",String(U)," | gridLocked: ",String(v)]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsx("div",{className:"col-span-2",children:a.jsx(y,{label:"Search Transaction",value:Le,onChange:e=>at(e),items:Ge,search:Y,onSearchChange:ce,headers:["Id","Purchase No","Vendor","Date","Amount","Vendor Inv #"],columnWidths:["60px","120px","160px","110px","120px","120px"],dropdownPositionStyle:{width:"820px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsxs("div",{children:[a.jsx(y,{label:"Vendor",value:f,onChange:e=>{A(e);const c=V.find(t=>String(t.code)===String(e));$(c?.description||"")},items:V,search:De,onSearchChange:Re,headers:["Code","Description"],columnWidths:["140px","520px"],dropdownPositionStyle:{width:"700px"},inputClassName:"p-2 text-sm bg-white"}),X&&a.jsxs("div",{className:"mt-1 text-xs font-semibold text-gray-700",children:["Vendor: ",X]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1",children:"Date"}),a.jsx("input",{type:"date",value:j,disabled:U,onChange:e=>L(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),a.jsx("div",{children:a.jsx(y,{label:"Crop Year",value:_,onChange:M,items:je,search:Ee,onSearchChange:Pe,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsx("div",{children:a.jsx(y,{label:"Sugar Type",value:w,onChange:F,items:Ne,search:ke,onSearchChange:Te,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsx("div",{children:a.jsx(y,{label:"Mill Code",value:G,onChange:O,items:Ce,search:Ae,onSearchChange:$e,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1",children:"Explanation"}),a.jsx("input",{value:J,disabled:U,onChange:e=>B(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),a.jsx("div",{children:a.jsx(y,{label:"Booking #",value:K,onChange:H,items:Ie,search:z,onSearchChange:Ue,headers:["PBN No","PBN Date"],columnWidths:["140px","140px"],dropdownPositionStyle:{width:"360px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsx("div",{})]}),a.jsx("div",{className:"flex gap-2 mt-3",children:r?a.jsxs(a.Fragment,{children:[a.jsxs("button",{onClick:Qe,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700",children:[a.jsx(fe,{className:"h-5 w-5"}),"Update"]}),a.jsx("button",{onClick:Ze,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:"Cancel"}),a.jsx("button",{onClick:et,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:"Delete"})]}):a.jsxs("button",{onClick:Ke,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[a.jsx(fe,{className:"h-5 w-5"}),"Save"]})})]}),a.jsxs("div",{ref:me,className:"relative z-0",children:[a.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),re&&a.jsx(pt,{className:"hot-enhanced",ref:m,data:D,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,c)=>{const t=Je;if(!e)return c(t);const s=String(e).toLowerCase();c(t.filter(o=>o.toLowerCase().includes(s)))},filter:!0,strict:!0,allowInvalid:!1,visibleRows:12,readOnly:v,renderer:(e,c,t,s,o,i,p)=>{const h=E(String(i??""));we.renderers.TextRenderer(e,c,t,s,o,h,p)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:v},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:v}],afterBeginEditing:ot,afterChange:(e,c)=>{const t=m.current?.hotInstance;!e||!t||c==="edit"&&(e.forEach(([s,o,i,p])=>{if(o==="acct_code"){const h=String(p||""),k=E(h);t.setDataAtRowProp(s,"acct_desc",q(k));const T={...t.getSourceDataAtRow(s)},lt={id:T.id,acct_code:h,acct_desc:q(k),debit:Number(T.debit||0),credit:Number(T.credit||0),persisted:!!T.persisted};setTimeout(()=>ge(lt,s),0)}if(o==="debit"||o==="credit"){const h={...t.getSourceDataAtRow(s)},k={...h,acct_code:h.acct_code,debit:Number(o==="debit"?p:h.debit||0),credit:Number(o==="credit"?p:h.credit||0)};setTimeout(()=>ge(k,s),0)}}),requestAnimationFrame(()=>{const s=t.getSourceData();s.find(o=>!o.acct_code)||s.push(g()),x([...s])}))},contextMenu:{items:{remove_row:{name:"ðŸ—‘ï¸ Remove row",callback:async(e,c)=>{const t=m.current?.hotInstance,s=c[0].start.row,o=t?.getSourceData()||[],i=o[s];if(!i?.id){o.splice(s,1),x([...o]);return}(await b.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed&&(await l.post("/api/purchase/delete-detail",{id:i.id,transaction_id:r}),o.splice(s,1),x([...o]),u.success("Row deleted"))}}}},manualColumnResize:!0,stretchH:"all",height:qe,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),a.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[a.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>le(!0),onMouseLeave:()=>le(!1),children:[a.jsxs("button",{type:"button",disabled:!r,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${r?"bg-white text-blue-700 border-blue-300 hover:bg-blue-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[a.jsx(mt,{className:`h-5 w-5 ${r?"text-blue-600":"text-gray-400"}`}),a.jsx("span",{children:"Download"}),a.jsx(be,{className:"h-4 w-4 opacity-70"})]}),Fe&&a.jsx("div",{className:"absolute left-0 top-full z-50",children:a.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:a.jsxs("button",{type:"button",onClick:nt,disabled:!r,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${r?"text-gray-800 hover:bg-blue-50":"text-gray-400 cursor-not-allowed"}`,children:[a.jsx(ht,{className:`h-5 w-5 ${r?"text-blue-600":"text-gray-400"}`}),a.jsx("span",{className:"truncate",children:"Purchase Voucher â€“ Excel"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),a.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>de(!0),onMouseLeave:()=>de(!1),children:[a.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[a.jsx(gt,{className:"h-5 w-5"}),a.jsx("span",{children:"Print"}),a.jsx(be,{className:"h-4 w-4 opacity-70"})]}),Me&&a.jsx("div",{className:"absolute left-0 top-full z-50",children:a.jsxs("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:[a.jsxs("button",{type:"button",onClick:st,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[a.jsx(ye,{className:"h-5 w-5 text-red-600"}),a.jsx("span",{className:"truncate",children:"Purchase Voucher â€“ PDF"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]}),a.jsxs("button",{type:"button",onClick:()=>{if(!r)return u.info("Select or save a transaction.");window.open(`/api/purchase/check-pdf/${r}?company_id=${encodeURIComponent(d?.company_id||"")}`,"_blank")},className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[a.jsx(ye,{className:"h-5 w-5 text-red-600"}),a.jsx("span",{className:"truncate",children:"Print Check â€“ PDF"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})]})})]}),a.jsxs("button",{type:"button",onClick:it,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700",title:"Start a new transaction",children:[a.jsx(bt,{className:"h-5 w-5"}),a.jsx("span",{children:"New"})]})]}),He&&a.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:a.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[a.jsx("button",{onClick:()=>pe(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"âœ•"}),a.jsx("div",{className:"h-full w-full pt-8",children:a.jsx("iframe",{title:"Purchase Voucher PDF",src:Oe,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{Nt as default};
