import{n as u,j as t,F as ne}from"./index-D6_DhI4F.js";import{r,H as Me,a as ie,N as He}from"./handsontable-7BBM75Z1.js";import{L as Pe,D as ce,b as re,y as d,F as Ie,a as Ue}from"./DropdownWithHeaders-B_jafxHH.js";import{S as L,F as Be,a as Ye,b as oe}from"./sweetalert2.esm.all-B4pNkPRF.js";import"./react-Csw2ODfV.js";ie.cellTypes.registerCellType("numeric",He);function ze(p){if(!p)return"";const x=new Date(p);if(isNaN(x.getTime()))return"";const b=x.getFullYear(),S=String(x.getMonth()+1).padStart(2,"0"),g=String(x.getDate()).padStart(2,"0");return`${b}-${S}-${g}`}const O=p=>(p||"").split(";")[0];function Je(){const p=r.useRef(null),[x,b]=r.useState(""),[S,g]=r.useState(""),[Y,v]=r.useState(""),[z,j]=r.useState(""),[G,C]=r.useState(""),[V,D]=r.useState(""),[o,R]=r.useState(null),[y,w]=r.useState(!1),[A,_]=r.useState(!0),[M,W]=r.useState([]),[k,X]=r.useState([]),[le,de]=r.useState(""),[ue,H]=r.useState(""),[P,I]=r.useState(""),[q,J]=r.useState([]),[U,f]=r.useState([{acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}]),[K,E]=r.useState(!1),[me,Q]=r.useState(!1),[pe,Z]=r.useState(!1),[he,fe]=r.useState(void 0),[xe,ee]=r.useState(!1),te=r.useRef(null),[ae,be]=r.useState(600);r.useLayoutEffect(()=>{const e=()=>{const a=te.current?.getBoundingClientRect()?.top??0,s=window.innerHeight-a-140;be(Math.max(320,Math.floor(s)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const ge=28,ye=32,we=240,_e=r.useMemo(()=>{const e=Math.max(U.length,6),n=ye+e*ge+we;return Math.min(n,ae)},[U.length,ae]),l=r.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);r.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/customers",{params:{company_id:l?.company_id}}),n=(e||[]).map(a=>({code:String(a.cust_id??a.code),label:a.cust_name??a.label??"",description:a.cust_name??a.description??""}));W(n)}catch{W([])}})()},[l?.company_id]),r.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/accounts",{params:{company_id:l?.company_id}});X(Array.isArray(e)?e:[])}catch{X([])}})()},[l?.company_id]);const T=async()=>{try{const{data:e}=await u.get("/api/sales/list",{params:{company_id:l?.company_id||"",q:P||""}});J(Array.isArray(e)?e:[])}catch{J([])}};r.useEffect(()=>{T()},[P]);const Ne=r.useMemo(()=>(q||[]).map(e=>({code:String(e.id),cs_no:e.cs_no,cust_id:e.cust_id,sales_date:e.sales_date,sales_amount:e.sales_amount,si_no:e.si_no,label:e.cs_no,description:e.cust_id})),[q]),m=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),Se=()=>{H(""),I(""),b(""),g(""),v(""),j(""),C(""),D(""),R(null),w(!1),_(!1),E(!1),f([m()])},ve=async()=>{if((await L.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed)try{const n=await u.get("/api/sales/generate-cs-number",{params:{company_id:l?.company_id}}),a=n.data?.cs_no??n.data;b(a);const s=await u.post("/api/sales/save-main",{cs_no:a,cust_id:S,sales_date:z,explanation:G,si_no:V,company_id:l?.company_id,user_id:l?.id});R(s.data.id),E(!0),f([m(),m()]),d.success("Main saved. You can now input details."),T(),w(!0),_(!1)}catch(n){d.error(n?.response?.data?.message||"Failed to save.")}},je=()=>{w(!1),_(!1),d.success("Editing enabled. You can now update this transaction.")},Ce=async()=>{if(!(!o||!(await L.fire({title:"Cancel this transaction?",text:"This will mark the transaction as CANCELLED.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, cancel it"})).isConfirmed))try{await u.post("/api/sales/cancel",{id:o,is_cancel:"y",company_id:l?.company_id||""}),w(!0),_(!0),d.success("Transaction has been cancelled."),T()}catch{d.error("Failed to cancel transaction.")}},De=async()=>{if(!(!o||!(await L.fire({title:"Delete this transaction?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await u.delete(`/api/sales/${o}`),Se(),d.success("Transaction deleted."),T()}catch{d.error("Failed to delete transaction.")}},Re=e=>!!O(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,se=async(e,n)=>{if(!o||!Re(e))return;const a=O(e.acct_code);try{if(e.persisted)await u.post("/api/sales/update-detail",{id:e.id,transaction_id:o,acct_code:a,debit:e.debit||0,credit:e.credit||0});else{const s=await u.post("/api/sales/save-detail",{transaction_id:o,acct_code:a,debit:e.debit||0,credit:e.credit||0,company_id:l?.company_id,user_id:l?.id}),c=p.current?.hotInstance?.getSourceData()||[];c[n]&&(c[n].persisted=!0,c[n].id=s.data.detail_id),f([...c,...c.find(i=>!i.acct_code)?[]:[m()]])}}catch(s){d.error(s?.response?.data?.message||"Row save failed")}},ke=async e=>{if(e)try{H(e);const{data:n}=await u.get(`/api/sales/${e}`,{params:{company_id:l?.company_id}}),a=n.main??n;R(a.id),b(a.cs_no),g(String(a.cust_id||""));const s=M.find(i=>String(i.code)===String(a.cust_id));v(s?.description||s?.label||""),j(ze(a.sales_date)),C(a.explanation??""),D(a.si_no??"");const c=(n.details||[]).map(i=>({id:i.id,acct_code:`${i.acct_code};${i.acct_desc||B(i.acct_code)}`,acct_desc:i.acct_desc,debit:Number(i.debit??0),credit:Number(i.credit??0),persisted:!0}));f(c.length?c.concat([m()]):[m()]),E(!0),w(!0),_(!0),d.success("Transaction loaded.")}catch{d.error("Unable to load the selected transaction.")}},Ee=r.useMemo(()=>k.map(e=>`${e.acct_code};${e.acct_desc}`),[k]),B=e=>k.find(a=>a.acct_code===e)?.acct_desc||"",Te=()=>{if(!o)return d.info("Select or save a transaction first.");const e=`/api/sales/form-pdf/${o}?company_id=${encodeURIComponent(l?.company_id||"")}`;fe(e),ee(!0)},Fe=async()=>{if(!o)return d.info("Select or save a transaction first.");const e=await u.get(`/api/sales/form-excel/${o}`,{responseType:"blob",params:{company_id:l?.company_id||""}}),n=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`SalesVoucher_${x||o}.xlsx`,a=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),s=URL.createObjectURL(a),c=document.createElement("a");c.href=s,c.download=n,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(s)},$e=()=>{H(""),I(""),R(null),b(""),g(""),v(""),j(""),C(""),D(""),w(!1),_(!1),f([m(),m(),m(),m()]),E(!1),d.success("Form is ready for a new entry.")},Le=0,Oe=(e,n)=>{if(A||n!==Le)return;const s=p.current?.hotInstance?.getActiveEditor();s?.cellProperties?.type==="autocomplete"&&(s.TEXTAREA.value="",s.query="",s.open(),s.refreshDropdown?.())};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(Pe,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-yellow-50 shadow-md rounded-lg p-6 space-y-4 border border-yellow-400",children:[t.jsx("h2",{className:"text-xl font-bold text-green-800 mb-2",children:"SALES JOURNAL"}),t.jsxs("div",{className:"text-xs text-gray-500",children:["accounts: ",k.length," | hotEnabled: ",String(K)," | locked: ",String(y)," | gridLocked: ",String(A)]}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsx("div",{className:"col-span-3",children:t.jsx(ce,{label:"Search Transaction",value:ue,onChange:e=>ke(e),items:Ne,search:P,onSearchChange:I,headers:["ID","Sales No","Customer","Date","Amount","S.I. #"],inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-2",children:t.jsx(ce,{label:"Customer",value:S,onChange:e=>{g(e);const n=M.find(a=>String(a.code)===String(e));v(n?.description||n?.label||"")},items:M,search:le,onSearchChange:de,headers:["Code","Label","Description"],inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:z,disabled:y,onChange:e=>j(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Explanation"}),t.jsx("input",{value:G,disabled:y,onChange:e=>C(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"S.I. #"}),t.jsx("input",{value:V,disabled:y,onChange:e=>D(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),Y&&t.jsxs("div",{className:"col-span-3 text-sm font-semibold text-gray-700",children:["Customer: ",Y]})]}),t.jsx("div",{className:"flex gap-2 mt-3",children:o?t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:je,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[t.jsx(re,{className:"h-5 w-5"}),"Update"]}),t.jsx("button",{onClick:Ce,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:"Cancel"}),t.jsx("button",{onClick:De,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:"Delete"})]}):t.jsxs("button",{onClick:ve,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700",children:[t.jsx(re,{className:"h-5 w-5"}),"Save"]})})]}),t.jsxs("div",{ref:te,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),K&&t.jsx(Me,{className:"hot-enhanced",ref:p,data:U,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,n)=>{const a=Ee;if(!e)return n(a);const s=String(e).toLowerCase();n(a.filter(c=>c.toLowerCase().includes(s)))},filter:!0,strict:!0,allowInvalid:!1,visibleRows:12,readOnly:A,renderer:(e,n,a,s,c,i,N)=>{const h=O(String(i??""));ie.renderers.TextRenderer(e,n,a,s,c,h,N)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:y},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:y}],afterBeginEditing:Oe,afterChange:(e,n)=>{const a=p.current?.hotInstance;!e||!a||n==="edit"&&(e.forEach(([s,c,i,N])=>{if(c==="acct_code"){const h=String(N||""),F=O(h);a.setDataAtRowProp(s,"acct_desc",B(F));const $={...a.getSourceDataAtRow(s)},Ae={id:$.id,acct_code:h,acct_desc:B(F),debit:Number($.debit||0),credit:Number($.credit||0),persisted:!!$.persisted};setTimeout(()=>se(Ae,s),0)}if(c==="debit"||c==="credit"){const h={...a.getSourceDataAtRow(s)},F={...h,acct_code:h.acct_code,debit:Number(c==="debit"?N:h.debit||0),credit:Number(c==="credit"?N:h.credit||0)};setTimeout(()=>se(F,s),0)}}),requestAnimationFrame(()=>{const s=a.getSourceData();s.find(c=>!c.acct_code)||s.push(m()),f([...s])}))},contextMenu:{items:{remove_row:{name:"🗑️ Remove row",callback:async(e,n)=>{const a=p.current?.hotInstance,s=n[0].start.row,c=a?.getSourceData()||[],i=c[s];if(!i?.id){c.splice(s,1),f([...c]);return}(await L.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed&&(await u.post("/api/sales/delete-detail",{id:i.id,transaction_id:o}),c.splice(s,1),f([...c]),d.success("Row deleted"))}}}},manualColumnResize:!0,stretchH:"all",height:_e,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>Z(!0),onMouseLeave:()=>Z(!1),children:[t.jsxs("button",{type:"button",disabled:!o,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${o?"bg-white text-emerald-700 border-emerald-300 hover:bg-emerald-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(Be,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(ne,{className:"h-4 w-4 opacity-70"})]}),pe&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:Fe,disabled:!o,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${o?"text-gray-800 hover:bg-emerald-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx(Ye,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Sales Voucher – Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>Q(!0),onMouseLeave:()=>Q(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx(Ie,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(ne,{className:"h-4 w-4 opacity-70"})]}),me&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsxs("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:[t.jsxs("button",{type:"button",onClick:Te,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(oe,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Sales Voucher – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]}),t.jsxs("button",{type:"button",onClick:()=>{if(!o)return d.info("Select or save a transaction.");window.open(`/api/sales/check-pdf/${o}?company_id=${encodeURIComponent(l?.company_id||"")}`,"_blank")},className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(oe,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Print Check – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})]})})]}),t.jsxs("button",{type:"button",onClick:$e,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 focus:outline-none",title:"Start a new transaction",children:[t.jsx(Ue,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]})]}),xe&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>ee(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"✕"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Sales Voucher PDF",src:he,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{Je as default};
