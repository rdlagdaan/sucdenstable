import{n as g,j as t,F as fe}from"./index-hmZP66vh.js";import{r as c,H as Ve,a as ze,N as Ge}from"./handsontable-7BBM75Z1.js";import{L as Je,D as L,y,F as Xe,a as Ke,b as Qe}from"./DropdownWithHeaders-7fIjn5ql.js";import{S as he,F as Ze,a as et,b as tt}from"./sweetalert2.esm.all-B4pNkPRF.js";import"./react-Csw2ODfV.js";function st({title:d,titleId:h,...x},m){return c.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:m,"aria-labelledby":h},x),d?c.createElement("title",{id:h},d):null,c.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18 18 6M6 6l12 12"}))}const nt=c.forwardRef(st);function J(d){const[h,x]=c.useState([]),[m,v]=c.useState("");return c.useEffect(()=>{(async()=>{try{const _=await g.get(d);let N=[];d==="/api/vendors"?N=_.data.map(l=>({code:l.vend_code,description:l.vend_name})):d==="/api/crop-years"?N=_.data.map(l=>({code:l.crop_year,label:l.begin_year,description:l.end_year})):N=_.data.map(l=>({code:l.code??l.sugar_type??l.vend_code??l.crop_year,description:l.description??l.vendor_name??l.sugar_type??l.crop_year})),x(N)}catch(_){console.error(`Error fetching dropdown from ${d}`,_)}})()},[d]),{items:h.filter(w=>w.code.toString().toLowerCase().includes(m.toLowerCase())||w.label?.toString().toLowerCase().includes(m.toLowerCase())||w.description?.toString().toLowerCase().includes(m.toLowerCase())),setSearch:v,search:m}}ze.cellTypes.registerCellType("numeric",Ge);function ot(d){if(!d)return"";const h=new Date(d),x=h.getFullYear(),m=String(h.getMonth()+1).padStart(2,"0"),v=String(h.getDate()).padStart(2,"0");return`${x}-${m}-${v}`}function mt(){const d=c.useRef(null),[h,x]=c.useState(!1),[m,v]=c.useState(""),[R,w]=c.useState(""),[_,N]=c.useState(""),[l,O]=c.useState(""),[X,k]=c.useState(""),[K,T]=c.useState(""),[ge,M]=c.useState(!1),[p,q]=c.useState(null),[be,Q]=c.useState(!1),[$,ye]=c.useState(void 0),[xe,Z]=c.useState(!1),[we,ee]=c.useState(!1),b=!!p,_e=28,Ne=320,F=6,ve=220,te=(e,s)=>{const o=d.current?.hotInstance;if(!o)return;const a=o.getCell(e,s),n=document.querySelector(".handsontableEditor.autocompleteEditor");if(!a||!n)return;const r=a.getBoundingClientRect(),i=r.top-F,u=window.innerHeight-r.bottom-F,f=u>=ve||u>=i,me=Math.min(Ne,f?u:i,420),pe=Math.max(r.width,300),Ye=Math.max(8,Math.min(r.left,window.innerWidth-pe-8)),We=f?r.bottom+F:Math.max(8,r.top-me-F);n.style.left=`${Ye}px`,n.style.top=`${We}px`,n.style.maxHeight=`${Math.max(160,me)}px`,n.style.width=`${pe}px`,document.querySelector(".handsontableInput")?.focus()},[S,j]=c.useState([]),[se,Se]=c.useState([]),[ne,je]=c.useState([]),[H,U]=c.useState(""),[A,Ce]=c.useState(""),[B,Pe]=c.useState(!1),[at,Ee]=c.useState(null),[oe,Y]=c.useState(!1),W=J("/api/sugar-types"),V=J("/api/crop-years"),E=J("/api/vendors"),[C,z]=c.useState([]),ae=c.useRef(null),[Re,re]=c.useState(!1),P=c.useRef(!1),ce=260,Me=28,ie=(e,s)=>{const o=d.current?.hotInstance;if(!o)return;const a=o.getCell(e,s);if(!a)return;const n=a.getBoundingClientRect(),r=window.innerHeight-n.bottom;if(r>=ce)return;const i=ce-r,u=Math.ceil(i/Me)+1,f=Math.max(0,e-u);o.scrollViewportTo(f,s)},le=c.useRef(null),[de,Fe]=c.useState(600);c.useLayoutEffect(()=>{const e=()=>{const o=le.current?.getBoundingClientRect()?.top??0,n=window.innerHeight-o-140;Fe(Math.max(320,Math.floor(n)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const Be=32,De=240,Ie=c.useMemo(()=>{const e=Math.max(S.length,6),s=Be*1+e*_e+De;return Math.min(s,de)},[S.length,de]),D=e=>e.mill&&e.quantity!==void 0&&e.unit_cost!==void 0&&e.commission!==void 0&&e.mill!==""&&e.quantity!==""&&e.unit_cost!==""&&e.commission!=="",Le=4,G=()=>({mill:"",quantity:0,unit_cost:0,commission:0,cost:0,total_commission:0,total_cost:0,persisted:!1}),Oe=e=>!e?.mill&&!e?.quantity&&!e?.unit_cost&&!e?.commission,I=e=>{const s=[...e];let o=0;for(let n=s.length-1;n>=0&&Oe(s[n]);n--)o++;const a=Math.max(0,Le-o);for(let n=0;n<a;n++)s.push(G());return s},ue=async()=>{const e=localStorage.getItem("user"),s=e?JSON.parse(e):null,o=await g.get("/api/pbn/dropdown-list",{params:{include_posted:B.toString(),company_id:s?.company_id||""}}),a=o.data.map(n=>({...n,code:n.id.toString(),label:n.pbn_number,description:n.vendor_name??""}));console.log(o),je(a)};c.useEffect(()=>{ue()},[B]),c.useEffect(()=>{const e=localStorage.getItem("user"),o=(e?JSON.parse(e):null)?.company_id;let a=!1;async function n(){try{const{data:r}=await g.get("/api/mills",{params:{company_id:o}});a||Se((r||[]).map(i=>({mill_id:String(i.mill_id),mill_name:i.mill_name})))}catch(r){console.error("Failed to load mills",r)}}return n(),()=>{a=!0}},[]),c.useEffect(()=>{const e=E.items.find(s=>s.code===l);k(e?.description||"")},[l,E.items]),c.useEffect(()=>{p&&C.length>0&&(j(C),M(!0),z([]))},[p,C]),c.useEffect(()=>{ae.current=p},[p]),c.useEffect(()=>{p&&C.length>0&&(j(I(C)),M(!0),z([]))},[p,C]);const ke=()=>{v(""),U(""),w(""),N(""),O(""),k(""),T(""),x(!1),M(!1),q(null),j(I([G()])),Y(!1),y.success("âœ… PBN Entry form is now ready for new entry")},Te=async()=>{if((await he.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save it!"})).isConfirmed)try{const s=localStorage.getItem("user"),a=(s?JSON.parse(s):null)?.company_id;if(!a){y.error("Company ID not found in session.");return}const{data:n}=await g.get("/api/pbn/generate-pbn-number",{params:{company_id:a,sugar_type:R}}),r=n.pbn_number;v(r);const i=await g.post("/api/pbn/save-main",{sugar_type:R,crop_year:_,pbn_date:K,vend_code:l,vendor_name:X,pbn_number:r,posted_flag:h,company_id:a});await ue();const{id:u}=i.data;q(u),U(u.toString()),j(I([G()])),M(!0),Y(!0),y.success("Main PBN Entry saved. You can now input details.")}catch(s){y.error("Failed to save PBN Entry."),console.error(s)}},qe=async(e,s)=>{const o=ae.current;if(console.log("here"),console.log("mainEntryId:",o),console.log("pbnNumber:",m),console.log("row complete?",D(e)),!o||!m||!D(e))return;const a=localStorage.getItem("user"),n=a?JSON.parse(a):null,r={...e,mill_code:se.find(i=>i.mill_name===e.mill)?.mill_id||"",pbn_entry_id:o,pbn_number:m,row:s,company_id:n.company_id,user_id:n.id,cost:Math.round(e.quantity*e.unit_cost*100)/100,total_commission:e.quantity*e.commission,total_cost:e.quantity*e.unit_cost+e.quantity*e.commission};try{if(e.persisted)await g.post("/api/pbn/update-detail",r);else{const i=await g.post("/api/pbn/save-detail",r),u={...e,id:i.data.detail_id,persisted:!0},f=[...S];f[s]=u,s===f.length-1&&f.push({mill:"",quantity:0,unit_cost:0,commission:0,cost:0,total_commission:0,total_cost:0}),j(f)}}catch(i){console.error("Auto-save failed",i)}},$e=async e=>{try{const s=localStorage.getItem("user"),o=s?JSON.parse(s):null,n=(await g.get(`/api/id/${e}`,{params:{company_id:o?.company_id}})).data;Ee(n),U(n.main.id.toString()),w(n.main.sugar_type),N(n.main.crop_year),O(n.main.vend_code),k(n.main.vendor_name),x(n.main.posted_flag===1),T(ot(n.main.pbn_date)),Y(!0);const r=Array.isArray(n.details)&&n.details.length>0?n.details.map(i=>({mill:i.mill||"",quantity:i.quantity??0,unit_cost:i.unit_cost??0,commission:i.commission??0,cost:Math.round((i.quantity??0)*(i.unit_cost??0)*100)/100,total_commission:(i.quantity??0)*(i.commission??0),total_cost:(i.quantity??0)*(i.unit_cost??0)+(i.quantity??0)*(i.commission??0),id:i.id,row:i.row,pbn_entry_id:i.pbn_entry_id,pbn_number:i.pbn_number,persisted:!0})):[{mill:"",quantity:0,unit_cost:0,commission:0,cost:0,total_commission:0,total_cost:0,persisted:!1}];z(r),q(n.main.id),v(n.main.pbn_number)}catch(s){console.error("Failed to fetch PBN data:",s)}},He=c.useMemo(()=>{const e=A.toLowerCase();return ne.filter(s=>(s.pbn_number||"").toLowerCase().includes(e)||(s.vendor_name||"").toLowerCase().includes(e)||(s.pbn_date||"").toLowerCase().includes(e)||new Date(s.pbn_date).toLocaleDateString("en-US").includes(e))},[ne,A]),Ue=()=>{if(!H){y.error("Please select or save a PBN first.");return}const e=localStorage.getItem("user"),s=e?JSON.parse(e):null,o=`/api/pbn/form-pdf/${H}?company_id=${encodeURIComponent(s?.company_id||"")}`;ye(o),Z(!0)},Ae=async()=>{try{if(!p){y.info("Please save or select a PBN first.");return}const e=localStorage.getItem("user"),s=e?JSON.parse(e):null,o=await g.get(`/api/pbn/form-excel/${p}`,{responseType:"blob",params:{company_id:s?.company_id||""}}),a=`PBN_${m||p}.xlsx`,n=o.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1],r=new Blob([o.data],{type:o.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),i=URL.createObjectURL(r),u=document.createElement("a");u.href=i,u.download=n||a,document.body.appendChild(u),u.click(),u.remove(),URL.revokeObjectURL(i)}catch(e){console.error(e),y.error("Failed to download Excel.")}};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(Je,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-yellow-50 shadow-md rounded-lg p-6 space-y-4 border border-yellow-400",children:[t.jsx("h2",{className:"text-xl font-bold text-green-800 mb-4",children:"Purchase Book Note Entry Main"}),t.jsxs("div",{className:"flex items-end gap-2 w-full",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("input",{type:"checkbox",checked:B,onChange:()=>Pe(!B),className:"form-checkbox h-4 w-4 text-blue-600"}),t.jsx("label",{className:"text-sm font-medium text-gray-700",children:"PBN #"})]}),t.jsx("div",{className:"flex-grow",children:t.jsx(L,{label:"",value:H,onChange:$e,items:He,search:A,onSearchChange:Ce,headers:["ID","PBN Number","Sugar Type","Vendor Name","Crop Year","PBN Date"],dropdownPositionStyle:{minWidth:"1200px"},columnWidths:["30px","150px","60px","200px","80px","120px"],customKey:"pbn"})})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsx(L,{label:"Sugar Type",value:R,onChange:w,items:W.items,search:W.search,onSearchChange:W.setSearch,headers:["Sugar Type","Description"]}),t.jsx(L,{label:"Crop Year",value:_,onChange:N,items:V.items,search:V.search,onSearchChange:V.setSearch,headers:["Crop Year","FYear","TYear"]}),t.jsxs("div",{children:[t.jsx("label",{children:"PBN Date"}),t.jsx("input",{type:"date",value:K,onChange:e=>T(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsx(L,{label:"Vendor",value:l,onChange:O,items:E.items,search:E.search,onSearchChange:E.setSearch,headers:["Vendor Code","Vendor Name"]}),t.jsxs("div",{children:[t.jsx("label",{className:"block",children:"Vendor Name"}),t.jsx("input",{disabled:!0,className:"w-full border p-2 bg-green-100 text-green-900",value:X})]})]})]}),t.jsxs("div",{ref:le,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-6",children:"Purchase Book Note Details"}),ge&&t.jsx(Ve,{ref:d,data:S,colHeaders:["Mill","Quantity","Unit Cost","Commission","Cost","Total Commission","Total Cost"],columns:[{data:"mill",type:"autocomplete",source:(e,s)=>{const o=se.map(n=>n.mill_name);if(!e)return s(o);const a=String(e).toLowerCase();s(o.filter(n=>n.toLowerCase().includes(a)))},strict:!1,filter:!0,allowInvalid:!1,visibleRows:10,trimDropdown:!1},{data:"quantity",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"unit_cost",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"commission",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"cost",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"total_commission",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"total_cost",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}}],afterBeginEditing:(e,s)=>{P.current=!0,requestAnimationFrame(()=>ie(e,s))},beforeKeyDown:e=>{const s=document.querySelector(".handsontableEditor.autocompleteEditor"),o=document.activeElement;if(s&&o&&s.contains(o)){const a=e.key;(a==="ArrowDown"||a==="ArrowUp"||a==="PageDown"||a==="PageUp"||a==="Home"||a==="End")&&e.stopPropagation()}if(P.current){const a=d.current?.hotInstance,n=a?.getSelectedLast();if(a&&n){const[r,i]=n;requestAnimationFrame(()=>ie(r,i))}}},afterSelectionEnd:()=>{P.current=!1},afterDeselect:()=>{P.current=!1},afterScrollVertically:()=>{if(!P.current)return;const e=d.current?.hotInstance,s=e?.getSelectedLast();if(!e||!s)return;const[o,a]=s;requestAnimationFrame(()=>te(o,a))},afterRender:()=>{if(!P.current)return;const e=d.current?.hotInstance,s=e?.getSelectedLast();if(!e||!s)return;const[o,a]=s;requestAnimationFrame(()=>te(o,a))},afterChange:(e,s)=>{if(!e||s!=="edit")return;const o=[...S];let a=!1;e.forEach(([n])=>{const r=o[n];if(!r)return;const i=r.quantity??0,u=r.unit_cost??0,f=r.commission??0;r.cost=Math.round(i*u*100)/100,r.total_commission=i*f,r.total_cost=r.cost+r.total_commission,console.log(r),D(r)&&(console.log("is it complete"),setTimeout(()=>{setTimeout(()=>{p&&D(r)&&qe(r,n)},0)},0),n===o.length-1&&(a=!0))}),a&&o.push({mill:"",quantity:0,unit_cost:0,commission:0,cost:0,total_commission:0,total_cost:0}),j(I(o))},contextMenu:{items:{remove_row:{name:"ðŸ—‘ï¸ Remove row",callback:async function(e,s){const o=s[0].start.row,a=S[o];if((await he.fire({title:"Confirm Deletion?",text:"Do you want to delete this record?",icon:"warning",showCancelButton:!0,confirmButtonText:"Delete",cancelButtonText:"Cancel"})).isConfirmed)try{await g.post("/api/pbn/delete-detail",{...a,pbn_entry_id:a.pbn_entry_id,pbn_number:a.pbn_number,row:a.id});const r=[...S];r.splice(o,1),j(r),y.success("âœ… Row deleted successfully")}catch(r){y.error("âŒ Failed to delete record"),console.error(r)}}}}},manualColumnResize:!0,stretchH:"all",width:"100%",height:Ie,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-start",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>ee(!0),onMouseLeave:()=>ee(!1),children:[t.jsxs("button",{type:"button",disabled:!b,title:b?"Download":"Save/select a PBN first",className:`inline-flex items-center gap-2 rounded border px-3 py-2 focus:outline-none ${b?"bg-white text-emerald-700 border-emerald-300 hover:bg-emerald-50 focus:ring-2 focus:ring-emerald-400":"bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed"}`,children:[t.jsx(Ze,{className:`h-5 w-5 ${b?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(fe,{className:`h-4 w-4 opacity-70 ${b?"text-emerald-700":"text-gray-400"}`})]}),we&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:Ae,disabled:!b,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${b?"text-gray-800 hover:bg-emerald-50":"text-gray-400 cursor-not-allowed pointer-events-none"}`,children:[t.jsx(et,{className:`h-5 w-5 ${b?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"PBN Form - Excel"}),t.jsx("span",{className:`ml-auto text-[10px] font-semibold ${b?"text-emerald-600":"text-gray-400"}`,children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>re(!0),onMouseLeave:()=>re(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-400",children:[t.jsx(Xe,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(fe,{className:"h-4 w-4 opacity-70"})]}),Re&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:Ue,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(tt,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"PBN Form - PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})})})]}),t.jsxs("button",{onClick:ke,className:"inline-flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:[t.jsx(Ke,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]}),t.jsxs("button",{onClick:Te,disabled:oe,className:`inline-flex items-center gap-2 px-4 py-2 rounded ${oe?"bg-gray-400 cursor-not-allowed text-white":"bg-green-600 text-white hover:bg-green-700"}`,children:[t.jsx(Qe,{className:"h-5 w-5"}),t.jsx("span",{children:"Save"})]})]}),be&&t.jsx("div",{className:"fixed inset-0 z-[1000] flex items-center justify-center bg-black/50",onClick:()=>Q(!1),children:t.jsxs("div",{className:"bg-white rounded-lg shadow-2xl w-[90vw] max-w-[1100px] h-[88vh] flex flex-col",onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b",children:[t.jsx("div",{className:"font-semibold",children:"PBN Form â€“ PDF"}),t.jsx("button",{onClick:()=>Q(!1),className:"p-2 hover:bg-gray-100 rounded","aria-label":"Close",children:t.jsx(nt,{className:"h-6 w-6"})})]}),t.jsx("div",{className:"flex-1",children:$?t.jsx("iframe",{title:"PBN PDF",src:$,className:"w-full h-full"}):t.jsx("div",{className:"h-full flex items-center justify-center text-gray-500",children:"Loading PDFâ€¦"})})]})}),xe&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>Z(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"âœ•"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"PBN Form PDF",src:$,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{mt as default};
