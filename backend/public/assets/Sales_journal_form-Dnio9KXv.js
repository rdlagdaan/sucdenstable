import{n as u,j as t,F as K}from"./index-BiT4aQEb.js";import{r as c,H as Te,a as Fe,N as $e}from"./handsontable-7BBM75Z1.js";import{L as Me,D as Q,b as Z,y as l,F as Oe,a as Le}from"./DropdownWithHeaders-QGhKEsGD.js";import{S as k,F as Ae,a as He,b as ee}from"./sweetalert2.esm.all-B4pNkPRF.js";import"./react-Csw2ODfV.js";Fe.cellTypes.registerCellType("numeric",$e);function Ie(_){if(!_)return"";const f=new Date(_);if(isNaN(f.getTime()))return"";const b=f.getFullYear(),N=String(f.getMonth()+1).padStart(2,"0"),g=String(f.getDate()).padStart(2,"0");return`${b}-${N}-${g}`}function Ge(){const _=c.useRef(null),[f,b]=c.useState(""),[N,g]=c.useState(""),[A,v]=c.useState(""),[H,j]=c.useState(""),[I,S]=c.useState(""),[P,C]=c.useState(""),[o,D]=c.useState(null),[y,w]=c.useState(!1),[T,U]=c.useState([]),[F,B]=c.useState([]),[te,se]=c.useState(""),[ae,$]=c.useState(""),[M,O]=c.useState(""),[Y,z]=c.useState([]),[h,x]=c.useState([]),[ne,R]=c.useState(!1),[ce,G]=c.useState(!1),[oe,W]=c.useState(!1),[re,ie]=c.useState(void 0),[le,X]=c.useState(!1),J=c.useRef(null),[V,de]=c.useState(600);c.useLayoutEffect(()=>{const e=()=>{const s=J.current?.getBoundingClientRect()?.top??0,n=window.innerHeight-s-140;de(Math.max(320,Math.floor(n)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const ue=28,me=32,pe=240,he=c.useMemo(()=>{const e=Math.max(h.length,6),a=me+e*ue+pe;return Math.min(a,V)},[h.length,V]),i=c.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);c.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/customers",{params:{company_id:i?.company_id}}),a=(e||[]).map(s=>({code:String(s.cust_id??s.code),label:s.cust_name??s.label??"",description:s.cust_name??s.description??""}));U(a)}catch(e){console.error("Failed to load customers",e),U([])}})()},[i?.company_id]),c.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/accounts",{params:{company_id:i?.company_id}});B(Array.isArray(e)?e:[])}catch(e){console.error("Failed to load accounts",e),B([])}})()},[i?.company_id]);const E=async()=>{try{const{data:e}=await u.get("/api/sales/list",{params:{company_id:i?.company_id||"",q:M||""}}),a=Array.isArray(e)?e:[];z(a)}catch(e){console.error("Failed to load cash sales list",e),z([])}};c.useEffect(()=>{E()},[M]);const xe=c.useMemo(()=>(Y||[]).map(e=>({code:String(e.id),cs_no:e.cs_no,cust_id:e.cust_id,sales_date:e.sales_date,sales_amount:e.sales_amount,si_no:e.si_no,label:e.cs_no,description:e.cust_id})),[Y]),m=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),fe=()=>{$(""),O(""),b(""),g(""),v(""),j(""),S(""),C(""),D(null),w(!1),R(!1),x([m()])},be=async()=>{if((await k.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed)try{const a=await u.get("/api/sales/generate-cs-number",{params:{company_id:i?.company_id}}),s=a.data?.cs_no??a.data;b(s);const n=await u.post("/api/sales/save-main",{cs_no:s,cust_id:N,sales_date:H,explanation:I,si_no:P,company_id:i?.company_id,user_id:i?.id});D(n.data.id),R(!0),x([m(),m()]),l.success("Main saved. You can now input details."),E(),w(!0)}catch(a){console.error(a),l.error(a?.response?.data?.message||"Failed to save.")}},ge=()=>{w(!1),l.success("Editing enabled. You can now update this transaction.")},ye=async()=>{if(!(!o||!(await k.fire({title:"Cancel this transaction?",text:"This will mark the transaction as CANCELLED.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, cancel it"})).isConfirmed))try{await u.post("/api/sales/cancel",{id:o,is_cancel:"y",company_id:i?.company_id||""}),w(!0),l.success("Transaction has been cancelled."),E()}catch(a){console.error(a),l.error("Failed to cancel transaction.")}},we=async()=>{if(!(!o||!(await k.fire({title:"Delete this transaction?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await u.delete(`/api/sales/${o}`),fe(),l.success("Transaction deleted."),E()}catch(a){console.error(a),l.error("Failed to delete transaction.")}},_e=e=>e.acct_code&&(e.debit??0)>0!=(e.credit??0)>0,Ne=async(e,a)=>{if(o&&_e(e))try{if(e.persisted)await u.post("/api/sales/update-detail",{id:e.id,transaction_id:o,acct_code:e.acct_code,debit:e.debit||0,credit:e.credit||0});else{const s=await u.post("/api/sales/save-detail",{transaction_id:o,acct_code:e.acct_code,debit:e.debit||0,credit:e.credit||0,company_id:i?.company_id,user_id:i?.id}),n=[...h];n[a]={...e,id:s.data.detail_id,persisted:!0},a===n.length-1&&n.push(m()),x(n)}}catch(s){console.error(s),l.error(s?.response?.data?.message||"Row save failed")}},ve=async e=>{if(e)try{$(e);const{data:a}=await u.get(`/api/sales/${e}`,{params:{company_id:i?.company_id}}),s=a.main??a;D(s.id),b(s.cs_no),g(String(s.cust_id||""));const n=T.find(r=>String(r.code)===String(s.cust_id));v(n?.description||n?.label||"");const d=Ie(s.sales_date);j(d),S(s.explanation??""),C(s.si_no??"");const p=(a.details||[]).map(r=>({id:r.id,acct_code:r.acct_code,acct_desc:r.acct_desc,debit:Number(r.debit??0),credit:Number(r.credit??0),persisted:!0}));x(p.length?p.concat([m()]):[m()]),R(!0),w(!0),l.success("Transaction loaded.")}catch(a){console.error(a),l.error("Unable to load the selected transaction.")}},je=c.useMemo(()=>F.map(e=>`${e.acct_code};${e.acct_desc}`),[F]),Se=e=>F.find(s=>s.acct_code===e)?.acct_desc||"",Ce=()=>{if(!o)return l.info("Select or save a transaction first.");const e=`/api/sales/form-pdf/${o}?company_id=${encodeURIComponent(i?.company_id||"")}`;ie(e),X(!0)},De=async()=>{if(!o)return l.info("Select or save a transaction first.");const e=await u.get(`/api/sales/form-excel/${o}`,{responseType:"blob",params:{company_id:i?.company_id||""}}),a=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`SalesVoucher_${f||o}.xlsx`,s=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),n=URL.createObjectURL(s),d=document.createElement("a");d.href=n,d.download=a,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(n)},Re=()=>{$(""),O(""),D(null),b(""),g(""),v(""),j(""),S(""),C(""),w(!1),x([m(),m(),m(),m()]),R(!1),l.success("Form is ready for a new entry.")},Ee=0,ke=(e,a)=>{if(a!==Ee)return;const s=_.current?.hotInstance;if(!s)return;const n=s.getActiveEditor();n?.cellProperties?.type==="autocomplete"&&(n.TEXTAREA.value="",n.query="",n.open(),n.refreshDropdown?.())};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(Me,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-yellow-50 shadow-md rounded-lg p-6 space-y-4 border border-yellow-400",children:[t.jsx("h2",{className:"text-xl font-bold text-green-800 mb-2",children:"SALES JOURNAL"}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsx("div",{className:"col-span-3",children:t.jsx(Q,{label:"Search Transaction",value:ae,onChange:e=>ve(e),items:xe,search:M,onSearchChange:O,headers:["ID","Sales No","Customer","Date","Amount","S.I. #"],inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-2",children:t.jsx(Q,{label:"Customer",value:N,onChange:e=>{g(e);const a=T.find(s=>String(s.code)===String(e));v(a?.description||a?.label||"")},items:T,search:te,onSearchChange:se,headers:["Code","Label","Description"],inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:H,disabled:y,onChange:e=>j(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Explanation"}),t.jsx("input",{value:I,disabled:y,onChange:e=>S(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"S.I. #"}),t.jsx("input",{value:P,disabled:y,onChange:e=>C(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),A&&t.jsxs("div",{className:"col-span-3 text-sm font-semibold text-gray-700",children:["Customer: ",A]})]}),t.jsx("div",{className:"flex gap-2 mt-3",children:o?t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:ge,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[t.jsx(Z,{className:"h-5 w-5"}),"Update"]}),t.jsx("button",{onClick:ye,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:"Cancel"}),t.jsx("button",{onClick:we,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:"Delete"})]}):t.jsxs("button",{onClick:be,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700",children:[t.jsx(Z,{className:"h-5 w-5"}),"Save"]})})]}),t.jsxs("div",{ref:J,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),ne&&t.jsx(Te,{ref:_,data:h,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,a)=>{const s=je;if(!e)return a(s);const n=String(e).toLowerCase();a(s.filter(d=>d.toLowerCase().includes(n)))},filter:!0,strict:!1,allowInvalid:!1,visibleRows:12,readOnly:y},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:y},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:y}],afterBeginEditing:ke,afterChange:(e,a)=>{if(!e||a!=="edit")return;const s=[...h];e.forEach(([n,d,,p])=>{const r=s[n]||{};if(d==="acct_code"){const L=String(p||""),q=L.includes(";")?L.split(";")[0]:L;r.acct_code=q,r.acct_desc=Se(q)}d==="debit"&&(r.debit=Number(p||0)),d==="credit"&&(r.credit=Number(p||0)),s[n]=r,setTimeout(()=>Ne(r,n),0)}),s.find(n=>!n.acct_code)||s.push(m()),x(s)},contextMenu:{items:{remove_row:{name:"ðŸ—‘ï¸ Remove row",callback:async(e,a)=>{const s=a[0].start.row,n=h[s];if(!n?.id){const r=[...h];r.splice(s,1),x(r);return}if(!(await k.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed)return;await u.post("/api/sales/delete-detail",{id:n.id,transaction_id:o});const p=[...h];p.splice(s,1),x(p),l.success("Row deleted")}}}},manualColumnResize:!0,stretchH:"all",height:he,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>W(!0),onMouseLeave:()=>W(!1),children:[t.jsxs("button",{type:"button",disabled:!o,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${o?"bg-white text-emerald-700 border-emerald-300 hover:bg-emerald-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(Ae,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(K,{className:"h-4 w-4 opacity-70"})]}),oe&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:De,disabled:!o,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${o?"text-gray-800 hover:bg-emerald-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx(He,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Sales Voucher â€“ Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>G(!0),onMouseLeave:()=>G(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx(Oe,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(K,{className:"h-4 w-4 opacity-70"})]}),ce&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsxs("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:[t.jsxs("button",{type:"button",onClick:Ce,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(ee,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Sales Voucher â€“ PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]}),t.jsxs("button",{type:"button",onClick:()=>{if(!o)return l.info("Select or save a transaction.");window.open(`/api/sales/check-pdf/${o}?company_id=${encodeURIComponent(i?.company_id||"")}`,"_blank")},className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(ee,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Print Check â€“ PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})]})})]}),t.jsxs("button",{type:"button",onClick:Re,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 focus:outline-none",title:"Start a new transaction",children:[t.jsx(Le,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]})]}),le&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>X(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"âœ•"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Sales Voucher PDF",src:re,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{Ge as default};
