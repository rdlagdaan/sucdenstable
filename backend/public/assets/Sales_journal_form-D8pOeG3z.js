import{n as u,j as t,F as K}from"./index-ICCOB42T.js";import{r as n,H as Re,a as ke,N as Ee}from"./handsontable-7BBM75Z1.js";import{L as Fe,D as Q,a as Z,y as d,F as Te}from"./DropdownWithHeaders-Bri9DZeb.js";import{S,F as Me,a as $e,b as ee}from"./sweetalert2.esm.all-B4pNkPRF.js";import"./react-Csw2ODfV.js";ke.cellTypes.registerCellType("numeric",Ee);function Le(_){if(!_)return"";const f=new Date(_);if(isNaN(f.getTime()))return"";const g=f.getFullYear(),N=String(f.getMonth()+1).padStart(2,"0"),y=String(f.getDate()).padStart(2,"0");return`${g}-${N}-${y}`}function Ue(){const _=n.useRef(null),[f,g]=n.useState(""),[N,y]=n.useState(""),[L,j]=n.useState(""),[O,C]=n.useState(""),[H,D]=n.useState(""),[A,R]=n.useState(""),[o,k]=n.useState(null),[b,w]=n.useState(!1),[E,P]=n.useState([]),[F,I]=n.useState([]),[te,ae]=n.useState(""),[se,U]=n.useState(""),[T,B]=n.useState(""),[Y,z]=n.useState([]),[p,h]=n.useState([]),[ne,M]=n.useState(!1),[ce,G]=n.useState(!1),[oe,W]=n.useState(!1),[re,ie]=n.useState(void 0),[le,J]=n.useState(!1),V=n.useRef(null),[X,de]=n.useState(600);n.useLayoutEffect(()=>{const e=()=>{const a=V.current?.getBoundingClientRect()?.top??0,c=window.innerHeight-a-140;de(Math.max(320,Math.floor(c)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const ue=28,me=32,pe=240,he=n.useMemo(()=>{const e=Math.max(p.length,6),s=me+e*ue+pe;return Math.min(s,X)},[p.length,X]),i=n.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);n.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/customers",{params:{company_id:i?.company_id}}),s=(e||[]).map(a=>({code:String(a.cust_id??a.code),label:a.cust_name??a.label??"",description:a.cust_name??a.description??""}));P(s)}catch(e){console.error("Failed to load customers",e),P([])}})()},[i?.company_id]),n.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/accounts",{params:{company_id:i?.company_id}});I(Array.isArray(e)?e:[])}catch(e){console.error("Failed to load accounts",e),I([])}})()},[i?.company_id]);const v=async()=>{try{const{data:e}=await u.get("/api/sales/list",{params:{company_id:i?.company_id||"",q:T||""}}),s=Array.isArray(e)?e:[];z(s)}catch(e){console.error("Failed to load cash sales list",e),z([])}};n.useEffect(()=>{v()},[T]);const xe=n.useMemo(()=>(Y||[]).map(e=>({code:String(e.id),cs_no:e.cs_no,cust_id:e.cust_id,sales_date:e.sales_date,sales_amount:e.sales_amount,si_no:e.si_no,label:e.cs_no,description:e.cust_id})),[Y]),x=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),fe=()=>{U(""),B(""),g(""),y(""),j(""),C(""),D(""),R(""),k(null),w(!1),M(!1),h([x()])},be=async()=>{if((await S.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed)try{const s=await u.get("/api/sales/generate-cs-number",{params:{company_id:i?.company_id}}),a=s.data?.cs_no??s.data;g(a);const c=await u.post("/api/sales/save-main",{cs_no:a,cust_id:N,sales_date:O,explanation:H,si_no:A,company_id:i?.company_id,user_id:i?.id});k(c.data.id),M(!0),h([x(),x()]),d.success("Main saved. You can now input details."),v(),w(!0)}catch(s){console.error(s),d.error(s?.response?.data?.message||"Failed to save.")}},ge=()=>{w(!1),d.success("Editing enabled. You can now update this transaction.")},ye=async()=>{if(!(!o||!(await S.fire({title:"Cancel this transaction?",text:"This will mark the transaction as CANCELLED.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, cancel it"})).isConfirmed))try{await u.post("/api/sales/cancel",{id:o,is_cancel:"y",company_id:i?.company_id||""}),w(!0),d.success("Transaction has been cancelled."),v()}catch(s){console.error(s),d.error("Failed to cancel transaction.")}},we=async()=>{if(!(!o||!(await S.fire({title:"Delete this transaction?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await u.delete(`/api/sales/${o}`),fe(),d.success("Transaction deleted."),v()}catch(s){console.error(s),d.error("Failed to delete transaction.")}},_e=e=>e.acct_code&&(e.debit??0)>0!=(e.credit??0)>0,Ne=async(e,s)=>{if(o&&_e(e))try{if(e.persisted)await u.post("/api/sales/update-detail",{id:e.id,transaction_id:o,acct_code:e.acct_code,debit:e.debit||0,credit:e.credit||0});else{const a=await u.post("/api/sales/save-detail",{transaction_id:o,acct_code:e.acct_code,debit:e.debit||0,credit:e.credit||0,company_id:i?.company_id,user_id:i?.id}),c=[...p];c[s]={...e,id:a.data.detail_id,persisted:!0},s===c.length-1&&c.push(x()),h(c)}}catch(a){console.error(a),d.error(a?.response?.data?.message||"Row save failed")}},ve=async e=>{if(e)try{U(e);const{data:s}=await u.get(`/api/sales/${e}`,{params:{company_id:i?.company_id}}),a=s.main??s;k(a.id),g(a.cs_no),y(String(a.cust_id||""));const c=E.find(r=>String(r.code)===String(a.cust_id));j(c?.description||c?.label||"");const l=Le(a.sales_date);C(l),D(a.explanation??""),R(a.si_no??"");const m=(s.details||[]).map(r=>({id:r.id,acct_code:r.acct_code,acct_desc:r.acct_desc,debit:Number(r.debit??0),credit:Number(r.credit??0),persisted:!0}));h(m.length?m.concat([x()]):[x()]),M(!0),w(!0),d.success("Transaction loaded.")}catch(s){console.error(s),d.error("Unable to load the selected transaction.")}},Se=n.useMemo(()=>F.map(e=>`${e.acct_code};${e.acct_desc}`),[F]),je=e=>F.find(a=>a.acct_code===e)?.acct_desc||"",Ce=()=>{if(!o)return d.info("Select or save a transaction first.");const e=`/api/sales/form-pdf/${o}?company_id=${encodeURIComponent(i?.company_id||"")}`;ie(e),J(!0)},De=async()=>{if(!o)return d.info("Select or save a transaction first.");const e=await u.get(`/api/sales/form-excel/${o}`,{responseType:"blob",params:{company_id:i?.company_id||""}}),s=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`SalesVoucher_${f||o}.xlsx`,a=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),c=URL.createObjectURL(a),l=document.createElement("a");l.href=c,l.download=s,document.body.appendChild(l),l.click(),l.remove(),URL.revokeObjectURL(c)};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(Fe,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-yellow-50 shadow-md rounded-lg p-6 space-y-4 border border-yellow-400",children:[t.jsx("h2",{className:"text-xl font-bold text-green-800 mb-2",children:"SALES JOURNAL"}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsx("div",{className:"col-span-3",children:t.jsx(Q,{label:"Search Transaction",value:se,onChange:e=>ve(e),items:xe,search:T,onSearchChange:B,headers:["ID","Sales No","Customer","Date","Amount","S.I. #"],inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-2",children:t.jsx(Q,{label:"Customer",value:N,onChange:e=>{y(e);const s=E.find(a=>String(a.code)===String(e));j(s?.description||s?.label||"")},items:E,search:te,onSearchChange:ae,headers:["Code","Label","Description"],inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:O,disabled:b,onChange:e=>C(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Explanation"}),t.jsx("input",{value:H,disabled:b,onChange:e=>D(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"S.I. #"}),t.jsx("input",{value:A,disabled:b,onChange:e=>R(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),L&&t.jsxs("div",{className:"col-span-3 text-sm font-semibold text-gray-700",children:["Customer: ",L]})]}),t.jsx("div",{className:"flex gap-2 mt-3",children:o?t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:ge,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[t.jsx(Z,{className:"h-5 w-5"}),"Update"]}),t.jsx("button",{onClick:ye,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:"Cancel"}),t.jsx("button",{onClick:we,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:"Delete"})]}):t.jsxs("button",{onClick:be,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700",children:[t.jsx(Z,{className:"h-5 w-5"}),"Save"]})})]}),t.jsxs("div",{ref:V,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),ne&&t.jsx(Re,{ref:_,data:p,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,s)=>{const a=Se;if(!e)return s(a);const c=String(e).toLowerCase();s(a.filter(l=>l.toLowerCase().includes(c)))},strict:!1,visibleRows:10,allowInvalid:!1,readOnly:b},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:b},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:b}],afterChange:(e,s)=>{if(!e||s!=="edit")return;const a=[...p];e.forEach(([c,l,,m])=>{const r=a[c]||{};if(l==="acct_code"){const $=String(m||""),q=$.includes(";")?$.split(";")[0]:$;r.acct_code=q,r.acct_desc=je(q)}l==="debit"&&(r.debit=Number(m||0)),l==="credit"&&(r.credit=Number(m||0)),a[c]=r,setTimeout(()=>Ne(r,c),0)}),a.find(c=>!c.acct_code)||a.push(x()),h(a)},contextMenu:{items:{remove_row:{name:"ðŸ—‘ï¸ Remove row",callback:async(e,s)=>{const a=s[0].start.row,c=p[a];if(!c?.id){const r=[...p];r.splice(a,1),h(r);return}if(!(await S.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed)return;await u.post("/api/sales/delete-detail",{id:c.id,transaction_id:o});const m=[...p];m.splice(a,1),h(m),d.success("Row deleted")}}}},manualColumnResize:!0,stretchH:"all",height:he,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-start",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>W(!0),onMouseLeave:()=>W(!1),children:[t.jsxs("button",{type:"button",disabled:!o,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${o?"bg-white text-emerald-700 border-emerald-300 hover:bg-emerald-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(Me,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(K,{className:"h-4 w-4 opacity-70"})]}),oe&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:De,disabled:!o,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${o?"text-gray-800 hover:bg-emerald-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx($e,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Sales Voucher â€“ Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>G(!0),onMouseLeave:()=>G(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx(Te,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(K,{className:"h-4 w-4 opacity-70"})]}),ce&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsxs("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:[t.jsxs("button",{type:"button",onClick:Ce,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(ee,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Sales Voucher â€“ PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]}),t.jsxs("button",{type:"button",onClick:()=>{if(!o)return d.info("Select or save a transaction.");window.open(`/api/sales/check-pdf/${o}?company_id=${encodeURIComponent(i?.company_id||"")}`,"_blank")},className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(ee,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Print Check â€“ PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})]})})]})]}),le&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>J(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"âœ•"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Sales Voucher PDF",src:re,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{Ue as default};
