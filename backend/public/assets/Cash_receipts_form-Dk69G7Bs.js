import{n as h,j as t,F as be}from"./index-BLOVgrua.js";import{r as a,H as Je,a as we,N as Ze}from"./handsontable-7BBM75Z1.js";import{S as R,F as Qe,a as et,b as tt}from"./sweetalert2.esm.all-B4pNkPRF.js";import{y as d,L as st,D as T,b as xe,F as at,a as nt}from"./DropdownWithHeaders-DlVSdgRi.js";import{F as ct}from"./XMarkIcon-B-Tbi0qp.js";import{F as it}from"./TrashIcon-I-_qGSbO.js";import"./react-Csw2ODfV.js";function rt({title:o,titleId:r,...u},m){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:m,"aria-labelledby":r},u),o?a.createElement("title",{id:r},o):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3"}))}const ot=a.forwardRef(rt);we.cellTypes.registerCellType("numeric",Ze);const L=o=>(o||"").split(";")[0];function lt(o){const r=["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],u=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];let m="";const b=Math.floor(o/100),f=o%100;if(b&&(m+=r[b]+" hundred"+(f?" ":"")),f)if(f<20)m+=r[f];else{const w=Math.floor(f/10),k=f%10;m+=u[w]+(k?"-"+r[k]:"")}return m}function dt(o){if(o===0)return"zero";const r=[""," thousand"," million"," billion"," trillion"];let u="",m=0;for(;o>0;){const b=o%1e3;b&&(u=lt(b)+r[m]+(u?" "+u:"")),o=Math.floor(o/1e3),m++}return u}function ge(o){const[r,u]=Number(o||0).toFixed(2).split("."),m=parseInt(r,10)||0,b=parseInt(u,10)||0,f=dt(m).toUpperCase(),w=b===0?" PESOS ONLY":` PESOS AND ${String(b).padStart(2,"0")}/100 ONLY`;return`*** ${f}${w} ***`}const ut=o=>(Number(o)||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2});function yt(){const o=a.useRef(null),[r,u]=a.useState(null),[m,b]=a.useState(""),[f,w]=a.useState(""),[k,P]=a.useState(""),[$,B]=a.useState(()=>new Date().toISOString().slice(0,10)),[D,I]=a.useState(0),[ye,_e]=a.useState("*** ZERO PESOS ONLY ***"),[W,H]=a.useState(""),[U,z]=a.useState(""),[Q,V]=a.useState(""),[q,X]=a.useState(""),[mt,N]=a.useState(!1),[E,v]=a.useState(!0),[S,M]=a.useState(!1),p=a.useMemo(()=>r!=null,[r]),[O,ee]=a.useState([]),[Ne,te]=a.useState([]),[ve,se]=a.useState([]),[Y,ae]=a.useState([]),Se=a.useMemo(()=>Y.map(e=>`${e.acct_code};${e.acct_desc}`),[Y]),A=e=>Y.find(n=>n.acct_code===e)?.acct_desc||"",[Ce,ne]=a.useState(""),[G,ce]=a.useState(""),[ie,re]=a.useState([]),je=a.useMemo(()=>(ie||[]).map(e=>({code:String(e.id),cr_no:e.cr_no,cust_id:e.cust_id,cust_name:e.cust_name||"",receipt_date:(e.receipt_date||"").slice(0,10),receipt_amount:e.receipt_amount,collection_receipt:e.collection_receipt||"",label:e.cr_no,description:e.cust_name||e.cust_id})),[ie]),[K,y]=a.useState([{acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}]),_=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),oe=a.useRef(null),[le,ke]=a.useState(600);a.useLayoutEffect(()=>{const e=()=>{const c=oe.current?.getBoundingClientRect()?.top??0,i=window.innerHeight-c-140;ke(Math.max(320,Math.floor(i)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const Re=28,De=32,Ee=240,Me=a.useMemo(()=>{const e=Math.max(K.length,6),n=De+e*Re+Ee;return Math.min(n,le)},[K.length,le]),J=a.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]),x=J?.company_id;a.useEffect(()=>{_e(ge(D))},[D]),a.useEffect(()=>{(async()=>{try{const[e,n,c,i]=await Promise.all([h.get("/api/cr/customers",{params:{company_id:x}}),h.get("/api/cr/banks",{params:{company_id:x}}),h.get("/api/cr/payment-methods"),h.get("/api/cr/accounts",{params:{company_id:x}})]);ee((e.data||[]).map(s=>({code:String(s.cust_id??s.code),description:s.cust_name??s.description??""}))),te((n.data||[]).map(s=>({code:String(s.bank_id??s.code),description:s.bank_name??s.description??""}))),se((c.data||[]).map(s=>({code:String(s.pay_method_id??s.code),description:s.pay_method??s.description??""}))),ae(Array.isArray(i.data)?i.data:[])}catch{ee([]),te([]),se([]),ae([])}})()},[x]);const C=a.useCallback(async()=>{try{const{data:e}=await h.get("/api/cash-receipt/list",{params:{company_id:x||"",q:G||""}});re(Array.isArray(e)?e:[])}catch{re([])}},[x,G]);a.useEffect(()=>{C()},[C]);const Z=a.useCallback(async e=>{try{const{data:n}=await h.get(`/api/cash-receipt/${e}`,{params:{company_id:x}}),c=n.main??n;u(c.id),b(c.cr_no||""),w(String(c.cust_id||""));const i=O.find(l=>String(l.code)===String(c.cust_id));P(i?.description||""),B((c.receipt_date||"").slice(0,10)),I(Number(c.receipt_amount||0)),H(String(c.bank_id||"")),z(String(c.pay_method||"")),X(c.collection_receipt||""),V(c.details||""),M((c.is_cancel||c.is_cancelled)==="y");const s=(n.details||[]).map(l=>({id:l.id,acct_code:`${l.acct_code};${l.acct_desc||A(l.acct_code)}`,acct_desc:l.acct_desc,debit:Number(l.debit||0),credit:Number(l.credit||0),workstation_id:l.workstation_id||"",persisted:!0}));y(s.length?s.concat([_()]):[_()]),N(!0),v((c.is_cancel||c.is_cancelled)==="y"),d.success("Receipt loaded.")}catch{d.error("Unable to load the selected receipt.")}},[x,O,A]),Oe=async e=>{e&&(ne(e),await Z(e))},Ae=async()=>{if(!f||!$||!W||!U||!q)return d.error("Please complete Customer, Date, Bank, Payment Method, and Collection Receipt.");if((await R.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Save"})).isConfirmed)try{const n=await h.post("/api/cash-receipt/save-main",{cr_no:m||void 0,cust_id:f,receipt_date:$,receipt_amount:0,pay_method:U,bank_id:W,collection_receipt:q,details:Q,amount_in_words:ge(D).replace(/^\*\*\*\s|\s\*\*\*$/g,""),company_id:x,user_id:J?.id});u(n.data.id),b(n.data.cr_no||""),N(!0),v(!1),y([_(),_()]),d.success("Main saved. You can now input details."),C()}catch(n){d.error(n?.response?.data?.message||"Failed to save.")}},Fe=()=>{N(!1),v(!1),d.success("Editing enabled.")},Te=async()=>{if(!(!r||!(await R.fire({title:"Cancel this receipt?",icon:"warning",showCancelButton:!0,confirmButtonText:"Cancel"})).isConfirmed))try{const{data:n}=await h.post("/api/cash-receipt/cancel",{id:r,flag:1});M((n?.is_cancel||n?.is_cancelled)==="y"),N(!0),v(!0),d.success("Receipt marked CANCELLED."),C()}catch{d.error("Failed to cancel receipt.")}},Le=async()=>{if(!(!r||!(await R.fire({title:"Uncancel this receipt?",icon:"question",showCancelButton:!0,confirmButtonText:"Uncancel"})).isConfirmed))try{const{data:n}=await h.post("/api/cash-receipt/cancel",{id:r,flag:0});M((n?.is_cancel||n?.is_cancelled)!=="y"),N(!0),v(!1),d.success("Receipt is now ACTIVE."),C()}catch{d.error("Failed to uncancel receipt.")}},Pe=async()=>{if(!(!r||!(await R.fire({title:"Delete this receipt?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await h.delete(`/api/cash-receipt/${r}`),de(),d.success("Receipt deleted."),C()}catch{d.error("Failed to delete receipt.")}},de=()=>{ne(""),ce(""),u(null),b(""),w(""),P(""),B(new Date().toISOString().slice(0,10)),I(0),H(""),z(""),X(""),V(""),M(!1),N(!1),v(!0),y([_()])},$e=e=>!!L(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,Be=e=>{e&&I(Number(e.sum_credit??e.total_credit??e.credit??0))},Ie=async e=>{const{data:n}=await h.post("/api/cash-receipt/delete-detail",e);Be(n?.totals),await Z(e.transaction_id)},ue=async(e,n)=>{if(!r||!$e(e))return;const c=L(e.acct_code);try{if(e.persisted)await h.post("/api/cash-receipt/update-detail",{id:e.id,transaction_id:r,acct_code:c,debit:e.debit||0,credit:e.credit||0});else{const i=await h.post("/api/cash-receipt/save-detail",{transaction_id:r,acct_code:c,debit:e.debit||0,credit:e.credit||0,company_id:x,user_id:J?.id}),s=o.current?.hotInstance?.getSourceData()||[];s[n]&&(s[n].persisted=!0,s[n].id=i.data.detail_id),y([...s,...s.find(l=>!l.acct_code)?[]:[_()]])}}catch(i){d.error(i?.response?.data?.message||"Row save failed")}},We=0,He=(e,n)=>{if(E||n!==We)return;const i=o.current?.hotInstance?.getActiveEditor();i?.cellProperties?.type==="autocomplete"&&(i.TEXTAREA.value="",i.query="",i.open(),i.refreshDropdown?.())},[Ue,me]=a.useState(!1),[ze,pe]=a.useState(!1),[Ve,qe]=a.useState(void 0),[Xe,he]=a.useState(!1),Ye=()=>{if(!r)return d.info("Save or select a receipt first.");const e=`/api/cash-receipt/form-pdf/${r}?company_id=${encodeURIComponent(x||"")}`;qe(e),he(!0)},Ge=async()=>{if(!r)return d.info("Save or select a receipt first.");const e=await h.get(`/api/cash-receipt/form-excel/${r}`,{responseType:"blob",params:{company_id:x||""}}),n=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`ReceiptVoucher_${m||r}.xlsx`,c=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),i=URL.createObjectURL(c),s=document.createElement("a");s.href=i,s.download=n,document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(i)};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(st,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-blue-50 shadow-md rounded-lg p-6 space-y-4 border border-blue-200",children:[t.jsx("h2",{className:"text-xl font-bold text-blue-800 mb-2",children:"CASH RECEIPTS"}),t.jsx(T,{label:"Search Transaction",value:Ce,onChange:Oe,items:je,search:G,onSearchChange:ce,headers:["ID","RV #","Customer","Date","Amount","Collection Rcpt"],columnWidths:["60px","110px","220px","110px","110px","160px"],dropdownPositionStyle:{width:"820px"},inputClassName:"p-2 text-sm bg-white"}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsx("div",{className:"col-span-2",children:t.jsx(T,{label:"Customer",value:f,onChange:e=>{if(p)return;w(e);const n=O.find(c=>String(c.code)===String(e));P(n?.description||"")},items:O,search:"",onSearchChange:()=>{},headers:["Code","Name"],columnWidths:["140px","520px"],dropdownPositionStyle:{width:"700px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:$,disabled:p,onChange:e=>B(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsx("div",{className:"col-span-2",children:t.jsx(T,{label:"Bank Name",value:W,onChange:e=>{p||H(e)},items:Ne,search:"",onSearchChange:()=>{},headers:["Code","Bank"],columnWidths:["120px","520px"],dropdownPositionStyle:{width:"680px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"",children:t.jsx(T,{label:"Payment Method",value:U,onChange:e=>{p||z(e)},items:ve,search:"",onSearchChange:()=>{},headers:["Code","Method"],columnWidths:["120px","320px"],dropdownPositionStyle:{width:"480px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{className:"col-span-3",children:[t.jsx("label",{className:"block mb-1",children:"Details"}),t.jsx("input",{value:Q,disabled:p&&S,onChange:e=>V(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"Amount"}),t.jsx("input",{value:ut(D),readOnly:!0,className:"w-full border p-2 bg-yellow-50 text-right font-bold"})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Amount in Words"}),t.jsx("div",{className:"w-full border p-2 bg-white text-blue-900 text-sm font-semibold",children:ye})]}),t.jsxs("div",{className:"col-span-3",children:[t.jsx("label",{className:"block mb-1",children:"Collection Receipt #"}),t.jsx("input",{value:q,disabled:p&&S,onChange:e=>X(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),!!k&&t.jsxs("div",{className:"col-span-3 text-sm font-semibold text-gray-700",children:["Customer: ",k]})]}),t.jsx("div",{className:"flex gap-2 mt-3",children:p?t.jsxs(t.Fragment,{children:[!S&&t.jsxs("button",{onClick:Fe,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700",children:[t.jsx(xe,{className:"h-5 w-5"}),"Update"]}),S?t.jsxs("button",{onClick:Le,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-600 text-white hover:bg-amber-700",children:[t.jsx(ot,{className:"h-5 w-5"}),"Uncancel"]}):t.jsxs("button",{onClick:Te,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:[t.jsx(ct,{className:"h-5 w-5"}),"Cancel"]}),t.jsxs("button",{onClick:Pe,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:[t.jsx(it,{className:"h-5 w-5"}),"Delete"]})]}):t.jsxs("button",{onClick:Ae,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[t.jsx(xe,{className:"h-5 w-5"}),"Save"]})}),S&&t.jsx("div",{className:"text-red-600 font-bold mt-2",children:"CANCELLED"})]}),t.jsxs("div",{ref:oe,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),p&&t.jsx(Je,{className:"hot-enhanced hot-zebra",ref:o,data:K,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,n)=>{const c=Se;if(!e)return n(c);const i=String(e).toLowerCase();n(c.filter(s=>s.toLowerCase().includes(i)))},strict:!0,allowInvalid:!1,visibleRows:12,readOnly:E,renderer:(e,n,c,i,s,l,j)=>{const g=L(String(l??""));we.renderers.TextRenderer(e,n,c,i,s,g,j)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:E},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:E}],afterBeginEditing:He,afterChange:(e,n)=>{const c=o.current?.hotInstance;!e||!c||S||n==="edit"&&(e.forEach(([i,s,l,j])=>{const g={...c.getSourceDataAtRow(i)};if(g.workstation_id==="BANK"){r&&Z(r);return}if(s==="acct_code"){const F=String(j||""),fe=L(F);c.setDataAtRowProp(i,"acct_desc",A(fe));const Ke={...g,acct_code:F,acct_desc:A(fe),debit:Number(g.debit||0),credit:Number(g.credit||0)};setTimeout(()=>ue(Ke,i),0)}if(s==="debit"||s==="credit"){const F={...g,debit:Number(s==="debit"?j:g.debit||0),credit:Number(s==="credit"?j:g.credit||0)};setTimeout(()=>ue(F,i),0)}}),requestAnimationFrame(()=>{const i=c.getSourceData();i.find(s=>!s.acct_code)||i.push(_()),y([...i])}))},contextMenu:{items:{remove_row:{name:"ðŸ—‘ï¸ Remove row",callback:async(e,n)=>{const c=o.current?.hotInstance,i=n[0].start.row,s=c?.getSourceData()||[],l=s[i];if(l?.workstation_id==="BANK"){d.info("Bank line cannot be deleted.");return}if(!l?.id){s.splice(i,1),y([...s]);return}(await R.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed&&(await Ie({id:l.id,transaction_id:r}),s.splice(i,1),y([...s]),d.success("Row deleted."))}}}},manualColumnResize:!0,stretchH:"all",height:Me,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>pe(!0),onMouseLeave:()=>pe(!1),children:[t.jsxs("button",{type:"button",disabled:!p,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${p?"bg-white text-blue-700 border-blue-300 hover:bg-blue-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(Qe,{className:`h-5 w-5 ${p?"text-blue-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(be,{className:"h-4 w-4 opacity-70"})]}),ze&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:Ge,disabled:!p,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${p?"text-gray-800 hover:bg-blue-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx(et,{className:`h-5 w-5 ${p?"text-blue-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Receipt Voucher â€“ Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>me(!0),onMouseLeave:()=>me(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx(at,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(be,{className:"h-4 w-4 opacity-70"})]}),Ue&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:Ye,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(tt,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Receipt Voucher â€“ PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})})})]}),t.jsxs("button",{type:"button",onClick:de,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-blue-600 text-white hover:bg-blue-700",title:"Start a new transaction",children:[t.jsx(nt,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]})]}),Xe&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>he(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"âœ•"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Receipt Voucher PDF",src:Ve,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{yt as default};
