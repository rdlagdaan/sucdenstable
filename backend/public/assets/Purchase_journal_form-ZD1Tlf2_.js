import{n as l,j as a,F as ge}from"./index-DPdZcCwV.js";import{r as n,H as lt,a as _e,N as pt}from"./handsontable-7BBM75Z1.js";/* empty css                              */import{S as b,F as ut,a as mt,b as be}from"./sweetalert2.esm.all-B4pNkPRF.js";import{L as ht,D as y,b as ye,y as u,F as xt,a as gt}from"./DropdownWithHeaders-DTwSAhX6.js";import"./react-Csw2ODfV.js";_e.cellTypes.registerCellType("numeric",pt);const T=m=>(m||"").split(";")[0],fe=m=>m?new Date(m).toString()==="Invalid Date"?(m||"").split("T")[0]:new Date(m).toISOString().slice(0,10):"";function Nt(){const m=n.useRef(null),[we,P]=n.useState(""),[f,E]=n.useState(""),[q,A]=n.useState(""),[N,$]=n.useState(""),[_,L]=n.useState(""),[w,M]=n.useState(""),[X,F]=n.useState(""),[G,O]=n.useState(""),[J,B]=n.useState(""),[bt,K]=n.useState(""),[r,H]=n.useState(null),[Q,S]=n.useState(!1),[j,v]=n.useState(!0),[I,Z]=n.useState([]),[U,ee]=n.useState([]),[Se,te]=n.useState([]),[ve,ae]=n.useState([]),[Ne,se]=n.useState([]),[je,Ce]=n.useState(""),[De,Re]=n.useState(""),[ke,Te]=n.useState(""),[Pe,Ee]=n.useState(""),[Ae,ne]=n.useState(""),[V,ce]=n.useState(""),[oe,ie]=n.useState([]),[C,x]=n.useState([{acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}]),[$e,Y]=n.useState(!1),[Le,re]=n.useState(!1),[Me,de]=n.useState(!1),[Fe,Oe]=n.useState(void 0),[Be,le]=n.useState(!1),[He,pe]=n.useState([]),[W,Ie]=n.useState(""),ue=n.useRef(null),[me,Ue]=n.useState(600);n.useLayoutEffect(()=>{const e=()=>{const t=ue.current?.getBoundingClientRect()?.top??0,s=window.innerHeight-t-140;Ue(Math.max(320,Math.floor(s)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const Ve=28,Ye=32,We=240,ze=n.useMemo(()=>{const e=Math.max(C.length,6),c=Ye+e*Ve+We;return Math.min(c,me)},[C.length,me]),d=n.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);n.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/pj/vendors",{params:{company_id:d?.company_id}}),c=(e||[]).map(t=>({code:String(t.code??t.vend_code??t.vendor_id??""),description:t.description??t.vend_name??t.vendor_name??"",label:t.label??t.code??""}));Z(c)}catch{Z([])}})()},[d?.company_id]),n.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/pj/accounts",{params:{company_id:d?.company_id}});ee(Array.isArray(e)?e:[])}catch{ee([])}})()},[d?.company_id]),n.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/sugar-types"),c=(Array.isArray(e)?e:[]).map(t=>({code:String(t.code??t.sugar_code??t.sugar_type??t.type??""),description:String(t.description??t.sugar_desc??t.name??t.code??""),label:String(t.code??t.sugar_code??t.sugar_type??"")}));te(c)}catch{te([])}})()},[]),n.useEffect(()=>{(async()=>{try{const{data:e}=await l.get("/api/crop-years"),c=(Array.isArray(e)?e:[]).map(t=>({code:String(t.code??t.crop_year??t.year??""),description:String(t.description??t.crop_year??t.year??""),label:String(t.code??t.crop_year??t.year??"")}));ae(c)}catch{ae([])}})()},[]);const qe=async e=>{try{const c={company_id:d?.company_id};e&&(c.as_of=e);const t=e?"/api/mills/effective":"/api/mills",{data:s}=await l.get(t,{params:c}),o=(Array.isArray(s)?s:[]).map(i=>{const p=String(i.mill_id??"").trim();return{code:p&&p!=="0"&&p.toLowerCase()!=="null"?p:String(i.prefix??"").trim(),description:String(i.mill_name??"").trim()}}).filter(i=>i.code);se(o)}catch{se([])}};n.useEffect(()=>{qe(N||void 0)},[N]);const D=async()=>{try{const{data:e}=await l.get("/api/purchase/list",{params:{company_id:d?.company_id||"",q:V||""}});ie(Array.isArray(e)?e:[])}catch{ie([])}};n.useEffect(()=>{D()},[V]);const Xe=n.useMemo(()=>(oe||[]).map(e=>({code:String(e.id),cp_no:e.cp_no,vendor_id:e.vendor_id,purchase_date:fe(e.purchase_date),purchase_amount:e.purchase_amount,invoice_no:e.invoice_no,label:e.cp_no,description:e.vendor_id})),[oe]),Ge=n.useMemo(()=>U.map(e=>`${e.acct_code};${e.acct_desc}`),[U]),z=e=>U.find(c=>c.acct_code===e)?.acct_desc||"",g=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),he=()=>{ne(""),ce(""),P(""),E(""),A(""),$(""),L(""),M(""),F(""),O(""),B(""),K(""),H(null),S(!1),v(!1),Y(!1),x([g()])},Je=async()=>{if((await b.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed){try{if((await l.get("/api/purchase/unbalanced-exists",{params:{company_id:d?.company_id||""}})).data?.exists){const t=await l.get("/api/purchase/unbalanced",{params:{company_id:d?.company_id||"",limit:20}}),i=`
          <div style="text-align:left">
            <div style="margin-bottom:8px">There are unbalanced purchase transactions. Please balance them first.</div>
            <table style="width:100%;border-collapse:collapse;font-size:12px">
              <thead>
                <tr>
                  <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 8px">CP #</th>
                  <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 8px">Vendor</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Debit</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Credit</th>
                </tr>
              </thead>
              <tbody>${(Array.isArray(t.data?.items)?t.data.items:[]).map(p=>`
          <tr>
            <td style="padding:6px 8px">${p.cp_no}</td>
            <td style="padding:6px 8px">${p.vendor_id}</td>
            <td style="padding:6px 8px;text-align:right">${Number(p.sum_debit||0).toLocaleString()}</td>
            <td style="padding:6px 8px;text-align:right">${Number(p.sum_credit||0).toLocaleString()}</td>
          </tr>`).join("")||'<tr><td colspan="4" style="padding:6px 8px;color:#6b7280">No detail</td></tr>'}</tbody>
            </table>
          </div>`;await b.fire({icon:"warning",title:"Unbalanced transactions found",html:i,confirmButtonText:"OK"});return}}catch{}try{const c=await l.get("/api/purchase/generate-cp-number",{params:{company_id:d?.company_id}}),t=c.data?.cp_no??c.data;P(t);const s=await l.post("/api/purchase/save-main",{cp_no:t,vend_id:f,purchase_date:N,explanation:G,company_id:d?.company_id,user_id:d?.id,crop_year:_,sugar_type:w,mill_id:X,booking_no:J});H(s.data.id),Y(!0),x([g(),g()]),u.success("Main saved. You can now input details."),D(),S(!0),v(!1)}catch(c){u.error(c?.response?.data?.message||"Failed to save.")}}},Ke=()=>{S(!1),v(!1),u.success("Editing enabled.")},Qe=async()=>{if(!(!r||!(await b.fire({title:"Cancel this transaction?",text:"This will mark the transaction as CANCELLED.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, cancel it"})).isConfirmed))try{await l.post("/api/purchase/cancel",{id:r,flag:"1",company_id:d?.company_id||""}),S(!0),v(!0),u.success("Transaction has been cancelled."),D()}catch{u.error("Failed to cancel transaction.")}},Ze=async()=>{if(!(!r||!(await b.fire({title:"Delete this transaction?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await l.delete(`/api/purchase/${r}`),he(),u.success("Transaction deleted."),D()}catch{u.error("Failed to delete transaction.")}},et=e=>!!T(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,xe=async(e,c)=>{if(!r||!et(e))return;const t=T(e.acct_code);try{if(e.persisted)await l.post("/api/purchase/update-detail",{id:e.id,transaction_id:r,acct_code:t,debit:e.debit||0,credit:e.credit||0});else{const s=await l.post("/api/purchase/save-detail",{transaction_id:r,acct_code:t,debit:e.debit||0,credit:e.credit||0,company_id:d?.company_id,user_id:d?.id}),o=m.current?.hotInstance?.getSourceData()||[];o[c]&&(o[c].persisted=!0,o[c].id=s.data.detail_id),x([...o,...o.find(i=>!i.acct_code)?[]:[g()]])}}catch(s){u.error(s?.response?.data?.message||"Row save failed")}},tt=async e=>{if(e)try{ne(e);const{data:c}=await l.get(`/api/purchase/${e}`,{params:{company_id:d?.company_id}}),t=c.main??c;H(t.id),P(t.cp_no),E(String(t.vendor_id||""));const s=I.find(i=>String(i.code)===String(t.vendor_id));A(s?.description||s?.label||""),$(fe(t.purchase_date)),O(t.explanation??""),K(t.invoice_no??""),L(String(t.crop_year??"")),M(String(t.sugar_type??"")),F(String(t.mill_id??"")),B(String(t.booking_no??""));const o=(c.details||[]).map(i=>({id:i.id,acct_code:`${i.acct_code};${i.acct_desc||z(i.acct_code)}`,acct_desc:i.acct_desc,debit:Number(i.debit??0),credit:Number(i.credit??0),persisted:!0}));x(o.length?o.concat([g()]):[g()]),Y(!0),S(!0),v(!0),u.success("Transaction loaded.")}catch{u.error("Unable to load the selected transaction.")}},at=()=>{if(!r)return u.info("Select or save a transaction first.");const e=`/api/purchase/form-pdf/${r}?company_id=${encodeURIComponent(d?.company_id||"")}`;Oe(e),le(!0)},st=async()=>{if(!r)return u.info("Select or save a transaction first.");const e=await l.get(`/api/purchase/form-excel/${r}`,{responseType:"blob",params:{company_id:d?.company_id||""}}),c=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`PurchaseVoucher_${we||r}.xlsx`,t=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),s=URL.createObjectURL(t),o=document.createElement("a");o.href=s,o.download=c,document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(s)},nt=0,ct=(e,c)=>{if(j||c!==nt)return;const s=m.current?.hotInstance?.getActiveEditor();s?.cellProperties?.type==="autocomplete"&&(s.TEXTAREA.value="",s.query="",s.open(),s.refreshDropdown?.())},ot=async()=>{const e=C.some(t=>t.acct_code&&t.acct_code.trim()!==""||(Number(t.debit)||0)>0||(Number(t.credit)||0)>0);(await b.fire({title:"Start a new transaction?",text:e?"This will clear the current form.":"",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, New"})).isConfirmed&&(he(),u.success("Form is ready for a new entry."))},it=e=>e?new Date(e).toLocaleDateString():"",rt=async()=>{try{const e={company_id:d?.company_id||"",q:W||""};f&&(e.vend_code=f),w&&(e.sugar_type=w),_&&(e.crop_year=_);const{data:c}=await l.get("/api/pbn/list",{params:e}),t=(Array.isArray(c)?c:[]).map(s=>({code:String(s.pbn_number),label:String(s.pbn_number),description:it(s.pbn_date),vendor_name:s.vendor_name,vend_code:s.vend_code,sugar_type:s.sugar_type,crop_year:s.crop_year}));pe(t)}catch{pe([])}};return n.useEffect(()=>{rt()},[d?.company_id,f,w,_,W]),a.jsxs("div",{className:"space-y-4 p-6",children:[a.jsx(ht,{position:"top-right",autoClose:3e3}),a.jsxs("div",{className:"bg-blue-50 shadow-md rounded-lg p-6 space-y-4 border border-blue-300",children:[a.jsx("h2",{className:"text-xl font-bold text-blue-800 mb-2",children:"PURCHASE JOURNAL"}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsx("div",{className:"col-span-2",children:a.jsx(y,{label:"Search Transaction",value:Ae,onChange:e=>tt(e),items:Xe,search:V,onSearchChange:ce,headers:["Id","Purchase No","Vendor","Date","Amount","Vendor Inv #"],columnWidths:["60px","120px","160px","110px","120px","120px"],dropdownPositionStyle:{width:"820px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsxs("div",{children:[a.jsx(y,{label:"Vendor",value:f,onChange:e=>{E(e);const c=I.find(t=>String(t.code)===String(e));A(c?.description||"")},items:I,search:je,onSearchChange:Ce,headers:["Code","Description"],columnWidths:["140px","520px"],dropdownPositionStyle:{width:"700px"},inputClassName:"p-2 text-sm bg-white"}),q&&a.jsxs("div",{className:"mt-1 text-xs font-semibold text-gray-700",children:["Vendor: ",q]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1",children:"Date"}),a.jsx("input",{type:"date",value:N,disabled:Q,onChange:e=>$(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),a.jsx("div",{children:a.jsx(y,{label:"Crop Year",value:_,onChange:L,items:ve,search:ke,onSearchChange:Te,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsx("div",{children:a.jsx(y,{label:"Sugar Type",value:w,onChange:M,items:Se,search:De,onSearchChange:Re,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsx("div",{children:a.jsx(y,{label:"Mill Code",value:X,onChange:F,items:Ne,search:Pe,onSearchChange:Ee,headers:["Code","Description"],columnWidths:["120px","260px"],dropdownPositionStyle:{width:"420px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1",children:"Explanation"}),a.jsx("input",{value:G,disabled:Q,onChange:e=>O(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),a.jsx("div",{children:a.jsx(y,{label:"Booking #",value:J,onChange:B,items:He,search:W,onSearchChange:Ie,headers:["PBN No","PBN Date"],columnWidths:["140px","140px"],dropdownPositionStyle:{width:"360px"},inputClassName:"p-2 text-sm bg-white"})}),a.jsx("div",{})]}),a.jsx("div",{className:"flex gap-2 mt-3",children:r?a.jsxs(a.Fragment,{children:[a.jsxs("button",{onClick:Ke,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700",children:[a.jsx(ye,{className:"h-5 w-5"}),"Update"]}),a.jsx("button",{onClick:Qe,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:"Cancel"}),a.jsx("button",{onClick:Ze,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:"Delete"})]}):a.jsxs("button",{onClick:Je,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[a.jsx(ye,{className:"h-5 w-5"}),"Save"]})})]}),a.jsxs("div",{ref:ue,className:"relative z-0",children:[a.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),$e&&a.jsx(lt,{className:"hot-enhanced",ref:m,data:C,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,c)=>{const t=Ge;if(!e)return c(t);const s=String(e).toLowerCase();c(t.filter(o=>o.toLowerCase().includes(s)))},filter:!0,strict:!0,allowInvalid:!1,visibleRows:12,readOnly:j,renderer:(e,c,t,s,o,i,p)=>{const h=T(String(i??""));_e.renderers.TextRenderer(e,c,t,s,o,h,p)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:j},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:j}],afterBeginEditing:ct,afterChange:(e,c)=>{const t=m.current?.hotInstance;!e||!t||c==="edit"&&(e.forEach(([s,o,i,p])=>{if(o==="acct_code"){const h=String(p||""),R=T(h);t.setDataAtRowProp(s,"acct_desc",z(R));const k={...t.getSourceDataAtRow(s)},dt={id:k.id,acct_code:h,acct_desc:z(R),debit:Number(k.debit||0),credit:Number(k.credit||0),persisted:!!k.persisted};setTimeout(()=>xe(dt,s),0)}if(o==="debit"||o==="credit"){const h={...t.getSourceDataAtRow(s)},R={...h,acct_code:h.acct_code,debit:Number(o==="debit"?p:h.debit||0),credit:Number(o==="credit"?p:h.credit||0)};setTimeout(()=>xe(R,s),0)}}),requestAnimationFrame(()=>{const s=t.getSourceData();s.find(o=>!o.acct_code)||s.push(g()),x([...s])}))},contextMenu:{items:{remove_row:{name:"ðŸ—‘ï¸ Remove row",callback:async(e,c)=>{const t=m.current?.hotInstance,s=c[0].start.row,o=t?.getSourceData()||[],i=o[s];if(!i?.id){o.splice(s,1),x([...o]);return}(await b.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed&&(await l.post("/api/purchase/delete-detail",{id:i.id,transaction_id:r}),o.splice(s,1),x([...o]),u.success("Row deleted"))}}}},manualColumnResize:!0,stretchH:"all",height:ze,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),a.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[a.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>de(!0),onMouseLeave:()=>de(!1),children:[a.jsxs("button",{type:"button",disabled:!r,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${r?"bg-white text-blue-700 border-blue-300 hover:bg-blue-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[a.jsx(ut,{className:`h-5 w-5 ${r?"text-blue-600":"text-gray-400"}`}),a.jsx("span",{children:"Download"}),a.jsx(ge,{className:"h-4 w-4 opacity-70"})]}),Me&&a.jsx("div",{className:"absolute left-0 top-full z-50",children:a.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:a.jsxs("button",{type:"button",onClick:st,disabled:!r,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${r?"text-gray-800 hover:bg-blue-50":"text-gray-400 cursor-not-allowed"}`,children:[a.jsx(mt,{className:`h-5 w-5 ${r?"text-blue-600":"text-gray-400"}`}),a.jsx("span",{className:"truncate",children:"Purchase Voucher â€“ Excel"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),a.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>re(!0),onMouseLeave:()=>re(!1),children:[a.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[a.jsx(xt,{className:"h-5 w-5"}),a.jsx("span",{children:"Print"}),a.jsx(ge,{className:"h-4 w-4 opacity-70"})]}),Le&&a.jsx("div",{className:"absolute left-0 top-full z-50",children:a.jsxs("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:[a.jsxs("button",{type:"button",onClick:at,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[a.jsx(be,{className:"h-5 w-5 text-red-600"}),a.jsx("span",{className:"truncate",children:"Purchase Voucher â€“ PDF"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]}),a.jsxs("button",{type:"button",onClick:()=>{if(!r)return u.info("Select or save a transaction.");window.open(`/api/purchase/check-pdf/${r}?company_id=${encodeURIComponent(d?.company_id||"")}`,"_blank")},className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[a.jsx(be,{className:"h-5 w-5 text-red-600"}),a.jsx("span",{className:"truncate",children:"Print Check â€“ PDF"}),a.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})]})})]}),a.jsxs("button",{type:"button",onClick:ot,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700",title:"Start a new transaction",children:[a.jsx(gt,{className:"h-5 w-5"}),a.jsx("span",{children:"New"})]})]}),Be&&a.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:a.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[a.jsx("button",{onClick:()=>le(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"âœ•"}),a.jsx("div",{className:"h-full w-full pt-8",children:a.jsx("iframe",{title:"Purchase Voucher PDF",src:Fe,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{Nt as default};
