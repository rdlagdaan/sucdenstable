import{n as o,j as e,F as Ge}from"./index-DaN3CB7B.js";import{r as a,H as Ke,a as $e,N as ze}from"./handsontable-7BBM75Z1.js";import{L as Je,D as Xe,y as c,c as le,F as Ze,a as et,S as tt,b as st}from"./DropdownWithHeaders-wxAsr3ld.js";import"./react-Csw2ODfV.js";$e.cellTypes.registerCellType("numeric",ze);const p=u=>Number(Math.round((u||0)*100)/100).toLocaleString("en-US",{minimumFractionDigits:2}),x=u=>u?new Date(u).toISOString().slice(0,10):"";function it(){const u=a.useRef(null),[k,oe]=a.useState(!1),[H,de]=a.useState([]),[h,ue]=a.useState(""),[i,Q]=a.useState(""),[y,C]=a.useState(""),[me,B]=a.useState(""),[pe,V]=a.useState(""),[xe,G]=a.useState(""),[K,R]=a.useState(""),[$,D]=a.useState(""),[N,F]=a.useState(""),[_,O]=a.useState(""),[T,I]=a.useState(!1),[A,M]=a.useState(!1),[E,f]=a.useState(""),[P,v]=a.useState(""),[j,he]=a.useState(0),[L,ge]=a.useState(0),[z,be]=a.useState(0),[J,ye]=a.useState(0),[X,Ne]=a.useState(0),[g,w]=a.useState([]),[_e,Z]=a.useState(!1),[fe,ve]=a.useState(0),[je,we]=a.useState(0),[Se,ke]=a.useState(0),[Ce,Re]=a.useState(0),[De,Fe]=a.useState(0),[Oe,Te]=a.useState(0);a.useEffect(()=>{(async()=>{const{data:t}=await o.get("/api/receiving/rr-list",{params:{include_posted:k?"1":"0",q:h}});de(t||[])})().catch(console.error)},[k,h]);const Ie=a.useMemo(()=>{const t=h.toLowerCase();return H.filter(s=>(s.receipt_no||"").toLowerCase().includes(t)||(s.pbn_number||"").toLowerCase().includes(t)||(s.vendor_name||"").toLowerCase().includes(t))},[H,h]),Ae=async t=>{try{Q(t);const{data:s}=await o.get("/api/receiving/entry",{params:{receipt_no:t}});C(x(s.receipt_date)||""),B(s.pbn_number||""),V(s.item_number||""),G(s.vendor_name||""),R(s.mill||""),D(s.gl_account_key||""),F(s.assoc_dues??""),O(s.others??""),I(!!s.no_storage),M(!!s.no_insurance),v(s.insurance_week?x(s.insurance_week):""),f(s.storage_week?x(s.storage_week):"");const[{data:r},{data:n}]=await Promise.all([o.get("/api/receiving/pbn-item",{params:{pbn_number:s.pbn_number,item_no:s.item_number}}),o.get("/api/mills/rate",{params:{mill_name:s.mill,as_of:x(s.receipt_date)}})]);he(Number(r?.unit_cost||0)),ge(Number(r?.commission||0)),be(Number(n?.insurance_rate||0)),ye(Number(n?.storage_rate||0)),Ne(Number(n?.days_free||0));const{data:l}=await o.get("/api/receiving/details",{params:{receipt_no:t}});w(Array.isArray(l)?l.map(d=>({...d,persisted:!0})):[]),Z(!0)}catch(s){console.error(s),c.error("Failed to load Receiving Entry.")}},Me=(t,s)=>{const r=(new Date(s).getTime()-new Date(t).getTime())/864e5;return Math.ceil(Math.abs(r)/30)},Ee=(t,s,r)=>{let n=(new Date(s).getTime()-new Date(t).getTime())/864e5;return n=n-r,n<0&&(n=0),Math.floor(n/30)},Pe=t=>{let s=0,r=0,n=0,l=0,d=0,re=0;const S=y||"",He=P||"",Qe=E||"";t.forEach(m=>{const b=Number(m.quantity||0),Be=Number(m.liens||0);s+=b,r+=Be;const ce=He||(m.week_ending?x(m.week_ending):""),ie=Qe||(m.week_ending?x(m.week_ending):"");let U=0;if(ce&&S&&!A){const Y=Me(ce,S);U=b*(z||0)*Y}let q=0;if(ie&&S&&!T){const Y=Ee(ie,S,X||0);q=b*(J||0)*Y}const Ve=b*(j||0)-(L||0);l+=U,n+=q,d+=Ve,re+=b*(j||0)-U-q}),ve(s),we(r),ke(n),Re(l),Fe(d),Te(re)};a.useEffect(()=>{Pe(g)},[g,y,P,E,A,T,j,L,z,J,X]);const ee=async(t,s)=>{i&&await o.post("/api/receiving/update-flag",{receipt_no:i,field:t,value:s?1:0})},W=async(t,s)=>{i&&await o.post("/api/receiving/update-date",{receipt_no:i,field:t,value:s||null})},Le=async t=>{I(t);try{await ee("no_storage",t)}catch{c.error("Failed to update Storage flag")}},We=async t=>{M(t);try{await ee("no_insurance",t)}catch{c.error("Failed to update Insurance flag")}},te=async t=>{f(t);try{await W("storage_week",t)}catch{c.error("Failed to update Storage Week")}},se=async t=>{v(t);try{await W("insurance_week",t)}catch{c.error("Failed to update Insurance Week")}},ae=async t=>{C(t);try{await W("receipt_date",t),c.success("Date Received updated")}catch{c.error("Failed to update Date Received")}},Ue=async()=>{if(i)try{await o.post("/api/receiving/update-mill",{receipt_no:i,mill:K}),c.success("Mill updated")}catch{c.error("Failed to update Mill")}},qe=async(t,s)=>{if(i)try{const r={receipt_no:i,row_index:s,row:t},{data:n}=await o.post("/api/receiving/batch-insert",r),l=n?.id;if(l){const d=[...g];d[s]={...t,id:l,persisted:!0},w(d)}}catch(r){console.error(r),c.error("Auto-save failed.")}},ne=async t=>{t==="storage"?(f(""),await te("")):(v(""),await se(""))},Ye=()=>{Q(""),Z(!1),w([]),C(""),B(""),V(""),G(""),R(""),F(""),O(""),M(!1),I(!1),v(""),f(""),D(""),c.success("Ready for new Receiving Entry")};return e.jsxs("div",{className:"p-4",children:[e.jsx(Je,{position:"top-right",autoClose:2200}),e.jsxs("div",{className:"border rounded-md shadow-sm",children:[e.jsx("div",{className:"px-4 py-2 border-b text-sm font-semibold",children:"RECEIVING ENTRY"}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-2 items-end",children:[e.jsxs("div",{className:"col-span-1 flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:k,onChange:()=>oe(t=>!t)}),e.jsx("span",{className:"text-sm",children:" "})]}),e.jsxs("div",{className:"col-span-6",children:[e.jsx("label",{className:"block text-sm mb-1",children:"Receiving #:"}),e.jsx(Xe,{label:"",value:i,onChange:Ae,items:Ie.map(t=>({code:t.receipt_no,label:t.receipt_no,description:t.vendor_name,quantity:t.quantity,pbn_number:t.pbn_number,sugar_type:t.sugar_type,receipt_date:t.receipt_date})),search:h,onSearchChange:ue,headers:["Receipt No","Quantity","Sugar Type","PBN No","RDate","Vendor ID","Vendor Name"],columnWidths:["120px","90px","60px","100px","120px","120px","220px"],dropdownPositionStyle:{minWidth:"900px"},customKey:"rr"})]}),e.jsxs("div",{className:"col-span-5 grid grid-cols-5 items-end gap-2",children:[e.jsxs("div",{className:"col-span-4",children:[e.jsx("label",{className:"block text-sm mb-1",children:"Date Received:"}),e.jsx("input",{type:"date",value:y,onChange:t=>ae(t.target.value),className:"w-full border p-2 rounded bg-yellow-100 text-gray-900"})]}),e.jsx("button",{onClick:()=>ae(y),className:"col-span-1 mt-6 inline-flex justify-center items-center text-xs px-2 py-2 border rounded",title:"Update Date",children:"UD"})]})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-2 items-end",children:[e.jsxs("div",{className:"col-span-7",children:[e.jsx("label",{className:"block text-sm mb-1",children:"PBN #:"}),e.jsx("input",{value:me,disabled:!0,className:"w-full border p-2 rounded bg-yellow-100 text-gray-900"})]}),e.jsxs("div",{className:"col-span-5",children:[e.jsx("label",{className:"block text-sm mb-1",children:"Item #:"}),e.jsx("input",{value:pe,disabled:!0,className:"w-full border p-2 rounded bg-yellow-100 text-gray-900"})]})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-2 items-end",children:[e.jsxs("div",{className:"col-span-7",children:[e.jsx("label",{className:"block text-sm mb-1",children:"Vendor Name:"}),e.jsx("input",{value:xe,disabled:!0,className:"w-full border p-2 rounded bg-yellow-100 text-gray-900"})]}),e.jsxs("div",{className:"col-span-4",children:[e.jsx("label",{className:"block text-sm mb-1",children:"Mill:"}),e.jsx("input",{value:K,onChange:t=>R(t.target.value),className:"w-full border p-2 rounded bg-yellow-100 text-gray-900"})]}),e.jsx("button",{onClick:Ue,className:"col-span-1 mt-6 inline-flex justify-center items-center text-xs px-2 py-2 border rounded",title:"Update Mill",children:"UM"})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Details"}),_e&&e.jsx(Ke,{ref:u,data:g,colHeaders:["Quedan #","Quantity","Liens","Week Ending","Date Issued","Planter TIN","Planter Name","Item","Mill","Unit Cost","Commission","Storage","Insurance","Total AP"],columns:[{data:"quedan_no",type:"text"},{data:"quantity",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"liens",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"week_ending",type:"date",dateFormat:"YYYY-MM-DD",correctFormat:!0},{data:"date_issued",type:"date",dateFormat:"YYYY-MM-DD",correctFormat:!0},{data:"planter_tin",type:"text"},{data:"planter_name",readOnly:!0},{data:"item_no",readOnly:!0},{data:"mill",readOnly:!0},{data:"unit_cost",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"commission",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"storage",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"insurance",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"total_ap",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}}],stretchH:"all",height:380,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation",afterChange:(t,s)=>{if(!t||s!=="edit")return;const r=[...g];t.forEach(([n])=>{const l=r[n]||{};l.unit_cost=j,l.commission=L,r[n]=l,l.quedan_no&&l.quantity!=null&&qe(l,n)}),w(r)}})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-4 pt-2",children:[e.jsxs("div",{className:"col-span-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:" Total Quantity____ "}),e.jsx("input",{className:"flex-1 border rounded p-2 bg-white",value:p(fe),readOnly:!0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:" Total Liens______ "}),e.jsx("input",{className:"flex-1 border rounded p-2 bg-white",value:p(je),readOnly:!0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:" Account Code: "}),e.jsx("input",{className:"flex-1 border rounded p-2",value:$,onChange:t=>D(t.target.value),onBlur:async()=>{if(i)try{await o.post("/api/receiving/update-gl",{receipt_no:i,gl_account_key:$}),c.success("GL Account updated")}catch{c.error("Failed to update GL Account")}}})]})]}),e.jsxs("div",{className:"col-span-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:" Total Insurance_ "}),e.jsx("input",{className:"flex-1 border rounded p-2 bg-white",value:p(Ce),readOnly:!0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:" Total Storage___ "}),e.jsx("input",{className:"flex-1 border rounded p-2 bg-white",value:p(Se),readOnly:!0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:" Assoc Dues______ "}),e.jsx("input",{type:"number",step:"0.01",className:"flex-1 border rounded p-2",value:N,onChange:t=>F(t.target.value===""?"":Number(t.target.value)),onBlur:async()=>{if(i)try{await o.post("/api/receiving/update-assoc-others",{receipt_no:i,assoc_dues:Number(N||0),others:Number(_||0)}),c.success("Assoc/Others saved")}catch{c.error("Failed to save Assoc/Others")}}})]})]}),e.jsxs("div",{className:"col-span-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:" Total Cost______ "}),e.jsx("input",{className:"flex-1 border rounded p-2 bg-white",value:p(De),readOnly:!0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:" Total AP Cost___ "}),e.jsx("input",{className:"flex-1 border rounded p-2 bg-white",value:p(Oe+Number(N||0)+Number(_||0)),readOnly:!0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:" Others________ "}),e.jsx("input",{type:"number",step:"0.01",className:"flex-1 border rounded p-2",value:_,onChange:t=>O(t.target.value===""?"":Number(t.target.value)),onBlur:async()=>{if(i)try{await o.post("/api/receiving/update-assoc-others",{receipt_no:i,assoc_dues:Number(N||0),others:Number(_||0)}),c.success("Assoc/Others saved")}catch{c.error("Failed to save Assoc/Others")}}})]})]})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-4 items-end pt-1",children:[e.jsxs("div",{className:"col-span-3 flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:T,onChange:t=>Le(t.target.checked)}),e.jsx("span",{children:"No Storage"})]}),e.jsxs("div",{className:"col-span-3 flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:A,onChange:t=>We(t.target.checked)}),e.jsx("span",{children:"No Insurance"})]}),e.jsxs("div",{className:"col-span-3",children:[e.jsx("label",{className:"block text-sm mb-1",children:"Storage Week"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("input",{type:"date",value:E,onChange:t=>te(t.target.value),className:"w-full border p-2 rounded"}),e.jsx("button",{title:"Clear",onClick:()=>ne("storage"),className:"border rounded px-2 flex items-center",children:e.jsx(le,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"col-span-3",children:[e.jsx("label",{className:"block text-sm mb-1",children:"Insurance Week"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("input",{type:"date",value:P,onChange:t=>se(t.target.value),className:"w-full border p-2 rounded"}),e.jsx("button",{title:"Clear",onClick:()=>ne("insurance"),className:"border rounded px-2 flex items-center",children:e.jsx(le,{className:"h-4 w-4"})})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsxs("button",{className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white",children:[e.jsx(Ze,{className:"h-5 w-5"}),e.jsx("span",{children:"Print"}),e.jsx(Ge,{className:"h-4 w-4"})]}),e.jsxs("button",{className:"inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700",onClick:Ye,children:[e.jsx(et,{className:"h-5 w-5"}),"New"]}),e.jsxs("button",{className:"inline-flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",onClick:()=>tt.fire({title:"Saved",icon:"success",timer:1200,showConfirmButton:!1}),children:[e.jsx(st,{className:"h-5 w-5"}),"Save"]})]})]})]})]})}export{it as default};
