import{n as u,j as t,F as ee}from"./index-DKCTrHCp.js";import{r,H as Te,a as se,N as $e}from"./handsontable-7BBM75Z1.js";/* empty css                              */import{S as w,F as ke,a as Ae,b as Oe}from"./sweetalert2.esm.all-B4pNkPRF.js";import{L as Fe,D as Le,b as te,y as l,F as Me,a as He}from"./DropdownWithHeaders-eiZ6sO4R.js";import"./react-Csw2ODfV.js";se.cellTypes.registerCellType("numeric",$e);function ae(p){if(!p)return"";const o=new Date(p);if(isNaN(o.getTime()))return(p||"").split("T")[0]||"";const N=o.getFullYear(),S=String(o.getMonth()+1).padStart(2,"0"),_=String(o.getDate()).padStart(2,"0");return`${N}-${S}-${_}`}const F=p=>(p||"").split(";")[0];function Ge(){const p=r.useRef(null),[o,N]=r.useState(null),[S,_]=r.useState(""),[P,D]=r.useState(""),[J,R]=r.useState(""),[I,v]=r.useState(!1),[C,j]=r.useState(!0),[h,E]=r.useState(!1),[L,Y]=r.useState([]),[G,z]=r.useState([]),[M,H]=r.useState(""),[ne,U]=r.useState(""),[f,b]=r.useState([{acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}]),[ce,T]=r.useState(!1),[re,q]=r.useState(!1),[oe,W]=r.useState(!1),[ie,le]=r.useState(void 0),[de,V]=r.useState(!1),X=r.useRef(null),[K,ue]=r.useState(600);r.useLayoutEffect(()=>{const e=()=>{const s=X.current?.getBoundingClientRect()?.top??0,a=window.innerHeight-s-140;ue(Math.max(320,Math.floor(a)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const me=28,pe=32,he=240,xe=r.useMemo(()=>{const e=Math.max(f.length,6),c=pe+e*me+he;return Math.min(c,K)},[f.length,K]),d=r.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);r.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/ga/accounts",{params:{company_id:d?.company_id}});Y(Array.isArray(e)?e:[])}catch{Y([])}})()},[d?.company_id]);const $=async()=>{try{const{data:e}=await u.get("/api/ga/list",{params:{company_id:d?.company_id||"",q:M||""}});z(Array.isArray(e)?e:[])}catch{z([])}};r.useEffect(()=>{$()},[M]);const ge=r.useMemo(()=>(G||[]).map(e=>({code:String(e.id),ga_no:e.ga_no,gen_acct_date:ae(e.gen_acct_date),explanation:e.explanation||"",label:e.ga_no,description:e.explanation||""})),[G]),x=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),be=()=>{U(""),H(""),N(null),_(""),D(""),R(""),v(!1),j(!1),E(!1),T(!1),b([x()])},fe=async()=>{if((await w.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed){try{if((await u.get("/api/ga/unbalanced-exists",{params:{company_id:d?.company_id||""}})).data?.exists){const s=await u.get("/api/ga/unbalanced",{params:{company_id:d?.company_id||"",limit:20}}),i=`
          <div style="text-align:left">
            <div style="margin-bottom:8px">There are unbalanced journal entries. Please balance them first before creating a new one.</div>
            <table style="width:100%;border-collapse:collapse;font-size:12px">
              <thead>
                <tr>
                  <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 8px">JE #</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Debit</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Credit</th>
                </tr>
              </thead>
              <tbody>${(Array.isArray(s.data?.items)?s.data.items:[]).map(m=>`
          <tr>
            <td style="padding:6px 8px">${m.ga_no}</td>
            <td style="padding:6px 8px;text-align:right">${Number(m.sum_debit||0).toLocaleString()}</td>
            <td style="padding:6px 8px;text-align:right">${Number(m.sum_credit||0).toLocaleString()}</td>
          </tr>
        `).join("")||'<tr><td colspan="3" style="padding:6px 8px;color:#6b7280">No detail available</td></tr>'}</tbody>
            </table>
          </div>`;await w.fire({icon:"warning",title:"Unbalanced found",html:i,confirmButtonText:"OK"});return}}catch{}try{const c=await u.get("/api/ga/generate-ga-number",{params:{company_id:d?.company_id}}),s=c.data?.ga_no??c.data;_(s);const a=await u.post("/api/ga/save-main",{ga_no:s,gen_acct_date:P,explanation:J,company_id:d?.company_id,user_id:d?.id});N(a.data.id),T(!0),b([x(),x()]),l.success("Journal header saved. You can now input details."),v(!0),j(!1),$()}catch(c){l.error(c?.response?.data?.message||"Failed to save.")}}},ye=()=>{v(!1),j(!1),l.success("Editing enabled.")},Q=async e=>{if(!(!o||!(await w.fire({title:e?"Cancel this entry?":"Uncancel this entry?",icon:e?"warning":"question",showCancelButton:!0,confirmButtonText:e?"Yes, Cancel":"Yes, Uncancel"})).isConfirmed))try{await u.post("/api/ga/cancel",{id:o,flag:e?"1":"0"}),E(e),j(!0),v(!0),l.success(e?"Entry cancelled.":"Entry reactivated."),$()}catch{l.error("Failed to update cancel status.")}},we=async()=>{if(!(!o||!(await w.fire({title:"Delete this journal?",text:"This action cannot be undone.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await u.delete(`/api/ga/${o}`),be(),l.success("Journal deleted."),$()}catch{l.error("Failed to delete journal.")}},Ne=e=>!!F(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,Z=async(e,c)=>{if(!o||h||!Ne(e))return;const s=F(e.acct_code);try{if(e.persisted)await u.post("/api/ga/update-detail",{id:e.id,transaction_id:o,acct_code:s,debit:e.debit||0,credit:e.credit||0});else{const a=await u.post("/api/ga/save-detail",{transaction_id:o,acct_code:s,debit:e.debit||0,credit:e.credit||0,company_id:d?.company_id,user_id:d?.id}),i=p.current?.hotInstance?.getSourceData()||[];i[c]&&(i[c].persisted=!0,i[c].id=a.data.detail_id),i.find(m=>!m.acct_code)||i.push(x()),b([...i])}}catch(a){l.error(a?.response?.data?.message||"Row save failed")}},_e=async e=>{if(e)try{U(e);const{data:c}=await u.get(`/api/ga/${e}`,{params:{company_id:d?.company_id}}),s=c.main??c;N(s.id),_(s.ga_no),D(ae(s.gen_acct_date)),R(s.explanation??""),E(s.is_cancel==="y");const a=(c.details||[]).map(n=>({id:n.id,acct_code:`${n.acct_code};${n.acct_desc||B(n.acct_code)}`,acct_desc:n.acct_desc,debit:Number(n.debit??0),credit:Number(n.credit??0),persisted:!0}));b(a.length?a.concat([x()]):[x()]),T(!0),v(!0),j(!0),l.success("Journal loaded.")}catch{l.error("Unable to load the selected journal.")}},ve=r.useMemo(()=>L.map(e=>`${e.acct_code};${e.acct_desc}`),[L]),B=e=>L.find(c=>c.acct_code===e)?.acct_desc||"",y=r.useMemo(()=>{const e=f.reduce((a,n)=>a+(Number(n.debit)||0),0),c=f.reduce((a,n)=>a+(Number(n.credit)||0),0),s=Math.abs(e-c)<.005;return{sumD:e,sumC:c,balanced:s}},[f]),k=e=>(Number(e)||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),je=async()=>{if(f.some(s=>s.acct_code&&s.acct_code.trim()!==""||(Number(s.debit)||0)>0||(Number(s.credit)||0)>0)&&!y.balanced){await w.fire({title:"Not balanced",html:`Debit <b>${k(y.sumD)}</b> must equal Credit <b>${k(y.sumC)}</b> before starting a new one.`,icon:"error"});return}(await w.fire({title:"Start a new journal?",text:"This will clear the current form.",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, New"})).isConfirmed&&(U(""),H(""),N(null),_(""),D(""),R(""),v(!1),j(!1),E(!1),b([x(),x(),x()]),T(!1),l.success("Form is ready for a new entry."))},Ce=0,Se=(e,c)=>{if(C||c!==Ce)return;const a=p.current?.hotInstance?.getActiveEditor();a?.cellProperties?.type==="autocomplete"&&(a.TEXTAREA.value="",a.query="",a.open(),a.refreshDropdown?.())},De=()=>{if(!o)return l.info("Select or save a journal first.");const e=`/api/ga/form-pdf/${o}?company_id=${encodeURIComponent(d?.company_id||"")}`;le(e),V(!0)},Re=async()=>{if(!o)return l.info("Select or save a journal first.");const e=await u.get(`/api/ga/form-excel/${o}`,{responseType:"blob",params:{company_id:d?.company_id||""}}),c=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`JournalVoucher_${S||o}.xlsx`,s=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),a=URL.createObjectURL(s),n=document.createElement("a");n.href=a,n.download=c,document.body.appendChild(n),n.click(),n.remove(),URL.revokeObjectURL(a)};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(Fe,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-yellow-50 shadow-md rounded-lg p-6 space-y-4 border border-yellow-400",children:[t.jsx("h2",{className:"text-xl font-bold text-green-800 mb-2",children:"GENERAL ACCOUNTING — JOURNAL ENTRY"}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsx("div",{className:"col-span-3",children:t.jsx(Le,{label:"Search JE",value:ne,onChange:e=>_e(e),items:ge,search:M,onSearchChange:H,headers:["Id","JE No","Date","Explanation"],columnWidths:["60px","120px","120px","420px"],dropdownPositionStyle:{width:"850px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:P,disabled:I||h,onChange:e=>D(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Explanation"}),t.jsx("input",{value:J,disabled:I||h,onChange:e=>R(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{className:"col-span-3 flex items-center gap-6 text-sm",children:[t.jsxs("div",{className:"font-semibold",children:["JE No: ",t.jsx("span",{className:"text-gray-800",children:S||"—"})]}),t.jsxs("div",{className:"font-semibold",children:["Total Debit: ",t.jsx("span",{className:"text-blue-700",children:k(y.sumD)})]}),t.jsxs("div",{className:"font-semibold",children:["Total Credit: ",t.jsx("span",{className:"text-blue-700",children:k(y.sumC)})]}),t.jsx("div",{className:`px-2 py-0.5 rounded text-white ${y.balanced?"bg-emerald-600":"bg-red-500"}`,children:y.balanced?"Balanced":"Unbalanced"}),h&&t.jsx("div",{className:"px-2 py-0.5 rounded bg-amber-600 text-white",children:"CANCELLED"})]})]}),t.jsx("div",{className:"flex gap-2 mt-3",children:o?t.jsxs(t.Fragment,{children:[!h&&t.jsxs("button",{onClick:ye,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[t.jsx(te,{className:"h-5 w-5"}),"Update"]}),h?t.jsx("button",{onClick:()=>Q(!1),className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700",children:"Uncancel"}):t.jsx("button",{onClick:()=>Q(!0),className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:"Cancel"}),t.jsx("button",{onClick:we,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:"Delete"})]}):t.jsxs("button",{onClick:fe,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700",children:[t.jsx(te,{className:"h-5 w-5"}),"Save"]})})]}),t.jsxs("div",{ref:X,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),ce&&t.jsx(Te,{className:"hot-enhanced",ref:p,data:f,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,c)=>{const s=ve;if(!e)return c(s);const a=String(e).toLowerCase();c(s.filter(n=>n.toLowerCase().includes(a)))},filter:!0,strict:!0,allowInvalid:!1,visibleRows:14,readOnly:C||h,renderer:(e,c,s,a,n,i,m)=>{const g=F(String(i??""));se.renderers.TextRenderer(e,c,s,a,n,g,m)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:C||h},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:C||h}],afterBeginEditing:Se,afterChange:(e,c)=>{const s=p.current?.hotInstance;!e||!s||h||c==="edit"&&(e.forEach(([a,n,i,m])=>{if(n==="acct_code"){const g=String(m||""),A=F(g);s.setDataAtRowProp(a,"acct_desc",B(A));const O={...s.getSourceDataAtRow(a)},Ee={id:O.id,acct_code:g,acct_desc:B(A),debit:Number(O.debit||0),credit:Number(O.credit||0),persisted:!!O.persisted};setTimeout(()=>Z(Ee,a),0)}if(n==="debit"||n==="credit"){const g={...s.getSourceDataAtRow(a)},A={...g,acct_code:g.acct_code,debit:Number(n==="debit"?m:g.debit||0),credit:Number(n==="credit"?m:g.credit||0)};setTimeout(()=>Z(A,a),0)}}),requestAnimationFrame(()=>{const a=s.getSourceData();a.find(n=>!n.acct_code)||a.push(x()),b([...a])}))},contextMenu:{items:{remove_row:{name:"🗑️ Remove row",callback:async(e,c)=>{if(C||h)return;const s=p.current?.hotInstance,a=c[0].start.row,n=s?.getSourceData()||[],i=n[a];if(!i?.id){n.splice(a,1),b([...n]);return}(await w.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed&&(await u.post("/api/ga/delete-detail",{id:i.id,transaction_id:o}),n.splice(a,1),b([...n]),l.success("Row deleted"))}}}},manualColumnResize:!0,stretchH:"all",height:xe,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>W(!0),onMouseLeave:()=>W(!1),children:[t.jsxs("button",{type:"button",disabled:!o,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${o?"bg-white text-emerald-700 border-emerald-300 hover:bg-emerald-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(ke,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(ee,{className:"h-4 w-4 opacity-70"})]}),oe&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:Re,disabled:!o,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${o?"text-gray-800 hover:bg-emerald-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx(Ae,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Journal Voucher – Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>q(!0),onMouseLeave:()=>q(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx(Me,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(ee,{className:"h-4 w-4 opacity-70"})]}),re&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-72 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:De,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(Oe,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Journal Voucher – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})})})]}),t.jsxs("button",{type:"button",onClick:je,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 focus:outline-none",title:"Start a new journal",children:[t.jsx(He,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]})]}),de&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>V(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"✕"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Journal Voucher PDF",src:ie,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{Ge as default};
