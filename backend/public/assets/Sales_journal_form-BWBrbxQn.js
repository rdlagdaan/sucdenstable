import{n as u,j as t,F as ee}from"./index-DWQCuE1b.js";import{r as c,H as Le,a as $e,N as Ae}from"./handsontable-7BBM75Z1.js";import{L as Me,D as te,b as se,y as l,F as He,a as Ie}from"./DropdownWithHeaders-Cfh1Lvbu.js";import{S as T,F as Pe,a as Ue,b as ae}from"./sweetalert2.esm.all-B4pNkPRF.js";import"./react-Csw2ODfV.js";$e.cellTypes.registerCellType("numeric",Ae);function Be(x){if(!x)return"";const b=new Date(x);if(isNaN(b.getTime()))return"";const g=b.getFullYear(),N=String(b.getMonth()+1).padStart(2,"0"),y=String(b.getDate()).padStart(2,"0");return`${g}-${N}-${y}`}function We(){const x=c.useRef(null),[b,g]=c.useState(""),[N,y]=c.useState(""),[H,v]=c.useState(""),[I,S]=c.useState(""),[P,j]=c.useState(""),[U,C]=c.useState(""),[o,D]=c.useState(null),[_,w]=c.useState(!1),[B,E]=c.useState(!0),[F,Y]=c.useState([]),[O,z]=c.useState([]),[ne,ce]=c.useState(""),[oe,L]=c.useState(""),[$,A]=c.useState(""),[G,X]=c.useState([]),[h,f]=c.useState([]),[re,R]=c.useState(!1),[ie,q]=c.useState(!1),[le,W]=c.useState(!1),[de,ue]=c.useState(void 0),[me,J]=c.useState(!1),V=c.useRef(null),[K,pe]=c.useState(600);c.useLayoutEffect(()=>{const e=()=>{const s=V.current?.getBoundingClientRect()?.top??0,n=window.innerHeight-s-140;pe(Math.max(320,Math.floor(n)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const he=28,fe=32,xe=240,be=c.useMemo(()=>{const e=Math.max(h.length,6),a=fe+e*he+xe;return Math.min(a,K)},[h.length,K]),i=c.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);c.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/customers",{params:{company_id:i?.company_id}}),a=(e||[]).map(s=>({code:String(s.cust_id??s.code),label:s.cust_name??s.label??"",description:s.cust_name??s.description??""}));Y(a)}catch(e){console.error("Failed to load customers",e),Y([])}})()},[i?.company_id]),c.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/accounts",{params:{company_id:i?.company_id}});z(Array.isArray(e)?e:[])}catch(e){console.error("Failed to load accounts",e),z([])}})()},[i?.company_id]);const k=async()=>{try{const{data:e}=await u.get("/api/sales/list",{params:{company_id:i?.company_id||"",q:$||""}}),a=Array.isArray(e)?e:[];X(a)}catch(e){console.error("Failed to load cash sales list",e),X([])}};c.useEffect(()=>{k()},[$]);const ge=c.useMemo(()=>(G||[]).map(e=>({code:String(e.id),cs_no:e.cs_no,cust_id:e.cust_id,sales_date:e.sales_date,sales_amount:e.sales_amount,si_no:e.si_no,label:e.cs_no,description:e.cust_id})),[G]),m=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),ye=()=>{L(""),A(""),g(""),y(""),v(""),S(""),j(""),C(""),D(null),w(!1),R(!1),f([m()])},we=async()=>{if((await T.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed)try{const a=await u.get("/api/sales/generate-cs-number",{params:{company_id:i?.company_id}}),s=a.data?.cs_no??a.data;g(s);const n=await u.post("/api/sales/save-main",{cs_no:s,cust_id:N,sales_date:I,explanation:P,si_no:U,company_id:i?.company_id,user_id:i?.id});D(n.data.id),R(!0),f([m(),m()]),l.success("Main saved. You can now input details."),k(),w(!0),E(!1)}catch(a){console.error(a),l.error(a?.response?.data?.message||"Failed to save.")}},_e=()=>{w(!1),E(!1),l.success("Editing enabled. You can now update this transaction.")},Ne=async()=>{if(!(!o||!(await T.fire({title:"Cancel this transaction?",text:"This will mark the transaction as CANCELLED.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, cancel it"})).isConfirmed))try{await u.post("/api/sales/cancel",{id:o,is_cancel:"y",company_id:i?.company_id||""}),w(!0),l.success("Transaction has been cancelled."),k()}catch(a){console.error(a),l.error("Failed to cancel transaction.")}},ve=async()=>{if(!(!o||!(await T.fire({title:"Delete this transaction?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await u.delete(`/api/sales/${o}`),ye(),l.success("Transaction deleted."),k()}catch(a){console.error(a),l.error("Failed to delete transaction.")}},Se=e=>e.acct_code&&(e.debit??0)>0!=(e.credit??0)>0,je=async(e,a)=>{if(o&&Se(e))try{if(e.persisted)await u.post("/api/sales/update-detail",{id:e.id,transaction_id:o,acct_code:e.acct_code,debit:e.debit||0,credit:e.credit||0});else{const s=await u.post("/api/sales/save-detail",{transaction_id:o,acct_code:e.acct_code,debit:e.debit||0,credit:e.credit||0,company_id:i?.company_id,user_id:i?.id}),n=[...h];n[a]={...e,id:s.data.detail_id,persisted:!0},a===n.length-1&&n.push(m()),f(n)}}catch(s){console.error(s),l.error(s?.response?.data?.message||"Row save failed")}},Ce=async e=>{if(e)try{L(e);const{data:a}=await u.get(`/api/sales/${e}`,{params:{company_id:i?.company_id}}),s=a.main??a;D(s.id),g(s.cs_no),y(String(s.cust_id||""));const n=F.find(r=>String(r.code)===String(s.cust_id));v(n?.description||n?.label||"");const d=Be(s.sales_date);S(d),j(s.explanation??""),C(s.si_no??"");const p=(a.details||[]).map(r=>({id:r.id,acct_code:r.acct_code,acct_desc:r.acct_desc,debit:Number(r.debit??0),credit:Number(r.credit??0),persisted:!0}));f(p.length?p.concat([m()]):[m()]),R(!0),w(!0),E(!0),l.success("Transaction loaded.")}catch(a){console.error(a),l.error("Unable to load the selected transaction.")}},De=c.useMemo(()=>O.map(e=>`${e.acct_code};${e.acct_desc}`),[O]),Ee=e=>O.find(s=>s.acct_code===e)?.acct_desc||"",Re=()=>{if(!o)return l.info("Select or save a transaction first.");const e=`/api/sales/form-pdf/${o}?company_id=${encodeURIComponent(i?.company_id||"")}`;ue(e),J(!0)},ke=async()=>{if(!o)return l.info("Select or save a transaction first.");const e=await u.get(`/api/sales/form-excel/${o}`,{responseType:"blob",params:{company_id:i?.company_id||""}}),a=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`SalesVoucher_${b||o}.xlsx`,s=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),n=URL.createObjectURL(s),d=document.createElement("a");d.href=n,d.download=a,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(n)},Te=()=>{L(""),A(""),D(null),g(""),y(""),v(""),S(""),j(""),C(""),w(!1),E(!1),f([m(),m(),m(),m()]),R(!1),l.success("Form is ready for a new entry.")},Q=0,Fe=(e,a)=>{if(a!==Q)return;const s=x.current?.hotInstance;if(!s)return;const n=s.getActiveEditor();n?.cellProperties?.type==="autocomplete"&&(n.TEXTAREA.value="",n.query="",n.open(),n.refreshDropdown?.())},Oe=(e,a)=>{if(a!==Q||B)return;const s=x.current?.hotInstance;s&&requestAnimationFrame(()=>{const n=s.getActiveEditor();n&&(n.beginEditing(""),n.cellProperties?.type==="autocomplete"&&(n.TEXTAREA.value="",n.query="",n.refreshDropdown?.()))})};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(Me,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-yellow-50 shadow-md rounded-lg p-6 space-y-4 border border-yellow-400",children:[t.jsx("h2",{className:"text-xl font-bold text-green-800 mb-2",children:"SALES JOURNAL"}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsx("div",{className:"col-span-3",children:t.jsx(te,{label:"Search Transaction",value:oe,onChange:e=>Ce(e),items:ge,search:$,onSearchChange:A,headers:["ID","Sales No","Customer","Date","Amount","S.I. #"],inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-2",children:t.jsx(te,{label:"Customer",value:N,onChange:e=>{y(e);const a=F.find(s=>String(s.code)===String(e));v(a?.description||a?.label||"")},items:F,search:ne,onSearchChange:ce,headers:["Code","Label","Description"],inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:I,disabled:_,onChange:e=>S(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Explanation"}),t.jsx("input",{value:P,disabled:_,onChange:e=>j(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"S.I. #"}),t.jsx("input",{value:U,disabled:_,onChange:e=>C(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),H&&t.jsxs("div",{className:"col-span-3 text-sm font-semibold text-gray-700",children:["Customer: ",H]})]}),t.jsx("div",{className:"flex gap-2 mt-3",children:o?t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:_e,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[t.jsx(se,{className:"h-5 w-5"}),"Update"]}),t.jsx("button",{onClick:Ne,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:"Cancel"}),t.jsx("button",{onClick:ve,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:"Delete"})]}):t.jsxs("button",{onClick:we,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700",children:[t.jsx(se,{className:"h-5 w-5"}),"Save"]})})]}),t.jsxs("div",{ref:V,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),re&&t.jsx(Le,{ref:x,data:h,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,a)=>{const s=De;if(!e)return a(s);const n=String(e).toLowerCase();a(s.filter(d=>d.toLowerCase().includes(n)))},filter:!0,strict:!1,allowInvalid:!1,visibleRows:12,readOnly:B},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:_},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:_}],afterBeginEditing:Fe,afterSelectionEnd:Oe,afterChange:(e,a)=>{if(!e||a!=="edit")return;const s=[...h];e.forEach(([n,d,,p])=>{const r=s[n]||{};if(d==="acct_code"){const M=String(p||""),Z=M.includes(";")?M.split(";")[0]:M;r.acct_code=Z,r.acct_desc=Ee(Z)}d==="debit"&&(r.debit=Number(p||0)),d==="credit"&&(r.credit=Number(p||0)),s[n]=r,setTimeout(()=>je(r,n),0)}),s.find(n=>!n.acct_code)||s.push(m()),f(s)},contextMenu:{items:{remove_row:{name:"🗑️ Remove row",callback:async(e,a)=>{const s=a[0].start.row,n=h[s];if(!n?.id){const r=[...h];r.splice(s,1),f(r);return}if(!(await T.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed)return;await u.post("/api/sales/delete-detail",{id:n.id,transaction_id:o});const p=[...h];p.splice(s,1),f(p),l.success("Row deleted")}}}},manualColumnResize:!0,stretchH:"all",height:be,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>W(!0),onMouseLeave:()=>W(!1),children:[t.jsxs("button",{type:"button",disabled:!o,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${o?"bg-white text-emerald-700 border-emerald-300 hover:bg-emerald-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(Pe,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(ee,{className:"h-4 w-4 opacity-70"})]}),le&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:ke,disabled:!o,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${o?"text-gray-800 hover:bg-emerald-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx(Ue,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Sales Voucher – Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>q(!0),onMouseLeave:()=>q(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx(He,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(ee,{className:"h-4 w-4 opacity-70"})]}),ie&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsxs("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:[t.jsxs("button",{type:"button",onClick:Re,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(ae,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Sales Voucher – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]}),t.jsxs("button",{type:"button",onClick:()=>{if(!o)return l.info("Select or save a transaction.");window.open(`/api/sales/check-pdf/${o}?company_id=${encodeURIComponent(i?.company_id||"")}`,"_blank")},className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(ae,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Print Check – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})]})})]}),t.jsxs("button",{type:"button",onClick:Te,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 focus:outline-none",title:"Start a new transaction",children:[t.jsx(Ie,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]})]}),me&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>J(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"✕"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Sales Voucher PDF",src:de,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{We as default};
