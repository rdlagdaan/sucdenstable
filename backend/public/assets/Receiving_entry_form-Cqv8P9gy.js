import{n as l,j as e,F as Qe}from"./index-CaGafZ9d.js";import{r as a,H as Be,a as Ue,N as Ge}from"./handsontable-7BBM75Z1.js";import{L as Ke,D as Ve,y as c,F as $e,a as ze,S as Je,b as Xe}from"./DropdownWithHeaders-DAFHLT8M.js";import"./react-Csw2ODfV.js";Ue.cellTypes.registerCellType("numeric",Ge);const p=u=>Number(Math.round((u||0)*100)/100).toLocaleString("en-US",{minimumFractionDigits:2}),g=u=>u?new Date(u).toISOString().slice(0,10):"";function at(){const u=a.useRef(null),[j,ae]=a.useState(!1),[H,ne]=a.useState([]),[h,re]=a.useState(""),[i,Y]=a.useState(""),[w,S]=a.useState(""),[ce,Q]=a.useState(""),[oe,B]=a.useState(""),[ie,U]=a.useState(""),[le,G]=a.useState(""),[K,V]=a.useState(""),[y,k]=a.useState(""),[_,C]=a.useState(""),[R,F]=a.useState(!1),[D,T]=a.useState(!1),[I,A]=a.useState(""),[O,L]=a.useState(""),[N,de]=a.useState(0),[P,ue]=a.useState(0),[$,me]=a.useState(0),[z,pe]=a.useState(0),[J,ge]=a.useState(0),[x,f]=a.useState([]),[he,X]=a.useState(!1),[xe,be]=a.useState(0),[ye,_e]=a.useState(0),[Ne,fe]=a.useState(0),[ve,je]=a.useState(0),[we,Se]=a.useState(0),[ke,Ce]=a.useState(0);a.useEffect(()=>{(async()=>{const{data:t}=await l.get("/api/receiving/rr-list",{params:{include_posted:j?"1":"0",q:h}});ne(t||[])})().catch(console.error)},[j,h]);const Re=a.useMemo(()=>{const t=h.toLowerCase();return H.filter(s=>(s.receipt_no||"").toLowerCase().includes(t)||(s.pbn_number||"").toLowerCase().includes(t)||(s.vendor_name||"").toLowerCase().includes(t))},[H,h]),Fe=async t=>{try{Y(t);const{data:s}=await l.get("/api/receiving/entry",{params:{receipt_no:t}});S(g(s.receipt_date)||""),Q(s.pbn_number||""),B(s.item_number||""),U(s.vendor_name||""),G(s.mill||""),V(s.gl_account_key||""),k(s.assoc_dues??""),C(s.others??""),F(!!s.no_storage),T(!!s.no_insurance),L(s.insurance_week?g(s.insurance_week):""),A(s.storage_week?g(s.storage_week):"");const[{data:r},{data:n}]=await Promise.all([l.get("/api/receiving/pbn-item",{params:{pbn_number:s.pbn_number,item_no:s.item_number}}),l.get("/api/mills/rate",{params:{mill_name:s.mill,as_of:g(s.receipt_date)}})]);de(Number(r?.unit_cost||0)),ue(Number(r?.commission||0)),me(Number(n?.insurance_rate||0)),pe(Number(n?.storage_rate||0)),ge(Number(n?.days_free||0));const{data:o}=await l.get("/api/receiving/details",{params:{receipt_no:t}});f(Array.isArray(o)?o.map(d=>({...d,persisted:!0})):[]),X(!0)}catch(s){console.error(s),c.error("Failed to load Receiving Entry.")}},De=(t,s)=>{const r=(new Date(s).getTime()-new Date(t).getTime())/864e5;return Math.ceil(Math.abs(r)/30)},Te=(t,s,r)=>{let n=(new Date(s).getTime()-new Date(t).getTime())/864e5;return n=n-r,n<0&&(n=0),Math.floor(n/30)},Ie=t=>{let s=0,r=0,n=0,o=0,d=0,ee=0;const v=w||"",Ee=O||"",qe=I||"";t.forEach(m=>{const b=Number(m.quantity||0),He=Number(m.liens||0);s+=b,r+=He;const te=Ee||(m.week_ending?g(m.week_ending):""),se=qe||(m.week_ending?g(m.week_ending):"");let W=0;if(te&&v&&!D){const q=De(te,v);W=b*($||0)*q}let E=0;if(se&&v&&!R){const q=Te(se,v,J||0);E=b*(z||0)*q}const Ye=b*(N||0)-(P||0);o+=W,n+=E,d+=Ye,ee+=b*(N||0)-W-E}),be(s),_e(r),fe(n),je(o),Se(d),Ce(ee)};a.useEffect(()=>{Ie(x)},[x,w,O,I,D,R,N,P,$,z,J]);const Z=async(t,s)=>{i&&await l.post("/api/receiving/update-flag",{receipt_no:i,field:t,value:s?1:0})},M=async(t,s)=>{i&&await l.post("/api/receiving/update-date",{receipt_no:i,field:t,value:s||null})},Ae=async t=>{F(t);try{await Z("no_storage",t),c.success("Storage flag updated")}catch{c.error("Failed to update storage flag")}},Oe=async t=>{T(t);try{await Z("no_insurance",t),c.success("Insurance flag updated")}catch{c.error("Failed to update insurance flag")}},Le=async t=>{A(t);try{await M("storage_week",t)}catch{c.error("Failed to update Storage Week")}},Pe=async t=>{L(t);try{await M("insurance_week",t)}catch{c.error("Failed to update Insurance Week")}},Me=async t=>{S(t);try{await M("receipt_date",t),c.success("Date Received updated")}catch{c.error("Failed to update Date Received")}},We=async(t,s)=>{if(i)try{const r={receipt_no:i,row_index:s,row:t},{data:n}=await l.post("/api/receiving/batch-insert",r),o=n?.id;if(o){const d=[...x];d[s]={...t,id:o,persisted:!0},f(d)}}catch(r){console.error(r),c.error("Auto-save failed.")}};return e.jsxs("div",{className:"space-y-4 p-6",children:[e.jsx(Ke,{position:"top-right",autoClose:2500}),e.jsxs("div",{className:"bg-yellow-50 shadow rounded-lg p-4 border border-yellow-300 space-y-3",children:[e.jsx("h2",{className:"text-lg font-bold text-green-800",children:"Receiving Entry"}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:j,onChange:()=>ae(t=>!t)}),e.jsx("label",{className:"text-sm",children:"Receiving #"})]}),e.jsx("div",{className:"flex-1",children:e.jsx(Ve,{label:"",value:i,onChange:Fe,items:Re.map(t=>({code:t.receipt_no,label:t.receipt_no,description:t.vendor_name,quantity:t.quantity,pbn_number:t.pbn_number,sugar_type:t.sugar_type,receipt_date:t.receipt_date})),search:h,onSearchChange:re,headers:["Receipt No","Quantity","Sugar Type","PBN No","RDate","Vendor ID","Vendor Name"],columnWidths:["120px","90px","60px","100px","120px","120px","220px"],dropdownPositionStyle:{minWidth:"900px"},customKey:"rr"})}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 flex-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Date Received"}),e.jsx("input",{type:"date",value:w,onChange:t=>Me(t.target.value),className:"w-full border p-2 bg-green-100 text-green-900 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"PBN #"}),e.jsx("input",{value:ce,disabled:!0,className:"w-full border p-2 bg-green-100 text-green-900 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Item #"}),e.jsx("input",{value:oe,disabled:!0,className:"w-full border p-2 bg-green-100 text-green-900 rounded"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Vendor Name"}),e.jsx("input",{value:ie,disabled:!0,className:"w-full border p-2 bg-green-100 text-green-900 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Mill"}),e.jsx("input",{value:le,disabled:!0,className:"w-full border p-2 bg-green-100 text-green-900 rounded"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:R,onChange:t=>Ae(t.target.checked)}),e.jsx("label",{children:"No Storage"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:D,onChange:t=>Oe(t.target.checked)}),e.jsx("label",{children:"No Insurance"})]}),e.jsx("div",{}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Storage Week"}),e.jsx("input",{type:"date",value:I,onChange:t=>Le(t.target.value),className:"w-full border p-2 bg-white rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Insurance Week"}),e.jsx("input",{type:"date",value:O,onChange:t=>Pe(t.target.value),className:"w-full border p-2 bg-white rounded"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"GL Account"}),e.jsx("input",{value:K,onChange:t=>V(t.target.value),onBlur:async()=>{if(i)try{await l.post("/api/receiving/update-gl",{receipt_no:i,gl_account_key:K}),c.success("GL Account updated")}catch{c.error("Failed to update GL Account")}},className:"w-full border p-2 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Assoc Dues"}),e.jsx("input",{type:"number",step:"0.01",value:y,onChange:t=>k(t.target.value===""?"":Number(t.target.value)),onBlur:async()=>{if(i)try{await l.post("/api/receiving/update-assoc-others",{receipt_no:i,assoc_dues:Number(y||0),others:Number(_||0)}),c.success("Assoc/Others saved")}catch{c.error("Failed to save Assoc/Others")}},className:"w-full border p-2 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Others"}),e.jsx("input",{type:"number",step:"0.01",value:_,onChange:t=>C(t.target.value===""?"":Number(t.target.value)),onBlur:async()=>{if(i)try{await l.post("/api/receiving/update-assoc-others",{receipt_no:i,assoc_dues:Number(y||0),others:Number(_||0)}),c.success("Assoc/Others saved")}catch{c.error("Failed to save Assoc/Others")}},className:"w-full border p-2 rounded"})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-2",children:"Details"}),he&&e.jsx(Be,{ref:u,data:x,colHeaders:["Quedan #","Quantity","Liens","Week Ending","Date Issued","Planter TIN","Planter Name","Item","Mill","Unit Cost","Commission","Storage","Insurance","Total AP"],columns:[{data:"quedan_no",type:"text"},{data:"quantity",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"liens",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"week_ending",type:"date",dateFormat:"YYYY-MM-DD",correctFormat:!0},{data:"date_issued",type:"date",dateFormat:"YYYY-MM-DD",correctFormat:!0},{data:"planter_tin",type:"text"},{data:"planter_name",readOnly:!0},{data:"item_no",readOnly:!0},{data:"mill",readOnly:!0},{data:"unit_cost",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"commission",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"storage",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"insurance",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"total_ap",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}}],stretchH:"all",height:420,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation",afterChange:(t,s)=>{if(!t||s!=="edit")return;const r=[...x];t.forEach(([n])=>{const o=r[n]||{};o.unit_cost=N,o.commission=P,r[n]=o,o.quedan_no&&o.quantity!=null&&We(o,n)}),f(r)}})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{children:[" Total Quantity__ ",e.jsx("span",{className:"font-semibold",children:p(xe)})," "]}),e.jsxs("div",{children:[" Total Insurance_ ",e.jsx("span",{className:"font-semibold",children:p(ve)})," "]}),e.jsxs("div",{children:[" Total Cost______ ",e.jsx("span",{className:"font-semibold",children:p(we)})," "]}),e.jsxs("div",{children:[" Total Liens_____ ",e.jsx("span",{className:"font-semibold",children:p(ye)})," "]}),e.jsxs("div",{children:[" Total Storage___ ",e.jsx("span",{className:"font-semibold",children:p(Ne)})," "]}),e.jsxs("div",{children:[" Total AP Cost___ ",e.jsx("span",{className:"font-semibold",children:p(ke+Number(y||0)+Number(_||0))})," "]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white",children:[e.jsx($e,{className:"h-5 w-5"}),e.jsx("span",{children:"Print"}),e.jsx(Qe,{className:"h-4 w-4"})]}),e.jsxs("button",{className:"inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700",onClick:()=>{Y(""),X(!1),f([]),S(""),Q(""),B(""),U(""),G(""),k(""),C(""),T(!1),F(!1),L(""),A(""),c.success("Ready for new Receiving Entry")},children:[e.jsx(ze,{className:"h-5 w-5"}),"New"]}),e.jsxs("button",{className:"inline-flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",onClick:()=>Je.fire({title:"Saved",icon:"success",timer:1200,showConfirmButton:!1}),children:[e.jsx(Xe,{className:"h-5 w-5"}),"Save"]})]})]})}export{at as default};
