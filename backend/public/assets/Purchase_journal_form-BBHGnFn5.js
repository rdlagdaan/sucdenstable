import{n as u,j as t,F as ce}from"./index-CSA0WWTE.js";import{r as o,H as Be,a as le,N as Ie}from"./handsontable-7BBM75Z1.js";/* empty css                              */import{S as f,F as Ue,a as Ve,b as oe}from"./sweetalert2.esm.all-B4pNkPRF.js";import{L as Ye,D as ie,b as re,y as l,F as ze,a as qe}from"./DropdownWithHeaders-aGpJfmdE.js";import"./react-Csw2ODfV.js";le.cellTypes.registerCellType("numeric",Ie);function de(p){if(!p)return"";const g=new Date(p);if(isNaN(g.getTime()))return(p||"").split("T")[0]||"";const y=g.getFullYear(),S=String(g.getMonth()+1).padStart(2,"0"),w=String(g.getDate()).padStart(2,"0");return`${y}-${S}-${w}`}const O=p=>(p||"").split(";")[0];function Ze(){const p=o.useRef(null),[g,y]=o.useState(""),[S,w]=o.useState(""),[V,C]=o.useState(""),[Y,D]=o.useState(""),[z,R]=o.useState(""),[q,T]=o.useState(""),[r,k]=o.useState(null),[E,_]=o.useState(!1),[N,v]=o.useState(!0),[M,W]=o.useState([]),[$,G]=o.useState([]),[ue,pe]=o.useState(""),[me,H]=o.useState(""),[B,I]=o.useState(""),[X,J]=o.useState([]),[j,b]=o.useState([{acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}]),[K,F]=o.useState(!1),[he,Q]=o.useState(!1),[xe,Z]=o.useState(!1),[be,fe]=o.useState(void 0),[ge,ee]=o.useState(!1),te=o.useRef(null),[ae,ye]=o.useState(600);o.useLayoutEffect(()=>{const e=()=>{const s=te.current?.getBoundingClientRect()?.top??0,n=window.innerHeight-s-140;ye(Math.max(320,Math.floor(n)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const we=28,_e=32,ve=240,Ne=o.useMemo(()=>{const e=Math.max(j.length,6),a=_e+e*we+ve;return Math.min(a,ae)},[j.length,ae]),d=o.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);o.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/pj/vendors",{params:{company_id:d?.company_id}}),a=(e||[]).map(s=>({code:String(s.vendor_id??s.code),description:s.vendor_name??s.description??""}));W(a)}catch{W([])}})()},[d?.company_id]),o.useEffect(()=>{(async()=>{try{const{data:e}=await u.get("/api/pj/accounts",{params:{company_id:d?.company_id}});G(Array.isArray(e)?e:[])}catch{G([])}})()},[d?.company_id]);const P=async()=>{try{const{data:e}=await u.get("/api/purchase/list",{params:{company_id:d?.company_id||"",q:B||""}});J(Array.isArray(e)?e:[])}catch{J([])}};o.useEffect(()=>{P()},[B]);const je=o.useMemo(()=>(X||[]).map(e=>({code:String(e.id),cp_no:e.cp_no,vendor_id:e.vendor_id,purchase_date:de(e.purchase_date),purchase_amount:e.purchase_amount,invoice_no:e.invoice_no,label:e.cp_no,description:e.vendor_id})),[X]),m=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),Se=()=>{H(""),I(""),y(""),w(""),C(""),D(""),R(""),T(""),k(null),_(!1),v(!1),F(!1),b([m()])},Ce=async()=>{if((await f.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed){try{if((await u.get("/api/purchase/unbalanced-exists",{params:{company_id:d?.company_id||""}})).data?.exists){const s=await u.get("/api/purchase/unbalanced",{params:{company_id:d?.company_id||"",limit:20}}),i=`
          <div style="text-align:left">
            <div style="margin-bottom:8px">There are unbalanced purchase transactions. Please balance them first.</div>
            <table style="width:100%;border-collapse:collapse;font-size:12px">
              <thead>
                <tr>
                  <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 8px">CP #</th>
                  <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 8px">Vendor</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Debit</th>
                  <th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 8px">Credit</th>
                </tr>
              </thead>
              <tbody>${(Array.isArray(s.data?.items)?s.data.items:[]).map(h=>`
          <tr>
            <td style="padding:6px 8px">${h.cp_no}</td>
            <td style="padding:6px 8px">${h.vendor_id}</td>
            <td style="padding:6px 8px;text-align:right">${Number(h.sum_debit||0).toLocaleString()}</td>
            <td style="padding:6px 8px;text-align:right">${Number(h.sum_credit||0).toLocaleString()}</td>
          </tr>`).join("")||'<tr><td colspan="4" style="padding:6px 8px;color:#6b7280">No detail</td></tr>'}</tbody>
            </table>
          </div>`;await f.fire({icon:"warning",title:"Unbalanced transactions found",html:i,confirmButtonText:"OK"});return}}catch(a){console.error("Unbalanced check failed",a)}try{const a=await u.get("/api/purchase/generate-cp-number",{params:{company_id:d?.company_id}}),s=a.data?.cp_no??a.data;y(s);const n=await u.post("/api/purchase/save-main",{cp_no:s,vendor_id:S,purchase_date:Y,explanation:z,invoice_no:q,company_id:d?.company_id,user_id:d?.id});k(n.data.id),F(!0),b([m(),m()]),l.success("Main saved. You can now input details."),P(),_(!0),v(!1)}catch(a){l.error(a?.response?.data?.message||"Failed to save.")}}},De=()=>{_(!1),v(!1),l.success("Editing enabled. You can now update this transaction.")},Re=async()=>{if(!(!r||!(await f.fire({title:"Cancel this transaction?",text:"This will mark the transaction as CANCELLED.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, cancel it"})).isConfirmed))try{await u.post("/api/purchase/cancel",{id:r,flag:"1",company_id:d?.company_id||""}),_(!0),v(!0),l.success("Transaction has been cancelled."),P()}catch{l.error("Failed to cancel transaction.")}},Te=async()=>{if(!(!r||!(await f.fire({title:"Delete this transaction?",text:"This action is irreversible.",icon:"error",showCancelButton:!0,confirmButtonText:"Delete"})).isConfirmed))try{await u.delete(`/api/purchase/${r}`),Se(),l.success("Transaction deleted."),P()}catch{l.error("Failed to delete transaction.")}},ke=e=>!!O(e.acct_code)&&(e.debit??0)>0!=(e.credit??0)>0,se=async(e,a)=>{if(!r||!ke(e))return;const s=O(e.acct_code);try{if(e.persisted)await u.post("/api/purchase/update-detail",{id:e.id,transaction_id:r,acct_code:s,debit:e.debit||0,credit:e.credit||0});else{const n=await u.post("/api/purchase/save-detail",{transaction_id:r,acct_code:s,debit:e.debit||0,credit:e.credit||0,company_id:d?.company_id,user_id:d?.id}),c=p.current?.hotInstance?.getSourceData()||[];c[a]&&(c[a].persisted=!0,c[a].id=n.data.detail_id),b([...c,...c.find(i=>!i.acct_code)?[]:[m()]])}}catch(n){l.error(n?.response?.data?.message||"Row save failed")}},Ee=async e=>{if(e)try{H(e);const{data:a}=await u.get(`/api/purchase/${e}`,{params:{company_id:d?.company_id}}),s=a.main??a;k(s.id),y(s.cp_no),w(String(s.vendor_id||""));const n=M.find(i=>String(i.code)===String(s.vendor_id));C(n?.description||n?.label||""),D(de(s.purchase_date)),R(s.explanation??""),T(s.invoice_no??"");const c=(a.details||[]).map(i=>({id:i.id,acct_code:`${i.acct_code};${i.acct_desc||U(i.acct_code)}`,acct_desc:i.acct_desc,debit:Number(i.debit??0),credit:Number(i.credit??0),persisted:!0}));b(c.length?c.concat([m()]):[m()]),F(!0),_(!0),v(!0),l.success("Transaction loaded.")}catch{l.error("Unable to load the selected transaction.")}},$e=o.useMemo(()=>$.map(e=>`${e.acct_code};${e.acct_desc}`),[$]),U=e=>$.find(a=>a.acct_code===e)?.acct_desc||"",Fe=()=>{if(!r)return l.info("Select or save a transaction first.");const e=`/api/purchase/form-pdf/${r}?company_id=${encodeURIComponent(d?.company_id||"")}`;fe(e),ee(!0)},Pe=async()=>{if(!r)return l.info("Select or save a transaction first.");const e=await u.get(`/api/purchase/form-excel/${r}`,{responseType:"blob",params:{company_id:d?.company_id||""}}),a=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`PurchaseVoucher_${g||r}.xlsx`,s=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),n=URL.createObjectURL(s),c=document.createElement("a");c.href=n,c.download=a,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(n)},Ae=e=>{const a=e.reduce((c,i)=>c+(Number(i.debit)||0),0),s=e.reduce((c,i)=>c+(Number(i.credit)||0),0),n=Math.abs(a-s)<.005;return{sumD:a,sumC:s,balanced:n}},ne=e=>(Number(e)||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),Le=async()=>{if(j.some(a=>a.acct_code&&a.acct_code.trim()!==""||(Number(a.debit)||0)>0||(Number(a.credit)||0)>0)){const{sumD:a,sumC:s,balanced:n}=Ae(j);if(!n){await f.fire({title:"Transaction not balanced",html:`Debit <b>${ne(a)}</b> must equal Credit <b>${ne(s)}</b> before starting a new one.`,icon:"error"});return}if(!(await f.fire({title:"Start a new transaction?",text:"This will clear the current form.",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, New"})).isConfirmed)return}else if(!(await f.fire({title:"Start a new transaction?",text:"This will clear the current form.",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, New"})).isConfirmed)return;H(""),I(""),k(null),y(""),w(""),C(""),D(""),R(""),T(""),_(!1),v(!1),b([m(),m(),m(),m()]),F(!1),l.success("Form is ready for a new entry.")},Oe=0,Me=(e,a)=>{if(N||a!==Oe)return;const n=p.current?.hotInstance?.getActiveEditor();n?.cellProperties?.type==="autocomplete"&&(n.TEXTAREA.value="",n.query="",n.open(),n.refreshDropdown?.())};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(Ye,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-blue-50 shadow-md rounded-lg p-6 space-y-4 border border-blue-300",children:[t.jsx("h2",{className:"text-xl font-bold text-blue-800 mb-2",children:"PURCHASE JOURNAL"}),t.jsxs("div",{className:"text-xs text-gray-500",children:["accounts: ",$.length," | hotEnabled: ",String(K)," | locked: ",String(E)," | gridLocked: ",String(N)]}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsx("div",{className:"col-span-3",children:t.jsx(ie,{label:"Search Transaction",value:me,onChange:e=>Ee(e),items:je,search:B,onSearchChange:I,headers:["Id","Purchase No","Vendor","Date","Amount","Vendor Inv #"],columnWidths:["60px","120px","160px","110px","120px","120px"],dropdownPositionStyle:{width:"800px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsx("div",{className:"col-span-2",children:t.jsx(ie,{label:"Vendor",value:S,onChange:e=>{w(e);const a=M.find(s=>String(s.code)===String(e));C(a?.description||"")},items:M,search:ue,onSearchChange:pe,headers:["Code","Description"],columnWidths:["140px","520px"],dropdownPositionStyle:{width:"700px"},inputClassName:"p-2 text-sm bg-white"})}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:Y,disabled:E,onChange:e=>D(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block mb-1",children:"Explanation"}),t.jsx("input",{value:z,disabled:E,onChange:e=>R(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"Vendor Invoice #"}),t.jsx("input",{value:q,disabled:E,onChange:e=>T(e.target.value),className:"w-full border p-2 bg-blue-100 text-blue-900"})]}),V&&t.jsxs("div",{className:"col-span-3 text-sm font-semibold text-gray-700",children:["Vendor: ",V]})]}),t.jsx("div",{className:"flex gap-2 mt-3",children:r?t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:De,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700",children:[t.jsx(re,{className:"h-5 w-5"}),"Update"]}),t.jsx("button",{onClick:Re,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600",children:"Cancel"}),t.jsx("button",{onClick:Te,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700",children:"Delete"})]}):t.jsxs("button",{onClick:Ce,className:"inline-flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:[t.jsx(re,{className:"h-5 w-5"}),"Save"]})})]}),t.jsxs("div",{ref:te,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),K&&t.jsx(Be,{className:"hot-enhanced",ref:p,data:j,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,a)=>{const s=$e;if(!e)return a(s);const n=String(e).toLowerCase();a(s.filter(c=>c.toLowerCase().includes(n)))},filter:!0,strict:!0,allowInvalid:!1,visibleRows:12,readOnly:N,renderer:(e,a,s,n,c,i,h)=>{const x=O(String(i??""));le.renderers.TextRenderer(e,a,s,n,c,x,h)}},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:N},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:N}],afterBeginEditing:Me,afterChange:(e,a)=>{const s=p.current?.hotInstance;!e||!s||a==="edit"&&(e.forEach(([n,c,i,h])=>{if(c==="acct_code"){const x=String(h||""),A=O(x);s.setDataAtRowProp(n,"acct_desc",U(A));const L={...s.getSourceDataAtRow(n)},He={id:L.id,acct_code:x,acct_desc:U(A),debit:Number(L.debit||0),credit:Number(L.credit||0),persisted:!!L.persisted};setTimeout(()=>se(He,n),0)}if(c==="debit"||c==="credit"){const x={...s.getSourceDataAtRow(n)},A={...x,acct_code:x.acct_code,debit:Number(c==="debit"?h:x.debit||0),credit:Number(c==="credit"?h:x.credit||0)};setTimeout(()=>se(A,n),0)}}),requestAnimationFrame(()=>{const n=s.getSourceData();n.find(c=>!c.acct_code)||n.push(m()),b([...n])}))},contextMenu:{items:{remove_row:{name:"🗑️ Remove row",callback:async(e,a)=>{const s=p.current?.hotInstance,n=a[0].start.row,c=s?.getSourceData()||[],i=c[n];if(!i?.id){c.splice(n,1),b([...c]);return}(await f.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed&&(await u.post("/api/purchase/delete-detail",{id:i.id,transaction_id:r}),c.splice(n,1),b([...c]),l.success("Row deleted"))}}}},manualColumnResize:!0,stretchH:"all",height:Ne,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-center",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>Z(!0),onMouseLeave:()=>Z(!1),children:[t.jsxs("button",{type:"button",disabled:!r,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${r?"bg-white text-blue-700 border-blue-300 hover:bg-blue-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(Ue,{className:`h-5 w-5 ${r?"text-blue-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(ce,{className:"h-4 w-4 opacity-70"})]}),xe&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:Pe,disabled:!r,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${r?"text-gray-800 hover:bg-blue-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx(Ve,{className:`h-5 w-5 ${r?"text-blue-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Purchase Voucher – Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>Q(!0),onMouseLeave:()=>Q(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx(ze,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(ce,{className:"h-4 w-4 opacity-70"})]}),he&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsxs("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:[t.jsxs("button",{type:"button",onClick:Fe,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(oe,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Purchase Voucher – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]}),t.jsxs("button",{type:"button",onClick:()=>{if(!r)return l.info("Select or save a transaction.");window.open(`/api/purchase/check-pdf/${r}?company_id=${encodeURIComponent(d?.company_id||"")}`,"_blank")},className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(oe,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Print Check – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})]})})]}),t.jsxs("button",{type:"button",onClick:Le,className:"inline-flex items-center gap-2 rounded border px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700",title:"Start a new transaction",children:[t.jsx(qe,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]})]}),ge&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>ee(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"✕"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Purchase Voucher PDF",src:be,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{Ze as default};
