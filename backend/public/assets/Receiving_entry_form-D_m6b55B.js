import{j as t,n as u,F as at}from"./index-OQiN5P-Z.js";import{r as a,H as nt,a as rt,N as ot}from"./handsontable-7BBM75Z1.js";import{L as ct,D as we,y as i,F as it,a as lt,S as dt,b as ut}from"./DropdownWithHeaders-BRSdrHAi.js";import"./react-Csw2ODfV.js";function mt({value:y,displayValue:T,readOnlyInput:$,onChange:N,items:F,headers:g,columns:h,search:d,onSearchChange:I,inputClassName:v,dropdownClassName:A,columnWidths:p,placeholder:E="- -"}){const[O,m]=a.useState(!1),[L,P]=a.useState(""),M=a.useRef(null),_=a.useRef(null),w=a.useRef(null),j=(d??L).trim().toLowerCase(),f=a.useMemo(()=>j?F.filter(n=>h.some(l=>String(n[l]??"").toLowerCase().includes(j))):F,[F,h,j]);a.useEffect(()=>{const n=x=>{const C=M.current;C&&(C.contains(x.target)||m(!1))},l=x=>{x.key==="Escape"&&m(!1)};return document.addEventListener("mousedown",n,!0),document.addEventListener("touchstart",n,!0),document.addEventListener("keydown",l,!0),()=>{document.removeEventListener("mousedown",n,!0),document.removeEventListener("touchstart",n,!0),document.removeEventListener("keydown",l,!0)}},[]),a.useEffect(()=>{O&&setTimeout(()=>w.current?.focus(),0)},[O]);const S=()=>setTimeout(()=>{const n=M.current;n&&!n.contains(document.activeElement)&&m(!1)},0);return t.jsxs("div",{className:"relative w-full",ref:M,children:[t.jsx("input",{ref:_,value:T??y??"",onChange:n=>{$||N(n.target.value)},onFocus:()=>m(!0),onClick:()=>m(!0),onKeyDown:n=>{(n.key==="ArrowDown"||n.key==="Enter")&&(m(!0),setTimeout(()=>w.current?.focus(),0),n.preventDefault())},readOnly:!!$,onBlur:S,className:`w-full border rounded px-3 py-2 h-11 text-sm ${v||""}`,placeholder:E,autoComplete:"off"}),O&&t.jsxs("div",{className:`absolute z-50 mt-1 min-w-full bg-white border rounded shadow ${A||""}`,onMouseDown:n=>{n.target.closest("input")||n.preventDefault()},children:[t.jsx("div",{className:"p-2 border-b sticky top-0 bg-white",children:t.jsx("input",{ref:w,value:d??L,onChange:n=>I?I(n.target.value):P(n.target.value),onBlur:S,onKeyDown:n=>{if(n.key==="Enter"){const l=f[0];l&&(N(String(l.code??l[h[0]])),m(!1))}},className:"w-full border px-2 py-1 rounded text-sm",placeholder:"Search..."})}),t.jsx("div",{className:"grid text-xs font-semibold text-gray-600 px-2 py-2 border-b",style:{gridTemplateColumns:p&&p.length?p.join(" "):`repeat(${g.length}, minmax(0, 1fr))`},children:g.map(n=>t.jsx("div",{className:"truncate pr-2",children:n},n))}),t.jsx("div",{className:"max-h-72 overflow-auto",children:f.length===0?t.jsx("div",{className:"px-3 py-3 text-sm text-gray-500",children:"No results"}):f.map(n=>t.jsx("button",{type:"button",className:"grid w-full text-left px-2 py-1 hover:bg-gray-100 text-sm",style:{gridTemplateColumns:p&&p.length?p.join(" "):`repeat(${g.length}, minmax(0, 1fr))`},onMouseDown:l=>{l.preventDefault(),N(String(n.code??n[h[0]])),m(!1)},children:h.map((l,x)=>t.jsx("div",{className:"truncate pr-2",children:String(n[l]??"")},`${n.code??n[h[0]]}-${x}`))},String(n.code??n[h[0]])))})]})]})}rt.cellTypes.registerCellType("numeric",ot);const D=y=>Number(Math.round((y||0)*100)/100).toLocaleString("en-US",{minimumFractionDigits:2}),R=y=>y?new Date(y).toISOString().slice(0,10):"";function bt(){const y=a.useRef(null),[T,$]=a.useState(!1),[N,F]=a.useState([]),[g,h]=a.useState(""),[d,I]=a.useState(""),[v,A]=a.useState(""),[p,E]=a.useState(""),[O,m]=a.useState(""),[L,P]=a.useState(""),[M,_]=a.useState(""),[w,j]=a.useState(""),[f,S]=a.useState(""),[n,l]=a.useState(""),[x,C]=a.useState(!1),[Q,U]=a.useState(!1),[V,G]=a.useState(""),[z,J]=a.useState(""),[W,je]=a.useState([]),[X,Se]=a.useState(""),[oe,ce]=a.useState([]),[ie,Ce]=a.useState(""),[Y,Z]=a.useState(0),[ee,te]=a.useState(0),[le,de]=a.useState(0),[ue,me]=a.useState(0),[pe,ge]=a.useState(0),[q,H]=a.useState([]),[ke,he]=a.useState(!1),[De,Re]=a.useState(0),[Te,Fe]=a.useState(0),[Ie,Ae]=a.useState(0),[Ee,Oe]=a.useState(0),[Le,Pe]=a.useState(0),[Me,qe]=a.useState(0),xe="h-8 px-3 py-2.5 text-base leading-6 rounded border border-gray-300",Be=p?`${p} — ${L||""}`:"",be=a.useRef(null);a.useEffect(()=>{(async()=>{const{data:e}=await u.get("/api/receiving/rr-list",{params:{include_posted:T?"1":"0",q:g}});F(e||[])})().catch(console.error)},[T,g]),a.useEffect(()=>{(async()=>{const e=await u.get("/api/pbn/list",{params:{q:X}}),s=Array.isArray(e.data)?e.data:Array.isArray(e.data?.data)?e.data.data:[];je(s),console.log("PBN items →",W.length,W[0])})().catch(console.error)},[X]);const $e=a.useMemo(()=>{const e=g.toLowerCase();return N.filter(s=>(s.receipt_no||"").toLowerCase().includes(e)||(s.pbn_number||"").toLowerCase().includes(e)||(s.vendor_name||"").toLowerCase().includes(e))},[N,g]),We=async e=>{try{I(e);const{data:s}=await u.get("/api/receiving/entry",{params:{receipt_no:e}});if(A(R(s.receipt_date)||""),E(s.pbn_number||""),m(s.item_number||""),P(s.vendor_name||""),_(s.mill||""),j(s.gl_account_key||""),S(s.assoc_dues??""),l(s.others??""),C(!!s.no_storage),U(!!s.no_insurance),J(s.insurance_week?R(s.insurance_week):""),G(s.storage_week?R(s.storage_week):""),s.pbn_number){const[{data:o},{data:c},{data:b}]=await Promise.all([u.get("/api/pbn/items",{params:{pbn_number:s.pbn_number}}),u.get("/api/receiving/pbn-item",{params:{pbn_number:s.pbn_number,item_no:s.item_number}}),u.get("/api/mills/rate",{params:{mill_name:s.mill,as_of:R(s.receipt_date)}})]);ce(Array.isArray(o)?o:[]),Z(Number(c?.unit_cost||0)),te(Number(c?.commission||0)),de(Number(b?.insurance_rate||0)),me(Number(b?.storage_rate||0)),ge(Number(b?.days_free||0))}const{data:r}=await u.get("/api/receiving/details",{params:{receipt_no:e}});H(Array.isArray(r)?r.map(o=>({...o,persisted:!0})):[]),he(!0)}catch(s){console.error(s),i.error("Failed to load Receiving Entry.")}},Ye=async e=>{try{E(e);const s=W.find(c=>c.pbn_number===e);s&&P(s.vendor_name||"");const{data:r}=await u.get("/api/pbn/items",{params:{pbn_number:e}}),o=Array.isArray(r)?r:[];ce(o),o.length===1?await ye(String(o[0].row)):setTimeout(()=>{be.current?.querySelector("input")?.focus()},0),o.length!==1&&(m(""),_(""),Z(0),te(0))}catch(s){console.error(s),i.error("Failed to load PBN items.")}},ye=async e=>{const s=oe.find(r=>String(r.row)===String(e));if(m(e),!!s){_(s.mill||""),Z(Number(s.unit_cost||0)),te(Number(s.commission||0));try{const{data:r}=await u.get("/api/mills/rate",{params:{mill_name:s.mill,as_of:v||void 0}});de(Number(r?.insurance_rate||0)),me(Number(r?.storage_rate||0)),ge(Number(r?.days_free||0))}catch{}}},He=(e,s)=>{const r=(new Date(s).getTime()-new Date(e).getTime())/864e5;return Math.ceil(Math.abs(r)/30)},Ke=(e,s,r)=>{let o=(new Date(s).getTime()-new Date(e).getTime())/864e5;return o-=r,o<0&&(o=0),Math.floor(o/30)},Qe=e=>{let s=0,r=0,o=0,c=0,b=0,Ne=0;const K=v||"",Ze=z||"",et=V||"";e.forEach(k=>{const B=Number(k.quantity||0),tt=Number(k.liens||0);s+=B,r+=tt;const ve=Ze||(k.week_ending?R(k.week_ending):""),_e=et||(k.week_ending?R(k.week_ending):"");let ae=0;if(ve&&K&&!Q){const re=He(ve,K);ae=B*(le||0)*re}let ne=0;if(_e&&K&&!x){const re=Ke(_e,K,pe||0);ne=B*(ue||0)*re}const st=B*(Y||0)-(ee||0);c+=ae,o+=ne,b+=st,Ne+=B*(Y||0)-ae-ne}),Re(s),Fe(r),Ae(o),Oe(c),Pe(b),qe(Ne)};a.useEffect(()=>{Qe(q)},[q,v,z,V,Q,x,Y,ee,le,ue,pe]);const fe=async(e,s)=>{d&&await u.post("/api/receiving/update-flag",{receipt_no:d,field:e,value:s?1:0})},se=async(e,s)=>{d&&await u.post("/api/receiving/update-date",{receipt_no:d,field:e,value:s||null})},Ue=async e=>{C(e);try{await fe("no_storage",e),i.success("Storage flag updated")}catch{i.error("Failed to update storage flag")}},Ve=async e=>{U(e);try{await fe("no_insurance",e),i.success("Insurance flag updated")}catch{i.error("Failed to update insurance flag")}},Ge=async e=>{G(e);try{await se("storage_week",e)}catch{i.error("Failed to update Storage Week")}},ze=async e=>{J(e);try{await se("insurance_week",e)}catch{i.error("Failed to update Insurance Week")}},Je=async e=>{A(e);try{await se("receipt_date",e),i.success("Date Received updated")}catch{i.error("Failed to update Date Received")}},Xe=async(e,s)=>{if(d)try{const r={receipt_no:d,row_index:s,row:e},{data:o}=await u.post("/api/receiving/batch-insert",r),c=o?.id;if(c){const b=[...q];b[s]={...e,id:c,persisted:!0},H(b)}}catch(r){console.error(r),i.error("Auto-save failed.")}};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(ct,{position:"top-right",autoClose:2500}),t.jsxs("div",{className:"bg-yellow-50 shadow rounded-lg p-4 border border-yellow-300 space-y-4",children:[t.jsx("h2",{className:"text-lg font-bold text-slate-700",children:"RECEIVING ENTRY"}),t.jsxs("div",{className:"grid grid-cols-12 gap-3 items-end",children:[t.jsxs("div",{className:"col-span-8",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Receiving #"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:T,onChange:()=>$(e=>!e),title:"Include posted"}),t.jsx("div",{className:"flex-1",children:t.jsx(we,{label:"",value:d,onChange:We,items:$e.map(e=>({code:e.receipt_no,label:e.receipt_no,description:e.vendor_name,quantity:e.quantity,pbn_number:e.pbn_number,sugar_type:e.sugar_type,receipt_date:e.receipt_date})),search:g,onSearchChange:h,headers:["Receipt No","Quantity","Sugar Type","PBN No","RDate","Vendor ID","Vendor Name"],columnWidths:["120px","90px","70px","110px","110px","110px","220px"],customKey:"rr",inputClassName:`${xe} bg-green-100 text-green-900`})})]})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Date Received"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"date",value:v,onChange:e=>Je(e.target.value),className:"w-full border p-2 rounded bg-yellow-100"}),t.jsx("span",{className:"inline-flex items-center text-xs px-2 rounded border",children:"UD"})]})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-8",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"PBN #"}),t.jsx(mt,{value:p,displayValue:Be,readOnlyInput:!0,onChange:Ye,items:W.map(e=>({code:e.pbn_number,pbn_number:e.pbn_number,sugar_type:e.sugar_type,vendor_id:e.vendor_code,vendor_name:e.vendor_name,crop_year:e.crop_year,pbn_date:e.pbn_date})),headers:["PBN #","Sugar Type","Vendor ID","Vendor Name","Crop Year","PBN Date"],columns:["pbn_number","sugar_type","vendor_id","vendor_name","crop_year","pbn_date"],search:X,onSearchChange:Se,inputClassName:"bg-yellow-100",dropdownClassName:"min-w-[1000px]",columnWidths:["100px","70px","110px","350px","90px","110px"]})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Item #"}),t.jsx("div",{ref:be,children:t.jsx(we,{label:"",value:O,onChange:ye,items:oe.filter(e=>[String(e.row),e.mill,String(e.quantity??"")].join(" ").toLowerCase().includes(ie.toLowerCase())).map(e=>({code:String(e.row),label:String(e.row),mill:e.mill,quantity:e.quantity,unit_cost:e.unit_cost,commission:e.commission})),search:ie,onSearchChange:Ce,headers:["Item","MillMark","Quantity","BCost","CCost"],columnWidths:["80px","260px","120px","120px","120px"],dropdownPositionStyle:{minWidth:"750px"},customKey:"pbnitem",inputClassName:`${xe} bg-yellow-100`})})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-8",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Vendor Name"}),t.jsx("input",{value:L,disabled:!0,className:"w-full border p-2 bg-yellow-100 rounded"})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Mill"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{value:M,disabled:!0,className:"w-full border p-2 bg-yellow-100 rounded"}),t.jsx("span",{className:"inline-flex items-center text-xs px-2 rounded border",children:"UM"})]})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-6 flex items-center gap-3",children:[t.jsxs("label",{className:"inline-flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:x,onChange:e=>Ue(e.target.checked)}),t.jsx("span",{children:"No Storage"})]}),t.jsxs("label",{className:"inline-flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:Q,onChange:e=>Ve(e.target.checked)}),t.jsx("span",{children:"No Insurance"})]})]}),t.jsxs("div",{className:"col-span-3",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Storage Week"}),t.jsx("input",{type:"date",value:V,onChange:e=>Ge(e.target.value),className:"w-full border p-2 bg-white rounded"})]}),t.jsxs("div",{className:"col-span-3",children:[t.jsx("label",{className:"block text-sm text-slate-600",children:"Insurance Week"}),t.jsx("input",{type:"date",value:z,onChange:e=>ze(e.target.value),className:"w-full border p-2 bg-white rounded"})]})]}),t.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm",children:"GL Account"}),t.jsx("input",{value:w,onChange:e=>j(e.target.value),onBlur:async()=>{if(d)try{await u.post("/api/receiving/update-gl",{receipt_no:d,gl_account_key:w}),i.success("GL Account updated")}catch{i.error("Failed to update GL Account")}},className:"w-full border p-2 rounded"})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm",children:"Assoc Dues"}),t.jsx("input",{type:"number",step:"0.01",value:f,onChange:e=>S(e.target.value===""?"":Number(e.target.value)),onBlur:async()=>{if(d)try{await u.post("/api/receiving/update-assoc-others",{receipt_no:d,assoc_dues:Number(f||0),others:Number(n||0)}),i.success("Assoc/Others saved")}catch{i.error("Failed to save Assoc/Others")}},className:"w-full border p-2 rounded"})]}),t.jsxs("div",{className:"col-span-4",children:[t.jsx("label",{className:"block text-sm",children:"Others"}),t.jsx("input",{type:"number",step:"0.01",value:n,onChange:e=>l(e.target.value===""?"":Number(e.target.value)),onBlur:async()=>{if(d)try{await u.post("/api/receiving/update-assoc-others",{receipt_no:d,assoc_dues:Number(f||0),others:Number(n||0)}),i.success("Assoc/Others saved")}catch{i.error("Failed to save Assoc/Others")}},className:"w-full border p-2 rounded"})]})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-gray-800 mb-2",children:"Details"}),ke&&t.jsx(nt,{ref:y,data:q,colHeaders:["Quedan #","Quantity","Liens","Week Ending","Date Issued","Planter TIN","Planter Name","Item","Mill","Unit Cost","Commission","Storage","Insurance","Total AP"],columns:[{data:"quedan_no",type:"text"},{data:"quantity",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"liens",type:"numeric",numericFormat:{pattern:"0,0.00"}},{data:"week_ending",type:"date",dateFormat:"YYYY-MM-DD",correctFormat:!0},{data:"date_issued",type:"date",dateFormat:"YYYY-MM-DD",correctFormat:!0},{data:"planter_tin",type:"text"},{data:"planter_name",readOnly:!0},{data:"item_no",readOnly:!0},{data:"mill",readOnly:!0},{data:"unit_cost",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"commission",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"storage",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"insurance",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}},{data:"total_ap",type:"numeric",readOnly:!0,numericFormat:{pattern:"0,0.00"}}],stretchH:"all",height:420,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation",afterChange:(e,s)=>{if(!e||s!=="edit")return;const r=[...q];e.forEach(([o])=>{const c={...r[o]||{}};c.unit_cost=Y,c.commission=ee,r[o]=c,c.quedan_no&&c.quantity!=null&&Xe(c,o)}),H(r)}})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[t.jsxs("div",{children:[" Total Quantity__ ",t.jsx("span",{className:"font-semibold",children:D(De)})," "]}),t.jsxs("div",{children:[" Total Insurance_ ",t.jsx("span",{className:"font-semibold",children:D(Ee)})," "]}),t.jsxs("div",{children:[" Total Cost______ ",t.jsx("span",{className:"font-semibold",children:D(Le)})," "]}),t.jsxs("div",{children:[" Total Liens_____ ",t.jsx("span",{className:"font-semibold",children:D(Te)})," "]}),t.jsxs("div",{children:[" Total Storage___ ",t.jsx("span",{className:"font-semibold",children:D(Ie)})," "]}),t.jsxs("div",{children:["Total AP Cost___"," ",t.jsx("span",{className:"font-semibold",children:D(Me+Number(f||0)+Number(n||0))})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white",children:[t.jsx(it,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(at,{className:"h-4 w-4"})]}),t.jsxs("button",{className:"inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700",onClick:()=>{I(""),he(!1),H([]),A(""),E(""),m(""),P(""),_(""),S(""),l(""),U(!1),C(!1),J(""),G(""),i.success("Ready for new Receiving Entry")},children:[t.jsx(lt,{className:"h-5 w-5"}),"New"]}),t.jsxs("button",{className:"inline-flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",onClick:()=>dt.fire({title:"Saved",icon:"success",timer:1200,showConfirmButton:!1}),children:[t.jsx(ut,{className:"h-5 w-5"}),"Save"]})]})]})}export{bt as default};
