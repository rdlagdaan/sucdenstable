import{n as l,j as t,F as V}from"./index-DNEk2jBa.js";import{r as c,H as Ne,a as je,N as ve}from"./handsontable-7BBM75Z1.js";import{L as _e,D as W,y as u,a as G,b as J,F as Se}from"./DropdownWithHeaders-DIo1hMQ8.js";import{S as g,F as Ce,a as ke,b as X}from"./sweetalert2.esm.all-B4pNkPRF.js";import"./react-Csw2ODfV.js";je.cellTypes.registerCellType("numeric",ve);function Fe(){const Y=c.useRef(null),[K,w]=c.useState(""),[R,y]=c.useState(""),[E,L]=c.useState(""),[$,N]=c.useState(""),[F,j]=c.useState(""),[O,v]=c.useState(""),[o,_]=c.useState(null),[h,S]=c.useState(!1),[H,q]=c.useState([]),[C,Q]=c.useState([]),[Z,ee]=c.useState([]),[te,se]=c.useState(""),[p,x]=c.useState([]),[ae,k]=c.useState(!1),[ne,M]=c.useState(!1),[ce,T]=c.useState(!1),[oe,ie]=c.useState(void 0),[le,P]=c.useState(!1),I=c.useRef(null),[U,re]=c.useState(600);c.useLayoutEffect(()=>{const e=()=>{const s=I.current?.getBoundingClientRect()?.top??0,n=window.innerHeight-s-140;re(Math.max(320,Math.floor(n)))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const de=28,ue=32,me=240,pe=c.useMemo(()=>{const e=Math.max(p.length,6),a=ue+e*de+me;return Math.min(a,U)},[p.length,U]),i=c.useMemo(()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},[]);c.useEffect(()=>{(async()=>{const{data:e}=await l.get("/api/customers",{params:{company_id:i?.company_id}});q(e)})(),(async()=>{const{data:e}=await l.get("/api/accounts",{params:{company_id:i?.company_id}});Q(e)})()},[i?.company_id]);const b=async(e="")=>{const{data:a}=await l.get("/api/sales/list",{params:{company_id:i?.company_id,q:e}});ee(a)};c.useEffect(()=>{b("")},[]);const d=()=>({acct_code:"",acct_desc:"",debit:0,credit:0,persisted:!1}),A=()=>{_(null),w(""),y(""),L(""),N(""),j(""),v(""),S(!1),x([d(),d(),d(),d()]),k(!1),u.success("Sales Journal form ready for new entry.")},z=async()=>{if((await g.fire({title:"Confirm Save?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, Save"})).isConfirmed)try{const s=(await l.get("/api/sales/generate-cs-number",{params:{company_id:i?.company_id}})).data.cs_no;w(s);const n=await l.post("/api/sales/save-main",{cs_no:s,cust_id:R,sales_date:$,explanation:F,si_no:O,company_id:i?.company_id,user_id:i?.id});_(n.data.id),k(!0),x([d(),d()]),u.success("Main saved. You can now input details."),b()}catch(a){console.error(a),u.error(a?.response?.data?.message||"Failed to save.")}},he=e=>e.acct_code&&(e.debit??0)>0!=(e.credit??0)>0,xe=async(e,a)=>{if(o&&he(e))try{if(e.persisted)await l.post("/api/sales/update-detail",{id:e.id,transaction_id:o,acct_code:e.acct_code,debit:e.debit||0,credit:e.credit||0});else{const s=await l.post("/api/sales/save-detail",{transaction_id:o,acct_code:e.acct_code,debit:e.debit||0,credit:e.credit||0,company_id:i?.company_id,user_id:i?.id}),n=[...p];n[a]={...e,id:s.data.detail_id,persisted:!0},a===n.length-1&&n.push(d()),x(n)}}catch(s){u.error(s?.response?.data?.message||"Row save failed")}},fe=async e=>{if(e)try{const{data:a}=await l.get(`/api/sales/${e}`,{params:{company_id:i?.company_id}}),s=a.main;_(s.id),w(s.cs_no),y(s.cust_id),N(s.sales_date),j(s.explanation||""),v(s.si_no||""),S(!0),x((a.details||[]).length?a.details.map(n=>({id:n.id,acct_code:n.acct_code,acct_desc:n.acct_desc,debit:n.debit??0,credit:n.credit??0,persisted:!0})).concat([d()]):[d()]),k(!0)}catch(a){console.error(a)}},be=c.useMemo(()=>C.map(e=>`${e.acct_code};${e.acct_desc}`),[C]),ge=e=>C.find(s=>s.acct_code===e)?.acct_desc||"",we=()=>{if(!o)return u.info("Select or save a transaction first.");const e=`/api/sales/form-pdf/${o}?company_id=${encodeURIComponent(i?.company_id||"")}`;ie(e),P(!0)},ye=async()=>{if(!o)return u.info("Select or save a transaction first.");const e=await l.get(`/api/sales/form-excel/${o}`,{responseType:"blob",params:{company_id:i?.company_id||""}}),a=e.headers["content-disposition"]?.match(/filename="?([^"]+)"?/)?.[1]||`SalesVoucher_${K||o}.xlsx`,s=new Blob([e.data],{type:e.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),n=URL.createObjectURL(s),r=document.createElement("a");r.href=n,r.download=a,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(n)};return t.jsxs("div",{className:"space-y-4 p-6",children:[t.jsx(_e,{position:"top-right",autoClose:3e3}),t.jsxs("div",{className:"bg-yellow-50 shadow-md rounded-lg p-6 space-y-4 border border-yellow-400",children:[t.jsx("h2",{className:"text-xl font-bold text-green-800 mb-2",children:"SALES JOURNAL"}),t.jsxs("div",{className:"flex items-end gap-2",children:[t.jsx("div",{className:"w-full",children:t.jsx(W,{label:"Search Transaction",value:te,onChange:e=>{se(e),fe(e)},items:Z.map(e=>({code:String(e.id),id:e.id,cs_no:e.cs_no,cust_id:e.cust_id,sales_date:e.sales_date,amount:e.sales_amount,si_no:e.si_no})),headers:["ID","Sales No","Customer ID","Date","Amount","S.I. #"],onSearchChange:e=>b(e),search:"",columnWidths:["60px","120px","120px","120px","120px","120px"]})}),o&&t.jsxs("div",{className:"flex gap-2",children:[h?t.jsx("button",{onClick:()=>S(!1),className:"px-3 py-2 rounded bg-indigo-600 text-white",children:"Update"}):null,t.jsx("button",{onClick:async()=>{!o||!(await g.fire({title:"Cancel this transaction?",icon:"warning",showCancelButton:!0})).isConfirmed||(await l.post("/api/sales/cancel",{id:o,flag:1}),u.success("Transaction cancelled."),b())},className:"px-3 py-2 rounded bg-amber-600 text-white",children:"Cancel"}),t.jsx("button",{onClick:async()=>{!o||!(await g.fire({title:"Delete this transaction?",text:"This will remove header and details.",icon:"warning",showCancelButton:!0})).isConfirmed||(await l.post("/api/sales/delete-detail",{id:0,transaction_id:o}).catch(()=>{}),await l.post("/api/roles",{}).catch(()=>{}),u.success("Deleted (implement main delete endpoint as needed)."))},className:"px-3 py-2 rounded bg-rose-600 text-white",children:"Delete"})]})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[t.jsx(W,{label:"Customer",value:R,onChange:e=>{y(e);const a=H.find(s=>s.code===e);L(a?.description||"")},items:H,headers:["Code","Label","Description"]}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"Date"}),t.jsx("input",{type:"date",value:$,disabled:h,onChange:e=>N(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1",children:"S.I. #"}),t.jsx("input",{value:O,disabled:h,onChange:e=>v(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),t.jsxs("div",{className:"col-span-3",children:[t.jsx("label",{className:"block mb-1",children:"Explanation"}),t.jsx("input",{value:F,disabled:h,onChange:e=>j(e.target.value),className:"w-full border p-2 bg-green-100 text-green-900"})]}),E&&t.jsxs("div",{className:"col-span-3 text-sm font-semibold text-gray-700",children:["Customer: ",E]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("button",{onClick:A,className:"inline-flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:[t.jsx(G,{className:"h-5 w-5"})," New"]}),t.jsxs("button",{onClick:z,disabled:!!o,className:`inline-flex items-center gap-2 px-4 py-2 rounded ${o?"bg-gray-400 cursor-not-allowed text-white":"bg-green-600 text-white hover:bg-green-700"}`,children:[t.jsx(J,{className:"h-5 w-5"})," Save"]})]})]}),t.jsxs("div",{ref:I,className:"relative z-0",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2 mt-4",children:"Details"}),ae&&t.jsx(Ne,{ref:Y,data:p,colHeaders:["Account Code","Account Description","Debit","Credit"],columns:[{data:"acct_code",type:"autocomplete",source:(e,a)=>{const s=be;if(!e)return a(s);const n=String(e).toLowerCase();a(s.filter(r=>r.toLowerCase().includes(n)))},strict:!1,visibleRows:10,allowInvalid:!1,readOnly:h},{data:"acct_desc",readOnly:!0},{data:"debit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:h},{data:"credit",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:h}],afterChange:(e,a)=>{if(!e||a!=="edit")return;const s=[...p];e.forEach(([n,r,,f])=>{const m=s[n]||{};if(r==="acct_code"){const D=String(f||""),B=D.includes(";")?D.split(";")[0]:D;m.acct_code=B,m.acct_desc=ge(B)}r==="debit"&&(m.debit=Number(f||0)),r==="credit"&&(m.credit=Number(f||0)),s[n]=m,setTimeout(()=>xe(m,n),0)}),s.find(n=>!n.acct_code)||s.push(d()),x(s)},contextMenu:{items:{remove_row:{name:"🗑️ Remove row",callback:async(e,a)=>{const s=a[0].start.row,n=p[s];if(!n?.id){const m=[...p];m.splice(s,1),x(m);return}if(!(await g.fire({title:"Delete this line?",icon:"warning",showCancelButton:!0})).isConfirmed)return;await l.post("/api/sales/delete-detail",{id:n.id,transaction_id:o});const f=[...p];f.splice(s,1),x(f),u.success("Row deleted")}}}},manualColumnResize:!0,stretchH:"all",height:pe,rowHeaders:!0,licenseKey:"non-commercial-and-evaluation"})]}),t.jsxs("div",{className:"flex gap-3 mt-4 items-start",children:[t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>T(!0),onMouseLeave:()=>T(!1),children:[t.jsxs("button",{type:"button",disabled:!o,className:`inline-flex items-center gap-2 rounded border px-3 py-2 ${o?"bg-white text-emerald-700 border-emerald-300 hover:bg-emerald-50":"bg-gray-100 text-gray-400 border-gray-200"}`,children:[t.jsx(Ce,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{children:"Download"}),t.jsx(V,{className:"h-4 w-4 opacity-70"})]}),ce&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsx("div",{className:"mt-1 w-60 rounded-md border bg-white shadow-lg py-1",children:t.jsxs("button",{type:"button",onClick:ye,disabled:!o,className:`flex w-full items-center gap-3 px-3 py-2 text-sm ${o?"text-gray-800 hover:bg-emerald-50":"text-gray-400 cursor-not-allowed"}`,children:[t.jsx(ke,{className:`h-5 w-5 ${o?"text-emerald-600":"text-gray-400"}`}),t.jsx("span",{className:"truncate",children:"Sales Voucher – Excel"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold",children:"XLSX"})]})})})]}),t.jsxs("div",{className:"relative inline-block",onMouseEnter:()=>M(!0),onMouseLeave:()=>M(!1),children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 rounded border px-3 py-2 bg-white text-gray-700 hover:bg-gray-50",children:[t.jsx(Se,{className:"h-5 w-5"}),t.jsx("span",{children:"Print"}),t.jsx(V,{className:"h-4 w-4 opacity-70"})]}),ne&&t.jsx("div",{className:"absolute left-0 top-full z-50",children:t.jsxs("div",{className:"mt-1 w-64 rounded-md border bg-white shadow-lg py-1",children:[t.jsxs("button",{type:"button",onClick:we,className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(X,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Sales Voucher – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]}),t.jsxs("button",{type:"button",onClick:()=>{if(!o)return u.info("Select or save a transaction.");window.open(`/api/sales/check-pdf/${o}?company_id=${encodeURIComponent(i?.company_id||"")}`,"_blank")},className:"flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-800 hover:bg-gray-100",children:[t.jsx(X,{className:"h-5 w-5 text-red-600"}),t.jsx("span",{className:"truncate",children:"Print Check – PDF"}),t.jsx("span",{className:"ml-auto text-[10px] font-semibold text-red-600",children:"PDF"})]})]})})]}),t.jsxs("button",{onClick:A,className:"inline-flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:[t.jsx(G,{className:"h-5 w-5"}),t.jsx("span",{children:"New"})]}),t.jsxs("button",{onClick:z,disabled:!!o,className:`inline-flex items-center gap-2 px-4 py-2 rounded ${o?"bg-gray-400 cursor-not-allowed text-white":"bg-green-600 text-white hover:bg-green-700"}`,children:[t.jsx(J,{className:"h-5 w-5"}),t.jsx("span",{children:"Save"})]})]}),le&&t.jsx("div",{className:"fixed inset-0 z-[10000] bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-[90vw] h-[85vh] relative",children:[t.jsx("button",{onClick:()=>P(!1),className:"absolute top-2 right-2 rounded-full px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200","aria-label":"Close",children:"✕"}),t.jsx("div",{className:"h-full w-full pt-8",children:t.jsx("iframe",{title:"Sales Voucher PDF",src:oe,className:"w-full h-full",style:{border:"none"}})})]})})]})}export{Fe as default};
